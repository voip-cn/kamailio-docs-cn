<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>NDB_REDIS Module</title>
    <link rel="stylesheet" type="text/css" href="../../../../css/sr-doc.css" tppabs="http://kamailio.org/css/sr-doc.css" />
    <meta name="generator" content="DocBook XSL Stylesheets V1.76.1" />
    <link rel="home" href="#idm4251024" title="NDB_REDIS Module" />
    <link rel="next" href="#idp3159488" title="Chapter 1. Admin Guide" />
  </head>
  <body>
    <div class="book" title="NDB_REDIS Module">
      <div class="titlepage">
        <div>
          <div>
            <h1 class="title"><a id="idm4251024"></a>NDB_REDIS Module</h1>
          </div>
          <div>
            <div class="authorgroup">
              <div class="author">
                <h3 class="author"><span class="firstname">Daniel-Constantin</span> <span class="surname">Mierla</span></h3>
                <code class="email">&lt;<a class="email" href="mailto:miconda@gmail.com">miconda@gmail.com</a>&gt;</code>
              </div>
              <div class="editor">
                <h4 class="editedby">Edited by</h4>
                <h3 class="editor"><span class="firstname">Daniel-Constantin</span> <span class="surname">Mierla</span></h3>
                <code class="email">&lt;<a class="email" href="mailto:miconda@gmail.com">miconda@gmail.com</a>&gt;</code>
              </div>
              <div class="author">
                <h3 class="author"><span class="firstname">Vicente</span> <span class="surname">Hernando</span></h3>
                <code class="email">&lt;<a class="email" href="mailto:vhernando@systemonenoc.com">vhernando@systemonenoc.com</a>&gt;</code>
              </div>
            </div>
          </div>
          <div>
            <p class="copyright">Copyright © 2011 asipto.com</p>
          </div>
          <div>
            <p class="copyright">Copyright © 2012 www.systemonenoc.com</p>
          </div>
        </div>
        <hr />
      </div>
      <div class="toc">
        <p>
          <strong>Table of Contents</strong>
        </p>
        <dl>
          <dt>
            <span class="chapter">
              <a href="#idp3159488">1. Admin Guide</a>
            </span>
          </dt>
          <dd>
            <dl>
              <dt>
                <span class="section">
                  <a href="#idp2956056">1. Overview</a>
                </span>
              </dt>
              <dt>
                <span class="section">
                  <a href="#idp2895480">2. Dependencies</a>
                </span>
              </dt>
              <dd>
                <dl>
                  <dt>
                    <span class="section">
                      <a href="#idp2265416">2.1. Kamailio Modules</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#idp2321872">2.2. External Libraries or Applications</a>
                    </span>
                  </dt>
                </dl>
              </dd>
              <dt>
                <span class="section">
                  <a href="#idp2414592">3. Parameters</a>
                </span>
              </dt>
              <dd>
                <dl>
                  <dt>
                    <span class="section">
                      <a href="#ndb_redis.p.server">3.1. <code class="varname">server</code> (str)</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#ndb_redis.p.init_without_redis">3.2. <code class="varname">init_without_redis</code> (integer)</a>
                    </span>
                  </dt>
                </dl>
              </dd>
              <dt>
                <span class="section">
                  <a href="#idp2488272">4. Functions</a>
                </span>
              </dt>
              <dd>
                <dl>
                  <dt>
                    <span class="section">
                      <a href="#ndb_redis.f.redis_cmd">4.1. 
		<code class="function">redis_cmd(srvname, command, ..., replyid)</code>
	    </a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#ndb_redis.f.redis_free">4.2. 
		<code class="function">redis_free(replyid)</code>
	</a>
                    </span>
                  </dt>
                </dl>
              </dd>
            </dl>
          </dd>
        </dl>
      </div>
      <div class="list-of-examples">
        <p>
          <strong>List of Examples</strong>
        </p>
        <dl>
          <dt>1.1. <a href="#idp2477488">Set <code class="varname">server</code> parameter</a></dt>
          <dt>1.2. <a href="#idp2251120">Set <code class="varname">init_without_redis</code> parameter</a></dt>
          <dt>1.3. <a href="#idp2505112"><code class="function">redis_cmd</code> usage</a></dt>
          <dt>1.4. <a href="#idp1635192"><code class="function">redis_free</code> usage</a></dt>
        </dl>
      </div>
      <div class="chapter" title="Chapter 1. Admin Guide">
        <div class="titlepage">
          <div>
            <div>
              <h2 class="title"><a id="idp3159488"></a>Chapter 1. Admin Guide</h2>
            </div>
          </div>
        </div>
        <div class="toc">
          <p>
            <strong>Table of Contents</strong>
          </p>
          <dl>
            <dt>
              <span class="section">
                <a href="#idp2956056">1. Overview</a>
              </span>
            </dt>
            <dt>
              <span class="section">
                <a href="#idp2895480">2. Dependencies</a>
              </span>
            </dt>
            <dd>
              <dl>
                <dt>
                  <span class="section">
                    <a href="#idp2265416">2.1. Kamailio Modules</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#idp2321872">2.2. External Libraries or Applications</a>
                  </span>
                </dt>
              </dl>
            </dd>
            <dt>
              <span class="section">
                <a href="#idp2414592">3. Parameters</a>
              </span>
            </dt>
            <dd>
              <dl>
                <dt>
                  <span class="section">
                    <a href="#ndb_redis.p.server">3.1. <code class="varname">server</code> (str)</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#ndb_redis.p.init_without_redis">3.2. <code class="varname">init_without_redis</code> (integer)</a>
                  </span>
                </dt>
              </dl>
            </dd>
            <dt>
              <span class="section">
                <a href="#idp2488272">4. Functions</a>
              </span>
            </dt>
            <dd>
              <dl>
                <dt>
                  <span class="section">
                    <a href="#ndb_redis.f.redis_cmd">4.1. 
		<code class="function">redis_cmd(srvname, command, ..., replyid)</code>
	    </a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#ndb_redis.f.redis_free">4.2. 
		<code class="function">redis_free(replyid)</code>
	</a>
                  </span>
                </dt>
              </dl>
            </dd>
          </dl>
        </div>
        <div class="section" title="1. Overview">
          <div class="titlepage">
            <div>
              <div>
                <h2 class="title"><a id="idp2956056"></a>1. Overview</h2>
              </div>
            </div>
          </div>
          <p>
		This module provides a connector to interact with REDIS NoSQL Database
		from configuration file. You can read more about REDIS at
		http://redis.io.
	</p>
          <p>
		It can connect to many REDIS servers and store the results in different
		containers.
	</p>
        </div>
        <div class="section" title="2. Dependencies">
          <div class="titlepage">
            <div>
              <div>
                <h2 class="title"><a id="idp2895480"></a>2. Dependencies</h2>
              </div>
            </div>
          </div>
          <div class="section" title="2.1. Kamailio Modules">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="idp2265416"></a>2.1. Kamailio Modules</h3>
                </div>
              </div>
            </div>
            <p>
		The following modules must be loaded before this module:
			</p>
            <div class="itemizedlist">
              <ul class="itemizedlist">
                <li class="listitem">
                  <p>
				<span class="emphasis"><em>none</em></span>.
			</p>
                </li>
              </ul>
            </div>
            <p>
		</p>
          </div>
          <div class="section" title="2.2. External Libraries or Applications">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="idp2321872"></a>2.2. External Libraries or Applications</h3>
                </div>
              </div>
            </div>
            <p>
		The following libraries or applications must be installed before running
		Kamailio with this module loaded:
			</p>
            <div class="itemizedlist">
              <ul class="itemizedlist">
                <li class="listitem">
                  <p>
				<span class="emphasis"><em>hiredis</em></span> - available at
				https://github.com/antirez/hiredis .
			</p>
                </li>
              </ul>
            </div>
            <p>
		</p>
          </div>
        </div>
        <div class="section" title="3. Parameters">
          <div class="titlepage">
            <div>
              <div>
                <h2 class="title"><a id="idp2414592"></a>3. Parameters</h2>
              </div>
            </div>
          </div>
          <div class="section" title="3.1. server (str)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="ndb_redis.p.server"></a>3.1. <code class="varname">server</code> (str)</h3>
                </div>
              </div>
            </div>
            <p>
			Specify the details to connect to REDIS server. It takes a list of attribute=value
			separated by semicolon, the attributes can be name, unix, addr, port, db and pass. Name
			is a generic identifier to be used with module functions. unix is the path to the unix
			domain socket provided by redis server. addr and port are the IP address and the port to
			connect to REDIS server. pass is the server password. unix and (addr, port) are mutually
			exclusive.  If both appear in same server settings unix domain socket is configured.  db
			is the DB number to use (defaults to 0 if not specified).
		</p>
            <p>
			You can set this parameter many times, in case you want to connect to
			many REDIS servers, just give different attributes and use the specific
			server name when querying the REDIS instance.
		</p>
            <p>
		<span class="emphasis"><em>
			Default value is NULL.
		</em></span>
		</p>
            <div class="example">
              <a id="idp2477488"></a>
              <p class="title">
                <strong>Example 1.1. Set <code class="varname">server</code> parameter</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
modparam("ndb_redis", "server", "name=srvN;addr=127.0.0.1;port=6379;db=1")
modparam("ndb_redis", "server", "name=srvX;addr=127.0.0.2;port=6379;db=4;pass=mypassword")

# Unix domain socket
modparam("ndb_redis", "server", "name=srvY;unix=/tmp/redis.sock;db=3")
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="3.2. init_without_redis (integer)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="ndb_redis.p.init_without_redis"></a>3.2. <code class="varname">init_without_redis</code> (integer)</h3>
                </div>
              </div>
            </div>
            <p>
			If set to 1, the module will correctly initialize even if redis is not available at start up.
		</p>
            <p>
		<span class="emphasis"><em>
			Default value is <span class="quote">“<span class="quote">0</span>”</span>.
		</em></span>
		</p>
            <div class="example">
              <a id="idp2251120"></a>
              <p class="title">
                <strong>Example 1.2. Set <code class="varname">init_without_redis</code> parameter</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
modparam("ndb_redis", "init_without_redis", 1)
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
        </div>
        <div class="section" title="4. Functions">
          <div class="titlepage">
            <div>
              <div>
                <h2 class="title"><a id="idp2488272"></a>4. Functions</h2>
              </div>
            </div>
          </div>
          <div class="section" title="4.1.  redis_cmd(srvname, command, ..., replyid)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="ndb_redis.f.redis_cmd"></a>4.1. 
		<code class="function">redis_cmd(srvname, command, ..., replyid)</code>
	    </h3>
                </div>
              </div>
            </div>
            <p>
			Send a command to REDIS server identified by srvname. The reply will
			be stored in a local container identified by replyid. All the
			parameters can be strings with pseudo-variables that are evaluated
			at runtime.
		</p>
            <p>
			Minimum required arguments are srvname, command and replyid. Command argument
			can be separated into several ones using %s token. (See examples)
			Total number of arguments cannot exceed six.
		</p>
            <p>
			The reply can be accessed via pseudo-variable $redis(key). The key
			can be: type - type of the reply (as in hiredis.h); value - the value
			returned by REDIS server; info - in case of error from REDIS, it will
			contain an info message.
		</p>
            <p>
			If reply type is an array (as in hiredis.h), there are other keys
			available:
			</p>
            <div class="itemizedlist">
              <ul class="itemizedlist">
                <li class="listitem">
                  <p>
				size - returns number of elements in the array.
				</p>
                </li>
                <li class="listitem">
                  <p>
				type[n] - returns the type of the nth element in the array. type
				- returns array type.
				</p>
                </li>
                <li class="listitem">
                  <p>
				value[n] - returns value of the nth element. value - returns null
				for an array. You need to get each element by index.
				</p>
                </li>
              </ul>
            </div>
            <p>
		</p>
            <div class="example">
              <a id="idp2505112"></a>
              <p class="title">
                <strong>Example 1.3. <code class="function">redis_cmd</code> usage</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
if(redis_cmd("srvN", "INCR cnt", "r")) {
    # success - the incremented value is in $redis(r=&gt;value)
    xlog("===== $redis(r=&gt;type) * $redis(r=&gt;value)\n");
}

# set a value
redis_cmd("srvN", "SET foo bar", "r");

redis_cmd("srvN", "SET ruri $ru", "r");

# get a value
redis_cmd("srvN", "GET foo", "r");

# same command separated into two arguments:
redis_cmd("srvN", "GET %s", "foo", "r");

# if we have a key with spaces within it:
redis_cmd("srvN", "GET %s", "foo bar", "r");

# several values substitution:
redis_cmd("srvN", "HMGET %s %s %s", "key1", "field1", "field2", "r");


# array example
if(redis_cmd("srvN", "HMGET foo_key field1 field3", "r")) {
    xlog("array size: $redis(r=&gt;size)\n");
    xlog("first values: $redis(r=&gt;value[0]) , $redis(r=&gt;value[1])\n");
}
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="4.2.  redis_free(replyid)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="ndb_redis.f.redis_free"></a>4.2. 
		<code class="function">redis_free(replyid)</code>
	</h3>
                </div>
              </div>
            </div>
            <p>
		Frees data in a previous reply from memory.
		After this function call, accessing to a freed replyid returns null value.
	</p>
            <p>
		It is not necessary to free a reply to use it again in a new redis_cmd
		function. When ndb_redis module closes, all pending replies are freed
		automatically.
	</p>
            <div class="example">
              <a id="idp1635192"></a>
              <p class="title">
                <strong>Example 1.4. <code class="function">redis_free</code> usage</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
After a redis command call:
	redis_cmd("srvN", "INCR cnt", "r");

free reply data:
	redis_free("r");
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
