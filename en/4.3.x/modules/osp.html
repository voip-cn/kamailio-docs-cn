<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>OSP Module for Secure, Multi-Lateral Peering</title>
    <link rel="stylesheet" type="text/css" href="../../../../css/sr-doc.css" tppabs="http://kamailio.org/css/sr-doc.css" />
    <meta name="generator" content="DocBook XSL Stylesheets V1.76.1" />
    <link rel="home" href="#idm4342960" title="OSP Module for Secure, Multi-Lateral Peering" />
    <link rel="next" href="#idp2242960" title="Chapter 1. Admin Guide" />
  </head>
  <body>
    <div class="book" title="OSP Module for Secure, Multi-Lateral Peering">
      <div class="titlepage">
        <div>
          <div>
            <h1 class="title"><a id="idm4342960"></a>OSP Module for Secure, Multi-Lateral Peering</h1>
          </div>
          <div>
            <div class="authorgroup">
              <div class="author">
                <h3 class="author"><span class="firstname">Ulrich</span> <span class="surname">Abend</span></h3>
                <div class="affiliation">
                  <span class="orgname">FhG FOKUS<br /></span>
                  <div class="address">
                    <p>
                      <code class="email">&lt;<a class="email" href="mailto:ullstar@iptel.org">ullstar@iptel.org</a>&gt;</code>
                    </p>
                  </div>
                </div>
              </div>
              <div class="editor">
                <h4 class="editedby">Edited by</h4>
                <h3 class="editor"><span class="firstname">Di-Shi</span> <span class="surname">Sun</span></h3>
                <div class="affiliation">
                  <span class="orgname">TransNexus, Inc.<br /></span>
                  <div class="address">
                    <p>
                      <code class="email">&lt;<a class="email" href="mailto:support@transnexus.com">support@transnexus.com</a>&gt;</code>
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div>
            <p class="copyright">Copyright © 2003 FhG FOKUS</p>
          </div>
        </div>
        <hr />
      </div>
      <div class="toc">
        <p>
          <strong>Table of Contents</strong>
        </p>
        <dl>
          <dt>
            <span class="chapter">
              <a href="#idp2242960">1. Admin Guide</a>
            </span>
          </dt>
          <dd>
            <dl>
              <dt>
                <span class="section">
                  <a href="#idp2079224">1. Overview</a>
                </span>
              </dt>
              <dt>
                <span class="section">
                  <a href="#idp1854408">2. Dependencies</a>
                </span>
              </dt>
              <dt>
                <span class="section">
                  <a href="#idp2983680">3. Parameters</a>
                </span>
              </dt>
              <dd>
                <dl>
                  <dt>
                    <span class="section">
                      <a href="#idp2562552">3.1. <code class="varname">sp1_uri</code>, <code class="varname">sp2_uri</code>, ..., <code class="varname">sp16_uri</code></a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#idm14968">3.2. <code class="varname">sp1_weight</code>, <code class="varname">sp2_weight</code>, ..., <code class="varname">sp16_weight</code></a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#idm12424">3.3. <code class="varname">device_ip</code></a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#idm10624">3.4. <code class="varname">device_port</code></a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#idm8552">3.5. <code class="varname">token_format</code></a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#idm5720">3.6. <code class="varname">private_key</code>, <code class="varname">local_certificate</code>, <code class="varname">ca_certificates</code></a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#idm2648">3.7. <code class="varname">enable_crypto_hardware_support</code></a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#idp70144">3.8. <code class="varname">ssl_lifetime</code></a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#idp72056">3.9. <code class="varname">persistence</code></a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#idp73928">3.10. <code class="varname">retry_delay</code></a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#idp75752">3.11. <code class="varname">retry_limit</code></a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#idp77736">3.12. <code class="varname">timeout</code></a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#idp79568">3.13. <code class="varname">max_destinations</code></a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#idp81368">3.14. <code class="varname">validate_call_id</code></a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#idp83352">3.15. <code class="varname">use_rpid_for_calling_number</code></a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#idp85424">3.16. <code class="varname">redirection_uri_format</code></a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#idp87632">3.17. <code class="varname">source_networkid_avp</code></a>
                    </span>
                  </dt>
                </dl>
              </dd>
              <dt>
                <span class="section">
                  <a href="#idp89696">4. Functions</a>
                </span>
              </dt>
              <dd>
                <dl>
                  <dt>
                    <span class="section">
                      <a href="#idp128232">4.1. <code class="function">checkospheader()</code></a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#idp130384">4.2. <code class="function">validateospheader()</code></a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#idp132768">4.3. <code class="function">requestosprouting()</code></a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#idp135896">4.4. <code class="function">checkosproute()</code></a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#idp138088">4.5. <code class="function">prepareosproute()</code></a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#idp140736">4.6. <code class="function">checkcallingtranslation()</code></a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#idp143336">4.7. <code class="function">prepareallosproute()</code></a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#idp145720">4.8. <code class="function">reportospusage()</code></a>
                    </span>
                  </dt>
                </dl>
              </dd>
            </dl>
          </dd>
          <dt>
            <span class="chapter">
              <a href="#idp237952">2. Developer Guide</a>
            </span>
          </dt>
        </dl>
      </div>
      <div class="list-of-examples">
        <p>
          <strong>List of Examples</strong>
        </p>
        <dl>
          <dt>1.1. <a href="#idm15896">Setting the OSP servers</a></dt>
          <dt>1.2. <a href="#idm13288">Setting the OSP server weights</a></dt>
          <dt>1.3. <a href="#idm11544">Setting the device IP address</a></dt>
          <dt>1.4. <a href="#idm9472">Setting the device port</a></dt>
          <dt>1.5. <a href="#idm6584">Setting the token format</a></dt>
          <dt>1.6. <a href="#idm4048">Set authorization files</a></dt>
          <dt>1.7. <a href="#idm1760">Setting the hardware support</a></dt>
          <dt>1.8. <a href="#idp71136">Setting the ssl lifetime</a></dt>
          <dt>1.9. <a href="#idp73008">Setting the persistence</a></dt>
          <dt>1.10. <a href="#idp74888">Setting the retry delay</a></dt>
          <dt>1.11. <a href="#idp76872">Setting the retry limit</a></dt>
          <dt>1.12. <a href="#idp78680">Setting the timeout</a></dt>
          <dt>1.13. <a href="#idp80408">Setting the number of destination</a></dt>
          <dt>1.14. <a href="#idp82432">Instructing the module to validate call id</a></dt>
          <dt>1.15. <a href="#idp84424">Instructing the module to use calling number in Remote-Party-ID</a></dt>
          <dt>1.16. <a href="#idp86664">Setting the redirection URI format</a></dt>
          <dt>1.17. <a href="#idp88640">Setting the source network ID AVP</a></dt>
          <dt>1.18. <a href="#idp129376">checkospheader usage</a></dt>
          <dt>1.19. <a href="#idp131744">validateospheader usage</a></dt>
          <dt>1.20. <a href="#idp134840">requestosprouting usage</a></dt>
          <dt>1.21. <a href="#idp137032">checkosproute usage</a></dt>
          <dt>1.22. <a href="#idp139680">prepareosproute usage</a></dt>
          <dt>1.23. <a href="#idp142216">checkcallingtranslation usage</a></dt>
          <dt>1.24. <a href="#idp144640">prepareallosproute usage</a></dt>
          <dt>1.25. <a href="#idp148568">reportospusage usage</a></dt>
        </dl>
      </div>
      <div class="chapter" title="Chapter 1. Admin Guide">
        <div class="titlepage">
          <div>
            <div>
              <h2 class="title"><a id="idp2242960"></a>Chapter 1. Admin Guide</h2>
            </div>
          </div>
        </div>
        <div class="toc">
          <p>
            <strong>Table of Contents</strong>
          </p>
          <dl>
            <dt>
              <span class="section">
                <a href="#idp2079224">1. Overview</a>
              </span>
            </dt>
            <dt>
              <span class="section">
                <a href="#idp1854408">2. Dependencies</a>
              </span>
            </dt>
            <dt>
              <span class="section">
                <a href="#idp2983680">3. Parameters</a>
              </span>
            </dt>
            <dd>
              <dl>
                <dt>
                  <span class="section">
                    <a href="#idp2562552">3.1. <code class="varname">sp1_uri</code>, <code class="varname">sp2_uri</code>, ..., <code class="varname">sp16_uri</code></a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#idm14968">3.2. <code class="varname">sp1_weight</code>, <code class="varname">sp2_weight</code>, ..., <code class="varname">sp16_weight</code></a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#idm12424">3.3. <code class="varname">device_ip</code></a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#idm10624">3.4. <code class="varname">device_port</code></a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#idm8552">3.5. <code class="varname">token_format</code></a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#idm5720">3.6. <code class="varname">private_key</code>, <code class="varname">local_certificate</code>, <code class="varname">ca_certificates</code></a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#idm2648">3.7. <code class="varname">enable_crypto_hardware_support</code></a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#idp70144">3.8. <code class="varname">ssl_lifetime</code></a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#idp72056">3.9. <code class="varname">persistence</code></a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#idp73928">3.10. <code class="varname">retry_delay</code></a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#idp75752">3.11. <code class="varname">retry_limit</code></a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#idp77736">3.12. <code class="varname">timeout</code></a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#idp79568">3.13. <code class="varname">max_destinations</code></a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#idp81368">3.14. <code class="varname">validate_call_id</code></a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#idp83352">3.15. <code class="varname">use_rpid_for_calling_number</code></a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#idp85424">3.16. <code class="varname">redirection_uri_format</code></a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#idp87632">3.17. <code class="varname">source_networkid_avp</code></a>
                  </span>
                </dt>
              </dl>
            </dd>
            <dt>
              <span class="section">
                <a href="#idp89696">4. Functions</a>
              </span>
            </dt>
            <dd>
              <dl>
                <dt>
                  <span class="section">
                    <a href="#idp128232">4.1. <code class="function">checkospheader()</code></a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#idp130384">4.2. <code class="function">validateospheader()</code></a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#idp132768">4.3. <code class="function">requestosprouting()</code></a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#idp135896">4.4. <code class="function">checkosproute()</code></a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#idp138088">4.5. <code class="function">prepareosproute()</code></a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#idp140736">4.6. <code class="function">checkcallingtranslation()</code></a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#idp143336">4.7. <code class="function">prepareallosproute()</code></a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#idp145720">4.8. <code class="function">reportospusage()</code></a>
                  </span>
                </dt>
              </dl>
            </dd>
          </dl>
        </div>
        <div class="section" title="1. Overview">
          <div class="titlepage">
            <div>
              <div>
                <h2 class="title"><a id="idp2079224"></a>1. Overview</h2>
              </div>
            </div>
          </div>
          <p>The OSP module enables Kamailio to support secure, multi-lateral peering using the OSP standard defined by ETSI (TS 101 321 V4.1.1). This module will enable your Kamailio to:</p>
          <div class="itemizedlist">
            <ul class="itemizedlist">
              <li class="listitem">
                <p>Send a peering authorization request to a peering server.</p>
              </li>
              <li class="listitem">
                <p>Validate a digitally signed peering authorization token received in a SIP INVITE message.</p>
              </li>
              <li class="listitem">
                <p>Report usage information to a peering server.</p>
              </li>
            </ul>
          </div>
        </div>
        <div class="section" title="2. Dependencies">
          <div class="titlepage">
            <div>
              <div>
                <h2 class="title"><a id="idp1854408"></a>2. Dependencies</h2>
              </div>
            </div>
          </div>
          <p>The OSP module depends on the following modules which must be loaded before the OSP module.</p>
          <div class="itemizedlist">
            <ul class="itemizedlist">
              <li class="listitem">
                <p><span class="emphasis"><em>sl</em></span> -- stateless replier</p>
              </li>
              <li class="listitem">
                <p><span class="emphasis"><em>tm</em></span> -- stateful processing</p>
              </li>
              <li class="listitem">
                <p><span class="emphasis"><em>rr</em></span> -- Record-Route/Route operation</p>
              </li>
              <li class="listitem">
                <p><span class="emphasis"><em>textops</em></span> -- text based operation</p>
              </li>
              <li class="listitem">
                <p><span class="emphasis"><em>siputils</em></span> -- Remote-Party-ID operattion</p>
              </li>
              <li class="listitem">
                <p><span class="emphasis"><em>OSP Toolkit</em></span> -- The OSP Toolkit, available from http://sourceforge.net/projects/osp-toolkit, must be built before building Kamailio with the OSP Module.  For instructions on building Kamailio with the OSP Toolkit, see http://www.transnexus.com/White%20Papers/Multi-Lateral_Peering_with_Kamailio_V1.4.pdf</p>
              </li>
            </ul>
          </div>
        </div>
        <div class="section" title="3. Parameters">
          <div class="titlepage">
            <div>
              <div>
                <h2 class="title"><a id="idp2983680"></a>3. Parameters</h2>
              </div>
            </div>
          </div>
          <div class="section" title="3.1. sp1_uri, sp2_uri, ..., sp16_uri">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="idp2562552"></a>3.1. <code class="varname">sp1_uri</code>, <code class="varname">sp2_uri</code>, ..., <code class="varname">sp16_uri</code></h3>
                </div>
              </div>
            </div>
            <p>These sp_uri (string) parameters define peering servers to be used for requesting peering authorization and routing information. At least one peering server must be configured. Others are required only if there are more than one peering servers. Each peering server address takes the form of a standard URL, and consists of up to four components:</p>
            <div class="itemizedlist">
              <ul class="itemizedlist">
                <li class="listitem">
                  <p>An optional indication of the protocol to be used for communicating with the peering server. Both HTTP and HTTP secured with SSL/TLS are supported and are indicated by "http://" and "https://" respectively. If the protocol is not explicitly indicated, the Kamailio defaults to HTTP secured with SSL.</p>
                </li>
                <li class="listitem">
                  <p>The Internet domain name for the peering server. An IP address may also be used, provided it is enclosed in square brackets such as [172.16.1.1].</p>
                </li>
                <li class="listitem">
                  <p>An optional TCP port number for communicating with the peering server. If the port number is omitted, the Kamailio defaults to port 1080 (for HTTP) or port 1443 (for HTTP secured with SSL).</p>
                  <p>The uniform resource identifier for requests to the peering server. This component is not optional and must be included.</p>
                </li>
              </ul>
            </div>
            <div class="example">
              <a id="idm15896"></a>
              <p class="title">
                <strong>Example 1.1. Setting the OSP servers</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">modparam("osp","sp1_uri","http://osptestserver.transnexus.com:1080/osp")
modparam("osp","sp2_uri","https://[1.2.3.4]:1443/osp")</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="3.2. sp1_weight, sp2_weight, ..., sp16_weight">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="idm14968"></a>3.2. <code class="varname">sp1_weight</code>, <code class="varname">sp2_weight</code>, ..., <code class="varname">sp16_weight</code></h3>
                </div>
              </div>
            </div>
            <p>These sp_weight (integer) parameters are used for load balancing peering requests to peering servers. These parameters are most effective when configured as factors of 1000. For example, if sp1_uri should manage twice the traffic load of sp2_uri, then set sp1_weight to 2000 and sp2_weight to 1000. Shared load balancing between peering servers is recommended. However, peering servers can be configured as primary and backup by assigning a sp_weight of 0 to the primary server and a non-zero sp_weight to the back-up server. The default values for sp1_weight and sp2_weight are 1000.</p>
            <div class="example">
              <a id="idm13288"></a>
              <p class="title">
                <strong>Example 1.2. Setting the OSP server weights</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">modparam("osp","sp1_weight",1000)</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="3.3. device_ip">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="idm12424"></a>3.3. <code class="varname">device_ip</code></h3>
                </div>
              </div>
            </div>
            <p>The device_ip (string) is a recommended parameter that explicitly defines the IP address of Kamailio in a peering request message (as SourceAlternate type=transport).  The IP address must be in brackets as shown in the example below.</p>
            <div class="example">
              <a id="idm11544"></a>
              <p class="title">
                <strong>Example 1.3. Setting the device IP address</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">modparam("osp","device_ip","[1.1.1.1]")</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="3.4. device_port">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="idm10624"></a>3.4. <code class="varname">device_port</code></h3>
                </div>
              </div>
            </div>
            <p>The device_port (string) parameter is an optional field which includes the SIP port being used by Kamailio in the peering request (as SourceAlternate type=network) to the peering server. If is not configured, this information is not included in the peering request. This field is useful if multiple Kamailio are running on the same Linux computer since it enables the peering server to administer different peering policies based on different SIP proxies. This parameter has not been implemented yet.</p>
            <div class="example">
              <a id="idm9472"></a>
              <p class="title">
                <strong>Example 1.4. Setting the device port</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">modparam("osp","device_port","5060")</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="3.5. token_format">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="idm8552"></a>3.5. <code class="varname">token_format</code></h3>
                </div>
              </div>
            </div>
            <p>When Kamailio receives a SIP INVITE with a peering token, the OSP Module will validate the token to determine whether or not the call has been authorized by a peering server. Peering tokens may, or may not, be digitally signed. The token_format (integer) parameter defines if Kamailio will validate signed or unsigned tokens or both. The values for token format are defined below. The default value is 2.</p>
            <p>0 - Validate only signed tokens. Calls with valid signed tokens are allowed.</p>
            <p>1 - Validate only unsigned tokens. Calls with valid unsigned tokens are allowed.</p>
            <p>2 - Validate both signed and unsigned tokens are allowed. Calls with valid tokens are allowed.</p>
            <div class="example">
              <a id="idm6584"></a>
              <p class="title">
                <strong>Example 1.5. Setting the token format</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">modparam("osp","token_format",2)</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="3.6. private_key, local_certificate, ca_certificates">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="idm5720"></a>3.6. <code class="varname">private_key</code>, <code class="varname">local_certificate</code>, <code class="varname">ca_certificates</code></h3>
                </div>
              </div>
            </div>
            <p>These parameters identify files are used for validating peering authorization tokens and establishing a secure channel between Kamailio and a peering server using SSL.  The files are generated using the 'Enroll' utility from the OSP Toolkit. By default, the proxy will look for pkey.pem, localcert.pem, and cacart_0.pem in the default configuration directory. The default config directory is set at compile time using CFG_DIR and defaults to /usr/local/etc/kamailio/. The files may be copied to the expected file location or the parameters below may be changed.</p>
            <div class="example">
              <a id="idm4048"></a>
              <p class="title">
                <strong>Example 1.6. Set authorization files</strong>
              </p>
              <div class="example-contents">
                <p>If the default CFG_DIR value was used at compile time, the files will be loaded from:</p>
                <pre class="programlisting">modparam("osp","private_key","/usr/local/etc/kamailio/pkey.pem")
modparam("osp","local_certificate","/usr/local/etc/kamailio/localcert.pem")
modparam("osp","ca_certificates","/usr/local/etc/kamailio/cacert.pem")</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="3.7. enable_crypto_hardware_support">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="idm2648"></a>3.7. <code class="varname">enable_crypto_hardware_support</code></h3>
                </div>
              </div>
            </div>
            <p>The enable_crypto_hardware_support (integer) parameter is used to set the cryptographic hardware acceleration engine in the openssl library. The default value is 0 (no crypto hardware is present). If crypto hardware is used, the value should be set to 1.</p>
            <div class="example">
              <a id="idm1760"></a>
              <p class="title">
                <strong>Example 1.7. Setting the hardware support</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">modparam("osp","enable_crypto_hardware_support",0)</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="3.8. ssl_lifetime">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="idp70144"></a>3.8. <code class="varname">ssl_lifetime</code></h3>
                </div>
              </div>
            </div>
            <p>The ssl_lifetime (integer) parameter defines the lifetime, in seconds, of a single SSL session key. Once this time limit is exceeded, the OSP Module will negotiate a new session key. Communication exchanges in progress will not be interrupted when this time limit expires. This is an optional field with default value is 200 seconds.</p>
            <div class="example">
              <a id="idp71136"></a>
              <p class="title">
                <strong>Example 1.8. Setting the ssl lifetime</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">modparam("osp","ssl_lifetime",200)</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="3.9. persistence">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="idp72056"></a>3.9. <code class="varname">persistence</code></h3>
                </div>
              </div>
            </div>
            <p>The persistence (integer) parameter defines the time, in seconds, that an HTTP connection should be maintained after the completion of a communication exchange. The OSP Module will maintain the connection for this time period in anticipation of future communication exchanges to the same peering server.</p>
            <div class="example">
              <a id="idp73008"></a>
              <p class="title">
                <strong>Example 1.9. Setting the persistence</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">modparam("osp","persistence",1000)</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="3.10. retry_delay">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="idp73928"></a>3.10. <code class="varname">retry_delay</code></h3>
                </div>
              </div>
            </div>
            <p>The retry_delay (integer) parameter defines the time, in seconds, between retrying connection attempts to an OSP peering server. After exhausting all peering servers the OSP Module will delay for this amount of time before resuming connection attempts. This is an optional field with default value is 1 second.</p>
            <div class="example">
              <a id="idp74888"></a>
              <p class="title">
                <strong>Example 1.10. Setting the retry delay</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">modparam("osp","retry_delay",1)</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="3.11. retry_limit">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="idp75752"></a>3.11. <code class="varname">retry_limit</code></h3>
                </div>
              </div>
            </div>
            <p>The retry_limit (integer) parameter defines the maximum number of retries for connection attempts to a peering server. If no connection is established after this many retry attempts to all peering servers, the OSP Module will cease connection attempts and return appropriate error codes. This number does not count the initial connection attempt, so that a retry_limit of 1 will result in a total of two connection attempts to every peering server. The default value is 2.</p>
            <div class="example">
              <a id="idp76872"></a>
              <p class="title">
                <strong>Example 1.11. Setting the retry limit</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">modparam("osp","retry_limit",2)</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="3.12. timeout">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="idp77736"></a>3.12. <code class="varname">timeout</code></h3>
                </div>
              </div>
            </div>
            <p>The timeout (integer) parameter defines the maximum time in milliseconds, to wait for a response from a peering server. If no response is received within this time, the current connection is aborted and the OSP Module attempts to contact the next peering server. The default value is 10 seconds.</p>
            <div class="example">
              <a id="idp78680"></a>
              <p class="title">
                <strong>Example 1.12. Setting the timeout</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">modparam("osp","timeout",10)</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="3.13. max_destinations">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="idp79568"></a>3.13. <code class="varname">max_destinations</code></h3>
                </div>
              </div>
            </div>
            <p>The max_destinations (integer) parameter defines the maximum number of destinations that Kamailio requests the peering server to return in a peering response. The default value is 5.</p>
            <div class="example">
              <a id="idp80408"></a>
              <p class="title">
                <strong>Example 1.13. Setting the number of destination</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">modparam("osp","max_destinations",5)</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="3.14. validate_call_id">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="idp81368"></a>3.14. <code class="varname">validate_call_id</code></h3>
                </div>
              </div>
            </div>
            <p>The validate_call_id (integer) parameter instructs the OSP module to validate call id in the peering token. If this value is set to 1, the OSP Module validates that the call id in the SIP INVITE message matches the call id in the peering token. If they do not match the INVITE is rejected. If this value is set to 0, the OSP Module will not validate the call id in the peering token. The default value is 1.</p>
            <div class="example">
              <a id="idp82432"></a>
              <p class="title">
                <strong>Example 1.14. Instructing the module to validate call id</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">modparam("osp","validate_call_id",1)</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="3.15. use_rpid_for_calling_number">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="idp83352"></a>3.15. <code class="varname">use_rpid_for_calling_number</code></h3>
                </div>
              </div>
            </div>
            <p>The use_rpid_for_calling_number (integer) parameter instructs the OSP module to use the calling number in the Remote-Party-ID of the SIP INVITE message. If this value is set to 1, the OSP Module uses the calling number in the Reomte-Party-ID header of the INVITE message when a Remote-Party-ID exists. If this value is set to 0, the OSP Module will use the calling number in the From header of the INVITE message. The default value is 1.</p>
            <div class="example">
              <a id="idp84424"></a>
              <p class="title">
                <strong>Example 1.15. Instructing the module to use calling number in Remote-Party-ID</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">modparam("osp","use_rpid_calling_number",1)</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="3.16. redirection_uri_format">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="idp85424"></a>3.16. <code class="varname">redirection_uri_format</code></h3>
                </div>
              </div>
            </div>
            <p>The redirection_uri_format (integer) parameter instructs the OSP module to use the different URI format in the SIP redirection message. If this value is set to 0, the OSP Module uses "xxxxxxxxxx@xxx.xxx.xxx.xxx" URI in the SIP redirection messages. If this value is set to 1, the OSP Module will use <span class="quote">“<span class="quote">&lt;xxxxxxxxxx@xxx.xxx.xxx.xxx&gt;</span>”</span> URI in the SIP redirection messages. The default value is 0</p>
            <div class="example">
              <a id="idp86664"></a>
              <p class="title">
                <strong>Example 1.16. Setting the redirection URI format</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">modparam("osp","redirection_uri_format",1)</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="3.17. source_networkid_avp">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="idp87632"></a>3.17. <code class="varname">source_networkid_avp</code></h3>
                </div>
              </div>
            </div>
            <p>The source_networkid_avp (string) parameter instructs the OSP module to use the defined AVP to pass the source network ID value. The default value is "$avp(s:_osp_source_networkid_)".  Then the source network ID can be set by "$avp(s:_osp_source_networkid_) = pseudo-variables".  All pseudo variables are described in http://kamailio.org/dokuwiki/doku.php/pseudovariables:1.3.x.</p>
            <div class="example">
              <a id="idp88640"></a>
              <p class="title">
                <strong>Example 1.17. Setting the source network ID AVP</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">modparam("osp","source_networkid_avp","$avp(s:snid)")</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
        </div>
        <div class="section" title="4. Functions">
          <div class="titlepage">
            <div>
              <div>
                <h2 class="title"><a id="idp89696"></a>4. Functions</h2>
              </div>
            </div>
          </div>
          <div class="section" title="4.1. checkospheader()">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="idp128232"></a>4.1. <code class="function">checkospheader()</code></h3>
                </div>
              </div>
            </div>
            <p>This function checks for the existence of the OSP-Auth-Token header field.</p>
            <p>This function can be used from REQUEST_ROUTE and FAILURE_ROUTE.</p>
            <div class="example">
              <a id="idp129376"></a>
              <p class="title">
                <strong>Example 1.18. checkospheader usage</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
if (checkospheader()) {
  log(1,"OSP header field found.\n");
} else {
  log(1,"no OSP header field present\n");
};
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="4.2. validateospheader()">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="idp130384"></a>4.2. <code class="function">validateospheader()</code></h3>
                </div>
              </div>
            </div>
            <p>This function validates an OSP-Token specified in the OSP-Auth-Tokenheader field of the SIP message. If a peering token is present, it will be validated locally. If no OSP header is found or the header token is invalid or expired, -1 is returned; on successful validation 1 is returned.</p>
            <p>This function can be used from REQUEST_ROUTE and FAILURE_ROUTE.</p>
            <div class="example">
              <a id="idp131744"></a>
              <p class="title">
                <strong>Example 1.19. validateospheader usage</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
if (validateospheader()) {
  log(1,"valid OSP header found\n");
} else {
  log(1,"OSP header not found, invalid or expired\n");
};
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="4.3. requestosprouting()">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="idp132768"></a>4.3. <code class="function">requestosprouting()</code></h3>
                </div>
              </div>
            </div>
            <p>This function launches a query to the peering server requesting the IP address of one or more destination peers serving the called party. If destination peers are available, the peering server will return the IP address and a peering authorization token for each destination peer. The OSP-Auth-Token Header field is inserted into the SIP message and the SIP uri is rewritten to the IP address of destination peer provided by the peering server.</p>
            <p>The address of the called party must be a valid E164 number, otherwise this function returns -1. If the transaction was accepted by the peering server, the uri is being rewritten and 1 returned, on errors (peering servers are not available, authentication failed or there is no route to destination or the route is blocked) -1 is returned.</p>
            <p>This function can be used from REQUEST_ROUTE and FAILURE_ROUTE.</p>
            <div class="example">
              <a id="idp134840"></a>
              <p class="title">
                <strong>Example 1.20. requestosprouting usage</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
if (requestosprouting()) {
  log(1,"successfully queried OSP server, now relaying call\n");
} else {
  log(1,"Authorization request was rejected from OSP server\n");
};
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="4.4. checkosproute()">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="idp135896"></a>4.4. <code class="function">checkosproute()</code></h3>
                </div>
              </div>
            </div>
            <p>This function is used to check if there is any route for the call.</p>
            <p>This function can be used from REQUEST_ROUTE and FAILURE_ROUTE.</p>
            <div class="example">
              <a id="idp137032"></a>
              <p class="title">
                <strong>Example 1.21. checkosproute usage</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
if (checkosproute()) {
  log(1,"There is at least one route for the call\n");
} else {
  log(1,"There is not any route for the call\n");
};
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="4.5. prepareosproute()">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="idp138088"></a>4.5. <code class="function">prepareosproute()</code></h3>
                </div>
              </div>
            </div>
            <p>This function tries to prepare the INVITE to be forwarded using the destination in the list returned by the peering server. If the calling number is translated, a RPID value for the RPID AVP will be set. If the route could not be prepared, the function returns 'FALSE' back to the script, which can then decide how to handle the failure. Note, if checkosproute has been called and returns 'TRUE' before calling prepareosproute, prepareosproute should not return 'FALSE' because checkosproute has confirmed that there is at least one route.</p>
            <p>This function can be used from BRANCH_ROUTE.</p>
            <div class="example">
              <a id="idp139680"></a>
              <p class="title">
                <strong>Example 1.22. prepareosproute usage</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
if (prepareosproute()) {
  log(1,"successfully prepared the route, now relaying call\n");
} else {
  log(1,"could not prepare the route, there is not route\n");
};
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="4.6. checkcallingtranslation()">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="idp140736"></a>4.6. <code class="function">checkcallingtranslation()</code></h3>
                </div>
              </div>
            </div>
            <p>This function is used to check if the calling number is translated. Before calling checkcallingtranslation, prepareosproute should be called. If the calling number does been translated, the original Remote-Party-ID, if it exists, should be removed from the INVITE message. And a new Remote-Party-ID header should be added (a RPID value for the RPID AVP has been set by prepareosproute). If the calling number is not translated, nothing should be done.</p>
            <p>This function can be used from BRANCH_ROUTE.</p>
            <div class="example">
              <a id="idp142216"></a>
              <p class="title">
                <strong>Example 1.23. checkcallingtranslation usage</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
if (checkcallingtranslation()) {
  # Remove the Remote_Party-ID from the received message
  # Otherwise it will be forwarded on to the next hop
  remove_hf("Remote-Party-ID");

  # Append a new Remote_Party
  append_rpid_hf();
}
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="4.7. prepareallosproute()">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="idp143336"></a>4.7. <code class="function">prepareallosproute()</code></h3>
                </div>
              </div>
            </div>
            <p>This function tries to prepare all the routes in the list returned by the peering server. The message is then either forked off or redirected to the destination. If unsuccessful in preparing the routes a SIP 500 is sent back and a trace message is logged.</p>
            <p>This function can be used from REQUEST_ROUTE and FAILURE_ROUTE.</p>
            <div class="example">
              <a id="idp144640"></a>
              <p class="title">
                <strong>Example 1.24. prepareallosproute usage</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
if (prepareallosproute()) {
  log(1,"Routes are prepared, now either forking or redirecting the call\n");
} else {
  log(1,"Could not prepare the routes. No destination available\n");
};
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="4.8. reportospusage()">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="idp145720"></a>4.8. <code class="function">reportospusage()</code></h3>
                </div>
              </div>
            </div>
            <p>This function should be called after receiving a BYE message. If the message contains an OSP cookie, the function will forward originating and/or terminating duration usage information to a peering server. The function returns TRUE if the BYE includes an OSP cookie. The actual usage message will be send on a different thread and will not delay BYE processing. The function should be called before relaying the message.</p>
            <p>Meaning of the parameter is as follows:
        </p>
            <div class="itemizedlist">
              <ul class="itemizedlist">
                <li class="listitem">
                  <p>"0" - Source device releases the call.</p>
                </li>
                <li class="listitem">
                  <p>"1" - Destination device releases the call.</p>
                </li>
              </ul>
            </div>
            <p>
      </p>
            <p>This function can be used from REQUEST_ROUTE.</p>
            <div class="example">
              <a id="idp148568"></a>
              <p class="title">
                <strong>Example 1.25. reportospusage usage</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
if (is_direction("downstream")) {
  log(1,"This BYE message is from SOURCE\n");
  if (!reportospusage("0")) {
    log(1,"This BYE message does not include OSP usage information\n");
  }
} else {
  log(1,"This BYE message is from DESTINATION\n");
  if (!reportospusage("1")) {
    log(1,"This BYE message does not include OSP usage information\n");
  }
}
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
        </div>
      </div>
      <div class="chapter" title="Chapter 2. Developer Guide">
        <div class="titlepage">
          <div>
            <div>
              <h2 class="title"><a id="idp237952"></a>Chapter 2. Developer Guide</h2>
            </div>
          </div>
        </div>
        <p>The functions of the OSP modules are not used by other Kamailio modules.</p>
      </div>
    </div>
  </body>
</html>
