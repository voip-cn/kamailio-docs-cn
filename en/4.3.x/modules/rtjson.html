<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>RTJSON Module</title>
    <link rel="stylesheet" type="text/css" href="../../../../css/sr-doc.css" tppabs="http://kamailio.org/css/sr-doc.css" />
    <meta name="generator" content="DocBook XSL Stylesheets V1.76.1" />
    <link rel="home" href="#idm15956720" title="RTJSON Module" />
    <link rel="next" href="#idp2587872" title="Chapter 1. Admin Guide" />
  </head>
  <body>
    <div class="book" title="RTJSON Module">
      <div class="titlepage">
        <div>
          <div>
            <h1 class="title"><a id="idm15956720"></a>RTJSON Module</h1>
          </div>
          <div>
            <div class="authorgroup">
              <div class="author">
                <h3 class="author"><span class="firstname">Daniel-Constantin</span> <span class="surname">Mierla</span></h3>
                <code class="email">&lt;<a class="email" href="mailto:miconda@gmail.com">miconda@gmail.com</a>&gt;</code>
              </div>
              <div class="editor">
                <h4 class="editedby">Edited by</h4>
                <h3 class="editor"><span class="firstname">Daniel-Constantin</span> <span class="surname">Mierla</span></h3>
                <code class="email">&lt;<a class="email" href="mailto:miconda@gmail.com">miconda@gmail.com</a>&gt;</code>
              </div>
            </div>
          </div>
          <div>
            <p class="copyright">Copyright © 2015 asipto.com</p>
          </div>
        </div>
        <hr />
      </div>
      <div class="toc">
        <p>
          <strong>Table of Contents</strong>
        </p>
        <dl>
          <dt>
            <span class="chapter">
              <a href="#idp2587872">1. Admin Guide</a>
            </span>
          </dt>
          <dd>
            <dl>
              <dt>
                <span class="section">
                  <a href="#idp2707528">1. Overview</a>
                </span>
              </dt>
              <dt>
                <span class="section">
                  <a href="#idp3412304">2. Dependencies</a>
                </span>
              </dt>
              <dd>
                <dl>
                  <dt>
                    <span class="section">
                      <a href="#idp3268416">2.1. Kamailio Modules</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#idp2039648">2.2. External Libraries or Applications</a>
                    </span>
                  </dt>
                </dl>
              </dd>
              <dt>
                <span class="section">
                  <a href="#idp1969872">3. Parameters</a>
                </span>
              </dt>
              <dd>
                <dl>
                  <dt>
                    <span class="section">
                      <a href="#rtjson.p.xavp_cfg">3.1. <code class="varname">xavp_cfg</code> (str)</a>
                    </span>
                  </dt>
                </dl>
              </dd>
              <dt>
                <span class="section">
                  <a href="#idp2606488">4. Functions</a>
                </span>
              </dt>
              <dd>
                <dl>
                  <dt>
                    <span class="section">
                      <a href="#rtjson.f.rtjson_init_routes">4.1. 
		<code class="function">rtjson_init_routes(rtdoc)</code>
	    </a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#rtjson.f.rtjson_push_routes">4.2. 
		<code class="function">rtjson_push_routes()</code>
	    </a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#rtjson.f.rtjson_next_route">4.3. 
		<code class="function">rtjson_next_route()</code>
	    </a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#rtjson.f.rtjson_update_branch">4.4. 
		<code class="function">rtjson_update_branch()</code>
	    </a>
                    </span>
                  </dt>
                </dl>
              </dd>
              <dt>
                <span class="section">
                  <a href="#rtjson.json-routing-structure">5. JSON Routing Structure</a>
                </span>
              </dt>
            </dl>
          </dd>
        </dl>
      </div>
      <div class="list-of-examples">
        <p>
          <strong>List of Examples</strong>
        </p>
        <dl>
          <dt>1.1. <a href="#idp2691928">Set <code class="varname">xavp_cfg</code> parameter</a></dt>
          <dt>1.2. <a href="#idp190752"><code class="function">rtjson_init_routes</code> usage</a></dt>
          <dt>1.3. <a href="#idp193360"><code class="function">rtjson_push_routes</code> usage</a></dt>
          <dt>1.4. <a href="#idp3006832"><code class="function">rtjson_next_route</code> usage</a></dt>
          <dt>1.5. <a href="#idp3009584"><code class="function">rtjson_update_branch</code> usage</a></dt>
          <dt>1.6. <a href="#idp3021256">JSON Routing Structure</a></dt>
        </dl>
      </div>
      <div class="chapter" title="Chapter 1. Admin Guide">
        <div class="titlepage">
          <div>
            <div>
              <h2 class="title"><a id="idp2587872"></a>Chapter 1. Admin Guide</h2>
            </div>
          </div>
        </div>
        <div class="toc">
          <p>
            <strong>Table of Contents</strong>
          </p>
          <dl>
            <dt>
              <span class="section">
                <a href="#idp2707528">1. Overview</a>
              </span>
            </dt>
            <dt>
              <span class="section">
                <a href="#idp3412304">2. Dependencies</a>
              </span>
            </dt>
            <dd>
              <dl>
                <dt>
                  <span class="section">
                    <a href="#idp3268416">2.1. Kamailio Modules</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#idp2039648">2.2. External Libraries or Applications</a>
                  </span>
                </dt>
              </dl>
            </dd>
            <dt>
              <span class="section">
                <a href="#idp1969872">3. Parameters</a>
              </span>
            </dt>
            <dd>
              <dl>
                <dt>
                  <span class="section">
                    <a href="#rtjson.p.xavp_cfg">3.1. <code class="varname">xavp_cfg</code> (str)</a>
                  </span>
                </dt>
              </dl>
            </dd>
            <dt>
              <span class="section">
                <a href="#idp2606488">4. Functions</a>
              </span>
            </dt>
            <dd>
              <dl>
                <dt>
                  <span class="section">
                    <a href="#rtjson.f.rtjson_init_routes">4.1. 
		<code class="function">rtjson_init_routes(rtdoc)</code>
	    </a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#rtjson.f.rtjson_push_routes">4.2. 
		<code class="function">rtjson_push_routes()</code>
	    </a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#rtjson.f.rtjson_next_route">4.3. 
		<code class="function">rtjson_next_route()</code>
	    </a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#rtjson.f.rtjson_update_branch">4.4. 
		<code class="function">rtjson_update_branch()</code>
	    </a>
                  </span>
                </dt>
              </dl>
            </dd>
            <dt>
              <span class="section">
                <a href="#rtjson.json-routing-structure">5. JSON Routing Structure</a>
              </span>
            </dt>
          </dl>
        </div>
        <div class="section" title="1. Overview">
          <div class="titlepage">
            <div>
              <div>
                <h2 class="title"><a id="idp2707528"></a>1. Overview</h2>
              </div>
            </div>
          </div>
          <p>
		This module facilitates SIP routing based on JSON specifications.
	</p>
          <p>
		The values for R-URI ($ru), outbound proxy ($du) and other attributes
		used for SIP routing can be retrieved in a JSON document. It is able
		to process attributes for more than one destination and prepare for
		routing in serial or parallel fashion.
	</p>
        </div>
        <div class="section" title="2. Dependencies">
          <div class="titlepage">
            <div>
              <div>
                <h2 class="title"><a id="idp3412304"></a>2. Dependencies</h2>
              </div>
            </div>
          </div>
          <div class="section" title="2.1. Kamailio Modules">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="idp3268416"></a>2.1. Kamailio Modules</h3>
                </div>
              </div>
            </div>
            <p>
		The following modules must be loaded before this module:
			</p>
            <div class="itemizedlist">
              <ul class="itemizedlist">
                <li class="listitem">
                  <p>
				<span class="emphasis"><em>tm</em></span> - (optional) transaction management.
			</p>
                  <p>
				<span class="emphasis"><em>uac</em></span> - (optional) user agent operations.
			</p>
                </li>
              </ul>
            </div>
            <p>
		</p>
          </div>
          <div class="section" title="2.2. External Libraries or Applications">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="idp2039648"></a>2.2. External Libraries or Applications</h3>
                </div>
              </div>
            </div>
            <p>
		The following libraries or applications must be installed before running
		Kamailio with this module loaded:
			</p>
            <div class="itemizedlist">
              <ul class="itemizedlist">
                <li class="listitem">
                  <p>
				<span class="emphasis"><em>None</em></span>
			</p>
                </li>
              </ul>
            </div>
            <p>
		</p>
          </div>
        </div>
        <div class="section" title="3. Parameters">
          <div class="titlepage">
            <div>
              <div>
                <h2 class="title"><a id="idp1969872"></a>3. Parameters</h2>
              </div>
            </div>
          </div>
          <div class="section" title="3.1. xavp_cfg (str)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="rtjson.p.xavp_cfg"></a>3.1. <code class="varname">xavp_cfg</code> (str)</h3>
                </div>
              </div>
            </div>
            <p>
			The name of the xavp to be used internally by the module. 
		</p>
            <p>
		<span class="emphasis"><em>
			Default value is "rtjson".
		</em></span>
		</p>
            <div class="example">
              <a id="idp2691928"></a>
              <p class="title">
                <strong>Example 1.1. Set <code class="varname">xavp_cfg</code> parameter</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
modparam("rtjson", "xavp_cfg", "myxavp")
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
        </div>
        <div class="section" title="4. Functions">
          <div class="titlepage">
            <div>
              <div>
                <h2 class="title"><a id="idp2606488"></a>4. Functions</h2>
              </div>
            </div>
          </div>
          <div class="section" title="4.1.  rtjson_init_routes(rtdoc)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="rtjson.f.rtjson_init_routes"></a>4.1. 
		<code class="function">rtjson_init_routes(rtdoc)</code>
	    </h3>
                </div>
              </div>
            </div>
            <p>
		Initialize routing based on JSON document stored in rtdoc parameter.
		</p>
            <p>
		The rtdoc parameter can be a static string or a dynamic string
		value with config variables. It has to result in a valid JSON document
		with the structure specified in chapter 'JSON Routing Structure'.
		</p>
            <p>
		This function can be used from REQUEST_ROUTE.
		</p>
            <div class="example">
              <a id="idp190752"></a>
              <p class="title">
                <strong>Example 1.2. <code class="function">rtjson_init_routes</code> usage</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
rtjson_init_routes("$var(json)");
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="4.2.  rtjson_push_routes()">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="rtjson.f.rtjson_push_routes"></a>4.2. 
		<code class="function">rtjson_push_routes()</code>
	    </h3>
                </div>
              </div>
            </div>
            <p>
		Push the routes given in JSON document to rtjson_init_routes(rtdoc) to
		the internal fields used by Kamailio for routing.
		</p>
            <p>
		This function can be used from REQUEST_ROUTE.
		</p>
            <div class="example">
              <a id="idp193360"></a>
              <p class="title">
                <strong>Example 1.3. <code class="function">rtjson_push_routes</code> usage</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
rtjson_init_routes("$var(json)");
rtjson_push_routes();
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="4.3.  rtjson_next_route()">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="rtjson.f.rtjson_next_route"></a>4.3. 
		<code class="function">rtjson_next_route()</code>
	    </h3>
                </div>
              </div>
            </div>
            <p>
		To be used in failure_route for serial forking, to push the next route
		to the internal fields used by Kamailio for routing.
		</p>
            <p>
		This function can be used from FAILURE_ROUTE.
		</p>
            <div class="example">
              <a id="idp3006832"></a>
              <p class="title">
                <strong>Example 1.4. <code class="function">rtjson_next_route</code> usage</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
rtjson_init_routes("$var(json)");
rtjson_push_routes();
t_on_failure("REROUTE");
t_relay();
...
failure_route[REROUTE] {
	rtjson_next_route();
}
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="4.4.  rtjson_update_branch()">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="rtjson.f.rtjson_update_branch"></a>4.4. 
		<code class="function">rtjson_update_branch()</code>
	    </h3>
                </div>
              </div>
            </div>
            <p>
		To be used in branch_route if the JSON document had attributes
		that needs to be set for each branch.
		</p>
            <p>
		This function can be used from BRANCH_ROUTE.
		</p>
            <div class="example">
              <a id="idp3009584"></a>
              <p class="title">
                <strong>Example 1.5. <code class="function">rtjson_update_branch</code> usage</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
rtjson_init_routes("$var(json)");
rtjson_push_routes();
t_on_branch("OUTGOING");
t_relay();
...
branch_route[OUTGOING] {
	rtjson_update_branch();
}
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
        </div>
        <div class="section" title="5. JSON Routing Structure">
          <div class="titlepage">
            <div>
              <div>
                <h2 class="title"><a id="rtjson.json-routing-structure"></a>5. JSON Routing Structure</h2>
              </div>
            </div>
          </div>
          <p>
		The format of the JSON document containing routing information.
	</p>
          <p>
		Description of the fields in the JSON routing document:
			</p>
          <div class="itemizedlist">
            <ul class="itemizedlist">
              <li class="listitem">
                <p>
				<span class="emphasis"><em>version</em></span> - intended to enforce versioning
				checks (not enforced yet), recommended to be set to "1.0".
			</p>
              </li>
              <li class="listitem">
                <p>
				<span class="emphasis"><em>routing</em></span> - can be "serial" or "parallel",
				corresponding to desired routing type: serial or parallel forking.
			</p>
              </li>
              <li class="listitem">
                <p>
				<span class="emphasis"><em>routes</em></span> - an array with structures holding
				the attributes for destinations. The attributes can be:
				</p>
                <div class="itemizedlist">
                  <ul class="itemizedlist">
                    <li class="listitem">
                      <p>
					<span class="emphasis"><em>uri</em></span> - request URI
				</p>
                    </li>
                    <li class="listitem">
                      <p>
					<span class="emphasis"><em>dst_uri</em></span> - outbound proxy URI
				</p>
                    </li>
                    <li class="listitem">
                      <p>
					<span class="emphasis"><em>path</em></span> - Path URI vector
				</p>
                    </li>
                    <li class="listitem">
                      <p>
					<span class="emphasis"><em>socket</em></span> - local socket
				</p>
                    </li>
                    <li class="listitem">
                      <p>
					<span class="emphasis"><em>headers</em></span> - a structure with values for headers
					From and To specified as display name and URI, plus extra
					headers to be appended to SIP request. It requires uac module in
					order to update From and To headers.
					Set by rtjson_update_branch() only for serial routing.
				</p>
                    </li>
                    <li class="listitem">
                      <p>
					<span class="emphasis"><em>branch_flags</em></span> - branch flags.
					Set by rtjson_update_branch() only for serial routing.
				</p>
                    </li>
                    <li class="listitem">
                      <p>
					<span class="emphasis"><em>fr_timer</em></span> - value for fr_timer parameter of
					tm module.
					Set by rtjson_update_branch() only for serial routing.
				</p>
                    </li>
                    <li class="listitem">
                      <p>
					<span class="emphasis"><em>fr_inv_timer</em></span> - value for fr_inv_timer parameter
					of tm module.
					Set by rtjson_update_branch() only for serial routing.
				</p>
                    </li>
                  </ul>
                </div>
                <p>
			</p>
              </li>
            </ul>
          </div>
          <p>
	</p>
          <p>
		Other fields can appear in the JSON routing document, being ignored
		by rtjson functions. They can be processed directly in the configuration
		files using json or jansson modules. For example, the document can include
		the transaction identification tuple (index,label) that can be used
		to resume the execution of a suspended transaction.
	</p>
          <div class="example">
            <a id="idp3021256"></a>
            <p class="title">
              <strong>Example 1.6. JSON Routing Structure</strong>
            </p>
            <div class="example-contents">
              <pre class="programlisting">...
{
	"version": "1.0",
	"routing": "serial",
	"routes": [
		{
			"uri": "sip:127.0.0.1:5080",
			"dst_uri": "sip:127.0.0.1:5082",
			"path": "&lt;sip:127.0.0.1:5084&gt;, &lt;sip:127.0.0.1:5086&gt;",
			"socket": "udp:127.0.0.1:5060",
			"headers": {
				"from": {
					"display": "Alice",
					"uri": "sip:alice@127.0.0.1"
				},
				"to": {
					"display": "Alice",
					"uri": "sip:alice@127.0.0.1"
				},
				"extra": "X-Hdr-A: abc\r\nX-Hdr-B: bcd\r\n"
			},
			"branch_flags": 8,
			"fr_timer": 5000,
			"fr_inv_timer": 30000
		},
		{
			"uri": "sip:127.0.0.1:5080",
			"dst_uri": "sip:127.0.0.1:5082",
			"path": "&lt;sip:127.0.0.1:5084&gt;, &lt;sip:127.0.0.1:5086&gt;",
			"socket": "udp:127.0.0.1:5060",
			"headers": {
				"from": {
					"display": "Alice",
					"uri": "sip:alice@127.0.0.1"
				},
				"to": {
					"display": "Alice",
					"uri": "sip:alice@127.0.0.1"
				},
				"extra": "X-Hdr-A: abc\r\nX-Hdr-B: bcd\r\n"
			},
			"branch_flags": 8,
			"fr_timer": 5000,
			"fr_inv_timer": 30000
		}
	]
}
...</pre>
            </div>
          </div>
          <br class="example-break" />
        </div>
      </div>
    </div>
  </body>
</html>
