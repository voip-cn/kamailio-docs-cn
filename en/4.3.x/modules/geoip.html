<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>geoip Module</title>
    <link rel="stylesheet" type="text/css" href="../../../../css/sr-doc.css" tppabs="http://kamailio.org/css/sr-doc.css" />
    <meta name="generator" content="DocBook XSL Stylesheets V1.76.1" />
    <link rel="home" href="#idm4261064" title="geoip Module" />
    <link rel="next" href="#idp1673352" title="Chapter¬†1.¬†Admin Guide" />
  </head>
  <body>
    <div class="book" title="geoip Module">
      <div class="titlepage">
        <div>
          <div>
            <h1 class="title"><a id="idm4261064"></a>geoip Module</h1>
          </div>
          <div>
            <div class="authorgroup">
              <div class="author">
                <h3 class="author"><span class="firstname">Daniel-Constantin</span> <span class="surname">Mierla</span></h3>
                <div class="affiliation">
                  <span class="orgname">asipto.com<br /></span>
                </div>
              </div>
              <div class="editor">
                <h4 class="editedby">Edited by</h4>
                <h3 class="editor"><span class="firstname">Daniel-Constantin</span> <span class="surname">Mierla</span></h3>
                <code class="email">&lt;<a class="email" href="mailto:miconda@gmail.com">miconda@gmail.com</a>&gt;</code>
              </div>
              <div class="editor">
                <h4 class="editedby">Edited by</h4>
                <h3 class="editor"><span class="firstname">Alex</span> <span class="surname">Balashov</span></h3>
                <div class="affiliation">
                  <span class="orgname">Evariste Systems LLC<br /></span>
                </div>
                <code class="email">&lt;<a class="email" href="mailto:abalashov@evaristesys.com">abalashov@evaristesys.com</a>&gt;</code>
              </div>
            </div>
          </div>
          <div>
            <p class="copyright">Copyright ¬© 2010 Daniel-Constantin Mierla (asipto.com)</p>
          </div>
        </div>
        <hr />
      </div>
      <div class="toc">
        <p>
          <strong>Table of Contents</strong>
        </p>
        <dl>
          <dt>
            <span class="chapter">
              <a href="#idp1673352">1. Admin Guide</a>
            </span>
          </dt>
          <dd>
            <dl>
              <dt>
                <span class="section">
                  <a href="#idp2739480">1. Overview</a>
                </span>
              </dt>
              <dt>
                <span class="section">
                  <a href="#idp1592608">2. Dependencies</a>
                </span>
              </dt>
              <dd>
                <dl>
                  <dt>
                    <span class="section">
                      <a href="#idp2577384">2.1. Kamailio Modules</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#idp2062608">2.2. External Libraries or Applications</a>
                    </span>
                  </dt>
                </dl>
              </dd>
              <dt>
                <span class="section">
                  <a href="#idp2617488">3. Parameters</a>
                </span>
              </dt>
              <dd>
                <dl>
                  <dt>
                    <span class="section">
                      <a href="#idp2514816">3.1. <code class="varname">path</code> (string)</a>
                    </span>
                  </dt>
                </dl>
              </dd>
              <dt>
                <span class="section">
                  <a href="#idp214200">4. Functions</a>
                </span>
              </dt>
              <dd>
                <dl>
                  <dt>
                    <span class="section">
                      <a href="#idp214568">4.1. 
		<code class="function">geoip_match(ipaddr, pvc)</code>
	    </a>
                    </span>
                  </dt>
                </dl>
              </dd>
              <dt>
                <span class="section">
                  <a href="#idp217000">5. Exported pseudo-variables</a>
                </span>
              </dt>
            </dl>
          </dd>
        </dl>
      </div>
      <div class="list-of-examples">
        <p>
          <strong>List of Examples</strong>
        </p>
        <dl>
          <dt>1.1. <a href="#idm20472">Set <code class="varname">path</code> parameter</a></dt>
          <dt>1.2. <a href="#idp215648"><code class="function">geoip_match</code> usage</a></dt>
        </dl>
      </div>
      <div class="chapter" title="Chapter¬†1.¬†Admin Guide">
        <div class="titlepage">
          <div>
            <div>
              <h2 class="title"><a id="idp1673352"></a>Chapter¬†1.¬†Admin Guide</h2>
            </div>
          </div>
        </div>
        <div class="toc">
          <p>
            <strong>Table of Contents</strong>
          </p>
          <dl>
            <dt>
              <span class="section">
                <a href="#idp2739480">1. Overview</a>
              </span>
            </dt>
            <dt>
              <span class="section">
                <a href="#idp1592608">2. Dependencies</a>
              </span>
            </dt>
            <dd>
              <dl>
                <dt>
                  <span class="section">
                    <a href="#idp2577384">2.1. Kamailio Modules</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#idp2062608">2.2. External Libraries or Applications</a>
                  </span>
                </dt>
              </dl>
            </dd>
            <dt>
              <span class="section">
                <a href="#idp2617488">3. Parameters</a>
              </span>
            </dt>
            <dd>
              <dl>
                <dt>
                  <span class="section">
                    <a href="#idp2514816">3.1. <code class="varname">path</code> (string)</a>
                  </span>
                </dt>
              </dl>
            </dd>
            <dt>
              <span class="section">
                <a href="#idp214200">4. Functions</a>
              </span>
            </dt>
            <dd>
              <dl>
                <dt>
                  <span class="section">
                    <a href="#idp214568">4.1. 
		<code class="function">geoip_match(ipaddr, pvc)</code>
	    </a>
                  </span>
                </dt>
              </dl>
            </dd>
            <dt>
              <span class="section">
                <a href="#idp217000">5. Exported pseudo-variables</a>
              </span>
            </dt>
          </dl>
        </div>
        <div class="section" title="1.¬†Overview">
          <div class="titlepage">
            <div>
              <div>
                <h2 class="title"><a id="idp2739480"></a>1.¬†Overview</h2>
              </div>
            </div>
          </div>
          <p>
		This module allows real-time queries against the Max Mind GeoIP 
		database to be performed from the config script. It uses the old
		version of API, still very common on OS distributions. For using
		the new version of GeoIP API, see geoip2 module.
	</p>
          <p>
		The Max Mind GeoIP database is a map of IP network address assignments 
		to geographical locales that can be useful -- though approximate --
		in identifying the physical location with which an IP host address
		is associated on a relatively granular level.
	</p>
          <p>
		This database itself can be obtained on a free or commercial basis 
		from <a class="ulink" href="javascript:if(confirm('http://www.maxmind.com/app/ip-location  \n\n∏√Œƒº˛Œﬁ∑®”√ Teleport Ultra œ¬‘ÿ, “ÚŒ™ À¸ «“ª∏ˆ”ÚªÚ¬∑æ∂Õ‚≤ø±ª…Ë÷√Œ™À¸µƒ∆Ù ºµÿ÷∑µƒµÿ÷∑°£  \n\nƒ„œÎ‘⁄∑˛ŒÒ∆˜…œ¥Úø™À¸?'))window.location='http://www.maxmind.com/app/ip-location'" tppabs="http://www.maxmind.com/app/ip-location">
		http://www.maxmind.com/app/ip-location</a>. The 
		library that interfaces with the Max Mind API, as well as scripts to
		automate downloading of the on-disk version of the open-source 
		database is also packaged by the Debian Linux distribution and 
		its derivatives as <span class="emphasis"><em>libgeoip</em></span>, and probably by
		other distributions as well.
	</p>
          <p>
		Debian Linux squeeze includes already a database as dependency, but as
		this contain the wrong data, it will not work correctly with the module.
		More acurate, the module expect the <span class="emphasis"><em>GeoIP City Edition</em></span>,
		and will not work with the <span class="emphasis"><em>GeoIP Country Edition</em></span>. In
		newer Debian Linux releases the package <span class="emphasis"><em>geoip-database-contrib</em></span>
		should contain the necessary database. You can download the Lite edition
		of the DB from <a class="ulink" href="javascript:if(confirm('http://www.maxmind.com/app/geolitecity  \n\n∏√Œƒº˛Œﬁ∑®”√ Teleport Ultra œ¬‘ÿ, “ÚŒ™ À¸ «“ª∏ˆ”ÚªÚ¬∑æ∂Õ‚≤ø±ª…Ë÷√Œ™À¸µƒ∆Ù ºµÿ÷∑µƒµÿ÷∑°£  \n\nƒ„œÎ‘⁄∑˛ŒÒ∆˜…œ¥Úø™À¸?'))window.location='http://www.maxmind.com/app/geolitecity'" tppabs="http://www.maxmind.com/app/geolitecity">
		http://www.maxmind.com/app/geolitecity</a>.
	</p>
          <p>
		This module exports a new class of pseudo-variables -
		$gip(pvc=&gt;key) - to enable access to the results of a query to the
		database.
	</p>
          <p>
		Many queries can be done and store results in different containers to
		be able to use in parallel. Database is loaded at startup in cache.
	</p>
        </div>
        <div class="section" title="2.¬†Dependencies">
          <div class="titlepage">
            <div>
              <div>
                <h2 class="title"><a id="idp1592608"></a>2.¬†Dependencies</h2>
              </div>
            </div>
          </div>
          <div class="section" title="2.1.¬†Kamailio Modules">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="idp2577384"></a>2.1.¬†Kamailio Modules</h3>
                </div>
              </div>
            </div>
            <p>
		The following modules must be loaded before this module:
	    	</p>
            <div class="itemizedlist">
              <ul class="itemizedlist">
                <li class="listitem">
                  <p>
			    <span class="emphasis"><em>none</em></span>.
			</p>
                </li>
              </ul>
            </div>
            <p>
	    </p>
          </div>
          <div class="section" title="2.2.¬†External Libraries or Applications">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="idp2062608"></a>2.2.¬†External Libraries or Applications</h3>
                </div>
              </div>
            </div>
            <p>
		The following libraries or applications must be installed before running
		Kamailio with this module loaded:
	    	</p>
            <div class="itemizedlist">
              <ul class="itemizedlist">
                <li class="listitem">
                  <p>
			    <span class="emphasis"><em>libgeoip</em></span> - the GeoIP library.
			</p>
                </li>
              </ul>
            </div>
            <p>
	    </p>
          </div>
        </div>
        <div class="section" title="3.¬†Parameters">
          <div class="titlepage">
            <div>
              <div>
                <h2 class="title"><a id="idp2617488"></a>3.¬†Parameters</h2>
              </div>
            </div>
          </div>
          <div class="section" title="3.1.¬†path (string)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="idp2514816"></a>3.1.¬†<code class="varname">path</code> (string)</h3>
                </div>
              </div>
            </div>
            <p>
		Path to the GeoIP database file.
	    </p>
            <p>
		<span class="emphasis"><em>
		    Default value is <span class="quote">‚Äú<span class="quote">null</span>‚Äù</span>.
		</em></span>
	    </p>
            <div class="example">
              <a id="idm20472"></a>
              <p class="title">
                <strong>Example¬†1.1.¬†Set <code class="varname">path</code> parameter</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
modparam("geoip", "path", "/usr/local/share/GeoLiteCity.dat")
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
        </div>
        <div class="section" title="4.¬†Functions">
          <div class="titlepage">
            <div>
              <div>
                <h2 class="title"><a id="idp214200"></a>4.¬†Functions</h2>
              </div>
            </div>
          </div>
          <div class="section" title="4.1.¬† geoip_match(ipaddr, pvc)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="idp214568"></a>4.1.¬†
		<code class="function">geoip_match(ipaddr, pvc)</code>
	    </h3>
                </div>
              </div>
            </div>
            <p>
			Match ipaddr against the GeoIP database and set the pvc container. The
			function has to be called before accessing a key via: $gip(pvc=&gt;key).
	    </p>
            <div class="example">
              <a id="idp215648"></a>
              <p class="title">
                <strong>Example¬†1.2.¬†<code class="function">geoip_match</code> usage</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
if(geoip_match("$si", "src"))
    xlog("SIP message from: $gip(src=&gt;cc)\n");
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
        </div>
        <div class="section" title="5.¬†Exported pseudo-variables">
          <div class="titlepage">
            <div>
              <div>
                <h2 class="title"><a id="idp217000"></a>5.¬†Exported pseudo-variables</h2>
              </div>
            </div>
          </div>
          <div class="itemizedlist">
            <ul class="itemizedlist">
              <li class="listitem">
                <p>
				<span class="emphasis"><em>$gip(pvc=&gt;key)</em></span> - <span class="emphasis"><em>pvc</em></span> is an 
				identifier for this query result;  it is designated by the second 
				parameter of geoip_match(). The <span class="emphasis"><em>key</em></span> can be one of
				the following:
				</p>
                <div class="itemizedlist">
                  <ul class="itemizedlist">
                    <li class="listitem">
                      <p>
					<span class="emphasis"><em>cc</em></span> - country code
				</p>
                    </li>
                    <li class="listitem">
                      <p>
					<span class="emphasis"><em>tz</em></span> - time zone
				</p>
                    </li>
                    <li class="listitem">
                      <p>
					<span class="emphasis"><em>zip</em></span> - postal code
				</p>
                    </li>
                    <li class="listitem">
                      <p>
					<span class="emphasis"><em>lat</em></span> - latitude
				</p>
                    </li>
                    <li class="listitem">
                      <p>
					<span class="emphasis"><em>lon</em></span> - longitude
				</p>
                    </li>
                    <li class="listitem">
                      <p>
					<span class="emphasis"><em>dma</em></span> - dma code
				</p>
                    </li>
                    <li class="listitem">
                      <p>
					<span class="emphasis"><em>ips</em></span> - ip start
				</p>
                    </li>
                    <li class="listitem">
                      <p>
					<span class="emphasis"><em>ipe</em></span> - ip end
				</p>
                    </li>
                    <li class="listitem">
                      <p>
					<span class="emphasis"><em>city</em></span> - city
				</p>
                    </li>
                    <li class="listitem">
                      <p>
					<span class="emphasis"><em>area</em></span> - area code
				</p>
                    </li>
                    <li class="listitem">
                      <p>
					<span class="emphasis"><em>regc</em></span> - region
				</p>
                    </li>
                    <li class="listitem">
                      <p>
					<span class="emphasis"><em>regn</em></span> - region name
				</p>
                    </li>
                    <li class="listitem">
                      <p>
					<span class="emphasis"><em>metro</em></span> - metro code
				</p>
                    </li>
                    <li class="listitem">
                      <p>
					<span class="emphasis"><em>contc</em></span> - continent code
				</p>
                    </li>
                  </ul>
                </div>
              </li>
            </ul>
          </div>
          <p>
		Exported pseudo-variables are documented at <a class="ulink" href="javascript:if(confirm('http://www.kamailio.org/wiki/  \n\n∏√Œƒº˛Œﬁ∑®”√ Teleport Ultra œ¬‘ÿ, “ÚŒ™ À¸ «“ª∏ˆ”ÚªÚ¬∑æ∂Õ‚≤ø±ª…Ë÷√Œ™À¸µƒ∆Ù ºµÿ÷∑µƒµÿ÷∑°£  \n\nƒ„œÎ‘⁄∑˛ŒÒ∆˜…œ¥Úø™À¸?'))window.location='http://www.kamailio.org/wiki/'" tppabs="http://www.kamailio.org/wiki/">http://www.kamailio.org/wiki/</a>.
		</p>
        </div>
      </div>
    </div>
  </body>
</html>
