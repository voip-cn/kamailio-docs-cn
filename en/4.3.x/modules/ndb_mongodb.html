<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>NDB_MONGODB Module</title>
    <link rel="stylesheet" type="text/css" href="../../../../css/sr-doc.css" tppabs="http://kamailio.org/css/sr-doc.css" />
    <meta name="generator" content="DocBook XSL Stylesheets V1.76.1" />
    <link rel="home" href="#idp3704" title="NDB_MONGODB Module" />
    <link rel="next" href="#idp2148976" title="Chapter1.Admin Guide" />
  </head>
  <body>
    <div class="book" title="NDB_MONGODB Module">
      <div class="titlepage">
        <div>
          <div>
            <h1 class="title"><a id="idp3704"></a>NDB_MONGODB Module</h1>
          </div>
          <div>
            <div class="authorgroup">
              <div class="author">
                <h3 class="author"><span class="firstname">Daniel-Constantin</span> <span class="surname">Mierla</span></h3>
                <code class="email">&lt;<a class="email" href="mailto:miconda@gmail.com">miconda@gmail.com</a>&gt;</code>
              </div>
              <div class="editor">
                <h4 class="editedby">Edited by</h4>
                <h3 class="editor"><span class="firstname">Daniel-Constantin</span> <span class="surname">Mierla</span></h3>
                <code class="email">&lt;<a class="email" href="mailto:miconda@gmail.com">miconda@gmail.com</a>&gt;</code>
              </div>
            </div>
          </div>
          <div>
            <p class="copyright">Copyright 漏 2014 asipto.com</p>
          </div>
        </div>
        <hr />
      </div>
      <div class="toc">
        <p>
          <strong>Table of Contents</strong>
        </p>
        <dl>
          <dt>
            <span class="chapter">
              <a href="#idp2148976">1. Admin Guide</a>
            </span>
          </dt>
          <dd>
            <dl>
              <dt>
                <span class="section">
                  <a href="#idp3062880">1. Overview</a>
                </span>
              </dt>
              <dt>
                <span class="section">
                  <a href="#idp3103200">2. Dependencies</a>
                </span>
              </dt>
              <dd>
                <dl>
                  <dt>
                    <span class="section">
                      <a href="#idp2043408">2.1. Kamailio Modules</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#idp2537432">2.2. External Libraries or Applications</a>
                    </span>
                  </dt>
                </dl>
              </dd>
              <dt>
                <span class="section">
                  <a href="#idp2514576">3. Parameters</a>
                </span>
              </dt>
              <dd>
                <dl>
                  <dt>
                    <span class="section">
                      <a href="#ndb_mongodb.p.server">3.1. <code class="varname">server</code> (str)</a>
                    </span>
                  </dt>
                </dl>
              </dd>
              <dt>
                <span class="section">
                  <a href="#idp2954424">4. Functions</a>
                </span>
              </dt>
              <dd>
                <dl>
                  <dt>
                    <span class="section">
                      <a href="#ndb_mongodb.f.mongodb_cmd">4.1. 
		<code class="function">mongodb_cmd(srvname, dbname, cname, command, replyid)</code>
	    </a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#ndb_mongodb.f.mongodb_cmd_simple">4.2. 
		<code class="function">mongodb_cmd_simple(srvname, dbname, cname, command, replyid)</code>
	    </a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#ndb_mongodb.f.mongodb_find">4.3. 
		<code class="function">mongodb_find(srvname, dbname, cname, command, replyid)</code>
	    </a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#ndb_mongodb.f.mongodb_find_one">4.4. 
		<code class="function">mongodb_find_one(srvname, dbname, cname, command, replyid)</code>
	    </a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#ndb_mongodb.f.mongodb_next">4.5. 
		<code class="function">mongodb_next(replyid)</code>
	</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#ndb_mongodb.f.mongodb_free">4.6. 
		<code class="function">mongodb_free(replyid)</code>
	</a>
                    </span>
                  </dt>
                </dl>
              </dd>
            </dl>
          </dd>
        </dl>
      </div>
      <div class="list-of-examples">
        <p>
          <strong>List of Examples</strong>
        </p>
        <dl>
          <dt>1.1. <a href="#idp2574504">Set <code class="varname">server</code> parameter</a></dt>
          <dt>1.2. <a href="#idp1376616"><code class="function">mongodb_cmd</code> usage</a></dt>
          <dt>1.3. <a href="#idp1380632"><code class="function">mongodb_cmd_simple</code> usage</a></dt>
          <dt>1.4. <a href="#idp1384752"><code class="function">mongodb_find</code> usage</a></dt>
          <dt>1.5. <a href="#idp1387784"><code class="function">mongodb_find_one</code> usage</a></dt>
          <dt>1.6. <a href="#idp1390424"><code class="function">mongodb_next</code> usage</a></dt>
          <dt>1.7. <a href="#idm15000"><code class="function">mongodb_free</code> usage</a></dt>
        </dl>
      </div>
      <div class="chapter" title="Chapter1.Admin Guide">
        <div class="titlepage">
          <div>
            <div>
              <h2 class="title"><a id="idp2148976"></a>Chapter1.Admin Guide</h2>
            </div>
          </div>
        </div>
        <div class="toc">
          <p>
            <strong>Table of Contents</strong>
          </p>
          <dl>
            <dt>
              <span class="section">
                <a href="#idp3062880">1. Overview</a>
              </span>
            </dt>
            <dt>
              <span class="section">
                <a href="#idp3103200">2. Dependencies</a>
              </span>
            </dt>
            <dd>
              <dl>
                <dt>
                  <span class="section">
                    <a href="#idp2043408">2.1. Kamailio Modules</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#idp2537432">2.2. External Libraries or Applications</a>
                  </span>
                </dt>
              </dl>
            </dd>
            <dt>
              <span class="section">
                <a href="#idp2514576">3. Parameters</a>
              </span>
            </dt>
            <dd>
              <dl>
                <dt>
                  <span class="section">
                    <a href="#ndb_mongodb.p.server">3.1. <code class="varname">server</code> (str)</a>
                  </span>
                </dt>
              </dl>
            </dd>
            <dt>
              <span class="section">
                <a href="#idp2954424">4. Functions</a>
              </span>
            </dt>
            <dd>
              <dl>
                <dt>
                  <span class="section">
                    <a href="#ndb_mongodb.f.mongodb_cmd">4.1. 
		<code class="function">mongodb_cmd(srvname, dbname, cname, command, replyid)</code>
	    </a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#ndb_mongodb.f.mongodb_cmd_simple">4.2. 
		<code class="function">mongodb_cmd_simple(srvname, dbname, cname, command, replyid)</code>
	    </a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#ndb_mongodb.f.mongodb_find">4.3. 
		<code class="function">mongodb_find(srvname, dbname, cname, command, replyid)</code>
	    </a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#ndb_mongodb.f.mongodb_find_one">4.4. 
		<code class="function">mongodb_find_one(srvname, dbname, cname, command, replyid)</code>
	    </a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#ndb_mongodb.f.mongodb_next">4.5. 
		<code class="function">mongodb_next(replyid)</code>
	</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#ndb_mongodb.f.mongodb_free">4.6. 
		<code class="function">mongodb_free(replyid)</code>
	</a>
                  </span>
                </dt>
              </dl>
            </dd>
          </dl>
        </div>
        <div class="section" title="1.Overview">
          <div class="titlepage">
            <div>
              <div>
                <h2 class="title"><a id="idp3062880"></a>1.Overview</h2>
              </div>
            </div>
          </div>
          <p>
		This module provides a non-db connector to interact with MongoDB NoSQL
		server from configuration file. You can read more about MongoDB at
		<a class="ulink" href="javascript:if(confirm('http://www.mongodb.org/  \n\n该文件无法用 Teleport Ultra 下载, 因为 它是一个域或路径外部被设置为它的启始地址的地址。  \n\n你想在服务器上打开它?'))window.location='http://www.mongodb.org/'" tppabs="http://www.mongodb.org/">http://www.mongodb.org</a>.
	</p>
          <p>
		It can connect to many MongoDB servers and store the results in different
		containers.
	</p>
        </div>
        <div class="section" title="2.Dependencies">
          <div class="titlepage">
            <div>
              <div>
                <h2 class="title"><a id="idp3103200"></a>2.Dependencies</h2>
              </div>
            </div>
          </div>
          <div class="section" title="2.1.Kamailio Modules">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="idp2043408"></a>2.1.Kamailio Modules</h3>
                </div>
              </div>
            </div>
            <p>
		The following modules must be loaded before this module:
			</p>
            <div class="itemizedlist">
              <ul class="itemizedlist">
                <li class="listitem">
                  <p>
				<span class="emphasis"><em>none</em></span>.
			</p>
                </li>
              </ul>
            </div>
            <p>
		</p>
          </div>
          <div class="section" title="2.2.External Libraries or Applications">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="idp2537432"></a>2.2.External Libraries or Applications</h3>
                </div>
              </div>
            </div>
            <p>
		The following libraries or applications must be installed before running
		Kamailio with this module loaded:
			</p>
            <div class="itemizedlist">
              <ul class="itemizedlist">
                <li class="listitem">
                  <p>
				<span class="emphasis"><em>mongo-c-driver</em></span> - available at
				<a class="ulink" href="javascript:if(confirm('https://github.com/mongodb/mongo-c-driver  \n\n该文件无法用 Teleport Ultra 下载, 因为 它是一个域或路径外部被设置为它的启始地址的地址。  \n\n你想在服务器上打开它?'))window.location='https://github.com/mongodb/mongo-c-driver'" tppabs="https://github.com/mongodb/mongo-c-driver">https://github.com/mongodb/mongo-c-driver</a>
			</p>
                </li>
              </ul>
            </div>
            <p>
		</p>
          </div>
        </div>
        <div class="section" title="3.Parameters">
          <div class="titlepage">
            <div>
              <div>
                <h2 class="title"><a id="idp2514576"></a>3.Parameters</h2>
              </div>
            </div>
          </div>
          <div class="section" title="3.1.server (str)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="ndb_mongodb.p.server"></a>3.1.<code class="varname">server</code> (str)</h3>
                </div>
              </div>
            </div>
            <p>
			Specify the details to connect to REDIS server. It takes a list of
			attribute=value separated by semicolon, the attributes can be
			name and uri. Name is a generic identifier to be used
			with module functions. The uri parameter must be a valid
			MongoDB database connection string.
		</p>
            <p>
			You can set this parameter many times, in case you want to connect to
			many MongoDB servers, just give different attributes and use the specific
			server name when querying the MongoDB instance.
		</p>
            <p>
		<span class="emphasis"><em>
			Default value is NULL.
		</em></span>
		</p>
            <div class="example">
              <a id="idp2574504"></a>
              <p class="title">
                <strong>Example1.1.Set <code class="varname">server</code> parameter</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
modparam("ndb_mongodb", "server", "name=mgs1;uri='mongodb://localhost/kamailio'")
modparam("ndb_mongodb", "server", "name=mgs2;uri='mongodb://127.0.0.2/kamailio'")
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
        </div>
        <div class="section" title="4.Functions">
          <div class="titlepage">
            <div>
              <div>
                <h2 class="title"><a id="idp2954424"></a>4.Functions</h2>
              </div>
            </div>
          </div>
          <div class="section" title="4.1. mongodb_cmd(srvname, dbname, cname, command, replyid)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="ndb_mongodb.f.mongodb_cmd"></a>4.1.
		<code class="function">mongodb_cmd(srvname, dbname, cname, command, replyid)</code>
	    </h3>
                </div>
              </div>
            </div>
            <p>
			Send a valid command to MongoDB server identified by srvname. The reply will
			be stored in a local container identified by replyid. All the
			parameters can be strings with pseudo-variables that are evaluated
			at runtime.
		</p>
            <p>
			The reply can be accessed via pseudo-variable $mongodb(key). The key
			can be: type - type of the reply; value - the value in JSON format
			returned by MongoDB server; info - in case of error from MongoDB, it will
			contain an info message.
		</p>
            <p>
			The result can contain many documents, see mongodb_next() function for
			more details.
		</p>
            <p>
			Meaning of the parameters:
			</p>
            <div class="itemizedlist">
              <ul class="itemizedlist">
                <li class="listitem">
                  <p>
				<span class="emphasis"><em>srvname</em></span> - MongoDB server name as given via
				'server' parameter.
			</p>
                </li>
                <li class="listitem">
                  <p>
				<span class="emphasis"><em>dbname</em></span> - MongoDB database name.
			</p>
                </li>
                <li class="listitem">
                  <p>
				<span class="emphasis"><em>cname</em></span> - MongodDB collection (table) name.
			</p>
                </li>
                <li class="listitem">
                  <p>
				<span class="emphasis"><em>command</em></span> - valid MongoDB command given
				as JSON string.
			</p>
                </li>
                <li class="listitem">
                  <p>
				<span class="emphasis"><em>replyid</em></span> - the name of the container to
				store the response.
			</p>
                </li>
              </ul>
            </div>
            <p>
		</p>
            <p>
			The function can be used from ANY_ROUTE.
		</p>
            <div class="example">
              <a id="idp1376616"></a>
              <p class="title">
                <strong>Example1.2.<code class="function">mongodb_cmd</code> usage</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
if(mongodb_cmd("mgs1", "kamailio", "acc", "{ \"collStats\": \"acc\" }", "mgr1")) {
	xlog("response from mongodb is [[$mongodb(mgr1=&gt;value)]]\n");
}
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="4.2. mongodb_cmd_simple(srvname, dbname, cname, command, replyid)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="ndb_mongodb.f.mongodb_cmd_simple"></a>4.2.
		<code class="function">mongodb_cmd_simple(srvname, dbname, cname, command, replyid)</code>
	    </h3>
                </div>
              </div>
            </div>
            <p>
			Send a valid command to MongoDB server identified by srvname. The reply will
			be stored in a local container identified by replyid. All the
			parameters can be strings with pseudo-variables that are evaluated
			at runtime.
		</p>
            <p>
			The reply can be accessed via pseudo-variable $mongodb(key). The key
			can be: type - type of the reply; value - the value in JSON format
			returned by MongoDB server; info - in case of error from MongoDB, it will
			contain an info message.
		</p>
            <p>
			This function should be used when the response has only one document.
		</p>
            <p>
			See mongodb_cmd() for the meaning of the parameters.
		</p>
            <p>
			The function can be used from ANY_ROUTE.
		</p>
            <div class="example">
              <a id="idp1380632"></a>
              <p class="title">
                <strong>Example1.3.<code class="function">mongodb_cmd_simple</code> usage</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
if(mongodb_cmd_simple("mgs1", "kamailio", "acc", "{ \"collStats\": \"acc\" }", "mgr1")) {
	xlog("response from mongodb is [[$mongodb(mgr1=&gt;value)]]\n");
}
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="4.3. mongodb_find(srvname, dbname, cname, command, replyid)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="ndb_mongodb.f.mongodb_find"></a>4.3.
		<code class="function">mongodb_find(srvname, dbname, cname, command, replyid)</code>
	    </h3>
                </div>
              </div>
            </div>
            <p>
			Send a find command to MongoDB server identified by srvname. The reply will
			be stored in a local container identified by replyid. All the
			parameters can be strings with pseudo-variables that are evaluated
			at runtime.
		</p>
            <p>
			The reply can be accessed via pseudo-variable $mongodb(key). The key
			can be: type - type of the reply; value - the value in JSON format
			returned by MongoDB server; info - in case of error from MongoDB, it will
			contain an info message.
		</p>
            <p>
			This function is useful for querying collections and accessing the results.
		</p>
            <p>
			See mongodb_cmd() for the meaning of the parameters, with the remark that
			command has to be a valid filter JSON document, like for find() command
			in mongoc command line client tool.
		</p>
            <p>
			The function can be used from ANY_ROUTE.
		</p>
            <div class="example">
              <a id="idp1384752"></a>
              <p class="title">
                <strong>Example1.4.<code class="function">mongodb_find</code> usage</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
if(mongodb_find("mgs1", "kamailio", "acc", "{ \"src_user\" : \"111\" }", "mgr1")) {
	xlog("response from mongodb is [[$mongodb(mgr1=&gt;value)]]\n");
}
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="4.4. mongodb_find_one(srvname, dbname, cname, command, replyid)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="ndb_mongodb.f.mongodb_find_one"></a>4.4.
		<code class="function">mongodb_find_one(srvname, dbname, cname, command, replyid)</code>
	    </h3>
                </div>
              </div>
            </div>
            <p>
			Similar to mongodb_find(...), but it stops searching after first
			match, returning the result with one object - faster when expecting
			to have a single match. Parameters and behaviour are the same
			as for mongodb_find(...).
		</p>
            <p>
			The function can be used from ANY_ROUTE.
		</p>
            <div class="example">
              <a id="idp1387784"></a>
              <p class="title">
                <strong>Example1.5.<code class="function">mongodb_find_one</code> usage</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
if(mongodb_find_one("mgs1", "kamailio", "subscriber", "{ \"username\" : \"111\" }", "mgr1")) {
	xlog("response from mongodb is [[$mongodb(mgr1=&gt;value)]]\n");
}
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="4.5. mongodb_next(replyid)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="ndb_mongodb.f.mongodb_next"></a>4.5.
		<code class="function">mongodb_next(replyid)</code>
	</h3>
                </div>
              </div>
            </div>
            <p>
		Moves to next document in a MongoDB reply. This function can be used
		after a succesful mongodb_cmd() or mongodb_find(). It returns true if
		there is a shift to document. The current document becomes available
		via $mongodb(key) variable.
	</p>
            <div class="example">
              <a id="idp1390424"></a>
              <p class="title">
                <strong>Example1.6.<code class="function">mongodb_next</code> usage</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
if(mongodb_find("mgs1", "kamailio", "acc", "{ \"src_user\" : \"111\" }", "mgr1")) {
    xlog("first response from mongodb is [[$mongodb(mgr1=&gt;value)]]\n");
    while(mongodb_next("mgr1") ){
        xlog("next response from mongodb is [[$mongodb(mgr1=&gt;value)]]\n");
    }
}
mongodb_free("mgr1");
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="4.6. mongodb_free(replyid)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="ndb_mongodb.f.mongodb_free"></a>4.6.
		<code class="function">mongodb_free(replyid)</code>
	</h3>
                </div>
              </div>
            </div>
            <p>
		Frees data in a previous reply from memory.
		After this function call, accessing to a freed replyid returns null value.
	</p>
            <p>
		It is not really necessary to free a reply to use it again in a new mongodb_cmd
		function, being automatically freed on next command execution, but for freeing
		used resources (e.g., memory), it is recommended to do it.
	</p>
            <div class="example">
              <a id="idm15000"></a>
              <p class="title">
                <strong>Example1.7.<code class="function">mongodb_free</code> usage</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
if(mongodb_cmd_simple("mgs1", "kamailio", "acc", "{ \"collStats\": \"acc\" }", "mgr1")) {
	xlog("response from mongodb is [[$mongodb(mgr1=&gt;value)]]\n");
}
mongodb_free("mgr1");
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
