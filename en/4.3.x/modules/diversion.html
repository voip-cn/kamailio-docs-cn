<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>Diversion Module</title>
    <link rel="stylesheet" type="text/css" href="../../../../css/sr-doc.css" tppabs="http://kamailio.org/css/sr-doc.css" />
    <meta name="generator" content="DocBook XSL Stylesheets V1.76.1" />
    <link rel="home" href="#idm15456344" title="Diversion Module" />
    <link rel="next" href="#idp2435440" title="Chapter 1. Admin Guide" />
  </head>
  <body>
    <div class="book" title="Diversion Module">
      <div class="titlepage">
        <div>
          <div>
            <h1 class="title"><a id="idm15456344"></a>Diversion Module</h1>
          </div>
          <div>
            <div class="authorgroup">
              <div class="author">
                <h3 class="author"><span class="firstname">Jan</span> <span class="surname">Janak</span></h3>
                <div class="affiliation">
                  <span class="orgname">FhG FOKUS<br /></span>
                </div>
              </div>
              <div class="editor">
                <h4 class="editedby">Edited by</h4>
                <h3 class="editor"><span class="firstname">Jan</span> <span class="surname">Janak</span></h3>
              </div>
            </div>
          </div>
          <div>
            <p class="copyright">Copyright © 2004 FhG FOKUS</p>
          </div>
        </div>
        <hr />
      </div>
      <div class="toc">
        <p>
          <strong>Table of Contents</strong>
        </p>
        <dl>
          <dt>
            <span class="chapter">
              <a href="#idp2435440">1. Admin Guide</a>
            </span>
          </dt>
          <dd>
            <dl>
              <dt>
                <span class="section">
                  <a href="#diversion.overview">1. Overview</a>
                </span>
              </dt>
              <dt>
                <span class="section">
                  <a href="#idp3186768">2. Dependencies</a>
                </span>
              </dt>
              <dd>
                <dl>
                  <dt>
                    <span class="section">
                      <a href="#idp2623280">2.1. Kamailio Modules</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#idp2032024">2.2. External Libraries or Applications</a>
                    </span>
                  </dt>
                </dl>
              </dd>
              <dt>
                <span class="section">
                  <a href="#idp2429464">3. Parameters</a>
                </span>
              </dt>
              <dd>
                <dl>
                  <dt>
                    <span class="section">
                      <a href="#diversion.p.suffix">3.1. <code class="varname">suffix</code> (string)</a>
                    </span>
                  </dt>
                </dl>
              </dd>
              <dt>
                <span class="section">
                  <a href="#idp2508248">4. Functions</a>
                </span>
              </dt>
              <dd>
                <dl>
                  <dt>
                    <span class="section">
                      <a href="#diversion.f.add_diversion">4.1. <code class="function">add_diversion(reason [, uri])</code></a>
                    </span>
                  </dt>
                </dl>
              </dd>
              <dt>
                <span class="section">
                  <a href="#idp1359896">5. Diversion Example</a>
                </span>
              </dt>
            </dl>
          </dd>
          <dt>
            <span class="chapter">
              <a href="#idp1520656">2. Developer Guide</a>
            </span>
          </dt>
        </dl>
      </div>
      <div class="list-of-examples">
        <p>
          <strong>List of Examples</strong>
        </p>
        <dl>
          <dt>1.1. <a href="#idp2418392"><code class="varname">suffix</code> usage</a></dt>
          <dt>1.2. <a href="#idp268976"><code class="function">add_diversion</code> usage</a></dt>
        </dl>
      </div>
      <div class="chapter" title="Chapter 1. Admin Guide">
        <div class="titlepage">
          <div>
            <div>
              <h2 class="title"><a id="idp2435440"></a>Chapter 1. Admin Guide</h2>
            </div>
          </div>
        </div>
        <div class="toc">
          <p>
            <strong>Table of Contents</strong>
          </p>
          <dl>
            <dt>
              <span class="section">
                <a href="#diversion.overview">1. Overview</a>
              </span>
            </dt>
            <dt>
              <span class="section">
                <a href="#idp3186768">2. Dependencies</a>
              </span>
            </dt>
            <dd>
              <dl>
                <dt>
                  <span class="section">
                    <a href="#idp2623280">2.1. Kamailio Modules</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#idp2032024">2.2. External Libraries or Applications</a>
                  </span>
                </dt>
              </dl>
            </dd>
            <dt>
              <span class="section">
                <a href="#idp2429464">3. Parameters</a>
              </span>
            </dt>
            <dd>
              <dl>
                <dt>
                  <span class="section">
                    <a href="#diversion.p.suffix">3.1. <code class="varname">suffix</code> (string)</a>
                  </span>
                </dt>
              </dl>
            </dd>
            <dt>
              <span class="section">
                <a href="#idp2508248">4. Functions</a>
              </span>
            </dt>
            <dd>
              <dl>
                <dt>
                  <span class="section">
                    <a href="#diversion.f.add_diversion">4.1. <code class="function">add_diversion(reason [, uri])</code></a>
                  </span>
                </dt>
              </dl>
            </dd>
            <dt>
              <span class="section">
                <a href="#idp1359896">5. Diversion Example</a>
              </span>
            </dt>
          </dl>
        </div>
        <div class="section" title="1. Overview">
          <div class="titlepage">
            <div>
              <div>
                <h2 class="title"><a id="diversion.overview"></a>1. Overview</h2>
              </div>
            </div>
          </div>
          <p>
		The module implements the Diversion extensions as per 
		RFC 5806. The diversion extensions are useful in various
		scenarios involving call forwarding. Typically one needs to communicate
		the original recipient of the call to the PSTN gateway and this is what
		the diversion extensions can be used for.
	</p>
          <div class="warning" title="Warning" style="margin-left: 0.5in; margin-right: 0.5in;">
            <h3 class="title">Warning</h3>
            <p>
		Note that RFC 5806 has historic status.
	</p>
          </div>
        </div>
        <div class="section" title="2. Dependencies">
          <div class="titlepage">
            <div>
              <div>
                <h2 class="title"><a id="idp3186768"></a>2. Dependencies</h2>
              </div>
            </div>
          </div>
          <div class="section" title="2.1. Kamailio Modules">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="idp2623280"></a>2.1. Kamailio Modules</h3>
                </div>
              </div>
            </div>
            <p>None.</p>
          </div>
          <div class="section" title="2.2. External Libraries or Applications">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="idp2032024"></a>2.2. External Libraries or Applications</h3>
                </div>
              </div>
            </div>
            <p>
		The following libraries or applications must be installed before running
		Kamailio with this module loaded:
			</p>
            <div class="itemizedlist">
              <ul class="itemizedlist">
                <li class="listitem">
                  <p>
				<span class="emphasis"><em>None</em></span>.
			</p>
                </li>
              </ul>
            </div>
            <p>
		</p>
          </div>
        </div>
        <div class="section" title="3. Parameters">
          <div class="titlepage">
            <div>
              <div>
                <h2 class="title"><a id="idp2429464"></a>3. Parameters</h2>
              </div>
            </div>
          </div>
          <div class="section" title="3.1. suffix (string)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="diversion.p.suffix"></a>3.1. <code class="varname">suffix</code> (string)</h3>
                </div>
              </div>
            </div>
            <p>
		The suffix to be appended to the end of the header field. You can use 
		the parameter to specify additional parameters to be added to the 
		header field, see the example.
		</p>
            <p>
		Default value is <span class="quote">“<span class="quote"></span>”</span> (empty string).
		</p>
            <div class="example">
              <a id="idp2418392"></a>
              <p class="title">
                <strong>Example 1.1. <code class="varname">suffix</code> usage</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">modparam("diversion", "suffix", ";privacy=full")</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
        </div>
        <div class="section" title="4. Functions">
          <div class="titlepage">
            <div>
              <div>
                <h2 class="title"><a id="idp2508248"></a>4. Functions</h2>
              </div>
            </div>
          </div>
          <div class="section" title="4.1. add_diversion(reason [, uri])">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="diversion.f.add_diversion"></a>4.1. <code class="function">add_diversion(reason [, uri])</code></h3>
                </div>
              </div>
            </div>
            <p>
		The function adds a new diversion header field before any other 
		existing Diversion header field in the message (the newly added 
		Diversion header field will become the topmost Diversion header field).
		If 'uri' parameter is missing, the inbound (without any modifications done
		by the proxy server) Request-URI will be used as the Diversion URI.
		</p>
            <p>Meaning of the parameters is as follows:</p>
            <div class="itemizedlist">
              <ul class="itemizedlist">
                <li class="listitem">
                  <p><span class="emphasis"><em>reason</em></span> - The reason string to be added 
			as the reason parameter
			</p>
                </li>
                <li class="listitem">
                  <p><span class="emphasis"><em>uri</em></span> - The URI to be set in Diversion header
			</p>
                </li>
              </ul>
            </div>
            <p>
		The parameters can contain pseudo-variables.
	</p>
            <p>
	This function can be used from REQUEST_ROUTE, FAILURE_ROUTE, BRANCH_ROUTE.
	</p>
            <div class="example">
              <a id="idp268976"></a>
              <p class="title">
                <strong>Example 1.2. <code class="function">add_diversion</code> usage</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
add_diversion("user-busy");
add_diversion("user-busy", "$ru");
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
        </div>
        <div class="section" title="5. Diversion Example">
          <div class="titlepage">
            <div>
              <div>
                <h2 class="title"><a id="idp1359896"></a>5. Diversion Example</h2>
              </div>
            </div>
          </div>
          <p>
			The following example shows a Diversion header field added to 
			INVITE message. The original INVITE received by the user agent 
			of sip:bob@sip.org is:
		</p>
          <pre class="programlisting">INVITE sip:bob@sip.org SIP/2.0
Via: SIP/2.0/UDP 1.2.3.4:5060
From: "mark" &lt;sip:mark@sip.org&gt;;tag=ldgheoihege
To: "Bob" &lt;sip:bob@sip.org&gt;
Call-ID: adgasdkgjhkjha@1.2.3.4
CSeq: 3 INVITE
Contact: &lt;sip:mark@1.2.3.4&gt;
Content-Length: 0</pre>
          <p>
			The INVITE message is diverted by the user agent 
			of sip:bob@sip.org because the user was talking to someone else 
			and the new destination is sip:alice@sip.org :
		</p>
          <pre class="programlisting">INVITE sip:alice@sip.org SIP/2.0
Via: SIP/2.0/UDP 5.6.7.8:5060
Via: SIP/2.0/UDP 1.2.3.4:5060
From: "mark" &lt;sip:mark@sip.org&gt;;tag=ldgheoihege
To: "Bob" &lt;sip:bob@sip.org&gt;
Call-ID: adgasdkgjhkjha@1.2.3.4
CSeq: 3 INVITE
Diversion: &lt;sip:bob@sip.org&gt;;reason=user-busy
Contact: &lt;sip:mark@1.2.3.4&gt;
Content-Length: 0</pre>
        </div>
      </div>
      <div class="chapter" title="Chapter 2. Developer Guide">
        <div class="titlepage">
          <div>
            <div>
              <h2 class="title"><a id="idp1520656"></a>Chapter 2. Developer Guide</h2>
            </div>
          </div>
        </div>
        <p>
	According to the specification a new <span class="quote">“<span class="quote">Diversion</span>”</span> header field should be inserted
	as the topmost Diversion header field in the message, that means before any other existing
	Diversion header field in the message. In addition to that, the <code class="function">add_diversion</code> function can be called several times and each time
	it should insert the new Diversion header field as the topmost one.
    </p>
        <p>
	In order to implement this, add_diversion function creates the anchor in data_lump lists as
	a static variable to ensure that the next call of the function will use the same anchor and
	would insert new Diversion headers before the one created in the previous execution. To my
	knowledge this is the only way of inserting the diversion header field before any other
	created in previous runs of the function.
    </p>
        <p>
	The anchor kept this way is only valid for a single message and we have to invalidate it
	when another message is being processed. For this reason, the function also stores the id of
	the message in another static variable and compares the value of that variable with the id
	of the SIP message being processed. If they differ then the anchor will be invalidated and
	the function creates a new one.
    </p>
        <p>
	The following code snippet shows the code that invalidates the anchor, new anchor will be
	created when the <code class="varname">anchor</code> variable is set to 0.
    </p>
        <pre class="programlisting">static inline int add_diversion_helper(struct sip_msg* msg, str* s)
{
    static struct lump* anchor = 0;
    static int msg_id = 0;

    if (msg_id != msg-&gt;id) {
        msg_id = msg-&gt;id;
        anchor = 0;
    }
...
}</pre>
      </div>
    </div>
  </body>
</html>
