<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>jsonrpc-c (client) Module</title>
    <link rel="stylesheet" type="text/css" href="../../../../css/sr-doc.css" tppabs="http://kamailio.org/css/sr-doc.css" />
    <meta name="generator" content="DocBook XSL Stylesheets V1.76.1" />
    <link rel="home" href="#idm4293800" title="jsonrpc-c (client) Module" />
    <link rel="next" href="#idp1600672" title="Chapter 1. Admin Guide" />
  </head>
  <body>
    <div class="book" title="jsonrpc-c (client) Module">
      <div class="titlepage">
        <div>
          <div>
            <h1 class="title"><a id="idm4293800"></a>jsonrpc-c (client) Module</h1>
          </div>
          <div>
            <div class="authorgroup">
              <div class="author">
                <h3 class="author"><span class="firstname">Matthew</span> <span class="surname">Williams</span></h3>
                <code class="email">&lt;<a class="email" href="mailto:matthew@flowroute.com">matthew@flowroute.com</a>&gt;</code>
              </div>
              <div class="editor">
                <h4 class="editedby">Edited by</h4>
                <h3 class="editor"><span class="firstname">Jordan</span> <span class="surname">Levy</span></h3>
                <code class="email">&lt;<a class="email" href="mailto:jordan@flowroute.com">jordan@flowroute.com</a>&gt;</code>
              </div>
            </div>
          </div>
          <div>
            <p class="copyright">Copyright © 2011 Flowroute LLC (flowroute.com)</p>
          </div>
        </div>
        <hr />
      </div>
      <div class="toc">
        <p>
          <strong>Table of Contents</strong>
        </p>
        <dl>
          <dt>
            <span class="chapter">
              <a href="#idp1600672">1. Admin Guide</a>
            </span>
          </dt>
          <dd>
            <dl>
              <dt>
                <span class="section">
                  <a href="#idp2245160">1. Overview</a>
                </span>
              </dt>
              <dt>
                <span class="section">
                  <a href="#idp2216672">2. Dependencies</a>
                </span>
              </dt>
              <dd>
                <dl>
                  <dt>
                    <span class="section">
                      <a href="#idp2351992">2.1. Kamailio Modules</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#idp3108912">2.2. External Libraries or Applications</a>
                    </span>
                  </dt>
                </dl>
              </dd>
              <dt>
                <span class="section">
                  <a href="#idp2968672">3. Parameters</a>
                </span>
              </dt>
              <dd>
                <dl>
                  <dt>
                    <span class="section">
                      <a href="#idp3142616">3.1. <code class="varname">servers</code> (string)</a>
                    </span>
                  </dt>
                </dl>
              </dd>
              <dt>
                <span class="section">
                  <a href="#idp2522904">4. Functions</a>
                </span>
              </dt>
              <dd>
                <dl>
                  <dt>
                    <span class="section">
                      <a href="#idp2463944">4.1. 
				<code class="function">jsonrpc_notification(method, parameters)</code>
			</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#idp1412240">4.2. 
				<code class="function">jsonrpc_request(method, parameters, return_route, error_route, result_var)</code>
			</a>
                    </span>
                  </dt>
                </dl>
              </dd>
            </dl>
          </dd>
        </dl>
      </div>
      <div class="list-of-examples">
        <p>
          <strong>List of Examples</strong>
        </p>
        <dl>
          <dt>1.1. <a href="#idp2303976">Set <code class="varname">servers</code> parameter</a></dt>
          <dt>1.2. <a href="#idp2725696"><code class="function">jsonrpc_notification</code> usage</a></dt>
          <dt>1.3. <a href="#idp2293704"><code class="function">jsonrpc_request</code> usage</a></dt>
        </dl>
      </div>
      <div class="chapter" title="Chapter 1. Admin Guide">
        <div class="titlepage">
          <div>
            <div>
              <h2 class="title"><a id="idp1600672"></a>Chapter 1. Admin Guide</h2>
            </div>
          </div>
        </div>
        <div class="toc">
          <p>
            <strong>Table of Contents</strong>
          </p>
          <dl>
            <dt>
              <span class="section">
                <a href="#idp2245160">1. Overview</a>
              </span>
            </dt>
            <dt>
              <span class="section">
                <a href="#idp2216672">2. Dependencies</a>
              </span>
            </dt>
            <dd>
              <dl>
                <dt>
                  <span class="section">
                    <a href="#idp2351992">2.1. Kamailio Modules</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#idp3108912">2.2. External Libraries or Applications</a>
                  </span>
                </dt>
              </dl>
            </dd>
            <dt>
              <span class="section">
                <a href="#idp2968672">3. Parameters</a>
              </span>
            </dt>
            <dd>
              <dl>
                <dt>
                  <span class="section">
                    <a href="#idp3142616">3.1. <code class="varname">servers</code> (string)</a>
                  </span>
                </dt>
              </dl>
            </dd>
            <dt>
              <span class="section">
                <a href="#idp2522904">4. Functions</a>
              </span>
            </dt>
            <dd>
              <dl>
                <dt>
                  <span class="section">
                    <a href="#idp2463944">4.1. 
				<code class="function">jsonrpc_notification(method, parameters)</code>
			</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#idp1412240">4.2. 
				<code class="function">jsonrpc_request(method, parameters, return_route, error_route, result_var)</code>
			</a>
                  </span>
                </dt>
              </dl>
            </dd>
          </dl>
        </div>
        <div class="section" title="1. Overview">
          <div class="titlepage">
            <div>
              <div>
                <h2 class="title"><a id="idp2245160"></a>1. Overview</h2>
              </div>
            </div>
          </div>
          <p>
			This module provides access to json-rpc services (operating over TCP/Netstrings).
		</p>
          <p>
			This module uses t_suspend() and t_continue() from the TM module.
		</p>
          <p>
			Note that after invoking an asyncronous operation, the processing
			will continue later, in another application process. Therefore, do not
			rely on variables stored in private memory, use shared memory if you
			want to get values after the processing is resumend (e.g., $shv(...)
			or htable $sht(...)).
		</p>
        </div>
        <div class="section" title="2. Dependencies">
          <div class="titlepage">
            <div>
              <div>
                <h2 class="title"><a id="idp2216672"></a>2. Dependencies</h2>
              </div>
            </div>
          </div>
          <div class="section" title="2.1. Kamailio Modules">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="idp2351992"></a>2.1. Kamailio Modules</h3>
                </div>
              </div>
            </div>
            <p>
				The following modules must be loaded before this module:
				</p>
            <div class="itemizedlist">
              <ul class="itemizedlist">
                <li class="listitem">
                  <p>
							<span class="emphasis"><em>tm</em></span> - transaction management.
						</p>
                </li>
              </ul>
            </div>
            <p>
			</p>
          </div>
          <div class="section" title="2.2. External Libraries or Applications">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="idp3108912"></a>2.2. External Libraries or Applications</h3>
                </div>
              </div>
            </div>
            <p>
				Note: this module uses Linux specific API, part of glibc library,
				it might not compile on other types of operating systems.
			</p>
            <p>
				The following libraries or applications must be installed before running
				Kamailio with this module loaded:
				</p>
            <div class="itemizedlist">
              <ul class="itemizedlist">
                <li class="listitem">
                  <p>
							<span class="emphasis"><em>libjson (https://github.com/json-c/json-c/wiki)</em></span>
						</p>
                </li>
                <li class="listitem">
                  <p>
							<span class="emphasis"><em>libevent</em></span> - http://libevent.org/
						</p>
                </li>
                <li class="listitem">
                  <p>
							<span class="emphasis"><em>glibc</em></span> - http://www.gnu.org/software/libc/
							(v2.8 or higher)
						</p>
                </li>
              </ul>
            </div>
            <p>
			</p>
          </div>
        </div>
        <div class="section" title="3. Parameters">
          <div class="titlepage">
            <div>
              <div>
                <h2 class="title"><a id="idp2968672"></a>3. Parameters</h2>
              </div>
            </div>
          </div>
          <div class="section" title="3.1. servers (string)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="idp3142616"></a>3.1. <code class="varname">servers</code> (string)</h3>
                </div>
              </div>
            </div>
            <p>
				The servers providing the remote jsonrpc service. Format is "host1:port1,priority1 host2:port2,priority2". Requests to servers of the same priority will be distributed evenly (round robin). Server groups with higher priority are used first. 
			</p>
            <div class="example">
              <a id="idp2303976"></a>
              <p class="title">
                <strong>Example 1.1. Set <code class="varname">servers</code> parameter</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
modparam("jsonrpc", "servers", "localhost:9999,2 10.10.0.1:9999,2 backup.server:9999,1")
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
        </div>
        <div class="section" title="4. Functions">
          <div class="titlepage">
            <div>
              <div>
                <h2 class="title"><a id="idp2522904"></a>4. Functions</h2>
              </div>
            </div>
          </div>
          <div class="section" title="4.1.  jsonrpc_notification(method, parameters)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="idp2463944"></a>4.1. 
				<code class="function">jsonrpc_notification(method, parameters)</code>
			</h3>
                </div>
              </div>
            </div>
            <p>
				Invokes the remote 'method' with the given 'parameters' as a notification.
				Unlike jsonrpc_request (below), notifications do not receive a response. 
				Script processing continues in the usual fashion as soon as the notification
				has been sent.
			</p>
            <p>
				The method and parameters can be a static string or dynamic string value with 
				config variables.
			</p>
            <div class="example">
              <a id="idp2725696"></a>
              <p class="title">
                <strong>Example 1.2. <code class="function">jsonrpc_notification</code> usage</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
jsonrpc_notification("update_user", "{'id': 1234, 'name': 'Petros'}")
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="4.2.  jsonrpc_request(method, parameters, return_route, error_route, result_var)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="idp1412240"></a>4.2. 
				<code class="function">jsonrpc_request(method, parameters, return_route, error_route, result_var)</code>
			</h3>
                </div>
              </div>
            </div>
            <p>
				Invokes the remote 'method' with the given 'parameters'. 
				When the response is received, continues processing of the SIP request
				with the route[return_route]. If a timeout occurs, no servers can be reached,
				or a jsonrpc error message is received, continues process at route[error_route].
				In this case, the result_var will contain one of "timeout", "failure", or the error
				message received back from the jsonrpc server.
			</p>
            <p>
				The method, parameters, return_route, and error_route can be a static string or 
				a dynamic string value with config variables.
			</p>
            <p>
				Since the SIP request handling is resumed in another process,
				the config file execution is lost. As mentioned above, only 
				shared variables ($shv, etc) should be used for any value that
				will be needed when the script is resumed.
			</p>
            <p>
				The result is stored in the pseudo-variable 'result_var'. Since this 
				variable is set <span class="emphasis"><em>after</em></span> the response is received,
				it is possible to use a $var for this parameter.
			</p>
            <div class="example">
              <a id="idp2293704"></a>
              <p class="title">
                <strong>Example 1.3. <code class="function">jsonrpc_request</code> usage</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
jsonrpc_request("get_user", "{'id': 1234}", "RESPONSE", "ERROR", "$var(result)");
...
route[RESPONSE] {
	xlog("Result received: $var(result)");
	...
}
...
route[ERROR] {
	xlog("Error received: $var(result)");
	...
}
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
