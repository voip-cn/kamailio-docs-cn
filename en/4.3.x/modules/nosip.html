<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>NOSIP Module</title>
    <link rel="stylesheet" type="text/css" href="../../../../css/sr-doc.css" tppabs="http://kamailio.org/css/sr-doc.css" />
    <meta name="generator" content="DocBook XSL Stylesheets V1.76.1" />
    <link rel="home" href="#idm15533632" title="NOSIP Module" />
    <link rel="next" href="#idp1752128" title="Chapter 1. Admin Guide" />
  </head>
  <body>
    <div class="book" title="NOSIP Module">
      <div class="titlepage">
        <div>
          <div>
            <h1 class="title"><a id="idm15533632"></a>NOSIP Module</h1>
          </div>
          <div>
            <div class="authorgroup">
              <div class="author">
                <h3 class="author"><span class="firstname">Daniel-Constantin</span> <span class="surname">Mierla</span></h3>
                <code class="email">&lt;<a class="email" href="mailto:miconda@gmail.com">miconda@gmail.com</a>&gt;</code>
              </div>
              <div class="editor">
                <h4 class="editedby">Edited by</h4>
                <h3 class="editor"><span class="firstname">Daniel-Constantin</span> <span class="surname">Mierla</span></h3>
                <code class="email">&lt;<a class="email" href="mailto:miconda@gmail.com">miconda@gmail.com</a>&gt;</code>
              </div>
            </div>
          </div>
          <div>
            <p class="copyright">Copyright © 2014 asipto.com</p>
          </div>
        </div>
        <hr />
      </div>
      <div class="toc">
        <p>
          <strong>Table of Contents</strong>
        </p>
        <dl>
          <dt>
            <span class="chapter">
              <a href="#idp1752128">1. Admin Guide</a>
            </span>
          </dt>
          <dd>
            <dl>
              <dt>
                <span class="section">
                  <a href="#idp1750400">1. Overview</a>
                </span>
              </dt>
              <dt>
                <span class="section">
                  <a href="#idp2182096">2. Dependencies</a>
                </span>
              </dt>
              <dd>
                <dl>
                  <dt>
                    <span class="section">
                      <a href="#idp2176968">2.1. Kamailio Modules</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#idp1447064">2.2. External Libraries or Applications</a>
                    </span>
                  </dt>
                </dl>
              </dd>
              <dt>
                <span class="section">
                  <a href="#idp2448432">3. Parameters</a>
                </span>
              </dt>
              <dd>
                <dl>
                  <dt>
                    <span class="section">
                      <a href="#idp1443976">3.1. <code class="varname">msg_match</code> (str)</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#idp2544696">3.2. <code class="varname">msg_skip</code> (str)</a>
                    </span>
                  </dt>
                </dl>
              </dd>
              <dt>
                <span class="section">
                  <a href="#idp182448">4. Event Routes</a>
                </span>
              </dt>
              <dd>
                <dl>
                  <dt>
                    <span class="section">
                      <a href="#async.evr.nosip_msg">4.1. 
		<code class="function">event_route[nosip:msg]</code>
	    </a>
                    </span>
                  </dt>
                </dl>
              </dd>
              <dt>
                <span class="section">
                  <a href="#idp193000">5. Examples of Usage</a>
                </span>
              </dt>
            </dl>
          </dd>
        </dl>
      </div>
      <div class="list-of-examples">
        <p>
          <strong>List of Examples</strong>
        </p>
        <dl>
          <dt>1.1. <a href="#idp1506528">Set <code class="varname">msg_match</code> parameter</a></dt>
          <dt>1.2. <a href="#idm20608">Set <code class="varname">msg_match</code> parameter</a></dt>
          <dt>1.3. <a href="#idp191648"><code class="function">event_route[nosip:msg]</code> usage</a></dt>
          <dt>1.4. <a href="#idp194600"><code class="function">event_route[nosip:msg]</code> use case</a></dt>
        </dl>
      </div>
      <div class="chapter" title="Chapter 1. Admin Guide">
        <div class="titlepage">
          <div>
            <div>
              <h2 class="title"><a id="idp1752128"></a>Chapter 1. Admin Guide</h2>
            </div>
          </div>
        </div>
        <div class="toc">
          <p>
            <strong>Table of Contents</strong>
          </p>
          <dl>
            <dt>
              <span class="section">
                <a href="#idp1750400">1. Overview</a>
              </span>
            </dt>
            <dt>
              <span class="section">
                <a href="#idp2182096">2. Dependencies</a>
              </span>
            </dt>
            <dd>
              <dl>
                <dt>
                  <span class="section">
                    <a href="#idp2176968">2.1. Kamailio Modules</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#idp1447064">2.2. External Libraries or Applications</a>
                  </span>
                </dt>
              </dl>
            </dd>
            <dt>
              <span class="section">
                <a href="#idp2448432">3. Parameters</a>
              </span>
            </dt>
            <dd>
              <dl>
                <dt>
                  <span class="section">
                    <a href="#idp1443976">3.1. <code class="varname">msg_match</code> (str)</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#idp2544696">3.2. <code class="varname">msg_skip</code> (str)</a>
                  </span>
                </dt>
              </dl>
            </dd>
            <dt>
              <span class="section">
                <a href="#idp182448">4. Event Routes</a>
              </span>
            </dt>
            <dd>
              <dl>
                <dt>
                  <span class="section">
                    <a href="#async.evr.nosip_msg">4.1. 
		<code class="function">event_route[nosip:msg]</code>
	    </a>
                  </span>
                </dt>
              </dl>
            </dd>
            <dt>
              <span class="section">
                <a href="#idp193000">5. Examples of Usage</a>
              </span>
            </dt>
          </dl>
        </div>
        <div class="section" title="1. Overview">
          <div class="titlepage">
            <div>
              <div>
                <h2 class="title"><a id="idp1750400"></a>1. Overview</h2>
              </div>
            </div>
          </div>
          <p>
		This module provides a way to get access to non-SIP packages received
		by Kamailio via its SIP worker processes. The content of such packages
		is available in the $mb variable inside the event_route[nosip:msg].
	</p>
          <p>
		Note that packets with size less than 32 bytes are discarded, this
		threshold being set to avoid handling the NAT keepalive packets coming
		from devices. The limit is planned to be made configurable. Also, by
		default Kamailio writes a log messages in case of SIP parsing error,
		that can be controlled via 'corelog' global parameter.
	</p>
          <p>
		Besides the content of the packet, $si and $sp provide the source IP and
		port, allowing to do filtering and authorization.
	</p>
        </div>
        <div class="section" title="2. Dependencies">
          <div class="titlepage">
            <div>
              <div>
                <h2 class="title"><a id="idp2182096"></a>2. Dependencies</h2>
              </div>
            </div>
          </div>
          <div class="section" title="2.1. Kamailio Modules">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="idp2176968"></a>2.1. Kamailio Modules</h3>
                </div>
              </div>
            </div>
            <p>
		The following modules must be loaded before this module:
			</p>
            <div class="itemizedlist">
              <ul class="itemizedlist">
                <li class="listitem">
                  <p>
				<span class="emphasis"><em>none</em></span>.
			</p>
                </li>
              </ul>
            </div>
            <p>
		</p>
          </div>
          <div class="section" title="2.2. External Libraries or Applications">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="idp1447064"></a>2.2. External Libraries or Applications</h3>
                </div>
              </div>
            </div>
            <p>
		The following libraries or applications must be installed before running
		Kamailio with this module loaded:
			</p>
            <div class="itemizedlist">
              <ul class="itemizedlist">
                <li class="listitem">
                  <p>
				<span class="emphasis"><em>none</em></span>
			</p>
                </li>
              </ul>
            </div>
            <p>
		</p>
          </div>
        </div>
        <div class="section" title="3. Parameters">
          <div class="titlepage">
            <div>
              <div>
                <h2 class="title"><a id="idp2448432"></a>3. Parameters</h2>
              </div>
            </div>
          </div>
          <div class="section" title="3.1. msg_match (str)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="idp1443976"></a>3.1. <code class="varname">msg_match</code> (str)</h3>
                </div>
              </div>
            </div>
            <p>
			Regular expression to match against content of the packet in order
			to execute the event_route[nosip:msg].
		</p>
            <p>
		<span class="emphasis"><em>
			Default value is empty.
		</em></span>
		</p>
            <div class="example">
              <a id="idp1506528"></a>
              <p class="title">
                <strong>Example 1.1. Set <code class="varname">msg_match</code> parameter</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
modparam("nosip", "msg_match", "^KREQUEST-")
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="3.2. msg_skip (str)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="idp2544696"></a>3.2. <code class="varname">msg_skip</code> (str)</h3>
                </div>
              </div>
            </div>
            <p>
			Regular expression to match against content of the packet in order
			to skip execution the event_route[nosip:msg].
		</p>
            <p>
		<span class="emphasis"><em>
			Default value is empty.
		</em></span>
		</p>
            <div class="example">
              <a id="idm20608"></a>
              <p class="title">
                <strong>Example 1.2. Set <code class="varname">msg_match</code> parameter</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
modparam("nosip", "msg_skip", "^GET ")
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
        </div>
        <div class="section" title="4. Event Routes">
          <div class="titlepage">
            <div>
              <div>
                <h2 class="title"><a id="idp182448"></a>4. Event Routes</h2>
              </div>
            </div>
          </div>
          <div class="section" title="4.1.  event_route[nosip:msg]">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="async.evr.nosip_msg"></a>4.1. 
		<code class="function">event_route[nosip:msg]</code>
	    </h3>
                </div>
              </div>
            </div>
            <p>
			Event route block to be executed when a non-sip message is received
			by a SIP worker process.
		</p>
            <p>
		The routename parameter can be a static string or a dynamic string
		value with config variables.
		</p>
            <p>
		The sleep parameter represent the number of seconds to suspend the
		processing of a SIP request. Maximum value is 100. The parameter can be
		a static integer or a variable holding an integer.
		</p>
            <p>
		Since the SIP request handling is resumed in another process,
		the config file execution state is practically lost. Therefore beware
		that the execution of config after resume will end once the
		route[routename] is finished.
		</p>
            <p>
		This function can be used from REQUEST_ROUTE.
		</p>
            <div class="example">
              <a id="idp191648"></a>
              <p class="title">
                <strong>Example 1.3. <code class="function">event_route[nosip:msg]</code> usage</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
loadmodule "nosip.so"
...
event_route[nosip:msg] {
   xlog("non-sip packet received - content [[$mb]] from [$si:$sp]\n");
   exit;
}
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
        </div>
        <div class="section" title="5. Examples of Usage">
          <div class="titlepage">
            <div>
              <div>
                <h2 class="title"><a id="idp193000"></a>5. Examples of Usage</h2>
              </div>
            </div>
          </div>
          <p>
			There can be many useful cases when one wants to get a SIP worker
			back to handle a suspended SIP transaction. While this could be
			achieved via XMLRPC or HTTP for TCP workers, UDP workers are the
			least loaded in terms of network interaction layer (ie., there is
			no overhad for connections management like for TCP).
		</p>
          <p>
			Parsing of the non-sip message can be done using config file
			actions: functions, expressions with variables and transformations.
		</p>
          <p>
			Next is a basic example of parsing a message from the network and
			resuming the transaction.
		</p>
          <div class="example">
            <a id="idp194600"></a>
            <p class="title">
              <strong>Example 1.4. <code class="function">event_route[nosip:msg]</code> use case</strong>
            </p>
            <div class="example-contents">
              <pre class="programlisting">...
# expect: :KREQUEST-RESUME-TRANSACTION:tindex:tlabel:routename:
# example: :KREQUEST-RESUME-TRANSACTION:4242:8686:RESUME:
loadmodule "nosip.so"
...
event_route[nosip:msg] {
    xlog("non-sip packet received - content [[$mb]] from [$si:$sp]\n");

    # must be a trusted IP
    if($si!="127.0.0.1") {
        exit;
    }

    # validation of the format and resume transaction
    if($mb=~":KREQUEST-RESUME-TRANSACTION:[0-9]+:[0-9]+:[a-zA-Z0-9]+:$") {
        $var(tindex) = $(mb{s.select,1,:});
        $var(tlabel) = $(mb{s.select,2,:});
        $var(rname) = $(mb{s.select,3,:});
        t_continue("$var(tindex)", "$var(tlabel)", "$var(rname)");
    }
    exit;
}

route[RESUME] {
    ...
}
...</pre>
            </div>
          </div>
          <br class="example-break" />
        </div>
      </div>
    </div>
  </body>
</html>
