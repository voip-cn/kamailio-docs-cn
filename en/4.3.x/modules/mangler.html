<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>The Mangler Module - SDP mangling</title>
    <link rel="stylesheet" type="text/css" href="../../../../css/sr-doc.css" tppabs="http://kamailio.org/css/sr-doc.css" />
    <meta name="generator" content="DocBook XSL Stylesheets V1.76.1" />
    <link rel="home" href="#mangler" title="The Mangler Module - SDP mangling" />
    <link rel="next" href="#idm15503488" title="Chapter 1. Admin Guide" />
  </head>
  <body>
    <div class="book" title="The Mangler Module - SDP mangling">
      <div class="titlepage">
        <div>
          <div>
            <h1 class="title"><a id="mangler"></a>The Mangler Module - SDP mangling</h1>
          </div>
          <div>
            <div class="authorgroup">
              <div class="author">
                <h3 class="author"><span class="firstname">Gabriel</span> <span class="surname">Vasile</span></h3>
                <div class="affiliation">
                  <span class="orgname">FhG FOKUS<br /></span>
                </div>
              </div>
            </div>
          </div>
          <div>
            <p class="copyright">Copyright © 2003 FhG FOKUS</p>
          </div>
        </div>
        <hr />
      </div>
      <div class="toc">
        <p>
          <strong>Table of Contents</strong>
        </p>
        <dl>
          <dt>
            <span class="chapter">
              <a href="#idm15503488">1. Admin Guide</a>
            </span>
          </dt>
          <dd>
            <dl>
              <dt>
                <span class="section">
                  <a href="#mangler.overview">1. Overview</a>
                </span>
              </dt>
              <dt>
                <span class="section">
                  <a href="#mangler.parameters">2. Parameters</a>
                </span>
              </dt>
              <dd>
                <dl>
                  <dt>
                    <span class="section">
                      <a href="#mangler.p.contact_flds_separator">2.1. <code class="varname">contact_flds_separator</code> (string)</a>
                    </span>
                  </dt>
                </dl>
              </dd>
              <dt>
                <span class="section">
                  <a href="#mangler.functions">3. Functions</a>
                </span>
              </dt>
              <dd>
                <dl>
                  <dt>
                    <span class="section">
                      <a href="#mangler.f.sdp_mangle_ip">3.1. 
	    <code class="function">sdp_mangle_ip(pattern, newip)</code>
	</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#mangler.f.sdp_mangle_port">3.2. 
	    <code class="function">sdp_mangle_port(offset)</code>
	</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#mangler.f.encode_contact">3.3. 
	    <code class="function">encode_contact(encoding_prefix)</code>
	</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#mangler.f.decode_contact">3.4. 
	    <code class="function">decode_contact()</code>
	</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#mangler.f.decode_contact_header">3.5. 
	    <code class="function">decode_contact_header()</code>
	</a>
                    </span>
                  </dt>
                </dl>
              </dd>
            </dl>
          </dd>
        </dl>
      </div>
      <div class="list-of-examples">
        <p>
          <strong>List of Examples</strong>
        </p>
        <dl>
          <dt>1.1. <a href="#idp1727176">Set <code class="varname">db_url</code> parameter</a></dt>
          <dt>1.2. <a href="#idp652936"><code class="function">sdp_mangle_ip</code> usage</a></dt>
          <dt>1.3. <a href="#idp1362376"><code class="function">sdp_mangle_port</code> usage</a></dt>
          <dt>1.4. <a href="#idp3093176"><code class="function">encode_contact</code> usage</a></dt>
          <dt>1.5. <a href="#idp2530808"><code class="function">decode_contact</code> usage</a></dt>
          <dt>1.6. <a href="#idp2533712"><code class="function">decode_contact_header</code> usage</a></dt>
        </dl>
      </div>
      <div class="chapter" title="Chapter 1. Admin Guide">
        <div class="titlepage">
          <div>
            <div>
              <h2 class="title"><a id="idm15503488"></a>Chapter 1. Admin Guide</h2>
            </div>
          </div>
        </div>
        <div class="toc">
          <p>
            <strong>Table of Contents</strong>
          </p>
          <dl>
            <dt>
              <span class="section">
                <a href="#mangler.overview">1. Overview</a>
              </span>
            </dt>
            <dt>
              <span class="section">
                <a href="#mangler.parameters">2. Parameters</a>
              </span>
            </dt>
            <dd>
              <dl>
                <dt>
                  <span class="section">
                    <a href="#mangler.p.contact_flds_separator">2.1. <code class="varname">contact_flds_separator</code> (string)</a>
                  </span>
                </dt>
              </dl>
            </dd>
            <dt>
              <span class="section">
                <a href="#mangler.functions">3. Functions</a>
              </span>
            </dt>
            <dd>
              <dl>
                <dt>
                  <span class="section">
                    <a href="#mangler.f.sdp_mangle_ip">3.1. 
	    <code class="function">sdp_mangle_ip(pattern, newip)</code>
	</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#mangler.f.sdp_mangle_port">3.2. 
	    <code class="function">sdp_mangle_port(offset)</code>
	</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#mangler.f.encode_contact">3.3. 
	    <code class="function">encode_contact(encoding_prefix)</code>
	</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#mangler.f.decode_contact">3.4. 
	    <code class="function">decode_contact()</code>
	</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#mangler.f.decode_contact_header">3.5. 
	    <code class="function">decode_contact_header()</code>
	</a>
                  </span>
                </dt>
              </dl>
            </dd>
          </dl>
        </div>
        <div class="section" title="1. Overview">
          <div class="titlepage">
            <div>
              <div>
                <h2 class="title"><a id="mangler.overview"></a>1. Overview</h2>
              </div>
            </div>
          </div>
          <p>
	    This is a module to help with SDP mangling - changing data in the SDP.
	</p>
        </div>
        <div class="section" title="2. Parameters">
          <div class="titlepage">
            <div>
              <div>
                <h2 class="title"><a id="mangler.parameters"></a>2. Parameters</h2>
              </div>
            </div>
          </div>
          <div class="section" title="2.1. contact_flds_separator (string)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="mangler.p.contact_flds_separator"></a>2.1. <code class="varname">contact_flds_separator</code> (string)</h3>
                </div>
              </div>
            </div>
            <p>
	    First char of this parameter is used as a separator for
	    encoding/decoding Contact headers.
	    If you set this parameter to "-", 
	    then an encoded URI will look like "sip:user-password-ip-port-protocol@PublicIP"
	</p>
            <div class="warning" title="Warning" style="margin-left: 0.5in; margin-right: 0.5in;">
              <h3 class="title">Warning</h3>
              <p>
		The first character of this field must be set to a value which is not
		used inside username, password or other fields of
		contact.Otherwise it is possible for the decoding step to
		fail/produce wrong results.
	    </p>
            </div>
            <p>
	    Default value is "*".
	</p>
            <div class="example">
              <a id="idp1727176"></a>
              <p class="title">
                <strong>Example 1.1. Set <code class="varname">db_url</code> parameter</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
modparam("mangler", "contact_flds_separator", "-")
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
        </div>
        <div class="section" title="3. Functions">
          <div class="titlepage">
            <div>
              <div>
                <h2 class="title"><a id="mangler.functions"></a>3. Functions</h2>
              </div>
            </div>
          </div>
          <div class="section" title="3.1.  sdp_mangle_ip(pattern, newip)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="mangler.f.sdp_mangle_ip"></a>3.1. 
	    <code class="function">sdp_mangle_ip(pattern, newip)</code>
	</h3>
                </div>
              </div>
            </div>
            <p>
	    Changes IP addresses inside SDP document in lines describing
	    connections like c=IN IP4 . Currently this function only changes 
	    IP4 addresses since IP6 probably will not need to traverse NAT :)
	</p>
            <p>
	    The function returns negative on error, or number of replacements + 1.
	</p>
            <p>Meaning of the parameters is as follows:</p>
            <div class="itemizedlist">
              <ul class="itemizedlist">
                <li class="listitem">
                  <p>
		    <span class="emphasis"><em>pattern</em></span> - An IP address/mask pair used to match
		    IP's located inside SDP package in lines c=IN IP4 ip. This
		    line will only be changed if located IP is in the network
		    described by this pattern. Examples of valid patterns are
		    "10.0.0.0/255.0.0.0" or "10.0.0.0/8" etc.
		</p>
                </li>
                <li class="listitem">
                  <p>
		    <span class="emphasis"><em>newip</em></span> - A string representing the new
		    IP to be put inside SDP package if old IP address
		    matches pattern.
		</p>
                </li>
              </ul>
            </div>
            <div class="example">
              <a id="idp652936"></a>
              <p class="title">
                <strong>Example 1.2. <code class="function">sdp_mangle_ip</code> usage</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
sdp_mangle_ip("10.0.0.0/8","193.175.135.38");
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="3.2.  sdp_mangle_port(offset)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="mangler.f.sdp_mangle_port"></a>3.2. 
	    <code class="function">sdp_mangle_port(offset)</code>
	</h3>
                </div>
              </div>
            </div>
            <p>
	    Changes ports in SDP document in lines starting a media section like
	    "m=audio 13451".
	</p>
            <p>
	    The function returns negative on error, or number of replacements + 1.
	</p>
            <p>Meaning of the parameters is as follows:</p>
            <div class="itemizedlist">
              <ul class="itemizedlist">
                <li class="listitem">
                  <p>
		    <span class="emphasis"><em>offset</em></span> - A string representing an
		    integer which will be added/subtracted from the located
		    port.
		</p>
                </li>
              </ul>
            </div>
            <div class="example">
              <a id="idp1362376"></a>
              <p class="title">
                <strong>Example 1.3. <code class="function">sdp_mangle_port</code> usage</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
sdp_mangle_port("-12000");
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="3.3.  encode_contact(encoding_prefix)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="mangler.f.encode_contact"></a>3.3. 
	    <code class="function">encode_contact(encoding_prefix)</code>
	</h3>
                </div>
              </div>
            </div>
            <p>
	    This function will encode URIs inside the "Contact" header in the
	    following manner "sip:username:password@ip:port;transport=protocol"
	    goes <span class="emphasis"><em>sip:enc_pref*username*ip*port*protocol@public_ip</em></span>.
	    "*" (asterisk) is the default separator.
	</p>
            <p>
	    The function returns negative on error, 1 on success.
	</p>
            <p>Meaning of the parameters is as follows:</p>
            <div class="itemizedlist">
              <ul class="itemizedlist">
                <li class="listitem">
                  <p>
		    <span class="emphasis"><em>encoding_prefix</em></span> - Something to allow
		    us to determine that a contact is encoded public IP--a
		    routable IP, most probably you should put your external IP
		    of your NAT box.
		</p>
                </li>
              </ul>
            </div>
            <div class="example">
              <a id="idp3093176"></a>
              <p class="title">
                <strong>Example 1.4. <code class="function">encode_contact</code> usage</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
if (src_ip == 10.0.0.0/8) encode_contact("enc_prefix","193.175.135.38"); 
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="3.4.  decode_contact()">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="mangler.f.decode_contact"></a>3.4. 
	    <code class="function">decode_contact()</code>
	</h3>
                </div>
              </div>
            </div>
            <p>
	    This function will decode the URI in first line in packets which
	    come with encoded URI in the following manner
	    <span class="emphasis"><em>
	    sip:enc_pref*username*ip*port*protocol*src_ip*src_port*src_proto@public_ip;parameters
	    </em></span>
	   is converted to
	    <span class="emphasis"><em>
	    sip:username:password@ip:port;parameters
	    </em></span>
	    and will set destination URI to 
	    <span class="emphasis"><em>
	    sip:src_ip:src_port;transport=src_proto
	    </em></span>
		(so that the next forward() or
		t_relay() will send the message back to src_ip:src_port using 
		src_proto). It uses the default set parameter for contact encoding 
		separator.
	</p>
            <p>
	    The function returns negative on error, 1 on success.
	</p>
            <div class="example">
              <a id="idp2530808"></a>
              <p class="title">
                <strong>Example 1.5. <code class="function">decode_contact</code> usage</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
if (uri =~ "^enc*") { decode_contact(); }
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="3.5.  decode_contact_header()">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="mangler.f.decode_contact_header"></a>3.5. 
	    <code class="function">decode_contact_header()</code>
	</h3>
                </div>
              </div>
            </div>
            <p>
	    This function will decode URIs inside the "Contact" header in the
	    same manner as decode_contact(). The difference is that no dst_uri is set
		 (src_ip, src_port and src_proto are ignored) and instead of changing
		 the request URI, the Contact header URI is modified.
		 It uses the default set parameter for contact encoding separator.
	</p>
            <p>
	    The function returns negative on error, 1 on success.
	</p>
            <div class="example">
              <a id="idp2533712"></a>
              <p class="title">
                <strong>Example 1.6. <code class="function">decode_contact_header</code> usage</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
if (uri =~ "^enc*") { decode_contact_header(); }
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
