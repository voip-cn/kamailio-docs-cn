<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>TM Module</title>
    <link rel="stylesheet" type="text/css" href="../../../../css/sr-doc.css" tppabs="http://kamailio.org/css/sr-doc.css" />
    <meta name="generator" content="DocBook XSL Stylesheets V1.76.1" />
    <link rel="home" href="#tm" title="TM Module" />
    <link rel="next" href="#idp15592560" title="Chapter 1. Admin Guide" />
  </head>
  <body>
    <div class="book" title="TM Module">
      <div class="titlepage">
        <div>
          <div>
            <h1 class="title"><a id="tm"></a>TM Module</h1>
          </div>
          <div>
            <div class="authorgroup">
              <div class="author">
                <h3 class="author"><span class="firstname">Jiri</span> <span class="surname">Kuthan</span></h3>
                <div class="affiliation">
                  <span class="orgname">FhG FOKUS<br /></span>
                </div>
              </div>
              <div class="author">
                <h3 class="author"><span class="firstname">Juha</span> <span class="surname">Heinanen</span></h3>
                <code class="email">&lt;<a class="email" href="mailto:jh@tutpro.com">jh@tutpro.com</a>&gt;</code>
              </div>
            </div>
          </div>
          <div>
            <p class="copyright">Copyright © 2003 FhG FOKUS</p>
          </div>
          <div>
            <p class="copyright">Copyright © 2008 Juha Heinanen</p>
          </div>
        </div>
        <hr />
      </div>
      <div class="toc">
        <p>
          <strong>Table of Contents</strong>
        </p>
        <dl>
          <dt>
            <span class="chapter">
              <a href="#idp15592560">1. Admin Guide</a>
            </span>
          </dt>
          <dd>
            <dl>
              <dt>
                <span class="section">
                  <a href="#tm.overview">1. Overview</a>
                </span>
              </dt>
              <dt>
                <span class="section">
                  <a href="#tm.serial_forking">2. Serial Forking Based on Q Value</a>
                </span>
              </dt>
              <dt>
                <span class="section">
                  <a href="#tm.known_issues">3. Known Issues</a>
                </span>
              </dt>
              <dt>
                <span class="section">
                  <a href="#tm.parameters">4. Parameters</a>
                </span>
              </dt>
              <dd>
                <dl>
                  <dt>
                    <span class="section">
                      <a href="#tm.p.fr_timer">4.1. <code class="varname">fr_timer</code> (integer)</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#tmp.p.fr_inv_timer">4.2. <code class="varname">fr_inv_timer</code> (integer)</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#tm.p.max_inv_lifetime">4.3. <code class="varname">max_inv_lifetime</code> (integer)</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#max_noninv_lifetime">4.4. <code class="varname">max_noninv_lifetime</code> (integer)</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#tm.p.wt_timer">4.5. <code class="varname">wt_timer</code> (integer)</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#tm.p.delete_timer">4.6. <code class="varname">delete_timer</code> (integer)</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#tm.p.retr_timer1">4.7. <code class="varname">retr_timer1</code> (integer)</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#tm.p.retr_timer2">4.8. <code class="varname">retr_timer2</code> (integer)</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#tm.p.noisy_ctimer">4.9. <code class="varname">noisy_ctimer</code> (integer)</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#tm.p.restart_fr_on_each_reply">4.10. <code class="varname">restart_fr_on_each_reply</code> (integer)</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#tm.p.auto_inv_100">4.11. <code class="varname">auto_inv_100</code> (integer)</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#tm.p.auto_inv_100_reason">4.12. <code class="varname">auto_inv_100_reason</code> (string)</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#tm.p.unix_tx_timeout">4.13. <code class="varname">unix_tx_timeout</code> (integer)</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#tm.p.aggregate_challenges">4.14. <code class="varname">aggregate_challenges</code> (integer)</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#tm.p.reparse_invite">4.15. <code class="varname">reparse_invite</code> (integer)</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#tm.p.ac_extra_hdrs">4.16. <code class="varname">ac_extra_hdrs</code> (string)</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#tm.p.blst_503">4.17. <code class="varname">blst_503</code> (integer)</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#tm.p.blst_503_def_timeout">4.18. <code class="varname">blst_503_def_timeout</code> (integer)</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#tm.p.blst_503_min_timeout">4.19. <code class="varname">blst_503_min_timeout</code> (integer)</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#tm.p.blst_503_max_timeout">4.20. <code class="varname">blst_503_max_timeout</code> (integer)</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#tm.p.blst_methods_add">4.21. <code class="varname">blst_methods_add</code> (unsigned integer)</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#tm.p.blst_methods_lookup">4.22. <code class="varname">blst_methods_lookup</code> (unsigned integer)</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#tm.p.cancel_b_method">4.23. <code class="varname">cancel_b_method</code> (integer)</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#tm.p.reparse_on_dns_failover">4.24. <code class="varname">reparse_on_dns_failover</code> (integer)</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#tm.p.on_sl_reply">4.25. <code class="varname">on_sl_reply</code> (string)</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#tm.p.contacts_avp">4.26. <code class="varname">contacts_avp</code> (string)</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#tm.p.contact_flows_avp">4.27. <code class="varname">contact_flows_avp</code> (string)</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#tm.p.fr_timer_avp">4.28. <code class="varname">fr_timer_avp</code> (string)</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#tm.p.fr_inv_timer_avp">4.29. <code class="varname">fr_inv_timer_avp</code> (string)</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#tm.p.unmatched_cancel">4.30. <code class="varname">unmatched_cancel</code> (string)</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#tm.p.ruri_matching">4.31. <code class="varname">ruri_matching</code> (integer)</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#tm.p.via1_matching">4.32. <code class="varname">via1_matching</code> (integer)</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#tm.p.callid_matching">4.33. <code class="varname">callid_matching</code> (integer)</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#tm.p.pass_provisional_replies">4.34. <code class="varname">pass_provisional_replies</code> (integer)</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#tm.p.default_code">4.35. <code class="varname">default_code</code> (integer)</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#tm.p.default_reason">4.36. <code class="varname">default_reason</code> (string)</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#tm.p.disable_6xx_block">4.37. <code class="varname">disable_6xx_block</code> (integer)</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#tm.p.local_ack_mode">4.38. <code class="varname">local_ack_mode</code> (integer)</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#tm.p.failure_reply_mode">4.39. <code class="varname">failure_reply_mode</code> (integer)</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#faked_reply_prio">4.40. <code class="varname">faked_reply_prio</code> (integer)</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#local_cancel_reason">4.41. <code class="varname">local_cancel_reason</code> (boolean)</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#e2e_cancel_reason">4.42. <code class="varname">e2e_cancel_reason</code> (boolean)</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#remap_503_500">4.43. <code class="varname">remap_503_500</code> (boolean)</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#tm.p.failure_exec_mode">4.44. <code class="varname">failure_exec_mode</code> (boolean)</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#tm.p.dns_reuse_rcv_socket">4.45. <code class="varname">dns_reuse_rcv_socket</code> (boolean)</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#tm.p.xavp_contact">4.46. <code class="varname">xavp_contact</code> (string)</a>
                    </span>
                  </dt>
                </dl>
              </dd>
              <dt>
                <span class="section">
                  <a href="#tm.functions">5. Functions</a>
                </span>
              </dt>
              <dd>
                <dl>
                  <dt>
                    <span class="section">
                      <a href="#tm.f.t_relay">5.1. 
	    <code class="function">t_relay([host, port])</code>
	</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#tm.f.t_relay_to_udp">5.2. 
	    <code class="function">t_relay_to_udp([ip, port])</code>
	</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#tm.f.t_relay_to_tcp">5.3. 
	    <code class="function">t_relay_to_tcp([ip, port])</code>
	</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#tm.f.t_relay_to_tls">5.4. 
	    <code class="function">t_relay_to_tls([ip, port])</code>
	</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#tm.f.t_relay_to_sctp">5.5. 
	    <code class="function">t_relay_to_sctp([ip, port])</code>
	</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#tm.f.t_on_failure">5.6. 
	    <code class="function">t_on_failure(failure_route)</code>
	</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#tm.f.t_on_branch_failure">5.7. 
	    <code class="function">t_on_branch_failure(branch_failure_route)</code>
	</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#tm.f.t_on_reply">5.8. 
	    <code class="function">t_on_reply(onreply_route)</code>
	</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#tm.f.t_on_branch">5.9. 
	    <code class="function">t_on_branch(branch_route)</code>
	</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#tm.f.t_newtran">5.10. 
	    <code class="function">t_newtran()</code>
	</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#tm.f.t_reply">5.11. 
	    <code class="function">t_reply(code, reason_phrase)</code>
	</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#tm.f.t_lookup_request">5.12. 
	    <code class="function">t_lookup_request()</code>
	</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#tm.f.t_retransmit_reply">5.13. 
	    <code class="function">t_retransmit_reply()</code>
	</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#tm.f.t_release">5.14. 
	    <code class="function">t_release()</code>
	</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#tm.f.t_forward_nonack">5.15. 
	    <code class="function">t_forward_nonack([ip, port])</code>
	</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#tm.f.t_forward_nonack_udp">5.16. 
	    <code class="function">t_forward_nonack_udp(ip, port)</code>
	</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#tm.f.t_forward_nonack_tcp">5.17. 
	    <code class="function">t_forward_nonack_tcp(ip, port)</code>
	</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#tm.f.t_forward_nonack_tls">5.18. 
	    <code class="function">t_forward_nonack_tls(ip, port)</code>
	</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#tm.f.t_forward_nonack_sctp">5.19. 
	    <code class="function">t_forward_nonack_sctp(ip, port)</code>
	</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#tm.f.t_set_fr">5.20. 
	    <code class="function">t_set_fr(fr_inv_timeout [, fr_timeout])</code>
	</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#tm.f.t_reset_fr">5.21. 
	    <code class="function">t_reset_fr()</code>
	</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#tm.f.t_set_max_lifetime">5.22. 
	    <code class="function">t_set_max_lifetime(inv_lifetime, noninv_lifetime)</code>
	</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#tm.f.t_reset_max_lifetime">5.23. 
	    <code class="function">t_reset_max_lifetime()</code>
	</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#tm.f.t_set_retr">5.24. 
	    <code class="function">t_set_retr(retr_t1_interval, retr_t2_interval)</code>
	</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#tm.f.t_reset_retr">5.25. 
	    <code class="function">t_reset_retr()</code>
	</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#tm.f.t_set_auto_inv_100">5.26. 
	    <code class="function">t_set_auto_inv_100(0|1)</code>
	</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#tm.f.t_branch_timeout">5.27. 
	    <code class="function">t_branch_timeout()</code>
	</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#tm.f.t_branch_replied">5.28. 
	    <code class="function">t_branch_replied()</code>
	</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#tm.f.t_any_timeout">5.29. 
	    <code class="function">t_any_timeout()</code>
	</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#tm.f.t_any_replied">5.30. 
	    <code class="function">t_any_replied()</code>
	</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#tm.f.t_grep_status">5.31. 
	    <code class="function">t_grep_status("code")</code>
	</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#tm.f.t_is_canceled">5.32. 
	    <code class="function">t_is_canceled()</code>
	</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#tm.f.t_is_expired">5.33. 
	    <code class="function">t_is_expired()</code>
	</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#tm.f.t_relay_cancel">5.34. 
	    <code class="function">t_relay_cancel()</code>
	</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#tm.f.t_lookup_cancel">5.35. 
	    <code class="function">t_lookup_cancel([1])</code>
	</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#tm.f.t_drop_replies">5.36. 
	    <code class="function">t_drop_replies([mode])</code>
	</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#tm.f.t_save_lumps">5.37. 
	    <code class="function">t_save_lumps()</code>
	</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#tm.f.t_load_contacts">5.38. 
		<code class="function">t_load_contacts()</code>
		</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#tm.f.t_next_contacts">5.39. 
		<code class="function">t_next_contacts()</code>
		</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#tm.f.t_next_contact_flow">5.40. 
		<code class="function">t_next_contact_flow()</code>
		</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#tm.f.t_check_status">5.41. 
		<code class="function">t_check_status(re)</code>
		</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#tm.f.t_check_trans">5.42. 
		<code class="function">t_check_trans()</code>
	</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#tm.f.t_set_disable_6xx">5.43. 
		<code class="function">t_set_disable_6xx(0|1)</code>
	</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#tm.f.t_set_disable_failover">5.44. 
		<code class="function">t_set_disable_failover(0|1)</code>
	</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#tm.f.t_set_disable_internal_reply">5.45. 
		<code class="function">t_set_disable_internal_reply(0|1)</code>
	</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#tm.f.t_replicate">5.46. 
	    <code class="function">t_replicate([params])</code>
	</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#tm.f.t_relay_to">5.47. 
	    <code class="function">t_relay_to(proxy, flags)</code>
	</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#tm.f.t_set_no_e2e_cancel_reason">5.48. 
		<code class="function">t_set_no_e2e_cancel_reason(0|1)</code>
	</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#tm.f.t_is_set">5.49. 
	    <code class="function">t_is_set(target)</code>
	</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#tm.f.t_use_uac_headers">5.50. 
	    <code class="function">t_use_uac_headers()</code>
	</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#tm.f.t_is_retr_async_reply">5.51. 
	    <code class="function">t_is_retr_async_reply()</code>
	</a>
                    </span>
                  </dt>
                </dl>
              </dd>
              <dt>
                <span class="section">
                  <a href="#tm.api">6. TM Module API</a>
                </span>
              </dt>
              <dd>
                <dl>
                  <dt>
                    <span class="section">
                      <a href="#defines">6.1. Defines</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#idp17059664">6.2. Functions</a>
                    </span>
                  </dt>
                  <dd>
                    <dl>
                      <dt>
                        <span class="section">
                          <a href="#idp16317296">6.2.1. 
		<code class="function">register_tmcb(cb_type, cb_func)</code>
	    </a>
                        </span>
                      </dt>
                      <dt>
                        <span class="section">
                          <a href="#load_tm">6.2.2. 
		<code class="function">load_tm(*import_structure)</code>
	    </a>
                        </span>
                      </dt>
                      <dt>
                        <span class="section">
                          <a href="#t_suspend">6.2.3. 
	    	<code class="function">int t_suspend(struct sip_msg *msg,
			unsigned int *hash_index, unsigned int *label)</code>
	    </a>
                        </span>
                      </dt>
                      <dt>
                        <span class="section">
                          <a href="#t_continue">6.2.4. 
		<code class="function">int t_continue(unsigned int hash_index, unsigned int label,
		                struct action *route)</code>
	    </a>
                        </span>
                      </dt>
                      <dt>
                        <span class="section">
                          <a href="#t_cancel_suspend">6.2.5. 
	    	<code class="function">int t_cancel_suspend(unsigned int hash_index, unsigned int label)</code>
	    </a>
                        </span>
                      </dt>
                    </dl>
                  </dd>
                </dl>
              </dd>
              <dt>
                <span class="section">
                  <a href="#tm.event_routes">7. Event Routes</a>
                </span>
              </dt>
              <dd>
                <dl>
                  <dt>
                    <span class="section">
                      <a href="#tm.e.branch-failure">7.1. 
	    <code class="function">event_route[tm:branch-failure]</code>
	</a>
                    </span>
                  </dt>
                </dl>
              </dd>
            </dl>
          </dd>
        </dl>
      </div>
      <div class="list-of-examples">
        <p>
          <strong>List of Examples</strong>
        </p>
        <dl>
          <dt>1.1. <a href="#idp17249768">Set <code class="varname">fr_timer</code> parameter</a></dt>
          <dt>1.2. <a href="#idp18599792">Set <code class="varname">fr_inv_timer</code> parameter</a></dt>
          <dt>1.3. <a href="#idp17283440">Set <code class="varname">max_inv_lifetime</code> parameter</a></dt>
          <dt>1.4. <a href="#idp17747464">Set <code class="varname">max_noninv_lifetime</code> parameter</a></dt>
          <dt>1.5. <a href="#idp16469216">Set <code class="varname">wt_timer</code> parameter</a></dt>
          <dt>1.6. <a href="#idp16769968">Set <code class="varname">delete_timer</code> parameter</a></dt>
          <dt>1.7. <a href="#idp16480888">Set <code class="varname">retr_timer1</code> parameter</a></dt>
          <dt>1.8. <a href="#idp17267400">Set <code class="varname">retr_timer2</code> parameter</a></dt>
          <dt>1.9. <a href="#idp17156600">Set <code class="varname">noisy_ctimer</code> parameter</a></dt>
          <dt>1.10. <a href="#idp18133264">Set <code class="varname">restart_fr_on_each_reply</code>
				parameter</a></dt>
          <dt>1.11. <a href="#idp18629032">Set <code class="varname">auto_inv_100</code> parameter</a></dt>
          <dt>1.12. <a href="#idp17372128">Set <code class="varname">auto_inv_100_reason</code> parameter</a></dt>
          <dt>1.13. <a href="#idp18732400">Set <code class="varname">unix_tx_timeout</code> parameter</a></dt>
          <dt>1.14. <a href="#idp18915736">Set <code class="varname">aggregate_challenges</code> parameter</a></dt>
          <dt>1.15. <a href="#idp18919784">Set <code class="varname">reparse_invite</code> parameter</a></dt>
          <dt>1.16. <a href="#idp18922752">Set <code class="varname">ac_extra_hdrs</code> parameter</a></dt>
          <dt>1.17. <a href="#idp18926640">Set <code class="varname">blst_503</code> parameter</a></dt>
          <dt>1.18. <a href="#idp18929608">Set <code class="varname">blst_503_def_timeout</code> parameter</a></dt>
          <dt>1.19. <a href="#idp15554248">Set <code class="varname">blst_503_min_timeout</code> parameter</a></dt>
          <dt>1.20. <a href="#idp15557576">Set <code class="varname">blst_503_max_timeout</code> parameter</a></dt>
          <dt>1.21. <a href="#idp15561120">Set <code class="varname">blst_methods_add</code> parameter</a></dt>
          <dt>1.22. <a href="#idp15563928">Set <code class="varname">blst_methods_lookup</code> parameter</a></dt>
          <dt>1.23. <a href="#idp15569616">Set <code class="varname">cancel_b_method</code> parameter</a></dt>
          <dt>1.24. <a href="#idp15573568">Set <code class="varname">reparse_on_dns_failover</code> parameter</a></dt>
          <dt>1.25. <a href="#idp15575888">Set <code class="varname">on_sl_reply</code> parameter</a></dt>
          <dt>1.26. <a href="#idp17410328">Set <code class="varname">contacts_avp</code> parameter</a></dt>
          <dt>1.27. <a href="#idp17414040">Set <code class="varname">contact_flows_avp</code> parameter</a></dt>
          <dt>1.28. <a href="#idp17419600">Set <code class="varname">fr_timer_avp</code> parameter</a></dt>
          <dt>1.29. <a href="#idp17425224">Set <code class="varname">fr_inv_timer_avp</code> parameter</a></dt>
          <dt>1.30. <a href="#idp17428304">Set <code class="varname">unmatched_cancel</code> parameter</a></dt>
          <dt>1.31. <a href="#idp17431904">Set <code class="varname">ruri_matching</code> parameter</a></dt>
          <dt>1.32. <a href="#idp17435504">Set <code class="varname">via1_matching</code> parameter</a></dt>
          <dt>1.33. <a href="#idp17439168">Set <code class="varname">callid_matching</code> parameter</a></dt>
          <dt>1.34. <a href="#idp17442376">Set <code class="varname">pass_provisional_replies</code> parameter
		</a></dt>
          <dt>1.35. <a href="#idp17445968">Set <code class="varname">default_code</code> parameter </a></dt>
          <dt>1.36. <a href="#idp17449552">Set <code class="varname">default_reason</code> parameter </a></dt>
          <dt>1.37. <a href="#idp17455368">Set <code class="varname">disable_6xx_block</code> parameter</a></dt>
          <dt>1.38. <a href="#idp17461792">Set <code class="varname">local_ack_mode</code> parameter</a></dt>
          <dt>1.39. <a href="#idp17468640">Set <code class="varname">failure_reply_mode</code> parameter</a></dt>
          <dt>1.40. <a href="#idp17473760">Set <code class="varname">faked_reply_prio</code> parameter</a></dt>
          <dt>1.41. <a href="#idp17477448">Set <code class="varname">local_cancel_reason</code> parameter</a></dt>
          <dt>1.42. <a href="#idp17481600">Set <code class="varname">e2e_cancel_reason</code> parameter</a></dt>
          <dt>1.43. <a href="#idp17484256">Set <code class="varname">remap_503_500</code> parameter</a></dt>
          <dt>1.44. <a href="#idp17486760">Set <code class="varname">failure_exec_mode</code> parameter</a></dt>
          <dt>1.45. <a href="#idp17490056">Set <code class="varname">dns_reuse_rcv_socket</code> parameter</a></dt>
          <dt>1.46. <a href="#idp17493160">Set <code class="varname">xavp_contact</code> parameter</a></dt>
          <dt>1.47. <a href="#idp15999232"><code class="function">t_relay</code> usage</a></dt>
          <dt>1.48. <a href="#idp16422760"><code class="function">t_relay_to_udp</code> usage</a></dt>
          <dt>1.49. <a href="#idp16752496"><code class="function">t_on_failure</code> usage</a></dt>
          <dt>1.50. <a href="#idp16188856"><code class="function">t_on_branch_failure</code> usage</a></dt>
          <dt>1.51. <a href="#idp16192576"><code class="function">t_on_reply</code> usage</a></dt>
          <dt>1.52. <a href="#idp16196568"><code class="function">t_on_branch</code> usage</a></dt>
          <dt>1.53. <a href="#idp16199208"><code class="function">t_newtran</code> usage</a></dt>
          <dt>1.54. <a href="#idp15809536"><code class="function">t_reply</code> usage</a></dt>
          <dt>1.55. <a href="#idp15812416"><code class="function">t_lookup_request</code> usage</a></dt>
          <dt>1.56. <a href="#idp15814752"><code class="function">t_retransmit_reply</code> usage</a></dt>
          <dt>1.57. <a href="#idp15817168"><code class="function">t_release</code> usage</a></dt>
          <dt>1.58. <a href="#idp15821160"><code class="function">t_forward_nonack</code> usage</a></dt>
          <dt>1.59. <a href="#idp18965872"><code class="function">t_set_fr</code> usage</a></dt>
          <dt>1.60. <a href="#idp18971192"><code class="function">t_reset_fr</code> usage</a></dt>
          <dt>1.61. <a href="#idp18977616"><code class="function">t_set_max_lifetime</code> usage</a></dt>
          <dt>1.62. <a href="#idp18982528"><code class="function">t_reset_max_lifetime</code> usage</a></dt>
          <dt>1.63. <a href="#idp18989608"><code class="function">t_set_retr</code> usage</a></dt>
          <dt>1.64. <a href="#idp18994856"><code class="function">t_reset_retr</code> usage</a></dt>
          <dt>1.65. <a href="#idp18997968"><code class="function">t_set_auto_inv_100</code> usage</a></dt>
          <dt>1.66. <a href="#idp19000904"><code class="function">t_branch_timeout</code> usage</a></dt>
          <dt>1.67. <a href="#idp19003896"><code class="function">t_branch_replied</code> usage</a></dt>
          <dt>1.68. <a href="#idp19006496"><code class="function">t_any_timeout</code> usage</a></dt>
          <dt>1.69. <a href="#idp19009152"><code class="function">t_any_replied</code> usage</a></dt>
          <dt>1.70. <a href="#idp19011688"><code class="function">t_grep_status</code> usage</a></dt>
          <dt>1.71. <a href="#idp19014168"><code class="function">t_is_canceled</code> usage</a></dt>
          <dt>1.72. <a href="#idp19016712"><code class="function">t_is_expired</code> usage</a></dt>
          <dt>1.73. <a href="#idp19020328"><code class="function">t_relay_cancel</code> usage</a></dt>
          <dt>1.74. <a href="#idp19024464"><code class="function">t_lookup_cancel</code> usage</a></dt>
          <dt>1.75. <a href="#idp19028112"><code class="function">t_drop_replies()</code> usage</a></dt>
          <dt>1.76. <a href="#idp19031752"><code class="function">t_save_lumps()</code> usage</a></dt>
          <dt>1.77. <a href="#idp19039128"><code class="function">t_load_contacts</code> usage</a></dt>
          <dt>1.78. <a href="#idp19046784"><code class="function">t_next_contacts</code> usage</a></dt>
          <dt>1.79. <a href="#idp19052320"><code class="function">t_next_contact_flow</code> usage</a></dt>
          <dt>1.80. <a href="#idp19057488"><code class="function">t_check_status</code> usage</a></dt>
          <dt>1.81. <a href="#idp19067984"><code class="function">t_check_trans</code> usage</a></dt>
          <dt>1.82. <a href="#idp19071816"><code class="function">t_set_disable_6xx</code> usage</a></dt>
          <dt>1.83. <a href="#idp19074696"><code class="function">t_set_disable_failover</code> usage</a></dt>
          <dt>1.84. <a href="#idp19077192"><code class="function">t_set_disable_internal_reply</code> usage</a></dt>
          <dt>1.85. <a href="#idp19122336"><code class="function">t_replicate</code> usage</a></dt>
          <dt>1.86. <a href="#idp19130912"><code class="function">t_relay_to</code> usage</a></dt>
          <dt>1.87. <a href="#idp19134504"><code class="function">t_set_no_e2e_cancel_reason</code> usage</a></dt>
          <dt>1.88. <a href="#idp19138928"><code class="function">t_replicate</code> usage</a></dt>
          <dt>1.89. <a href="#idp19141416"><code class="function">t_use_uac_headers</code> usage</a></dt>
          <dt>1.90. <a href="#idp19144216"><code class="function">t_is_retr_async_reply</code> usage</a></dt>
          <dt>1.91. <a href="#idp18461248"><code class="function">event_route[tm:branch-failure]</code> usage</a></dt>
        </dl>
      </div>
      <div class="chapter" title="Chapter 1. Admin Guide">
        <div class="titlepage">
          <div>
            <div>
              <h2 class="title"><a id="idp15592560"></a>Chapter 1. Admin Guide</h2>
            </div>
          </div>
        </div>
        <div class="toc">
          <p>
            <strong>Table of Contents</strong>
          </p>
          <dl>
            <dt>
              <span class="section">
                <a href="#tm.overview">1. Overview</a>
              </span>
            </dt>
            <dt>
              <span class="section">
                <a href="#tm.serial_forking">2. Serial Forking Based on Q Value</a>
              </span>
            </dt>
            <dt>
              <span class="section">
                <a href="#tm.known_issues">3. Known Issues</a>
              </span>
            </dt>
            <dt>
              <span class="section">
                <a href="#tm.parameters">4. Parameters</a>
              </span>
            </dt>
            <dd>
              <dl>
                <dt>
                  <span class="section">
                    <a href="#tm.p.fr_timer">4.1. <code class="varname">fr_timer</code> (integer)</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#tmp.p.fr_inv_timer">4.2. <code class="varname">fr_inv_timer</code> (integer)</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#tm.p.max_inv_lifetime">4.3. <code class="varname">max_inv_lifetime</code> (integer)</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#max_noninv_lifetime">4.4. <code class="varname">max_noninv_lifetime</code> (integer)</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#tm.p.wt_timer">4.5. <code class="varname">wt_timer</code> (integer)</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#tm.p.delete_timer">4.6. <code class="varname">delete_timer</code> (integer)</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#tm.p.retr_timer1">4.7. <code class="varname">retr_timer1</code> (integer)</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#tm.p.retr_timer2">4.8. <code class="varname">retr_timer2</code> (integer)</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#tm.p.noisy_ctimer">4.9. <code class="varname">noisy_ctimer</code> (integer)</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#tm.p.restart_fr_on_each_reply">4.10. <code class="varname">restart_fr_on_each_reply</code> (integer)</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#tm.p.auto_inv_100">4.11. <code class="varname">auto_inv_100</code> (integer)</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#tm.p.auto_inv_100_reason">4.12. <code class="varname">auto_inv_100_reason</code> (string)</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#tm.p.unix_tx_timeout">4.13. <code class="varname">unix_tx_timeout</code> (integer)</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#tm.p.aggregate_challenges">4.14. <code class="varname">aggregate_challenges</code> (integer)</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#tm.p.reparse_invite">4.15. <code class="varname">reparse_invite</code> (integer)</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#tm.p.ac_extra_hdrs">4.16. <code class="varname">ac_extra_hdrs</code> (string)</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#tm.p.blst_503">4.17. <code class="varname">blst_503</code> (integer)</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#tm.p.blst_503_def_timeout">4.18. <code class="varname">blst_503_def_timeout</code> (integer)</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#tm.p.blst_503_min_timeout">4.19. <code class="varname">blst_503_min_timeout</code> (integer)</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#tm.p.blst_503_max_timeout">4.20. <code class="varname">blst_503_max_timeout</code> (integer)</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#tm.p.blst_methods_add">4.21. <code class="varname">blst_methods_add</code> (unsigned integer)</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#tm.p.blst_methods_lookup">4.22. <code class="varname">blst_methods_lookup</code> (unsigned integer)</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#tm.p.cancel_b_method">4.23. <code class="varname">cancel_b_method</code> (integer)</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#tm.p.reparse_on_dns_failover">4.24. <code class="varname">reparse_on_dns_failover</code> (integer)</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#tm.p.on_sl_reply">4.25. <code class="varname">on_sl_reply</code> (string)</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#tm.p.contacts_avp">4.26. <code class="varname">contacts_avp</code> (string)</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#tm.p.contact_flows_avp">4.27. <code class="varname">contact_flows_avp</code> (string)</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#tm.p.fr_timer_avp">4.28. <code class="varname">fr_timer_avp</code> (string)</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#tm.p.fr_inv_timer_avp">4.29. <code class="varname">fr_inv_timer_avp</code> (string)</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#tm.p.unmatched_cancel">4.30. <code class="varname">unmatched_cancel</code> (string)</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#tm.p.ruri_matching">4.31. <code class="varname">ruri_matching</code> (integer)</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#tm.p.via1_matching">4.32. <code class="varname">via1_matching</code> (integer)</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#tm.p.callid_matching">4.33. <code class="varname">callid_matching</code> (integer)</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#tm.p.pass_provisional_replies">4.34. <code class="varname">pass_provisional_replies</code> (integer)</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#tm.p.default_code">4.35. <code class="varname">default_code</code> (integer)</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#tm.p.default_reason">4.36. <code class="varname">default_reason</code> (string)</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#tm.p.disable_6xx_block">4.37. <code class="varname">disable_6xx_block</code> (integer)</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#tm.p.local_ack_mode">4.38. <code class="varname">local_ack_mode</code> (integer)</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#tm.p.failure_reply_mode">4.39. <code class="varname">failure_reply_mode</code> (integer)</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#faked_reply_prio">4.40. <code class="varname">faked_reply_prio</code> (integer)</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#local_cancel_reason">4.41. <code class="varname">local_cancel_reason</code> (boolean)</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#e2e_cancel_reason">4.42. <code class="varname">e2e_cancel_reason</code> (boolean)</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#remap_503_500">4.43. <code class="varname">remap_503_500</code> (boolean)</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#tm.p.failure_exec_mode">4.44. <code class="varname">failure_exec_mode</code> (boolean)</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#tm.p.dns_reuse_rcv_socket">4.45. <code class="varname">dns_reuse_rcv_socket</code> (boolean)</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#tm.p.xavp_contact">4.46. <code class="varname">xavp_contact</code> (string)</a>
                  </span>
                </dt>
              </dl>
            </dd>
            <dt>
              <span class="section">
                <a href="#tm.functions">5. Functions</a>
              </span>
            </dt>
            <dd>
              <dl>
                <dt>
                  <span class="section">
                    <a href="#tm.f.t_relay">5.1. 
	    <code class="function">t_relay([host, port])</code>
	</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#tm.f.t_relay_to_udp">5.2. 
	    <code class="function">t_relay_to_udp([ip, port])</code>
	</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#tm.f.t_relay_to_tcp">5.3. 
	    <code class="function">t_relay_to_tcp([ip, port])</code>
	</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#tm.f.t_relay_to_tls">5.4. 
	    <code class="function">t_relay_to_tls([ip, port])</code>
	</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#tm.f.t_relay_to_sctp">5.5. 
	    <code class="function">t_relay_to_sctp([ip, port])</code>
	</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#tm.f.t_on_failure">5.6. 
	    <code class="function">t_on_failure(failure_route)</code>
	</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#tm.f.t_on_branch_failure">5.7. 
	    <code class="function">t_on_branch_failure(branch_failure_route)</code>
	</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#tm.f.t_on_reply">5.8. 
	    <code class="function">t_on_reply(onreply_route)</code>
	</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#tm.f.t_on_branch">5.9. 
	    <code class="function">t_on_branch(branch_route)</code>
	</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#tm.f.t_newtran">5.10. 
	    <code class="function">t_newtran()</code>
	</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#tm.f.t_reply">5.11. 
	    <code class="function">t_reply(code, reason_phrase)</code>
	</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#tm.f.t_lookup_request">5.12. 
	    <code class="function">t_lookup_request()</code>
	</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#tm.f.t_retransmit_reply">5.13. 
	    <code class="function">t_retransmit_reply()</code>
	</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#tm.f.t_release">5.14. 
	    <code class="function">t_release()</code>
	</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#tm.f.t_forward_nonack">5.15. 
	    <code class="function">t_forward_nonack([ip, port])</code>
	</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#tm.f.t_forward_nonack_udp">5.16. 
	    <code class="function">t_forward_nonack_udp(ip, port)</code>
	</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#tm.f.t_forward_nonack_tcp">5.17. 
	    <code class="function">t_forward_nonack_tcp(ip, port)</code>
	</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#tm.f.t_forward_nonack_tls">5.18. 
	    <code class="function">t_forward_nonack_tls(ip, port)</code>
	</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#tm.f.t_forward_nonack_sctp">5.19. 
	    <code class="function">t_forward_nonack_sctp(ip, port)</code>
	</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#tm.f.t_set_fr">5.20. 
	    <code class="function">t_set_fr(fr_inv_timeout [, fr_timeout])</code>
	</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#tm.f.t_reset_fr">5.21. 
	    <code class="function">t_reset_fr()</code>
	</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#tm.f.t_set_max_lifetime">5.22. 
	    <code class="function">t_set_max_lifetime(inv_lifetime, noninv_lifetime)</code>
	</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#tm.f.t_reset_max_lifetime">5.23. 
	    <code class="function">t_reset_max_lifetime()</code>
	</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#tm.f.t_set_retr">5.24. 
	    <code class="function">t_set_retr(retr_t1_interval, retr_t2_interval)</code>
	</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#tm.f.t_reset_retr">5.25. 
	    <code class="function">t_reset_retr()</code>
	</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#tm.f.t_set_auto_inv_100">5.26. 
	    <code class="function">t_set_auto_inv_100(0|1)</code>
	</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#tm.f.t_branch_timeout">5.27. 
	    <code class="function">t_branch_timeout()</code>
	</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#tm.f.t_branch_replied">5.28. 
	    <code class="function">t_branch_replied()</code>
	</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#tm.f.t_any_timeout">5.29. 
	    <code class="function">t_any_timeout()</code>
	</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#tm.f.t_any_replied">5.30. 
	    <code class="function">t_any_replied()</code>
	</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#tm.f.t_grep_status">5.31. 
	    <code class="function">t_grep_status("code")</code>
	</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#tm.f.t_is_canceled">5.32. 
	    <code class="function">t_is_canceled()</code>
	</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#tm.f.t_is_expired">5.33. 
	    <code class="function">t_is_expired()</code>
	</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#tm.f.t_relay_cancel">5.34. 
	    <code class="function">t_relay_cancel()</code>
	</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#tm.f.t_lookup_cancel">5.35. 
	    <code class="function">t_lookup_cancel([1])</code>
	</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#tm.f.t_drop_replies">5.36. 
	    <code class="function">t_drop_replies([mode])</code>
	</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#tm.f.t_save_lumps">5.37. 
	    <code class="function">t_save_lumps()</code>
	</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#tm.f.t_load_contacts">5.38. 
		<code class="function">t_load_contacts()</code>
		</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#tm.f.t_next_contacts">5.39. 
		<code class="function">t_next_contacts()</code>
		</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#tm.f.t_next_contact_flow">5.40. 
		<code class="function">t_next_contact_flow()</code>
		</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#tm.f.t_check_status">5.41. 
		<code class="function">t_check_status(re)</code>
		</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#tm.f.t_check_trans">5.42. 
		<code class="function">t_check_trans()</code>
	</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#tm.f.t_set_disable_6xx">5.43. 
		<code class="function">t_set_disable_6xx(0|1)</code>
	</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#tm.f.t_set_disable_failover">5.44. 
		<code class="function">t_set_disable_failover(0|1)</code>
	</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#tm.f.t_set_disable_internal_reply">5.45. 
		<code class="function">t_set_disable_internal_reply(0|1)</code>
	</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#tm.f.t_replicate">5.46. 
	    <code class="function">t_replicate([params])</code>
	</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#tm.f.t_relay_to">5.47. 
	    <code class="function">t_relay_to(proxy, flags)</code>
	</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#tm.f.t_set_no_e2e_cancel_reason">5.48. 
		<code class="function">t_set_no_e2e_cancel_reason(0|1)</code>
	</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#tm.f.t_is_set">5.49. 
	    <code class="function">t_is_set(target)</code>
	</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#tm.f.t_use_uac_headers">5.50. 
	    <code class="function">t_use_uac_headers()</code>
	</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#tm.f.t_is_retr_async_reply">5.51. 
	    <code class="function">t_is_retr_async_reply()</code>
	</a>
                  </span>
                </dt>
              </dl>
            </dd>
            <dt>
              <span class="section">
                <a href="#tm.api">6. TM Module API</a>
              </span>
            </dt>
            <dd>
              <dl>
                <dt>
                  <span class="section">
                    <a href="#defines">6.1. Defines</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#idp17059664">6.2. Functions</a>
                  </span>
                </dt>
                <dd>
                  <dl>
                    <dt>
                      <span class="section">
                        <a href="#idp16317296">6.2.1. 
		<code class="function">register_tmcb(cb_type, cb_func)</code>
	    </a>
                      </span>
                    </dt>
                    <dt>
                      <span class="section">
                        <a href="#load_tm">6.2.2. 
		<code class="function">load_tm(*import_structure)</code>
	    </a>
                      </span>
                    </dt>
                    <dt>
                      <span class="section">
                        <a href="#t_suspend">6.2.3. 
	    	<code class="function">int t_suspend(struct sip_msg *msg,
			unsigned int *hash_index, unsigned int *label)</code>
	    </a>
                      </span>
                    </dt>
                    <dt>
                      <span class="section">
                        <a href="#t_continue">6.2.4. 
		<code class="function">int t_continue(unsigned int hash_index, unsigned int label,
		                struct action *route)</code>
	    </a>
                      </span>
                    </dt>
                    <dt>
                      <span class="section">
                        <a href="#t_cancel_suspend">6.2.5. 
	    	<code class="function">int t_cancel_suspend(unsigned int hash_index, unsigned int label)</code>
	    </a>
                      </span>
                    </dt>
                  </dl>
                </dd>
              </dl>
            </dd>
            <dt>
              <span class="section">
                <a href="#tm.event_routes">7. Event Routes</a>
              </span>
            </dt>
            <dd>
              <dl>
                <dt>
                  <span class="section">
                    <a href="#tm.e.branch-failure">7.1. 
	    <code class="function">event_route[tm:branch-failure]</code>
	</a>
                  </span>
                </dt>
              </dl>
            </dd>
          </dl>
        </div>
        <div class="section" title="1. Overview">
          <div class="titlepage">
            <div>
              <div>
                <h2 class="title"><a id="tm.overview"></a>1. Overview</h2>
              </div>
            </div>
          </div>
          <p>
	    The <acronym class="acronym">TM</acronym> module enables stateful processing of SIP
	    transactions.  Stateful logic is costly in terms of memory and 
	    <acronym class="acronym">CPU</acronym>. The main use is services that
	    inherently need state. For example, transaction-based accounting
	    (module acc) needs to process transaction state as opposed to
	    individual messages. Any kind of forking must be implemented
	    transaction statefully. By using transaction states you trade
	    <acronym class="acronym">CPU</acronym> caused by retransmission processing for
	    memory. That only makes sense if <acronym class="acronym">CPU</acronym>
	    consumption per request is huge. For example, if you want to avoid
	    costly <acronym class="acronym">DNS</acronym> resolution for every retransmission
	    of a request to an unresolvable destination, use stateful
	    mode. Then, only the initial message burdens server by
	    <acronym class="acronym">DNS</acronym> queries, subsequent retransmissions will be
	    dropped and will not result in more processes blocked by
	    <acronym class="acronym">DNS</acronym> resolution. The price is more memory
	    consumption and higher processing latency.
	</p>
          <p>
	    From the admin's perspective, these are the major functions : t_relay,
	    t_relay_to_udp and t_relay_to_tcp. All of them setup transaction
	    state, absorb retransmissions from upstream, generate downstream
	    retransmissions and correlate replies to requests. t_relay forwards
	    to current URI (be it original request's URI or a URI changed by
	    some of URI-modifying functions, such as sethost). t_relay_to_udp
	    and t_relay_to_tcp forward to a specific address over UDP or TCP
	    respectively.
	</p>
          <p>
	    In general, if <acronym class="acronym">TM</acronym> is used, it copies clones of
	    received SIP messages in shared memory. That costs memory and
	    also <acronym class="acronym">CPU</acronym> time (memcpys, lookups, shmem locks,
	    etc.)  Note that non-<acronym class="acronym">TM</acronym> functions operate over
	    the received message in private memory, that means that any core
	    operations will have no effect on statefully processed messages
	    after creating the transactional state. For example, calling
	    record_route <span class="emphasis"><em>after</em></span> t_relay is pretty useless,
	    as the <acronym class="acronym">RR</acronym> is added to privately held message
	    whereas its <acronym class="acronym">TM</acronym> clone is being forwarded.
	</p>
          <p>
	    The <acronym class="acronym">TM</acronym> module is quite big and uneasy to program
	    --lots of mutexes, shared memory access, malloc and free, timers--you really
	    need to be careful when you do anything. To simplify
	    <acronym class="acronym">TM</acronym> programming, there is the instrument of
	    callbacks. The callback mechanisms allow programmers to register
	    their functions to a specific event. See t_hooks.h for a list of
	    possible events.
	</p>
          <p>
	    Other things programmers may want to know is UAC--it is a very
	    simplistic code which allows you to generate your own
	    transactions. Particularly useful for things like NOTIFYs or
	    <acronym class="acronym">IM</acronym> gateways. The UAC takes care of all the
	    transaction machinery: retransmissions, FR timeouts, forking, etc.
	    See t_uac prototype in uac.h for more details. If you want to see the
	    transaction result the code can register for a callback.
	</p>
          <div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;">
            <h3 class="title">Note</h3>
            <p>Several Kamailio TM module functions are now
		implemented in the TMX module: <span class="quote">“<span class="quote">modules_k/tmx</span>”</span>. Check
		it to see if what you are looking for is there.</p>
          </div>
        </div>
        <div class="section" title="2. Serial Forking Based on Q Value">
          <div class="titlepage">
            <div>
              <div>
                <h2 class="title"><a id="tm.serial_forking"></a>2. Serial Forking Based on Q Value</h2>
              </div>
            </div>
          </div>
          <p>
		A single SIP INVITE request may be forked to multiple destinations. We
		call the set of all such destinations a <span class="quote">“<span class="quote">destination set</span>”</span>.
		Individual elements within the destination sets are called branches.
		The script writer can add URIs to the destination set from the configuration
		file, or they can be loaded from the user location database. Each
		registered contact then becomes one branch in the destination set.
	  </p>
          <p>
		The default behavior of the <acronym class="acronym">TM</acronym> module, 
		if it encounters a SIP message with multiple branches in the destination
		set, is to forward the SIP message to all the branches in parallel.
		That means it sends the message to all the branch destinations before it
		waits for replies from any of them. This is the default behavior if you
		call <code class="function">t_relay()</code> and similar functions without
		any other arguments.
	  </p>
          <p>
		Another approach of handling multiple branches in a destination set is
		serial forking. When configured to do serial forking, the server takes
		the first branch out of the destination set, forwards the message to
		its destination and waits for a reply or timeout. Only after a reply
		has been received or a timeout occurred, the server takes another
		destination from the destination set and tries again, until it
		receives a positive final reply or until all branches from the
		destination set have been tried.
	  </p>
          <p>
		Yet another, more sophisticated, way of handling multiple branches is
		combined serial/parallel forking, where individual branches within the
		destination set are assigned priorities. The order in which individual
		branches are tried is then determined by their relative priority
		within the destination set. Branches can be tried sequentially in the
		descending priority order and all branches that have the same priority
		can be tried in parallel. Such combined serial/parallel forking can be
		achieved in the <acronym class="acronym">TM</acronym> module with the help of
		functions <code class="function">t_load_contacts()</code>
		and <code class="function">t_next_contacts()</code>.
	  </p>
          <p>
		Every branch in the destination set is assigned a priority number,
		also known as the <span class="quote">“<span class="quote">q value</span>”</span>. The q value is a floating 
		point number in a range 0 to 1.0. The higher the q value number, 
		the more priority is given to the particular branch in the destination set.
		Branches with q value 1.0 have maximum priority, such branches should be always
		be tried first in serial forking. Branches with q value 0 have the lowest
		priority and they should by tried after all other branches with higher
		priority in the destination set.
	  </p>
          <p>
		As an example, consider the following simple configuration file. When
		the server receives an INVITE, it creates four branches with
		usernames A through D and then forwards the request
		using <code class="function">t_relay()</code>:
	  </p>
          <pre class="programlisting">route {
  seturi("sip:a@example.com");
  append_branch("sip:b@example.com");
  append_branch("sip:c@example.com");
  append_branch("sip:d@example.com");

  t_relay();
  break;
}</pre>
          <p>
		With this configuration the server forwards the request to all four
		branches at once, performing parallel forking as described above. We did
		not set the q value for individual branches in this example but we can
		do that by slightly modifying the arguments given
		to <code class="function">append_branch()</code>:
	  </p>
          <pre class="programlisting">route {
  seturi("sip:a@example.com");
  append_branch("sip:b@example.com", "0.5");
  append_branch("sip:c@example.com", "0.5");
  append_branch("sip:d@example.com", "1.0");

  t_relay();
  break;
}</pre>
          <p>
		Here we assigned q value 0.5 to branches B and C and q value 1.0 to
		branch D. We did not specify any q value for branch A and in that case
		it is assumed that its q value is the lowest from all branches within
		the destination set. If you try to run this example again, you will
		figure out that nothing changed, <code class="function">t_relay()</code> still
		forward the message to all branches in parallel.
	  </p>
          <p>
		We now want to implement the combined serial/parallel forking. Branch
		D should be tried first, because its q value is 1.0. Branches B and C
		should be tried in parallel, but only after D finishes. Branch A
		should be tried after B and C finished, because its q value (the
		default) is the lowest of all. To do that, we need to introduce two
		new functions into our example and two tm module parameters:
	  </p>
          <pre class="programlisting">modparam("tm", "contacts_avp", "tm_contacts");
modparam("tm", "contact_flows_avp", "tm_contact_flows");

route {
  seturi("sip:a@example.com");
  append_branch("sip:b@example.com", "0.5");
  append_branch("sip:c@example.com", "0.5");
  append_branch("sip:d@example.com", "1.0");

  t_load_contacts();

  t_next_contacts();
  t_relay();
  break;
}</pre>
          <p>
		First of all, the tm module parameters are mandatory if the two new
		functions are used. Function <code class="function">t_load_contacts()</code>
		takes all branches from the destination set, sorts them according to
		their q values and stores them in the AVP configured in the modparam.
		The function also clears the destination set, which means that it
		removes all branches configured before
		with <code class="function">seturi()</code>
		and <code class="function">append_branch()</code>.
	  </p>
          <p>
		Function <code class="function">t_next_contacts()</code> takes the AVP created
		by the previous function and extract the branches with highest q
		values from it. In our example it is branch D. That branch is then put
		back into the destination set and when the script finally
		reaches <code class="function">t_relay()</code>, the destination set only
		contains branch D and the request will be forwarded there.
	  </p>
          <p>
		We achieved the first step of serial forking, but this is not
		sufficient. Now we also need to forward to other branches with lower
		priority values when branch D finishes. To do that, we need to extend
		the configuration file again and introduce a failure_route section:
		</p>
          <pre class="programlisting">modparam("tm", "contacts_avp", "tm_contacts");

route {
  seturi("sip:a@example.com");
  append_branch("sip:b@example.com", "0.5");
  append_branch("sip:c@example.com", "0.5");
  append_branch("sip:d@example.com", "1.0");

  t_load_contacts();

  t_next_contacts();
  t_on_failure("serial");
  t_relay();
  break;
}

failure_route["serial"]
{
  if (!t_next_contacts()) {
    exit;
  }

  t_on_failure("serial");
  t_relay();
}</pre>
          <p>
		The failure_route section will be executed when branch D finishes. It
		executes <code class="function">t_next_contacts()</code> again and this time
		the function retrieves branches B and C from the AVP and adds them to
		the destination set. Here we need to check the return value of the
		function, because a negative value indicates that there were no more
		branches, in that case the failure_route should just terminate and
		forward the response from branch D upstream.
	  </p>
          <p>
		If <code class="function">t_next_contact()</code> returns a positive value then
		we have more new branches to try and we need to setup the
		failure_route again and call <code class="function">t_relay()</code>. In our
		example the request will now be forwarded to branches B and C in
		paralell, because they were both added to the destination set
		by <code class="function">t_next_contacts()</code> at the same time.
	  </p>
          <p>
		When branches B and C finish, the failure_route block is executed
		again, this time <code class="function">t_next_contacts()</code> puts the final
		branch A into the destination set and <code class="function">t_relay()</code>
		forwards the request there.
	  </p>
          <p>
		And that's the whole example, we achieved combined serial/parallel
		forking based on the q value of individual branches. In real-world
		configuration files the script writer would need to check the return
		value of all functions and <code class="varname">restart_fr_on_each_reply</code>. 
		The destination set would not be configured directly in the configuration file, but
		can be retrieved from the user location database. In that
		case registered contacts will be stored in the destination set as
		branches and their q values (provided by UAs) will be used.
	  </p>
        </div>
        <div class="section" title="3. Known Issues">
          <div class="titlepage">
            <div>
              <div>
                <h2 class="title"><a id="tm.known_issues"></a>3. Known Issues</h2>
              </div>
            </div>
          </div>
          <div class="itemizedlist">
            <ul class="itemizedlist">
              <li class="listitem">
                <p>
		    Possibly, performance could be improved by not parsing
		    non-INVITEs, as they do not be replied with 100, and do not
		    result in ACK/CANCELs, and other things which take
		    parsing. However, we need to rethink whether we don't need
		    parsed headers later for something else. Remember, when we
		    now store a request in sh_mem, we can't apply any
		    pkg_mem operations to it any more. (that might be
		    redesigned too).
		</p>
              </li>
              <li class="listitem">
                <p>
		    Another performance improvement may be achieved by not
		    parsing CSeq in replies until reply branch matches branch
		    of an INVITE/CANCEL in transaction table.
		</p>
              </li>
              <li class="listitem">
                <p>
		    <code class="function">t_replicate</code> should be done more
		    cleanly--Vias, Routes, etc. should be removed from a
		    message prior to replicating it (well, does not matter any
		    longer so much as there is a new replication module).
		</p>
              </li>
            </ul>
          </div>
        </div>
        <div class="section" title="4. Parameters">
          <div class="titlepage">
            <div>
              <div>
                <h2 class="title"><a id="tm.parameters"></a>4. Parameters</h2>
              </div>
            </div>
          </div>
          <div class="section" title="4.1. fr_timer (integer)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="tm.p.fr_timer"></a>4.1. <code class="varname">fr_timer</code> (integer)</h3>
                </div>
              </div>
            </div>
            <p>
	    Timer which hits if no final reply for a request or ACK for a
	    negative INVITE reply arrives (in milliseconds).
	</p>
            <p>
	    Default value is 30000 ms (30 seconds).
	</p>
            <p>
		See also: <code class="function">t_set_fr()</code>,
				<code class="varname">max_noninv_lifetime</code>.
	</p>
            <div class="example">
              <a id="idp17249768"></a>
              <p class="title">
                <strong>Example 1.1. Set <code class="varname">fr_timer</code> parameter</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
modparam("tm", "fr_timer", 10000)
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="4.2. fr_inv_timer (integer)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="tmp.p.fr_inv_timer"></a>4.2. <code class="varname">fr_inv_timer</code> (integer)</h3>
                </div>
              </div>
            </div>
            <p>
	    Timer which hits if no final reply for an INVITE arrives after a
	    provisional message was received (in milliseconds).
	</p>
            <p>
	</p>
            <p>
		Note: This timer can be restarted when a provisional response is
		received. For more details see
		<code class="varname">restart_fr_on_each_reply</code>.
	</p>
            <p>
	    Default value is 120000 ms (120 seconds).
	</p>
            <p>
		See also: <code class="function">t_set_fr()</code>,
				<code class="varname">max_inv_lifetime</code>.
	</p>
            <div class="example">
              <a id="idp18599792"></a>
              <p class="title">
                <strong>Example 1.2. Set <code class="varname">fr_inv_timer</code> parameter</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
modparam("tm", "fr_inv_timer", 180000)
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="4.3. max_inv_lifetime (integer)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="tm.p.max_inv_lifetime"></a>4.3. <code class="varname">max_inv_lifetime</code> (integer)</h3>
                </div>
              </div>
            </div>
            <p>
		Maximum time an INVITE transaction is allowed to be active (in 
		milliseconds). After this interval has passed from the transaction
		creation, the transaction will be either moved into the wait state
		or in the final response retransmission state, irrespective of the
		transaction  <code class="varname">fr_inv_timer</code> and
		<code class="varname">fr_timer</code> values.
	</p>
            <p>
		An INVITE transaction will be kept in memory for maximum:
		<code class="varname">max_inv_lifetime</code>+<code class="varname">fr_timer</code>(from 
		the ACK to the final reply wait)+<code class="varname">wt_timer</code>.
	</p>
            <p>
		The main difference between this timer and 
		<code class="varname">fr_inv_timer</code> is that the 
		<code class="varname">fr_inv_timer</code> is per branch, while 
		<code class="varname">max_inv_lifetime</code> is per the whole transaction.
		Even on a per branch basis <code class="varname">fr_inv_timer</code> could be 
		restarted. For example, by default if 
		<code class="varname">restart_fr_on_each_reply</code> is not cleared, the 
		<code class="varname">fr_inv_timer</code> will be restarted for each received 
		provisional reply. Even if <code class="varname">restart_fr_on_each_reply</code>
		is not set the <code class="varname">fr_inv_timer</code> will still be restarted
		for each increasing reply (e.g. 180, 181, 182, ...). 
		Another example when a transaction can live substantially more than its
		<code class="varname">fr_inv_timer</code> and where
		<code class="varname">max_inv_lifetime</code> will help is when DNS failover is 
		used (each failed DNS destination can introduce a new branch).
	</p>
            <p>
		The default value is 180000 ms (180 seconds - the rfc3261 
		timer C value).
	</p>
            <p>
		See also: <code class="varname">max_noninv_lifetime</code>,
					<code class="function">t_set_max_lifetime()</code> (allows changing
					<code class="varname">max_inv_lifetime</code> on a per transaction
					basis),
					<code class="function">t_reset_max_lifetime</code>
					<code class="varname">fr_timer</code>,
					<code class="varname">wt_timer</code>,
					<code class="varname">restart_fr_on_each_reply</code>.
	</p>
            <div class="example">
              <a id="idp17283440"></a>
              <p class="title">
                <strong>Example 1.3. Set <code class="varname">max_inv_lifetime</code> parameter</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
modparam("tm", "max_inv_lifetime", 150000)
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="4.4. max_noninv_lifetime (integer)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="max_noninv_lifetime"></a>4.4. <code class="varname">max_noninv_lifetime</code> (integer)</h3>
                </div>
              </div>
            </div>
            <p>
		Maximum time a non-INVITE transaction is allowed to be active (in 
		milliseconds). After this interval has passed from the transaction
		creation, the transaction will be either moved into the wait state
		or in the final response retransmission state, irrespective of the
		transaction <code class="varname">fr_timer</code> value.
		It's the same as <code class="varname">max_inv_lifetime</code>, but for 
		non-INVITEs.
	</p>
            <p>
		A non-INVITE transaction will be kept in memory for a maximum of:
		<code class="varname">max_noninv_lifetime</code>+<code class="varname">wt_timer</code>.
	</p>
            <p>
		The main difference between this timer and 
		<code class="varname">fr_timer</code> is that the 
		<code class="varname">fr_timer</code> is per branch, while 
		<code class="varname">max_noninv_lifetime</code> is per the whole transaction.
		An example when a transaction can live substantially more then its
		<code class="varname">fr_timer</code> and where
		<code class="varname">max_noninv_lifetime</code> will help is when DNS failover
		is used (each failed DNS SRV destination can introduce a new branch).
	</p>
            <p>
		The default value is 32000 ms (32 seconds - the RFC3261 timer F value).
	</p>
            <p>
		See also: <code class="varname">max_inv_lifetime</code>,
					<code class="function">t_set_max_lifetime()</code> (allows changing
					<code class="varname">max_noninv_lifetime</code> on a per transaction
					basis),
					<code class="function">t_reset_max_lifetime</code>
					<code class="varname">fr_timer</code>,
					<code class="varname">wt_timer</code>.
	</p>
            <div class="example">
              <a id="idp17747464"></a>
              <p class="title">
                <strong>Example 1.4. Set <code class="varname">max_noninv_lifetime</code> parameter</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
modparam("tm", "max_noninv_lifetime", 30000)
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="4.5. wt_timer (integer)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="tm.p.wt_timer"></a>4.5. <code class="varname">wt_timer</code> (integer)</h3>
                </div>
              </div>
            </div>
            <p>
	    Time for which a transaction stays in memory to absorb delayed
	    messages after it completed (in milliseconds); also, when this 
	    timer hits,
	    retransmission of local CANCEL requests is stopped (a puristic but complex
	    behavior would be not to enter wait state until local branches are
	    finished by a final reply or FR timer--we simplified).
	</p>
            <p>
	    Default value is 5000 ms (5 seconds).
	</p>
            <div class="example">
              <a id="idp16469216"></a>
              <p class="title">
                <strong>Example 1.5. Set <code class="varname">wt_timer</code> parameter</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
modparam("tm", "wt_timer", 1000)
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="4.6. delete_timer (integer)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="tm.p.delete_timer"></a>4.6. <code class="varname">delete_timer</code> (integer)</h3>
                </div>
              </div>
            </div>
            <p>
	    Time after which a to-be-deleted transaction currently ref-ed by a
	    process will be tried to be deleted again (in milliseconds).
	</p>
            <p>
	    Note: this parameter is obsolete for SER 2.1 (in 2.1 the transaction
		 is deleted the moment it's not referenced anymore).
	</p>
            <p>
	    Default value is 200 milliseconds.
	</p>
            <div class="example">
              <a id="idp16769968"></a>
              <p class="title">
                <strong>Example 1.6. Set <code class="varname">delete_timer</code> parameter</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
modparam("tm", "delete_timer", 100)
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="4.7. retr_timer1 (integer)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="tm.p.retr_timer1"></a>4.7. <code class="varname">retr_timer1</code> (integer)</h3>
                </div>
              </div>
            </div>
            <p>
	    Initial retransmission period (in milliseconds).
	</p>
            <p>
	    Default value is 500 milliseconds.
	</p>
            <div class="example">
              <a id="idp16480888"></a>
              <p class="title">
                <strong>Example 1.7. Set <code class="varname">retr_timer1</code> parameter</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
modparam("tm", "retr_timer1", 1000)
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="4.8. retr_timer2 (integer)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="tm.p.retr_timer2"></a>4.8. <code class="varname">retr_timer2</code> (integer)</h3>
                </div>
              </div>
            </div>
            <p>
	    Maximum retransmission period (in milliseconds). The retransmission
		interval starts with <code class="varname">retr_timer1</code> and increases until
		it reaches this value. After this it stays constant at 
		<code class="varname">retr_timer2</code>.
	</p>
            <p>
	    Default value is 4000 milliseconds.
	</p>
            <div class="example">
              <a id="idp17267400"></a>
              <p class="title">
                <strong>Example 1.8. Set <code class="varname">retr_timer2</code> parameter</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
modparam("tm", "retr_timer2", 2000)
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="4.9. noisy_ctimer (integer)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="tm.p.noisy_ctimer"></a>4.9. <code class="varname">noisy_ctimer</code> (integer)</h3>
                </div>
              </div>
            </div>
            <p>
	    If set, INVITE transactions that time-out (FR INV timer) will be 
		always replied. If it's not set, the transaction has only one
		branch and no response was ever received on this branch, it 
		will be silently dropped (no 408 reply will be generated)
		This behavior is overridden if a request is forked, the transaction
		 has a failure route or callback, or some functionality explicitly 
		 turned it on  for a transaction (like the ACC module does to avoid unaccounted
		 transactions due to expired timer).
		Turn this off only if you know the client UACs will timeout and their
		timeout interval for INVITEs is lower or equal than tm's
		<code class="varname">fr_inv_timer</code>.
	</p>
            <p>
	    Default value is 1 (on).
	</p>
            <div class="example">
              <a id="idp17156600"></a>
              <p class="title">
                <strong>Example 1.9. Set <code class="varname">noisy_ctimer</code> parameter</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
modparam("tm", "noisy_ctimer", 1)
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="4.10. restart_fr_on_each_reply (integer)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="tm.p.restart_fr_on_each_reply"></a>4.10. <code class="varname">restart_fr_on_each_reply</code> (integer)</h3>
                </div>
              </div>
            </div>
            <p>
		If set (default), the <code class="varname">fr_inv_timer</code> for an INVITE
		transaction will be restarted for each provisional reply received
		(rfc3261 mandated behaviour). If not set, the 
		<code class="varname">fr_inv_timer</code> will be restarted only for the first
		provisional replies and for increasing replies greater or equal 180
		(e.g. 180, 181, 182, 185, ...).
	</p>
            <p>
		Setting it to 0 is especially useful when dealing with bad UAs that
		continuously retransmit 180s, not allowing the transaction to timeout 
		(and thus making impossible the implementation of certain services,
		like automatic voicemail after x seconds).
	</p>
            <p>
		Default value is 1 (on).
	</p>
            <p>
		See also: <code class="varname">fr_inv_timer</code>,
				<code class="varname">max_inv_lifetime</code>.
	</p>
            <div class="example">
              <a id="idp18133264"></a>
              <p class="title">
                <strong>Example 1.10. Set <code class="varname">restart_fr_on_each_reply</code>
				parameter</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
modparam("tm", "restart_fr_on_each_reply", 0)
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="4.11. auto_inv_100 (integer)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="tm.p.auto_inv_100"></a>4.11. <code class="varname">auto_inv_100</code> (integer)</h3>
                </div>
              </div>
            </div>
            <p>
		If set (default) tm will automatically send and 100 reply to INVITEs.
	</p>
            <p>
		Setting it to 0 can be used to enable first running some tests or
		pre-processing on the INVITE and only if some conditions are met
		manually send a 100 (using <code class="function">t_reply()</code>). Note 
		however that in this case all the 100s have to be sent "by hand".
		<code class="function">t_set_auto_inv_100()</code> might help to selectively
		turn off this feature only for some specific transactions.
	</p>
            <p>
		Default value is 1 (on).
	</p>
            <p>
		See also: <code class="function">t_set_auto_inv_100()</code>
				  <code class="varname">auto_inv_100_reason</code>. 
	</p>
            <div class="example">
              <a id="idp18629032"></a>
              <p class="title">
                <strong>Example 1.11. Set <code class="varname">auto_inv_100</code> parameter</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
modparam("tm", "auto_inv_100", 0)
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="4.12. auto_inv_100_reason (string)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="tm.p.auto_inv_100_reason"></a>4.12. <code class="varname">auto_inv_100_reason</code> (string)</h3>
                </div>
              </div>
            </div>
            <p>
		Set reason text of the automatically sent 100 to an INVITE.
	</p>
            <p>
		Default value is "trying -- your call is important to us".
	</p>
            <p>
		See also: <code class="varname">auto_inv_100</code>.
	</p>
            <div class="example">
              <a id="idp17372128"></a>
              <p class="title">
                <strong>Example 1.12. Set <code class="varname">auto_inv_100_reason</code> parameter</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
modparam("tm", "auto_inv_100_reason", "Trying")
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="4.13. unix_tx_timeout (integer)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="tm.p.unix_tx_timeout"></a>4.13. <code class="varname">unix_tx_timeout</code> (integer)</h3>
                </div>
              </div>
            </div>
            <p>
		Unix socket transmission timeout, in milliseconds.
	</p>
            <p>
		If UNIX sockets are used (e.g.: to communicate with sems) and sending
		a message on a UNIX socket takes longer than 
		<code class="varname">unix_tx_timeout</code>, the send will fail.
	</p>
            <p>
	    The default value is 500 milliseconds.
	</p>
            <div class="example">
              <a id="idp18732400"></a>
              <p class="title">
                <strong>Example 1.13. Set <code class="varname">unix_tx_timeout</code> parameter</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
modparam("tm", "unix_tx_timeout", 250)
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="4.14. aggregate_challenges (integer)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="tm.p.aggregate_challenges"></a>4.14. <code class="varname">aggregate_challenges</code> (integer)</h3>
                </div>
              </div>
            </div>
            <p>
		If set (default) and the final response is a 401 or a 407 and more than
		one branch received a 401 or 407, then all the WWW-Authenticate and 
		Proxy-Authenticate headers from all the 401 and 407 replies will 
		be aggregated in a new final response. If only one branch received the
		 winning 401 or 407 then this reply will be forwarded (no new one
		 will be built).
	</p>
            <p>
		If disabled (set to 0) only the first 401, or if no 401 was received the first 407,  will
		be forwarded (no header aggregation).
	</p>
            <p>
	    	Default value is 1 (required by RFC 3261).
	</p>
            <div class="example">
              <a id="idp18915736"></a>
              <p class="title">
                <strong>Example 1.14. Set <code class="varname">aggregate_challenges</code> parameter</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
modparam("tm", "aggregate_challenges", 0)
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="4.15. reparse_invite (integer)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="tm.p.reparse_invite"></a>4.15. <code class="varname">reparse_invite</code> (integer)</h3>
                </div>
              </div>
            </div>
            <p>
		If set (default), the CANCEL and negative ACK requests are
		constructed from the INVITE message which was sent out instead
		of building them from the received request. The disadvantage is
		that the outgoing INVITE has to be partially re-parsed, the advantage
		is that the CANCEL/ACK is always RFC 3261-compliant, it always
		contains the same route-set as the INVITE message. Do not disable
		the INVITE re-parsing for example in the following cases:
	</p>
            <p>
		- The INVITE contains a preloaded route-set, and Kamailio forwards
		the message to the next hop according to the "Route" header. The
		"Route" header is not removed in the CANCEL without
		<code class="varname">reparse_invite</code>=1.
	</p>
            <p>
		- Kamailio record-routes, thus an in-dialog INVITE contains a "Route"
		header which is removed during loose routing. If the in-dialog
		INVITE is rejected, the negative ACK still contains the "Route"
		header without <code class="varname">reparse_invite</code>=1.
	</p>
            <p>
	    Default value is 1.
	</p>
            <div class="example">
              <a id="idp18919784"></a>
              <p class="title">
                <strong>Example 1.15. Set <code class="varname">reparse_invite</code> parameter</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
modparam("tm", "reparse_invite", 0)
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="4.16. ac_extra_hdrs (string)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="tm.p.ac_extra_hdrs"></a>4.16. <code class="varname">ac_extra_hdrs</code> (string)</h3>
                </div>
              </div>
            </div>
            <p>
		Header fields prefixed by this parameter value are included
		in the CANCEL and negative ACK messages if they were present
		in the outgoing INVITE.
	</p>
            <p>
		Note, that the parameter value effects only those headers
		which are not covered by RFC 3261 (which are neither mandatory
		nor prohibited in CANCEL and ACK), and the parameter can be used
		only together with <code class="varname">reparse_invite</code>=1.
	</p>
            <p>
	    	Default value is "".
	</p>
            <div class="example">
              <a id="idp18922752"></a>
              <p class="title">
                <strong>Example 1.16. Set <code class="varname">ac_extra_hdrs</code> parameter</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
modparam("tm", "ac_extra_hdrs", "myfavoriteheaders-")
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="4.17. blst_503 (integer)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="tm.p.blst_503"></a>4.17. <code class="varname">blst_503</code> (integer)</h3>
                </div>
              </div>
            </div>
            <p>
		If set and the Kamailio blacklist support is enabled, every 503 reply source is
		added to the blacklist. The initial blacklist timeout (or ttl) depends
		on the presence of a "Retry-After" header in the reply and the values of
		the following tm parameters: <code class="varname">blst_503_def_timeout</code>, 
		<code class="varname">blst_503_min_timeout</code> and 
		<code class="varname">blst_503_max_timeout</code>.
	</p>
            <p>
		<span class="emphasis"><em>WARNING:</em></span>blindly allowing 503 blacklisting could 
		be very easily exploited for DOS attacks in most network setups.
	</p>
            <p>
		The default value is 0 (disabled due to the reasons above).
	</p>
            <div class="example">
              <a id="idp18926640"></a>
              <p class="title">
                <strong>Example 1.17. Set <code class="varname">blst_503</code> parameter</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
modparam("tm", "blst_503", 1)
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="4.18. blst_503_def_timeout (integer)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="tm.p.blst_503_def_timeout"></a>4.18. <code class="varname">blst_503_def_timeout</code> (integer)</h3>
                </div>
              </div>
            </div>
            <p>
		
		Blacklist interval in seconds for a 503 reply with no "Retry-After"
		header.
		See also <code class="varname">blst_503</code>, 
		<code class="varname">blst_503_min_timeout</code> and 
		<code class="varname">blst_503_max_timeout</code>.
	</p>
            <p>
		The default value is 0, which means that if no "Retry-After" header is
		present, the 503 reply source will not be blacklisted (RFC 3261 conformant
		 behaviour).
	</p>
            <div class="example">
              <a id="idp18929608"></a>
              <p class="title">
                <strong>Example 1.18. Set <code class="varname">blst_503_def_timeout</code> parameter</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
modparam("tm", "blst_503_def_timeout", 120)
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="4.19. blst_503_min_timeout (integer)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="tm.p.blst_503_min_timeout"></a>4.19. <code class="varname">blst_503_min_timeout</code> (integer)</h3>
                </div>
              </div>
            </div>
            <p>
		
		Minimum blacklist interval in seconds for a 503 reply with a 
		"Retry-After" header. It will be used if the "Retry-After" value is 
		smaller than this value.
	</p>
            <p>
		See also <code class="varname">blst_503</code>, 
		<code class="varname">blst_503_def_timeout</code> and 
		<code class="varname">blst_503_max_timeout</code>.
	</p>
            <p>
		The default value is 0 
	</p>
            <div class="example">
              <a id="idp15554248"></a>
              <p class="title">
                <strong>Example 1.19. Set <code class="varname">blst_503_min_timeout</code> parameter</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
modparam("tm", "blst_503_min_timeout", 30)
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="4.20. blst_503_max_timeout (integer)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="tm.p.blst_503_max_timeout"></a>4.20. <code class="varname">blst_503_max_timeout</code> (integer)</h3>
                </div>
              </div>
            </div>
            <p>
		
		Maximum blacklist interval in seconds for a 503 reply with a 
		"Retry-After header". It will be used if the "Retry-After" value is 
		greater than this limit.
	</p>
            <p>
		See also <code class="varname">blst_503</code>, 
		<code class="varname">blst_503_def_timeout</code> and 
		<code class="varname">blst_503_min_timeout</code>.
	</p>
            <p>
		The default value is 3600 
	</p>
            <div class="example">
              <a id="idp15557576"></a>
              <p class="title">
                <strong>Example 1.20. Set <code class="varname">blst_503_max_timeout</code> parameter</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
modparam("tm", "blst_503_max_timeout", 604800)
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="4.21. blst_methods_add (unsigned integer)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="tm.p.blst_methods_add"></a>4.21. <code class="varname">blst_methods_add</code> (unsigned integer)</h3>
                </div>
              </div>
            </div>
            <p>
		Bitmap of method types that trigger blacklisting on
		transaction timeouts. (This setting has no
		effect on blacklisting because of send failures.)
	</p>
            <p>
		The following values are associated to the request methods:
		INVITE=1, CANCEL=2, ACK=4 (not retransmitted, thus, never
		times-out), BYE=8, INFO=16, REGISTER=32, SUBSCRIBE=64,
		NOTIFY=126, OTHER=256 (all the unknown types).
		Check parser/msg_parser.h for farther details.
	</p>
            <p>
		Change the value carefully, because requests that doesn't get
		a provisional response (everything but INVITE) can easily
		cause the next hop to be inserted into the blacklist
		by mistake. For exmaple the next hop is a proxy, it is alive,
		but waiting for the response of the UAS, and has higher
		fr_timer value.
	</p>
            <p>
		The default value is 1, only INVITEs trigger blacklisting
	</p>
            <div class="example">
              <a id="idp15561120"></a>
              <p class="title">
                <strong>Example 1.21. Set <code class="varname">blst_methods_add</code> parameter</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
# INVITEs and REGISTERs trigger blacklisting
modparam("tm", "blst_methods_add", 33)
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="4.22. blst_methods_lookup (unsigned integer)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="tm.p.blst_methods_lookup"></a>4.22. <code class="varname">blst_methods_lookup</code> (unsigned integer)</h3>
                </div>
              </div>
            </div>
            <p>
		Bitmap of method types that are looked-up in the blacklist
		before being forwarded statefully.
		See also <code class="varname">blst_methods_add</code>
	</p>
            <p>
		The default value is 4294967287, every method type except BYE.
		(We try to deliver BYEs no matter what)
	</p>
            <div class="example">
              <a id="idp15563928"></a>
              <p class="title">
                <strong>Example 1.22. Set <code class="varname">blst_methods_lookup</code> parameter</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
# lookup only INVITEs
modparam("tm", "blst_methods_lookup", 1)
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="4.23. cancel_b_method (integer)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="tm.p.cancel_b_method"></a>4.23. <code class="varname">cancel_b_method</code> (integer)</h3>
                </div>
              </div>
            </div>
            <p>
		Method used when attempting to CANCEL an unreplied transaction branch
		(a branch where no response was received).
		The possible values are 0, 1, and 2.
	</p>
            <p>
		- <span class="emphasis"><em>0</em></span> will immediately stop the request (INVITE) 
		retransmission on the branch and it will behave as if the branch was 
		immediately replied with a 487 (a fake internal 487 reply). The 
		advantage is the unreplied branches will be terminated immediately.
		However it introduces a race risk with a possible slightly delayed
		 2xx reply. In this case we could have an UA receiving a 2xx after a
		 487. Moreover this risk is greatly amplified by packet loss
		(e.g. if an 180 is lost the branch will look as unreplied and
		 a CANCEL will silently drop the branch, but a 2xx can still come at
		 a later time). This is the behaviour for SER versions older than 2.1.
	</p>
            <p>
		- <span class="emphasis"><em>1</em></span> will keep retransmitting the request on 
		unreplied branches. If a provisional answer is received a CANCEL
		will be immediately sent back (attempting to quickly trigger a 487). 
		This approach is race free and avoids the 2xx after 487 problem, but
		 it's more resource intensive: faced with a branch towards and UA that
		 doesn't answer, a CANCEL attempt will keep the transaction alive for
		 the whole timeout interval (<code class="varname">fr_timer</code>).
	</p>
            <p>
		- <span class="emphasis"><em>2</em></span> will send and retransmit CANCEL even on 
		unreplied branches, stopping the request retransmissions. This has the
		same advantages as <span class="emphasis"><em>1</em></span> and also avoids the extra 
		roundtrip in the case of the provisional reply, but it's not RFC 3261 
		conforming (the RFC allows sending CANCELs only on pending branches).
	</p>
            <p>
		The default value is 1.
	</p>
            <div class="example">
              <a id="idp15569616"></a>
              <p class="title">
                <strong>Example 1.23. Set <code class="varname">cancel_b_method</code> parameter</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
modparam("tm", "cancel_b_method", 1)
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="4.24. reparse_on_dns_failover (integer)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="tm.p.reparse_on_dns_failover"></a>4.24. <code class="varname">reparse_on_dns_failover</code> (integer)</h3>
                </div>
              </div>
            </div>
            <p>
		If set to 1, the SIP message after a DNS failover is constructed
		from the outgoing message buffer of the failed branch instead of
		from the received request.
	</p>
            <p>
		It must be set if multiple branches are installed, the SIP message is
		modified differently in them, and at least one of them can result
		in DNS failover. If the parameter is not set the per-branch modifications
		are lost after the failover.
	</p>
            <p>
		Note: If the parameter is set, branch route block and TMCB_REQUEST_FWDED
		callback are not called in case of the failover.
	</p>
            <p>
		Disadvantage: only the via header is replaced in the message buffer, so
		the outgoing socket address is not corrected in any other part of the message.
		It is dangerous on multihomed hosts: when the new SIP request after
		the DNS failover is sent via different interface than the first request,
		the message can contain incorrect IP address in the Record-Route header.
	</p>
            <p>
		Default value is 1.
	</p>
            <div class="example">
              <a id="idp15573568"></a>
              <p class="title">
                <strong>Example 1.24. Set <code class="varname">reparse_on_dns_failover</code> parameter</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
modparam("tm", "reparse_on_dns_failover", 0)
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="4.25. on_sl_reply (string)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="tm.p.on_sl_reply"></a>4.25. <code class="varname">on_sl_reply</code> (string)</h3>
                </div>
              </div>
            </div>
            <p>
		Sets reply route block, to which control is passed when a
		reply is received that has no associated transaction.
		The reply is passed to the core for stateless forwarding after
		the route block execution unless it returns 0.
	</p>
            <div class="example">
              <a id="idp15575888"></a>
              <p class="title">
                <strong>Example 1.25. Set <code class="varname">on_sl_reply</code> parameter</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
modparam("tm", "on_sl_reply", "stateless_replies")
...

onreply_route["stateless_replies"] {
	# do not allow stateless replies to be forwarded
	return 0;
}</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="4.26. contacts_avp (string)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="tm.p.contacts_avp"></a>4.26. <code class="varname">contacts_avp</code> (string)</h3>
                </div>
              </div>
            </div>
            <p>
		This is the name of an XAVP that the 
		<code class="function">t_load_contacts()</code> function uses to
                store contacts of the destination set and that
                <code class="function">t_next_contacts()</code> function uses to
                restore those contacts.
		</p>
            <p>
		<span class="emphasis"><em>
			Default value is "NULL"
			(t_load_contacts()/t_next_contacts() functions
			are disabled).
		</em></span>
		</p>
            <div class="example">
              <a id="idp17410328"></a>
              <p class="title">
                <strong>Example 1.26. Set <code class="varname">contacts_avp</code> parameter</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
modparam("tm", "contacts_avp", "tm_contacts")
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="4.27. contact_flows_avp (string)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="tm.p.contact_flows_avp"></a>4.27. <code class="varname">contact_flows_avp</code> (string)</h3>
                </div>
              </div>
            </div>
            <p>
		This is the name of an XAVP
                that the <code class="function">t_next_contacts()</code> function uses to
                store contacts (if any) that it skipped, because they
		contained same +sip.instance value than some other contact,
                and that <code class="function">t_next_contact_flows()</code>
		function uses to restore those contacts.
		</p>
            <p>
		<span class="emphasis"><em>
			Default value is "NULL".  This parameter MUST be
			set if variable contacts_avp is set.
		</em></span>
		</p>
            <div class="example">
              <a id="idp17414040"></a>
              <p class="title">
                <strong>Example 1.27. Set <code class="varname">contact_flows_avp</code> parameter</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
modparam("tm", "contact_flows_avp", "tm_contact_flows")
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="4.28. fr_timer_avp (string)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="tm.p.fr_timer_avp"></a>4.28. <code class="varname">fr_timer_avp</code> (string)</h3>
                </div>
              </div>
            </div>
            <p>
			The value of fr_timer timer can be overriden on per-transaction
			basis. The administrator can provide a value to be used for a
			particular transaction in an AVP. This parameter contains the name
			of the AVP that will be checked. If the AVP exists then its value
			will be used for the fr_timer timer, effectively overriding the
			value configured in <code class="varname">fr_timer</code> parameter for the
			current transaction.
		</p>
            <div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;">
              <h3 class="title">Note</h3>
              <p>
			The value of the AVP is expected to be expressed in 
			<span class="emphasis"><em>seconds</em></span> and not milliseconds (unlike the rest
			of the timers).
		</p>
            </div>
            <p>
			This parameter is kept for backwards compatibility (hence its
			value expressed in seconds instead of milliseconds and its arcane
			way of specifying the avps). The recommended replacement is using
			<code class="function">t_set_fr()</code> on a per transaction basis.
		</p>
            <p>
			See also: <code class="function">t_set_fr()</code>,
			<code class="varname">fr_timer</code>.
		</p>
            <p>
			In Kamailio compatibility mode (defined by #!KAMAILIO), the value
			of the parameter must be the name of an AVP in pseudo-variable
			format: $avp(name). In SER compatibility mode it must be just
			AVP name.
		</p>
            <div class="example">
              <a id="idp17419600"></a>
              <p class="title">
                <strong>Example 1.28. Set <code class="varname">fr_timer_avp</code> parameter</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
# Kamailio mode
modparam("tm", "fr_timer_avp", "$avp(i:708)")
# Old SER mode
modparam("tm", "fr_timer_avp", "i:708")
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="4.29. fr_inv_timer_avp (string)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="tm.p.fr_inv_timer_avp"></a>4.29. <code class="varname">fr_inv_timer_avp</code> (string)</h3>
                </div>
              </div>
            </div>
            <p>
			The value of fr_inv_timer timer can be overriden on
			per-transaction basis. The administrator can provide a value to be
			used for a particular transaction in an AVP. This parameter
			contains the name of the AVP that will be checked. If the AVP
			exists, is non-empty and non-zero then its value will be used 
			for the fr_inv_timer timer, effectively overriding the value 
			configured in <code class="varname">fr_inv_timer</code> parameter for the
			current transaction.
		</p>
            <div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;">
              <h3 class="title">Note</h3>
              <p>
			The value of the AVP is expected to be expressed in
			<span class="emphasis"><em>seconds</em></span> and not milliseconds (unlike the rest
			of the timers).
		</p>
            </div>
            <p>
			This parameter is kept for backwards compatibility (hence its
			value expressed in seconds instead of milliseconds and its arcane
			way of specifying the avps). The recommended replacement is using
			<code class="function">t_set_fr()</code> on a per transaction basis.
		</p>
            <p>
			See also: <code class="function">t_set_fr()</code>,
			<code class="varname">fr_inv_timer</code>.
		</p>
            <p>
			In Kamailio compatibility mode (defined by #!KAMAILIO), the value
			of the parameter must be the name of an AVP in pseudo-variable
			format: $avp(name). In SER compatibility mode it must by just
			AVP name.
		</p>
            <div class="example">
              <a id="idp17425224"></a>
              <p class="title">
                <strong>Example 1.29. Set <code class="varname">fr_inv_timer_avp</code> parameter</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
# Kamailio mode
modparam("tm", "fr_inv_timer_avp", "$avp(my_fr_inv_timer)")
# Old SER mode
modparam("tm", "fr_inv_timer_avp", "my_fr_inv_timer")
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="4.30. unmatched_cancel (string)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="tm.p.unmatched_cancel"></a>4.30. <code class="varname">unmatched_cancel</code> (string)</h3>
                </div>
              </div>
            </div>
            <p>
			This parameter selects between forwarding CANCELs
			that do not match any transaction statefully (0,
			default value), statelessly (1) or dropping them
			(2). Note that the stateful forwarding has an
			additional hidden advantage: the tm module will be able to
			recognize INVITEs that arrive after their CANCEL.
			Note also that this feature could be used to try
			a memory exhaustion DOS attack against a proxy that
			authenticates all requests, by continuously flooding
			the victim with CANCELs to random destinations
			(since the CANCEL cannot be authenticated, each
			received bogus CANCEL will create a new transaction
			that will live by default 30s).
		</p>
            <p>
			Default value is 0.
		</p>
            <div class="example">
              <a id="idp17428304"></a>
              <p class="title">
                <strong>Example 1.30. Set <code class="varname">unmatched_cancel</code> parameter</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
modparam("tm", "unmatched_cancel", "2")
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="4.31. ruri_matching (integer)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="tm.p.ruri_matching"></a>4.31. <code class="varname">ruri_matching</code> (integer)</h3>
                </div>
              </div>
            </div>
            <p>
		If set the TM module will try to match the request URI when doing
		SIP 1.0 (pre-RFC 3261) transaction matching (the "Via" header branch parameter does
		not contain the 3261 cookie).
	</p>
            <p>
		The only reason to have it not set is for interoperability with old,
		broken implementations.
	</p>
            <p>
		Default value is 1 (on).
	</p>
            <p>
		Can be set at runtime, e.g.:
		</p>
            <pre class="programlisting">	$ kamcmd cfg.set_now_int tm ruri_matching 0</pre>
            <p>
	</p>
            <div class="example">
              <a id="idp17431904"></a>
              <p class="title">
                <strong>Example 1.31. Set <code class="varname">ruri_matching</code> parameter</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
modparam("tm", "ruri_matching", 1)
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="4.32. via1_matching (integer)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="tm.p.via1_matching"></a>4.32. <code class="varname">via1_matching</code> (integer)</h3>
                </div>
              </div>
            </div>
            <p>
		If set the TM module will try to match the topmost "Via" header when doing
		SIP 1.0 (pre-RFC 3261) transaction matching (the "Via" header branch parameter does
		not contain the 3261 cookie).
	</p>
            <p>
		The only reason to have it not set is for interoperability with old,
		broken implementations.
	</p>
            <p>
		Default value is 1 (on).
	</p>
            <p>
		Can be set at runtime, e.g.:
		</p>
            <pre class="programlisting">	$ kamcmd cfg.set_now_int tm via1_matching 0</pre>
            <p>
	</p>
            <div class="example">
              <a id="idp17435504"></a>
              <p class="title">
                <strong>Example 1.32. Set <code class="varname">via1_matching</code> parameter</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
modparam("tm", "via1_matching", 1)
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="4.33. callid_matching (integer)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="tm.p.callid_matching"></a>4.33. <code class="varname">callid_matching</code> (integer)</h3>
                </div>
              </div>
            </div>
            <p>
		If set the TM module will try to match the callid when doing
		transaction matching.
	</p>
            <p>
		Turn on if you don't want replies/requests from broken clients who
		send a mangled Call-ID to match the transaction. For example when
		the other side won't recognise the response anyway because of a changed
		Call-ID, this setting will prevent accounting records to be created
		or failure_route to be skipped.
	</p>
            <p>
		Default value is 0 (off).
	</p>
            <p>
		Can be set at runtime, e.g.:
		</p>
            <pre class="programlisting">	$ sercmd cfg.set_now_int tm callid_matching 0</pre>
            <p>
	</p>
            <div class="example">
              <a id="idp17439168"></a>
              <p class="title">
                <strong>Example 1.33. Set <code class="varname">callid_matching</code> parameter</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
modparam("tm", "callid_matching", 1)
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="4.34. pass_provisional_replies (integer)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="tm.p.pass_provisional_replies"></a>4.34. <code class="varname">pass_provisional_replies</code> (integer)</h3>
                </div>
              </div>
            </div>
            <p>
		If set, TMCB_LOCAL_REPONSE_OUT tm registered callbacks will be called
		also for provisional replies.
	</p>
            <p>
		Default value is 0 (off).
	</p>
            <p>
		Can be set at runtime, e.g.:
		</p>
            <pre class="programlisting">	$ kamcmd cfg.set_now_int tm pass_provisional_replies 1</pre>
            <p>
	</p>
            <div class="example">
              <a id="idp17442376"></a>
              <p class="title">
                <strong>Example 1.34. Set <code class="varname">pass_provisional_replies</code> parameter
		</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
modparam("tm", "pass_provisional_replies", 1)
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="4.35. default_code (integer)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="tm.p.default_code"></a>4.35. <code class="varname">default_code</code> (integer)</h3>
                </div>
              </div>
            </div>
            <p>
		Default response code sent by <code class="function">t_reply()</code> if it
		cannot retrieve its parameters (e.g. inexistent avp).
		Valid values are between 400 and 699.
	</p>
            <p>
		Default value is 500.
	</p>
            <p>
		Can be set at runtime, e.g.:
		</p>
            <pre class="programlisting">	$ kamcmd cfg.set_now_int tm default_code 505</pre>
            <p>
	</p>
            <div class="example">
              <a id="idp17445968"></a>
              <p class="title">
                <strong>Example 1.35. Set <code class="varname">default_code</code> parameter </strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
modparam("tm", "default_code", 501)
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="4.36. default_reason (string)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="tm.p.default_reason"></a>4.36. <code class="varname">default_reason</code> (string)</h3>
                </div>
              </div>
            </div>
            <p>
		Default SIP reason phrase sent by <code class="function">t_reply()</code> if it
		cannot retrieve its parameters (e.g. inexistent avp).
	</p>
            <p>
		Default value is "Server Internal Error".
	</p>
            <p>
		Can be set at runtime, e.g.:
		</p>
            <pre class="programlisting">	$ kamcmd cfg.set_now_string tm default_reason "Unknown error"</pre>
            <p>
	</p>
            <div class="example">
              <a id="idp17449552"></a>
              <p class="title">
                <strong>Example 1.36. Set <code class="varname">default_reason</code> parameter </strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
modparam("tm", "default_reason", "Unknown reason")
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="4.37. disable_6xx_block (integer)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="tm.p.disable_6xx_block"></a>4.37. <code class="varname">disable_6xx_block</code> (integer)</h3>
                </div>
              </div>
            </div>
            <p>
		If set the TM module will treat all the 6xx replies like normal replies 
		(warning: this would be non-RFC conformant behaviour).
	</p>
            <p>
		If not set (default) receiving a 6xx will cancel all the running
		parallel branches, will stop DNS failover and forking. However
		serial forking using <code class="function">append_branch()</code> in the
		<code class="function">failure_route</code> will still work.
	</p>
            <p>
		It can be overwritten on a per transaction basis using
		<code class="function">t_set_disable_6xx()</code>.
	</p>
            <p>
		Default value is 0 (off, rfc conformant behaviour).
	</p>
            <p>
		Can be set at runtime, e.g.:
		</p>
            <pre class="programlisting">	$ kamcmd cfg.set_now_int tm disable_6xx_block 0</pre>
            <p>
	</p>
            <p>
		See also: <code class="function">t_set_disable_6xx()</code>.
	</p>
            <div class="example">
              <a id="idp17455368"></a>
              <p class="title">
                <strong>Example 1.37. Set <code class="varname">disable_6xx_block</code> parameter</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
modparam("tm", "disable_6xx_block", 1)
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="4.38. local_ack_mode (integer)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="tm.p.local_ack_mode"></a>4.38. <code class="varname">local_ack_mode</code> (integer)</h3>
                </div>
              </div>
            </div>
            <p>
		This setting controls where locally generated ACKs for 2xx replies to local
		transactions (transactions created via <code class="function">t_uac*()</code>
		either through the TM api or via RPC/mi/fifo) are sent.
	</p>
            <p> It has 3 possible values:</p>
            <div class="itemizedlist">
              <ul class="itemizedlist">
                <li class="listitem">
                  <p>
		<span class="emphasis"><em>0</em></span> - the ACK destination is choosen according to
		the RFC: the next hop is found using the contact and the route set and
		then DNS resolution is used on it.
		</p>
                </li>
                <li class="listitem">
                  <p>
		<span class="emphasis"><em>1</em></span> - the ACK is sent to the same address as the
		corresponding INVITE branch.
		</p>
                </li>
                <li class="listitem">
                  <p>
		<span class="emphasis"><em>2</em></span> - the ACK is sent to the source of the 2xx
		reply.
		</p>
                </li>
              </ul>
            </div>
            <div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;">
              <h3 class="title">Note</h3>
              <p>
	Mode 1 and 2 does not follow RFC 3261, but are useful to deal with some simple UAs
	behind a NAT (no different routing for the ACK and the contact 
	contains an address behind the NAT).
	</p>
            </div>
            <p>
		The default value is 0 (RFC conformant behaviour).
	</p>
            <p>
		Can be set at runtime, e.g.:
		</p>
            <pre class="programlisting">	$ kamcmd cfg.set_now_int tm local_ack_mode 0</pre>
            <p>
	</p>
            <div class="example">
              <a id="idp17461792"></a>
              <p class="title">
                <strong>Example 1.38. Set <code class="varname">local_ack_mode</code> parameter</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
modparam("tm", "local_ack_mode", 1)
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="4.39. failure_reply_mode (integer)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="tm.p.failure_reply_mode"></a>4.39. <code class="varname">failure_reply_mode</code> (integer)</h3>
                </div>
              </div>
            </div>
            <p>
		This parameter controls how branches are managed and replies are selected for
		failure_route handling: keep all, drop all, drop last branches in
		SIP serial forking handling.
	</p>
            <p>
		To control per transaction see <code class="function">t_drop_replies()</code>.
	</p>
            <p> It has 4 possible values:</p>
            <div class="itemizedlist">
              <ul class="itemizedlist">
                <li class="listitem">
                  <p>
		<span class="emphasis"><em>0</em></span> - all branches are kept, no matter a new leg of
		serial forking has been started. Beware that if the new leg fails, you
		may get in failure_route a reply code from a branch of previous serial
		forking legs (e.g., if in first leg you got a 3xx, then you handled
		the redirection in failure route, sent to a new destination and this
		one timeout, you will get again the 3xx). Use t_drop_replies() on per
		transaction fashion to control the behavior you want. It is the
		default behaviour coming from SER 2.1.x.
		</p>
                </li>
                <li class="listitem">
                  <p>
		<span class="emphasis"><em>1</em></span> - all branches are discarded by default. You
		can still overwrite the behaviour via t_drop_replies()
		</p>
                </li>
                <li class="listitem">
                  <p>
		<span class="emphasis"><em>2</em></span> - by default only the branches of previous leg
		of serial forking are discarded
		</p>
                </li>
                <li class="listitem">
                  <p>
		<span class="emphasis"><em>3</em></span> - all previous branches are discarded if there
		is a new serial forking leg. This is the default behaviour coming from
		Kamailio 1.5.x. Use this mode if you don't want to handle in a per
		transaction fashion with t_drop_replies(). It ensures that you will
		get the winning reply from the branches of last serial forking step
		(e.g., if in first step you get 3xx, then you forward to a new
		destination, you will get in failure_route the reply coming from that
		destination or a local timeout).
		</p>
                </li>
              </ul>
            </div>
            <p>
		The default value is 3.
	</p>
            <div class="example">
              <a id="idp17468640"></a>
              <p class="title">
                <strong>Example 1.39. Set <code class="varname">failure_reply_mode</code> parameter</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
modparam("tm", "failure_reply_mode", 0)
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="4.40. faked_reply_prio (integer)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="faked_reply_prio"></a>4.40. <code class="varname">faked_reply_prio</code> (integer)</h3>
                </div>
              </div>
            </div>
            <p>
		It controls how branch selection is done. It allows to give a penalty
		to faked replies such as the infamous 408 on branch timeout.
	</p>
            <p>
		Internally, every reply is assigned a priority between 0 (high prio) 
		and 32000 (low prio). With this parameter the priority of fake replies
		can be adjusted.
	</p>
            <div class="itemizedlist">
              <ul class="itemizedlist">
                <li class="listitem">
                  <p>
		<span class="emphasis"><em>0</em></span> - disabled (default)
		</p>
                </li>
                <li class="listitem">
                  <p>
		<span class="emphasis"><em>&lt; 0</em></span> - priority is increased by given amount.
		</p>
                </li>
                <li class="listitem">
                  <p>
		<span class="emphasis"><em>&gt; 0</em></span> - priority is decreased by given amount.
		Do not make it higer than 10000 or faked replies will even loose
		from 1xx clsss replies.
		</p>
                </li>
              </ul>
            </div>
            <p>
		The default value is 0.
	</p>
            <p>
		To let received replies win from a locally generated 408, set this
		value to 2000.
	</p>
            <div class="example">
              <a id="idp17473760"></a>
              <p class="title">
                <strong>Example 1.40. Set <code class="varname">faked_reply_prio</code> parameter</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
modparam("tm", "faked_reply_prio", 2000)
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="4.41. local_cancel_reason (boolean)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="local_cancel_reason"></a>4.41. <code class="varname">local_cancel_reason</code> (boolean)</h3>
                </div>
              </div>
            </div>
            <p>
			Enables/disables adding reason headers (RFC 3326) for CANCELs
			generated due to receiving a final reply. The reason header added
			will look like: "Reason: SIP;cause=&lt;final_reply_code&gt;".
		</p>
            <p>
			Default value is 1 (enabled).
		</p>
            <p>
			Can be set at runtime, e.g.:
			</p>
            <pre class="programlisting">	$ kamcmd cfg.set_now_int tm local_cancel_reason 0</pre>
            <p>
		</p>
            <p>
			See also: <code class="varname">e2e_cancel_reason</code>.
		</p>
            <div class="example">
              <a id="idp17477448"></a>
              <p class="title">
                <strong>Example 1.41. Set <code class="varname">local_cancel_reason</code> parameter</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
modparam("tm", "local_cancel_reason", 0)
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="4.42. e2e_cancel_reason (boolean)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="e2e_cancel_reason"></a>4.42. <code class="varname">e2e_cancel_reason</code> (boolean)</h3>
                </div>
              </div>
            </div>
            <p>
			Enables/disables adding reason headers (RFC 3326) for CANCELs
			generated due to a received CANCEL.  If enabled the reason headers
			from received CANCELs will be copied into the generated hop-by-hop
			CANCELs.
		</p>
            <p>
			Default value is 1 (enabled).
		</p>
            <p>
			Can be changed at runtime, e.g.:
			</p>
            <pre class="programlisting">	$ kamcmd cfg.set_now_int tm e2e_cancel_reason 0</pre>
            <p>
		</p>
            <p>
			See also: <code class="function">t_set_no_e2e_cancel_reason()</code> and
						<code class="varname">local_cancel_reason</code>.
		</p>
            <div class="example">
              <a id="idp17481600"></a>
              <p class="title">
                <strong>Example 1.42. Set <code class="varname">e2e_cancel_reason</code> parameter</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
modparam("tm", "e2e_cancel_reason", 0)
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="4.43. remap_503_500 (boolean)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="remap_503_500"></a>4.43. <code class="varname">remap_503_500</code> (boolean)</h3>
                </div>
              </div>
            </div>
            <p>
			Enables/disables conversion of 503 response code to 500. By default
			it is enabled, based on the SIP RFC requirement. This is global
			setting for all received replies handled by TM. To do it per
			transaction basis, let this option disabled, set a failure route
			and then do t_reply("500", "...") inside it.
		</p>
            <p>
			Default value is 1 (enabled).
		</p>
            <div class="example">
              <a id="idp17484256"></a>
              <p class="title">
                <strong>Example 1.43. Set <code class="varname">remap_503_500</code> parameter</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
modparam("tm", "remap_503_500", 0)
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="4.44. failure_exec_mode (boolean)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="tm.p.failure_exec_mode"></a>4.44. <code class="varname">failure_exec_mode</code> (boolean)</h3>
                </div>
              </div>
            </div>
            <p>
			Add local failed branches in timer to be considered for failure
			routing blocks. If disabled, relay functions will return false
			in case the branch could not be forwarded (default behaviour
			before v4.1.0).
		</p>
            <p>
			Default value is 0 (disabled).
		</p>
            <div class="example">
              <a id="idp17486760"></a>
              <p class="title">
                <strong>Example 1.44. Set <code class="varname">failure_exec_mode</code> parameter</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
modparam("tm", "failure_exec_mode", 1)
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="4.45. dns_reuse_rcv_socket (boolean)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="tm.p.dns_reuse_rcv_socket"></a>4.45. <code class="varname">dns_reuse_rcv_socket</code> (boolean)</h3>
                </div>
              </div>
            </div>
            <p>
			Control reuse of the receive socket for additional branches added
			by <acronym class="acronym">DNS</acronym> failover. If set to 1, the receive socket is used for
			sending out the new branches, unless the socket is forced
			explicitely in configuration file. If set to 0, selected socket
			is done depending on value of global parameter "mhomed" (if mhomed=0,
			then the first listen socket is used, otherwise the socket is
			selected based on routing rules).
		</p>
            <p>
			Do enable it with caution, it might create troubles on DNS results
			with different transport layer. Better let it be disabled and enable
			"mhomed".
		</p>
            <p>
			Default value is 0 (disabled).
		</p>
            <div class="example">
              <a id="idp17490056"></a>
              <p class="title">
                <strong>Example 1.45. Set <code class="varname">dns_reuse_rcv_socket</code> parameter</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
modparam("tm", "dns_reuse_rcv_socket", 1)
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="4.46. xavp_contact (string)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="tm.p.xavp_contact"></a>4.46. <code class="varname">xavp_contact</code> (string)</h3>
                </div>
              </div>
            </div>
            <p>
		The name of XAVP storing the attributes per contact. This must be the same as
		the usrloc parameter <code class="varname">xavp_contacts</code>.
		</p>
            <p>
		<span class="emphasis"><em>
			Default value is <span class="quote">“<span class="quote">NULL</span>”</span>.
		</em></span>
		</p>
            <div class="example">
              <a id="idp17493160"></a>
              <p class="title">
                <strong>Example 1.46. Set <code class="varname">xavp_contact</code> parameter</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
modparam("tm|usrloc", "xavp_contact", "ulattrs")
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
        </div>
        <div class="section" title="5. Functions">
          <div class="titlepage">
            <div>
              <div>
                <h2 class="title"><a id="tm.functions"></a>5. Functions</h2>
              </div>
            </div>
          </div>
          <div class="section" title="5.1.  t_relay([host, port])">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="tm.f.t_relay"></a>5.1. 
	    <code class="function">t_relay([host, port])</code>
	</h3>
                </div>
              </div>
            </div>
            <p>
	    Relay a message statefully either to the destination indicated in the
		current URI (if called without any parameters) or to the specified 
		host and port. In the later case (host and port specified) the protocol
		used is the same protocol on which the message was received.
	</p>
            <p>
		<code class="function">t_relay()</code> is the statefull version for 
		<code class="function">forward()</code>
		while <code class="function">t_relay(host, port)</code> is similar to 
		<code class="function">forward(host, port)</code>.
	</p>
            <p>
		In the forward to uri case (<code class="function">t_relay()</code>), if the
	    original URI was rewritten (by UsrLoc, RR, strip/prefix, etc.) the new
		URI will be taken). The destination (including the protocol) is 
		determined from the uri, using SIP specific DNS resolving if needed
		(NAPTR, SRV a.s.o depending also on the dns options).
	</p>
            <p>
		Returns a negative value on failure -- you may still want to send a
	    negative reply upstream statelessly not to leave upstream UAC in lurch.
	</p>
            <div class="example">
              <a id="idp15999232"></a>
              <p class="title">
                <strong>Example 1.47. <code class="function">t_relay</code> usage</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
if (!t_relay()) 
{ 
    sl_reply_error(); 
    break; 
};
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="5.2.  t_relay_to_udp([ip, port])">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="tm.f.t_relay_to_udp"></a>5.2. 
	    <code class="function">t_relay_to_udp([ip, port])</code>
	</h3>
                </div>
              </div>
            </div>
            <p>
	    Relay a message statefully using a fixed protocol either to the 
		 specified fixed destination or to a destination derived from the 
		 message uri (if the host address and port are not specified).
		 These along with
	    <code class="function">t_relay</code> are the functions most users want to
	    use--all other are mostly for programming. Programmers interested
	    in writing <acronym class="acronym">TM</acronym> logic should review how t_relay is
	    implemented in tm.c and how <acronym class="acronym">TM</acronym> callbacks work.
	</p>
            <p>Meaning of the parameters is as follows:</p>
            <div class="itemizedlist">
              <ul class="itemizedlist">
                <li class="listitem">
                  <p><span class="emphasis"><em>ip</em></span> - IP address where the message should be sent.
		</p>
                </li>
                <li class="listitem">
                  <p><span class="emphasis"><em>port</em></span> - Port number.
		</p>
                </li>
              </ul>
            </div>
            <p>If no parameters are specified the message is sent to a destination
	 derived from the message uri (using sip sepcific DNS lookups), but with 
	 the protocol corresponding to the function name.</p>
            <div class="example">
              <a id="idp16422760"></a>
              <p class="title">
                <strong>Example 1.48. <code class="function">t_relay_to_udp</code> usage</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
if (src_ip==10.0.0.0/8)
	t_relay_to_udp("1.2.3.4", "5060"); # sent to 1.2.3.4:5060 over udp
else
	t_relay_to_tcp(); # relay to msg. uri, but over tcp
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="5.3.  t_relay_to_tcp([ip, port])">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="tm.f.t_relay_to_tcp"></a>5.3. 
	    <code class="function">t_relay_to_tcp([ip, port])</code>
	</h3>
                </div>
              </div>
            </div>
            <p>
		See function <code class="function">t_relay_to_udp([ip, port])</code>.
	</p>
          </div>
          <div class="section" title="5.4.  t_relay_to_tls([ip, port])">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="tm.f.t_relay_to_tls"></a>5.4. 
	    <code class="function">t_relay_to_tls([ip, port])</code>
	</h3>
                </div>
              </div>
            </div>
            <p>
		See function <code class="function">t_relay_to_udp([ip, port])</code>.
	</p>
          </div>
          <div class="section" title="5.5.  t_relay_to_sctp([ip, port])">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="tm.f.t_relay_to_sctp"></a>5.5. 
	    <code class="function">t_relay_to_sctp([ip, port])</code>
	</h3>
                </div>
              </div>
            </div>
            <p>
		See function <code class="function">t_relay_to_udp([ip, port])</code>.
	</p>
          </div>
          <div class="section" title="5.6.  t_on_failure(failure_route)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="tm.f.t_on_failure"></a>5.6. 
	    <code class="function">t_on_failure(failure_route)</code>
	</h3>
                </div>
              </div>
            </div>
            <p>
	    Sets failure routing block, to which control is passed after a
	    transaction completed with a negative result but before sending a
	    final reply. In the referred block, you can either start a new
	    branch (good for services such as forward_on_no_reply) or send a
	    final reply on your own (good for example for message silo, which
	    received a negative reply from upstream and wants to tell upstream
	    "202 I will take care of it"). Note that the set of
	    commands which are usable within failure_routes is strictly limited to
	    rewriting URI, initiating new branches, logging, and sending
	    stateful replies (<code class="function">t_reply</code>). Any other commands
	    may result in unpredictable behavior and possible server
	    failure. Note that whenever failure_route is entered, uri is reset to
	    value which it had on relaying. If it temporarily changed during a
	    reply_route processing, subsequent reply_route will ignore the
	    changed value and use again the original one.
	</p>
            <p>Meaning of the parameters is as follows:</p>
            <div class="itemizedlist">
              <ul class="itemizedlist">
                <li class="listitem">
                  <p><span class="emphasis"><em>failure_route</em></span> - Failure route block to be called.
		</p>
                </li>
              </ul>
            </div>
            <div class="example">
              <a id="idp16752496"></a>
              <p class="title">
                <strong>Example 1.49. <code class="function">t_on_failure</code> usage</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
route { 
    t_on_failure("1"); 
    t_relay(); 
} 

failure_route[1] {
    revert_uri(); 
    setuser("voicemail"); 
    append_branch(); 
}
...</pre>
              </div>
            </div>
            <br class="example-break" />
            <p>
	    See <code class="filename">test/onr.cfg</code> for a more complex example of
	    combination of serial with parallel forking.
	</p>
          </div>
          <div class="section" title="5.7.  t_on_branch_failure(branch_failure_route)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="tm.f.t_on_branch_failure"></a>5.7. 
	    <code class="function">t_on_branch_failure(branch_failure_route)</code>
	</h3>
                </div>
              </div>
            </div>
            <p>
	    Sets the branch_failure routing block, to which control is passed on each
	    negative response to a transaction. This route is run before deciding if
	    the transaction is complete. In the referred block, you can start a new
	    branch which is required for failover of multiple outbound flows (RFC 5626).
	    Note that the set of commands which are usable within a branch_failure route
	    is limited to a subset of the failure_rotue commands including logging,
	    rewriting URI and initiating new branches. Any other commands may generate
	    errors or result in unpredictable behavior.
	    Note that whenever failure_route is entered, uri is reset to
	    value which it had on relaying. If it temporarily changed during a
	    reply_route processing, subsequent reply_route will ignore the
	    changed value and use again the original one.
	</p>
            <p>Function Parameters:</p>
            <div class="itemizedlist">
              <ul class="itemizedlist">
                <li class="listitem">
                  <p><span class="emphasis"><em>branch_failure_route</em></span> - Name of the branch_failure route
			block to be called (it is prefixed internally with 'tm:branch-failure:').
		</p>
                </li>
              </ul>
            </div>
            <div class="example">
              <a id="idp16188856"></a>
              <p class="title">
                <strong>Example 1.50. <code class="function">t_on_branch_failure</code> usage</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
route {
    t_on_branch_failure("myroute");
    t_relay();
}

event_route[tm:branch-failure:myroute] {
    if (t_check_status("430|403") {
        unregister("location", "$tu", "$T_reply_ruid");
    }
}
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="5.8.  t_on_reply(onreply_route)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="tm.f.t_on_reply"></a>5.8. 
	    <code class="function">t_on_reply(onreply_route)</code>
	</h3>
                </div>
              </div>
            </div>
            <p>
	    Sets the reply routing block, to which control is passed when a
	    reply for the current transaction is received.
	    Note that the set of commands which are usable within onreply_routes is
	     limited.
	</p>
            <p>Meaning of the parameters is as follows:</p>
            <div class="itemizedlist">
              <ul class="itemizedlist">
                <li class="listitem">
                  <p><span class="emphasis"><em>onreply_route</em></span> - Onreply route block to be
			called.
		</p>
                </li>
              </ul>
            </div>
            <div class="example">
              <a id="idp16192576"></a>
              <p class="title">
                <strong>Example 1.51. <code class="function">t_on_reply</code> usage</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
loadmodule "/usr/local/lib/ser/modules/nathelper.so"
...
route { 
	/* if natted */
	t_on_reply("1"); 
	t_relay(); 
} 

onreply_route[1] {
	if (status=~ "(183)|2[0-9][0-9]"){
		force_rtp_proxy();
		search_append('^(Contact|m)[ \t]*:.*sip:[^&gt;[:cntrl:]]*', ';nat=yes');
	}
	if (nat_uac_test("1")){
		fix_nated_contact();
	}
}</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="5.9.  t_on_branch(branch_route)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="tm.f.t_on_branch"></a>5.9. 
	    <code class="function">t_on_branch(branch_route)</code>
	</h3>
                </div>
              </div>
            </div>
            <p>
	    Sets the branch routing block, to which control is passed after
	    forking (when a new branch is created). For now branch routes
	    are intended only for last minute changes of the SIP messages
	    (like adding new headers).
	    Note that the set of commands which are usable within branch_routes is
	    very limited. It is not possible to generate a reply.
	</p>
            <p>Meaning of the parameters is as follows:</p>
            <div class="itemizedlist">
              <ul class="itemizedlist">
                <li class="listitem">
                  <p><span class="emphasis"><em>branch_route</em></span> - branch route block to be
			called.
		</p>
                </li>
              </ul>
            </div>
            <div class="example">
              <a id="idp16196568"></a>
              <p class="title">
                <strong>Example 1.52. <code class="function">t_on_branch</code> usage</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
route { 
	t_on_branch("1"); 
	t_relay(); 
} 

branch_route[1] {
	if (uri=~"sip:[0-9]+"){
		append_hf("P-Warn: numeric uri\r\n");
	}
}</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="5.10.  t_newtran()">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="tm.f.t_newtran"></a>5.10. 
	    <code class="function">t_newtran()</code>
	</h3>
                </div>
              </div>
            </div>
            <p>
	    Creates a new transaction, returns a negative value on error. This
	    is the only way a script can add a new transaction in an atomic
	    way. Typically, it is used to deploy a UAS.
	</p>
            <div class="example">
              <a id="idp16199208"></a>
              <p class="title">
                <strong>Example 1.53. <code class="function">t_newtran</code> usage</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
if (t_newtran()) { 
    log("UAS logic"); 
    t_reply("999","hello"); 
} else sl_reply_error();
...</pre>
              </div>
            </div>
            <br class="example-break" />
            <p>
	    See test/uas.cfg for more examples.
	</p>
          </div>
          <div class="section" title="5.11.  t_reply(code, reason_phrase)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="tm.f.t_reply"></a>5.11. 
	    <code class="function">t_reply(code, reason_phrase)</code>
	</h3>
                </div>
              </div>
            </div>
            <p>
	    Sends a stateful reply after a transaction has been
	    established. See <code class="function">t_newtran</code> for usage.
	</p>
            <p>
		If the code is in the range 300-399 (redirect reply), the current
		destination set is appended to the reply as Contact headers.
		The destination set contains the request URI (R-URI), if it is
		modified compared to the received one, plus the branches added to the
		request (e.g., after an append_branch() or lookup("location")).
		If the R-URI was changed but it is not desired to be part of the
		destination set, it can be reverted using the function revert_uri().
	</p>
            <p>
		Custom headers to the reply can be added using append_to_reply()
		function from textops module.
	</p>
            <p>Meaning of the parameters is as follows:</p>
            <div class="itemizedlist">
              <ul class="itemizedlist">
                <li class="listitem">
                  <p><span class="emphasis"><em>code</em></span> - Reply code number.
		</p>
                </li>
                <li class="listitem">
                  <p><span class="emphasis"><em>reason_phrase</em></span> - Reason string.
		</p>
                </li>
              </ul>
            </div>
            <div class="example">
              <a id="idp15809536"></a>
              <p class="title">
                <strong>Example 1.54. <code class="function">t_reply</code> usage</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
t_reply("404", "Not found");
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="5.12.  t_lookup_request()">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="tm.f.t_lookup_request"></a>5.12. 
	    <code class="function">t_lookup_request()</code>
	</h3>
                </div>
              </div>
            </div>
            <p>
	    Checks if a transaction exists. Returns a positive value if so,
	    negative otherwise.  Most likely you will not want to use it, as a
	    typical application of a look-up is to introduce a new transaction
	    if none was found. However this is safely (atomically) done using
	    <code class="function">t_newtran</code>.
	</p>
            <div class="example">
              <a id="idp15812416"></a>
              <p class="title">
                <strong>Example 1.55. <code class="function">t_lookup_request</code> usage</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
if (t_lookup_request()) {
    ...
};
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="5.13.  t_retransmit_reply()">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="tm.f.t_retransmit_reply"></a>5.13. 
	    <code class="function">t_retransmit_reply()</code>
	</h3>
                </div>
              </div>
            </div>
            <p>
	    Retransmits a reply sent previously by UAS transaction.
	</p>
            <div class="example">
              <a id="idp15814752"></a>
              <p class="title">
                <strong>Example 1.56. <code class="function">t_retransmit_reply</code> usage</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
t_retransmit_reply();
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="5.14.  t_release()">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="tm.f.t_release"></a>5.14. 
	    <code class="function">t_release()</code>
	</h3>
                </div>
              </div>
            </div>
            <p>
	    Remove transaction from memory (it will be first put on a wait
	    timer to absorb delayed messages).
	</p>
            <div class="example">
              <a id="idp15817168"></a>
              <p class="title">
                <strong>Example 1.57. <code class="function">t_release</code> usage</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
t_release();
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="5.15.  t_forward_nonack([ip, port])">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="tm.f.t_forward_nonack"></a>5.15. 
	    <code class="function">t_forward_nonack([ip, port])</code>
	</h3>
                </div>
              </div>
            </div>
            <p>
		Mainly for internal usage -- forward a non-ACK request statefully.
		Variants of this functions can enforce a specific transport protocol.
	</p>
            <p>Meaning of the parameters is as follows:</p>
            <div class="itemizedlist">
              <ul class="itemizedlist">
                <li class="listitem">
                  <p><span class="emphasis"><em>ip</em></span> - IP address where the message should be sent.
		</p>
                </li>
                <li class="listitem">
                  <p><span class="emphasis"><em>port</em></span> - Port number.
		</p>
                </li>
              </ul>
            </div>
            <div class="example">
              <a id="idp15821160"></a>
              <p class="title">
                <strong>Example 1.58. <code class="function">t_forward_nonack</code> usage</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
t_forward_nonack("1.2.3.4", "5060");
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="5.16.  t_forward_nonack_udp(ip, port)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="tm.f.t_forward_nonack_udp"></a>5.16. 
	    <code class="function">t_forward_nonack_udp(ip, port)</code>
	</h3>
                </div>
              </div>
            </div>
            <p>
	    See function <code class="function">t_forward_nonack([ip, port])</code>.
	</p>
          </div>
          <div class="section" title="5.17.  t_forward_nonack_tcp(ip, port)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="tm.f.t_forward_nonack_tcp"></a>5.17. 
	    <code class="function">t_forward_nonack_tcp(ip, port)</code>
	</h3>
                </div>
              </div>
            </div>
            <p>
	    See function <code class="function">t_forward_nonack([ip, port])</code>.
	</p>
          </div>
          <div class="section" title="5.18.  t_forward_nonack_tls(ip, port)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="tm.f.t_forward_nonack_tls"></a>5.18. 
	    <code class="function">t_forward_nonack_tls(ip, port)</code>
	</h3>
                </div>
              </div>
            </div>
            <p>
	    See function <code class="function">t_forward_nonack([ip, port])</code>.
	</p>
          </div>
          <div class="section" title="5.19.  t_forward_nonack_sctp(ip, port)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="tm.f.t_forward_nonack_sctp"></a>5.19. 
	    <code class="function">t_forward_nonack_sctp(ip, port)</code>
	</h3>
                </div>
              </div>
            </div>
            <p>
	    See function <code class="function">t_forward_nonack([ip, port])</code>.
	</p>
          </div>
          <div class="section" title="5.20.  t_set_fr(fr_inv_timeout [, fr_timeout])">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="tm.f.t_set_fr"></a>5.20. 
	    <code class="function">t_set_fr(fr_inv_timeout [, fr_timeout])</code>
	</h3>
                </div>
              </div>
            </div>
            <p>
		Sets the fr_inv_timeout and optionally fr_timeout for the current
		transaction or for transactions created during the same script 
		invocation, after calling this function.
		If the transaction is already created (e.g called after
		 <code class="function">t_relay()</code> or in an onreply_route) all the
		 branches will have their final response timeout updated on-the-fly.
		If one of the parameters is 0, its value won't be changed.
	</p>
            <p>Meaning of the parameters is as follows:</p>
            <div class="itemizedlist">
              <ul class="itemizedlist">
                <li class="listitem">
                  <p><span class="emphasis"><em>fr_inv_timeout</em></span> - new final response timeout
			(in milliseconds) for INVITEs. See also 
			<code class="varname">fr_inv_timer</code>.
		</p>
                  <p><span class="emphasis"><em>fr_timeout</em></span> - new final response timeout
		 	(in milliseconds) for non-INVITE transaction, or INVITEs which 
			haven't received yet a provisional response. See also
			<code class="varname">fr_timer</code>.
		</p>
                </li>
              </ul>
            </div>
            <p>
		See also: 
			<code class="varname">fr_timer</code>,
			<code class="varname">fr_inv_timer</code>,
			<code class="function">t_reset_fr()</code>.
	</p>
            <div class="example">
              <a id="idp18965872"></a>
              <p class="title">
                <strong>Example 1.59. <code class="function">t_set_fr</code> usage</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
route { 
	t_set_fr(10000); # set only fr invite timeout to 10s
	t_on_branch("1");
	t_relay(); 
} 

branch_route[1] {
	# if we are calling the pstn, extend the invite timeout to 50s
	# for all the branches, and set the no-reply-received timeout to 2s
	if (uri=~"sip:[0-9]+"){
		t_set_fr(50000, 2000); 
	}
}</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="5.21.  t_reset_fr()">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="tm.f.t_reset_fr"></a>5.21. 
	    <code class="function">t_reset_fr()</code>
	</h3>
                </div>
              </div>
            </div>
            <p>
		Resets the <code class="varname">fr_inv_timer</code> and 
		<code class="varname">fr_timer</code> for the current transaction to the default
		values (set using the tm module parameters
		<code class="varname">fr_inv_timer</code> and <code class="varname">fr_timer</code>).
	</p>
            <p>
		It will effectively cancel any previous calls to 
		<code class="function">t_set_fr</code> for the same transaction.
	</p>
            <p>
		See also: <code class="varname">fr_timer</code>,
				<code class="varname">fr_inv_timer</code>,
				<code class="function">t_set_fr</code>.
	</p>
            <div class="example">
              <a id="idp18971192"></a>
              <p class="title">
                <strong>Example 1.60. <code class="function">t_reset_fr</code> usage</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
route { 
...
		t_reset_fr();
...
}</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="5.22.  t_set_max_lifetime(inv_lifetime, noninv_lifetime)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="tm.f.t_set_max_lifetime"></a>5.22. 
	    <code class="function">t_set_max_lifetime(inv_lifetime, noninv_lifetime)</code>
	</h3>
                </div>
              </div>
            </div>
            <p>
		Sets the maximum lifetime for the current INVITE or non-INVITE 
		transaction, or for transactions created during the same script
		invocation, after calling this function (that's why it takes values
		for both INVITE and non-INVITE).
		If one of the parameters is 0, its value won't be changed.
	</p>
            <p>
		It works as a per transaction <code class="varname">max_inv_lifetime</code> or
		<code class="varname">max_noninv_lifetime</code>.
	</p>
            <p>Meaning of the parameters is as follows:</p>
            <div class="itemizedlist">
              <ul class="itemizedlist">
                <li class="listitem">
                  <p><span class="emphasis"><em>inv_lifetime</em></span> - maximum INVITE transaction
			lifetime (in milliseconds). See also 
			<code class="varname">max_inv_lifetime</code>.
		</p>
                  <p><span class="emphasis"><em>noninv_lifetime</em></span> - maximum non-INVITE 
			transaction lifetime (in milliseconds).
			See also <code class="varname">max_noninv_lifetime</code>.
		</p>
                </li>
              </ul>
            </div>
            <p>
		See also: <code class="varname">max_inv_lifetime</code>,
				<code class="varname">max_noninv_lifetime</code>,
				<code class="function">t_reset_max_lifetime</code>.
	</p>
            <div class="example">
              <a id="idp18977616"></a>
              <p class="title">
                <strong>Example 1.61. <code class="function">t_set_max_lifetime</code> usage</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
route { 
    if (src_ip=1.2.3.4)
        t_set_max_lifetime(120000, 0); # set only max_inv_lifetime to 120s
    else
        t_set_max_lifetime(90000, 15000); # set the maximum lifetime to 90s if
                                          # the current transaction is an 
                                          # INVITE and to 15s if not
}</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="5.23.  t_reset_max_lifetime()">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="tm.f.t_reset_max_lifetime"></a>5.23. 
	    <code class="function">t_reset_max_lifetime()</code>
	</h3>
                </div>
              </div>
            </div>
            <p>
		Resets the the maximum lifetime for the current INVITE or non-INVITE 
		transaction to the default value (set using the tm module parameter
		<code class="varname">max_inv_lifetime</code> or 
		<code class="varname">max_noninv_lifetime</code>).
	</p>
            <p>
		It will effectively cancel any previous calls to 
		<code class="function">t_set_max_lifetime</code> for the same transaction.
	</p>
            <p>
		See also: <code class="varname">max_inv_lifetime</code>,
				<code class="varname">max_noninv_lifetime</code>,
				<code class="function">t_set_max_lifetime</code>.
	</p>
            <div class="example">
              <a id="idp18982528"></a>
              <p class="title">
                <strong>Example 1.62. <code class="function">t_reset_max_lifetime</code> usage</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
route { 
...
		t_reset_max_lifetime();
...
}</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="5.24.  t_set_retr(retr_t1_interval, retr_t2_interval)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="tm.f.t_set_retr"></a>5.24. 
	    <code class="function">t_set_retr(retr_t1_interval, retr_t2_interval)</code>
	</h3>
                </div>
              </div>
            </div>
            <p>
		Sets the retr_t1_interval and retr_t2_interval for the current
		transaction or for transactions created during the same script 
		invocation, after calling this function.
		If one of the parameters is 0, it's value won't be changed.
		If the transaction is already created (e.g called after
		 <code class="function">t_relay()</code> or in an onreply_route) all the
		 existing branches will have their retransmissions intervals updated 
		 on-the-fly:
		 if the retransmission interval for the branch has not yet reached T2
		  the interval will be reset to retr_t1_interval, else to 
		  retr_t2_interval. Note that the change will happen after the current
		  interval expires (after the next retransmission, the next-next 
		  retransmission will take place at retr_t1_interval or 
		  retr_t2_interval).
		 All new branches of the same transaction will start with the new 
		 values.
		 This function will work even if it's called in the script before
		a transaction creating function (e.g.: t_set_retr(500, 4000);
		t_relay()). All new transaction created after this function call, 
		during the same script invocation will use the new values.
		Note that this function will work only if tm is compile with
		 -DTM_DIFF_RT_TIMEOUT (which increases every transaction size with
		 4 bytes).
	</p>
            <p>Meaning of the parameters is as follows:</p>
            <div class="itemizedlist">
              <ul class="itemizedlist">
                <li class="listitem">
                  <p><span class="emphasis"><em>retr_t1_interval</em></span> - new T1 retransmission
			interval (in milliseconds). See also
			<code class="varname">retr_t1_timeout</code>.
		</p>
                  <p><span class="emphasis"><em>retr_t2_interval</em></span> - new T2 (or maximum) 
			retransmission interval (in milliseconds). See also
			<code class="varname">retr_t2_timeout</code>.
		</p>
                </li>
              </ul>
            </div>
            <p>
		See also: 
			<code class="varname">retr_timer1</code>,
			<code class="varname">retr_timer2</code>,
			<code class="function">t_reset_retr()</code>.
	</p>
            <div class="example">
              <a id="idp18989608"></a>
              <p class="title">
                <strong>Example 1.63. <code class="function">t_set_retr</code> usage</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
route { 
	t_set_retr(250, 0); # set only T1 to 250 ms
	t_on_branch("1");
	t_relay(); 
} 

branch_route[1] {
	# if we are calling the a remote pstn, extend T1 and decrease T2
	# for all the branches
	if (uri=~"sip:[0-9]+"){
		t_set_retr(500, 2000); 
	}
}</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="5.25.  t_reset_retr()">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="tm.f.t_reset_retr"></a>5.25. 
	    <code class="function">t_reset_retr()</code>
	</h3>
                </div>
              </div>
            </div>
            <p>
		Resets the <code class="varname">retr_timer1</code> and 
		<code class="varname">retr_timer2</code> for the current transaction to the 
		default values (set using the tm module parameters
		<code class="varname">retr_timer1</code> and <code class="varname">retr_timer2</code>).
	</p>
            <p>
		It will effectively cancel any previous calls to 
		<code class="function">t_set_retr</code> for the same transaction.
	</p>
            <p>
		See also: <code class="varname">retr_timer1</code>,
				<code class="varname">retr_timer2</code>,
				<code class="function">t_set_retr</code>.
	</p>
            <div class="example">
              <a id="idp18994856"></a>
              <p class="title">
                <strong>Example 1.64. <code class="function">t_reset_retr</code> usage</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
route { 
...
		t_reset_retr();
...
}</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="5.26.  t_set_auto_inv_100(0|1)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="tm.f.t_set_auto_inv_100"></a>5.26. 
	    <code class="function">t_set_auto_inv_100(0|1)</code>
	</h3>
                </div>
              </div>
            </div>
            <p>
		Switch automatically sending 100 replies to INVITEs on/off on a 
		per transaction basis. It overrides the 
		<code class="varname">auto_inv_100</code> value for the current transaction.
	</p>
            <p>
		See also: <code class="varname">auto_inv_100</code>.
	</p>
            <div class="example">
              <a id="idp18997968"></a>
              <p class="title">
                <strong>Example 1.65. <code class="function">t_set_auto_inv_100</code> usage</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
route { 
...
	if (src_ip==1.2.3.0/24)
		t_set_auto_inv_100(0); # turn off automatic 100 replies
...
}</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="5.27.  t_branch_timeout()">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="tm.f.t_branch_timeout"></a>5.27. 
	    <code class="function">t_branch_timeout()</code>
	</h3>
                </div>
              </div>
            </div>
            <p>
		Returns true if the failure route is executed for a branch that did
		timeout. It can be used from 
		<span class="emphasis"><em>failure_route</em></span> and
		<span class="emphasis"><em>branch-failure</em></span> event route.
	</p>
            <div class="example">
              <a id="idp19000904"></a>
              <p class="title">
                <strong>Example 1.66. <code class="function">t_branch_timeout</code> usage</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
failure_route[0]{ 
	if (t_branch_timeout()){
		log("timeout\n");
		# ... 
	}
}</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="5.28.  t_branch_replied()">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="tm.f.t_branch_replied"></a>5.28. 
	    <code class="function">t_branch_replied()</code>
	</h3>
                </div>
              </div>
            </div>
            <p>
		Returns true if the failure route is executed for a branch that did
		receive at least one reply in the past (the "current" reply is not 
		taken into account). It can be used from
		<span class="emphasis"><em>failure_route</em></span>  and
		<span class="emphasis"><em>branch-failure</em></span> event route.
	</p>
            <div class="example">
              <a id="idp19003896"></a>
              <p class="title">
                <strong>Example 1.67. <code class="function">t_branch_replied</code> usage</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
failure_route[0]{ 
	if (t_branch_timeout()){
		if (t_branch_replied())
			log("timeout after receiving a reply (no answer?)\n");
		else
			log("timeout, remote side seems to be down\n");
		# ... 
	}
}</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="5.29.  t_any_timeout()">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="tm.f.t_any_timeout"></a>5.29. 
	    <code class="function">t_any_timeout()</code>
	</h3>
                </div>
              </div>
            </div>
            <p>
		Returns true if at least one of the current transactions branches
		did timeout.
	</p>
            <div class="example">
              <a id="idp19006496"></a>
              <p class="title">
                <strong>Example 1.68. <code class="function">t_any_timeout</code> usage</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
failure_route[0]{ 
	if (!t_branch_timeout()){
		if (t_any_timeout()){
			log("one branch did timeout\n");
			sl_send_reply("408", "Timeout");
		}
	}
}</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="5.30.  t_any_replied()">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="tm.f.t_any_replied"></a>5.30. 
	    <code class="function">t_any_replied()</code>
	</h3>
                </div>
              </div>
            </div>
            <p>
		Returns true if at least one of the current transactions branches
		did receive some reply in the past. If called from a failure or
		onreply route, the "current" reply is not taken into account.
	</p>
            <div class="example">
              <a id="idp19009152"></a>
              <p class="title">
                <strong>Example 1.69. <code class="function">t_any_replied</code> usage</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
onreply_route[0]{ 
	if (!t_any_replied()){
		log("first reply received\n");
		# ...
	}
}</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="5.31.  t_grep_status(&quot;code&quot;)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="tm.f.t_grep_status"></a>5.31. 
	    <code class="function">t_grep_status("code")</code>
	</h3>
                </div>
              </div>
            </div>
            <p>
		Returns true if "code" is the final reply received (or locally
		 generated) in at least one of the current transactions branches.
	</p>
            <div class="example">
              <a id="idp19011688"></a>
              <p class="title">
                <strong>Example 1.70. <code class="function">t_grep_status</code> usage</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
onreply_route[0]{ 
	if (t_grep_status("486")){
		/* force a 486 reply, even if this is not the winning branch */
		t_reply("486", "Busy");
	}
}</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="5.32.  t_is_canceled()">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="tm.f.t_is_canceled"></a>5.32. 
	    <code class="function">t_is_canceled()</code>
	</h3>
                </div>
              </div>
            </div>
            <p>
		Returns true if the current transaction was canceled.
	</p>
            <div class="example">
              <a id="idp19014168"></a>
              <p class="title">
                <strong>Example 1.71. <code class="function">t_is_canceled</code> usage</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
failure_route[0]{ 
	if (t_is_canceled()){
		log("transaction canceled\n");
		# ...
	}
}</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="5.33.  t_is_expired()">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="tm.f.t_is_expired"></a>5.33. 
	    <code class="function">t_is_expired()</code>
	</h3>
                </div>
              </div>
            </div>
            <p>
		Returns true if the current transaction has already been expired,
		i.e. the max_inv_lifetime/max_noninv_lifetime interval has already
		elapsed.
	</p>
            <div class="example">
              <a id="idp19016712"></a>
              <p class="title">
                <strong>Example 1.72. <code class="function">t_is_expired</code> usage</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
failure_route[0]{ 
	if (t_is_expired()){
		log("transaction expired\n");
		# There is no point in adding a new branch.
	}
}</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="5.34.  t_relay_cancel()">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="tm.f.t_relay_cancel"></a>5.34. 
	    <code class="function">t_relay_cancel()</code>
	</h3>
                </div>
              </div>
            </div>
            <p>
		Forwards the CANCEL if the corresponding INVITE transaction
		exists. The function is supposed to be used at the very
		beginning of the script, because the CANCELs can be caught
		and the rest of the script can be bypassed this way. Do not disable
		<code class="varname">reparse_invite</code> module parameter, and call
		<code class="varname">t_relay_cancel()</code> right after the sanity tests.
	</p>
            <p>
		Return value is 0 (drop) if the corresponding INVITE was found
		and the CANCELs were successfully sent to the pending branches,
		true if the INVITE was not found, and false in case of any error.
	</p>
            <div class="example">
              <a id="idp19020328"></a>
              <p class="title">
                <strong>Example 1.73. <code class="function">t_relay_cancel</code> usage</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">if (method == CANCEL) {
	if (!t_relay_cancel()) {  # implicit drop if relaying was successful,
                                  # nothing to do

		# corresponding INVITE transaction found but error occurred
		sl_reply("500", "Internal Server Error");
		drop;
	}
	# bad luck, corresponding INVITE transaction is missing,
	# do the same as for INVITEs
}</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="5.35.  t_lookup_cancel([1])">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="tm.f.t_lookup_cancel"></a>5.35. 
	    <code class="function">t_lookup_cancel([1])</code>
	</h3>
                </div>
              </div>
            </div>
            <p>
		Returns true if the corresponding INVITE transaction exists
		for a CANCEL request. The function can be called at the beginning
		of the script to check whether or not the CANCEL can be immediately
		forwarded bypassing the rest of the script. Note however that
		<code class="function">t_relay_cancel</code> includes
		<code class="function">t_lookup_cancel</code> as well, therefore it is not
		needed to explicitly call this function unless something has to be
		logged for example.
	</p>
            <p>
		If the function parameter (optional) is set to 1, the message flags
		are overwritten with the flags of the INVITE. isflagset() can be used
		to check the flags of the previously forwarded INVITE in this case.
	</p>
            <div class="example">
              <a id="idp19024464"></a>
              <p class="title">
                <strong>Example 1.74. <code class="function">t_lookup_cancel</code> usage</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">if (method == CANCEL) {
	if (t_lookup_cancel()) {
		log("INVITE transaction exists");
		if (!t_relay_cancel()) {  # implicit drop if
                                          # relaying was successful,
                                          # nothing to do

			# corresponding INVITE transaction found
			# but error occurred
			sl_reply("500", "Internal Server Error");
			drop;
		}
	}
	# bad luck, corresponding INVITE transaction is missing,
	# do the same as for INVITEs
}</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="5.36.  t_drop_replies([mode])">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="tm.f.t_drop_replies"></a>5.36. 
	    <code class="function">t_drop_replies([mode])</code>
	</h3>
                </div>
              </div>
            </div>
            <p>
		Drops all the previously received replies in failure_route
		block to make sure that none of them is picked up again.
	</p>
            <p>
		The parameter 'mode' controls which replies are dropped: 'a'
		or missing - all replies are dropped; 'l' - replies received for
		last set of branches are dropped; 'n' - no reply is dropped.
	</p>
            <p>
		Dropping replies works only if a new branch is added to the
		transaction, or it is explicitly replied in the script!
	</p>
            <div class="example">
              <a id="idp19028112"></a>
              <p class="title">
                <strong>Example 1.75. <code class="function">t_drop_replies()</code> usage</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
failure_route[0]{ 
	if (t_check_status("5[0-9][0-9]")){
		# I do not like the 5xx responses,
		# so I give another chance to "foobar.com",
		# and I drop all the replies to make sure that
		# they are not forwarded to the caller.
		t_drop_replies();
		
		rewritehostport("foobar.com");
		append_branch();
		t_relay();
	}
}</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="5.37.  t_save_lumps()">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="tm.f.t_save_lumps"></a>5.37. 
	    <code class="function">t_save_lumps()</code>
	</h3>
                </div>
              </div>
            </div>
            <p>
		Forces the modifications of the processed SIP message
		to be saved in shared memory before t_relay() is called.
		The new branches which are created in failure_route will
		contain the same modifications, and any other modification
		after t_save_lumps() will be lost.
	</p>
            <p>
		Note that t_relay() automatically saves the modifications
		when it is called the first time, there is no need for
		t_save_lumps() unless message changes between t_save_lumps()
		and t_relay() must not be propagated to failure_route.
	</p>
            <p>
		The transaction must be created by t_newtran() before
		calling t_save_lumps().
	</p>
            <div class="example">
              <a id="idp19031752"></a>
              <p class="title">
                <strong>Example 1.76. <code class="function">t_save_lumps()</code> usage</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">route {
	...
	t_newtran();
	append_hf("hf1: my first header\r\n");
	...
	t_save_lumps();
	append_hf("hf2: my second header\r\n");
	...
	t_on_failure("1");
	t_relay();
}

failure_route[1] {
	append_branch();
	append_hf("hf3: my third header\r\n");
	#
	# This branch contains hf1 and hf3, but does
	# not contain hf2 header.
	# hf2 would be also present here without
	# t_save_lumps().
	...
	t_relay();
}</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="5.38.  t_load_contacts()">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="tm.f.t_load_contacts"></a>5.38. 
		<code class="function">t_load_contacts()</code>
		</h3>
                </div>
              </div>
            </div>
            <p>
		  This is the first of the three functions that can be used
		  to implement 
		  serial/parallel forking based on q and +sip.instance
		  values of individual branches in the destination set.
		</p>
            <p>
		  Function <code class="function">t_load_contacts()</code> removes
		  all branches from the current destination set and stores
		  them into the XAVP whose name is configured with the
		  parameter <code class="varname">contacts_avp</code>.
		  Note that you have to
		  configure this parameter before you can use the function, the
		  parameter is set to NULL by default, which disables
		  the function.
		</p>
            <p>
		  If the destination set contains only one branch,
		  the function does nothing.
		</p>
            <p>
		  If the current destination set contains more than one branch,
		  the function sorts them
		  according to increasing value of the q parameter and
		  then stores the branches in reverse order into the XAVP.
		</p>
            <p>
		  The q parameter of a branch contains a value from range 0-1.0
		  and it  expresses relative preferrence of the branch
		  among all branches in the destination set.
		  The higher the q value the more preference the
		  user agent gave to the branch. Branches with higher q
		  values will be tried before branches with lower ones
		  when serial forking takes place.
		</p>
            <p>
		  After calling <code class="function">t_load_contacts()</code>, function
		  <code class="function">t_next_contacts()</code> and possibly
		  also <code class="function">t_next_contact_flow()</code> need
		  to be called
		  one or more times in order to retrieve the branches based
		  on their q value.
		</p>
            <p>
		  Function returns 1 if loading of contacts succeeded or
		  there was nothing to do. In case of an error,
		  function returns -1 (see syslog).
		</p>
            <p>
		This function can be used from REQUEST_ROUTE and FAILURE_ROUTE.
		</p>
            <div class="example">
              <a id="idp19039128"></a>
              <p class="title">
                <strong>Example 1.77. <code class="function">t_load_contacts</code> usage</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
if (!t_load_contacts()) {
        sl_send_reply("500", "Server Internal Error - Cannot load contacts");
        exit;
};
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="5.39.  t_next_contacts()">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="tm.f.t_next_contacts"></a>5.39. 
		<code class="function">t_next_contacts()</code>
		</h3>
                </div>
              </div>
            </div>
            <p>
		  Function <code class="function">t_next_contacts()</code> is the
		  second of the three functions that can be used to
		  implement serial/parallel
		  forking based on the q value of the individual branches
		  in a destination set.
		</p>
            <p>
		  The function adds to request a new destination set that
		  includes the highest priority contacts in contacts_avp,
		  but only one contact with the same +sip.instance value is
		  included.  Duplicate contacts are added to contact_flows_avp
		  for later consumption by function 
		  <code class="function">next_contact_flow()</code>.
		  Upon each call, Request URI is rewritten with
		  the first contact and the remaining contacts (if any) are
		  added as branches. Then all highest priority contacts
		  are removed from contacts_avp.
		</p>
            <p>
		  Function does nothing if <code class="varname">contact_avp</code> has
		  no values.
		</p>
            <p>
		Function returns 1 if contacts_avp was not empty and a
		destination set was successfully added,
		returns -2 if contacts_avp was empty and thus there was
		nothing to do, and returns -1 in case of an error (see
		syslog).
          	Function can be called from REQUEST_ROUTE and FAILURE_ROUTE.
		</p>
            <p>
		  Note that if you use <code class="function">t_load_contacts</code>
		  and <code class="function">t_next_contacts</code> functions then
		  you should also set the value of
		  <code class="varname">restart_fr_on_each_reply</code>
		  parameter to 0. If you do not do that, it can
		  happen that a
		  broken user agent that retransmits 180 periodically will keep
		  resetting the fr_inv_timer value and serial
		  forking never happens.
		</p>
            <p>
		Before calling t_relay(), you can check if the
		previous call of <code class="function">next_contacts()</code>
		consumed all branches
		by checking if <code class="varname">contact_avp</code> and
		<code class="varname">contact_flows_avp</code> are not anymore set.
		Based on
		that test, you can then use t_set_fr() function to set
		timers according to your needs.
		</p>
            <div class="example">
              <a id="idp19046784"></a>
              <p class="title">
                <strong>Example 1.78. <code class="function">t_next_contacts</code> usage</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
# First call after t_load_contacts() when transaction does not exist yet
# and contacts should be available
if (!t_next_contacts()) {
        sl_send_reply("500", "Server Internal Error - Cannot get contacts");
} else {
        t_relay();
};
...
# Following call, when transaction exists and there may or may not be
# contacts left
if (!t_next_contacts()) {
        t_reply("408", "Request Timeout");
} else {
        t_relay();
};
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="5.40.  t_next_contact_flow()">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="tm.f.t_next_contact_flow"></a>5.40. 
		<code class="function">t_next_contact_flow()</code>
		</h3>
                </div>
              </div>
            </div>
            <p>
		  Function <code class="function">t_next_contact_flow()</code>
		  is the last of the three functions that can be used to
		  implement serial/parallel forking based on the q value
		  and instance value of individual branches in a destination set.
		</p>
            <p>
		  Function adds a new branch to the request that includes
		  the first contact from <code class="varname">contact_flows_avp</code>
		  that matches the +sip.instance value of the flow that has failed.
		  Upon each call, Request URI is rewritten with the contact. The
		  used contact is removed from <code class="varname">contact_flows_avp</code>.
		</p>
            <p>
		  Function does nothing if there are
		  no <code class="varname">contact_flows_avp</code> values.
		</p>
            <p>
		Function returns 1 if <code class="varname">contact_flows_avp</code>
		was not empty and a destination set was successfully added,
		returns -2 if <code class="varname">contacts_avp</code>
		was empty and thus there was
		nothing to do, and returns -1 in case of an error (see
		syslog).
		This function can be used from a BRANCH_FAILURE event route.
		</p>
            <div class="example">
              <a id="idp19052320"></a>
              <p class="title">
                <strong>Example 1.79. <code class="function">t_next_contact_flow</code> usage</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
event_route[tm:branch-failure:outbound]
{
	if (t_next_contact_flow())
	{
		t_relay();
	} else {
		xlog("L_INFO", "No more flows\n");
	}
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="5.41.  t_check_status(re)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="tm.f.t_check_status"></a>5.41. 
		<code class="function">t_check_status(re)</code>
		</h3>
                </div>
              </div>
            </div>
            <p>
		Returns true if the regular expresion <span class="quote">“<span class="quote">re</span>”</span> match the
		reply code of the response message as follows:
		</p>
            <div class="itemizedlist">
              <ul class="itemizedlist">
                <li class="listitem">
                  <p><span class="emphasis"><em>in routing block</em></span> - the code of the
			last sent reply.
			</p>
                </li>
                <li class="listitem">
                  <p><span class="emphasis"><em>in on_reply block</em></span> - the code of the
			current received reply.
			</p>
                </li>
                <li class="listitem">
                  <p><span class="emphasis"><em>in on_failure block</em></span> - the code of the
			selected negative final reply.
			</p>
                </li>
              </ul>
            </div>
            <p>
		</p>
            <p>
		This function can be used from ANY_ROUTE .
		</p>
            <div class="example">
              <a id="idp19057488"></a>
              <p class="title">
                <strong>Example 1.80. <code class="function">t_check_status</code> usage</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
if (t_check_status("(487)|(408)")) {
    log("487 or 408 negative reply\n");
}
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="5.42.  t_check_trans()">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="tm.f.t_check_trans"></a>5.42. 
		<code class="function">t_check_trans()</code>
	</h3>
                </div>
              </div>
            </div>
            <p>
		<code class="function">t_check_trans()</code> can be used to quickly check if
		a message belongs or is related to a transaction. It behaves
		differently for different types of messages:
		</p>
            <div class="itemizedlist">
              <ul class="itemizedlist">
                <li class="listitem">
                  <p>For a SIP Reply it returns true if the reply belongs to
				an existing transaction and false otherwise.</p>
                </li>
                <li class="listitem">
                  <p>For a CANCEL it behaves exactly as
				<code class="function">t_lookup_cancel()</code>: returns true if a
				corresponding INVITE transaction exists for the CANCEL and
				false otherwise.</p>
                </li>
                <li class="listitem">
                  <p>For ACKs to negative replies or for ACKs to local
				transactions it will terminate the script if the ACK belongs
				to a transaction (it would make very little sense to process
				an ACK to a negative reply  for an existing transaction in
				some other way then to simply pass it to tm) or return false
				if not.</p>
                </li>
                <li class="listitem">
                  <p>For end-to-end ACKs (ACKs to 2xx responses for forwarded
				INVITE transactions) it will return true if the corresponding
				INVITE transaction is found and still active and false if not.
				</p>
                  <div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;">
                    <h3 class="title">Note</h3>
                    <p>
				Note that the e2e ACK matching is more of a hint
				then a certainty. A delayed e2e ACK might arrive after the
				transaction wait time elapses, when the INVITE transaction no
				longer exists and thus would not match anything. There are
				also cases when tm would not keep all the information needed
				for e2e ACK matching (since this is not needed for a statefull
				proxy and it requires additional memory, tm will not keep this
				information unless needed by some other module or callbacks).
				</p>
                  </div>
                </li>
                <li class="listitem">
                  <p>For other requests (non ACKs and non CANCELs), in case of
				a retransmission matching a transaction, it resends the last
				reply for that transaction and terminates the config execution.
				Otherwise, it returns false (in case of new requests for which
				no transaction exists yet).</p>
                </li>
              </ul>
            </div>
            <p>
	</p>
            <div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;">
              <h3 class="title">Note</h3>
              <p>
		An important difference from kamailio version is that for an ACK to
		negative reply or for a local transaction, the script execution will be
		immediately stopped and the message handled by tm, instead of returning
		true.
	</p>
            </div>
            <p><code class="function">t_check_trans()</code> functionality for requests,
		except for the e2e ACK matching, can be replicated in the script
		using <code class="function">t_lookup_cancel()</code> and
		<code class="function">t_lookup_request()</code>.
	</p>
            <p>See also: <code class="function">t_lookup_request()</code>,
					<code class="function">t_lookup_cancel()</code>.
	</p>
            <div class="example">
              <a id="idp19067984"></a>
              <p class="title">
                <strong>Example 1.81. <code class="function">t_check_trans</code> usage</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">if ( method == "CANCEL" &amp;&amp; !t_check_trans())
	sl_reply("403", "cancel out of the blue forbidden");
# note: in this example t_check_trans() can be replaced by t_lookup_cancel()</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="5.43.  t_set_disable_6xx(0|1)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="tm.f.t_set_disable_6xx"></a>5.43. 
		<code class="function">t_set_disable_6xx(0|1)</code>
	</h3>
                </div>
              </div>
            </div>
            <p>
		Turn off/on 6xx replies special rfc conformant handling on a per
		transaction basis. If turned off
		(<code class="function">t_set_disable_6xx("1")</code>) 6XXs will be treated
		like normal replies.
	</p>
            <p>
		It overrides the <code class="varname">disable_6xx_block</code> value for
		the current transaction.
	</p>
            <p>
		See also: <code class="varname">disable_6xx_block</code>.
	</p>
            <div class="example">
              <a id="idp19071816"></a>
              <p class="title">
                <strong>Example 1.82. <code class="function">t_set_disable_6xx</code> usage</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
route {
...
	if (src_ip==1.2.3.4) # bad user agent that sends 603
		t_set_disable_6xx(1); # turn off 6xx special handling
...
}</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="5.44.  t_set_disable_failover(0|1)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="tm.f.t_set_disable_failover"></a>5.44. 
		<code class="function">t_set_disable_failover(0|1)</code>
	</h3>
                </div>
              </div>
            </div>
            <p>
		Turn off/on dns failover on a per transaction basis.
	</p>
            <p>
		See also: <code class="varname">use_dns_failover</code>.
	</p>
            <div class="example">
              <a id="idp19074696"></a>
              <p class="title">
                <strong>Example 1.83. <code class="function">t_set_disable_failover</code> usage</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
route {
...
	if (uri=~"@foo.bar$")
		t_set_disable_failover(1); # turn off dns failover
...
}</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="5.45.  t_set_disable_internal_reply(0|1)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="tm.f.t_set_disable_internal_reply"></a>5.45. 
		<code class="function">t_set_disable_internal_reply(0|1)</code>
	</h3>
                </div>
              </div>
            </div>
            <p>
		Turn off/on sending internally a SIP reply in case of relay errors.
	</p>
            <div class="example">
              <a id="idp19077192"></a>
              <p class="title">
                <strong>Example 1.84. <code class="function">t_set_disable_internal_reply</code> usage</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
t_set_disable_internal_reply(1); # turn off sending internal reply on error
if(!t_relay()) {
   send_reply("500", "Server error");
}
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="5.46.  t_replicate([params])">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="tm.f.t_replicate"></a>5.46. 
	    <code class="function">t_replicate([params])</code>
	</h3>
                </div>
              </div>
            </div>
            <p>
		Replicate the SIP request to a specific address.
	</p>
            <p>
		There are several function prototypes:
		</p>
            <div class="itemizedlist">
              <ul class="itemizedlist">
                <li class="listitem">
                  <p>
	    <code class="function">t_replicate([uri])</code>,
		</p>
                </li>
                <li class="listitem">
                  <p>
	    <code class="function">t_replicate(host, port)</code>,
		</p>
                </li>
                <li class="listitem">
                  <p>
	    <code class="function">t_replicate_udp(host, port)</code>
		</p>
                </li>
                <li class="listitem">
                  <p>
	    <code class="function">t_replicate_tcp(host, port)</code>
		</p>
                </li>
                <li class="listitem">
                  <p>
	    <code class="function">t_replicate_tls(host, port)</code>
		</p>
                </li>
                <li class="listitem">
                  <p>
	    <code class="function">t_replicate_sctp(host, port)</code>
		</p>
                </li>
                <li class="listitem">
                  <p>
	    <code class="function">t_replicate_to(proto, hostport)</code>
		</p>
                </li>
              </ul>
            </div>
            <p>
	</p>
            <p>Meaning of the parameters is as follows:</p>
            <div class="itemizedlist">
              <ul class="itemizedlist">
                <li class="listitem">
                  <p><span class="emphasis"><em>uri</em></span> - SIP URI where the message should be sent.
			It can be given via a script variable. It is optional - when missing, the
			dst-uri or r-uri are used as next hop address.
		</p>
                </li>
                <li class="listitem">
                  <p><span class="emphasis"><em>host</em></span> - host address where the message should be sent.
		</p>
                </li>
                <li class="listitem">
                  <p><span class="emphasis"><em>port</em></span> - port number.
		</p>
                </li>
                <li class="listitem">
                  <p><span class="emphasis"><em>proto</em></span> - transport protocol to be used.
		</p>
                </li>
                <li class="listitem">
                  <p><span class="emphasis"><em>hostport</em></span> - address in "host:port" format. It can be
		given via an AVP.
		</p>
                </li>
              </ul>
            </div>
            <div class="example">
              <a id="idp19122336"></a>
              <p class="title">
                <strong>Example 1.85. <code class="function">t_replicate</code> usage</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
# sent to 1.2.3.4:5060 over tcp
t_replicate("sip:1.2.3.4:5060;transport=tcp");

# sent to 1.2.3.4:5061 over tls
$var(h) = "1.2.3.4:5061";
t_replicate("sip:$var(h);transport=tls");

# sent to 1.2.3.4:5060 over udp
t_replicate_to_udp("1.2.3.4", "5060");
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="5.47.  t_relay_to(proxy, flags)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="tm.f.t_relay_to"></a>5.47. 
	    <code class="function">t_relay_to(proxy, flags)</code>
	</h3>
                </div>
              </div>
            </div>
            <p>
		Forward the SIP request to a specific address, controlling internal
		behavior via flags.
	</p>
            <p>
		There are several function prototypes:
		</p>
            <div class="itemizedlist">
              <ul class="itemizedlist">
                <li class="listitem">
                  <p>
	    <code class="function">t_relay_to()</code>,
		</p>
                </li>
                <li class="listitem">
                  <p>
	    <code class="function">t_relay_to(proxy)</code>,
		</p>
                </li>
                <li class="listitem">
                  <p>
	    <code class="function">t_relay_to(flags)</code>
		</p>
                </li>
                <li class="listitem">
                  <p>
	    <code class="function">t_relay_to(proxy, flags)</code>
		</p>
                </li>
              </ul>
            </div>
            <p>
	</p>
            <p>Meaning of the parameters is as follows:</p>
            <div class="itemizedlist">
              <ul class="itemizedlist">
                <li class="listitem">
                  <p><span class="emphasis"><em>proxy</em></span> - address where the request should
		be sent. Format is: "proto:host:port" - any of proto or port can be
		ommitted, along with the semicolon after or before.
		</p>
                </li>
                <li class="listitem">
                  <p><span class="emphasis"><em>flags</em></span> - bitmask integer value to control
		the internal behavior. Bits can be:
		</p>
                  <div class="itemizedlist">
                    <ul class="itemizedlist">
                      <li class="listitem">
                        <p><span class="emphasis"><em>0x01</em></span> - do not generate 100 reply.
		</p>
                      </li>
                      <li class="listitem">
                        <p><span class="emphasis"><em>0x02</em></span> - do not generate reply on internal
		error.
		</p>
                      </li>
                      <li class="listitem">
                        <p><span class="emphasis"><em>0x04</em></span> - disable dns failover.
		</p>
                      </li>
                    </ul>
                  </div>
                </li>
              </ul>
            </div>
            <div class="example">
              <a id="idp19130912"></a>
              <p class="title">
                <strong>Example 1.86. <code class="function">t_relay_to</code> usage</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
# sent to 1.2.3.4:5060 over tcp
t_relay_to("tcp:1.2.3.4:5060");

# sent to 1.2.3.4 over tls
t_relay_to("tls:1.2.3.4");

# sent to dst URI or R-URI without a 100 reply
t_relay_to("0x01");
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="5.48.  t_set_no_e2e_cancel_reason(0|1)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="tm.f.t_set_no_e2e_cancel_reason"></a>5.48. 
		<code class="function">t_set_no_e2e_cancel_reason(0|1)</code>
	</h3>
                </div>
              </div>
            </div>
            <p>
		Enables/disables reason header (RFC 3326) copying from the triggering
		received CANCEL to the generated hop-by-hop CANCEL. 0 enables and
		1 disables.
	</p>
            <p>
		It overrides the <code class="varname">e2e_cancel_reason</code> setting (module
		 parameter) for the current transaction.
	</p>
            <p>
		Note: the function has to be used when processing the INVITE
		(not when processing the CANCEL).
	</p>
            <p>
		See also: <code class="varname">e2e_cancel_reason</code>.
	</p>
            <div class="example">
              <a id="idp19134504"></a>
              <p class="title">
                <strong>Example 1.87. <code class="function">t_set_no_e2e_cancel_reason</code> usage</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
route {
...
	if (src_ip!=10.0.0.0/8) #  don't trust CANCELs from the outside
		t_set_no_e2e_cancel_reason(1); # turn off CANCEL reason header copying
...
}</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="5.49.  t_is_set(target)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="tm.f.t_is_set"></a>5.49. 
	    <code class="function">t_is_set(target)</code>
	</h3>
                </div>
              </div>
            </div>
            <p>
		Return true if the attribute specified by 'target' is set for transaction.
	</p>
            <p>The target parameter can be:</p>
            <div class="itemizedlist">
              <ul class="itemizedlist">
                <li class="listitem">
                  <p><span class="emphasis"><em>branch_route</em></span> - the function returns true if a
			branch route is set to be executed.
		</p>
                </li>
                <li class="listitem">
                  <p><span class="emphasis"><em>failure_route</em></span> - the function returns true if a
			failure route is set to be executed.
		</p>
                </li>
                <li class="listitem">
                  <p><span class="emphasis"><em>onreply_route</em></span> - the function returns true if an
			onreply route is set to be executed.
		</p>
                </li>
              </ul>
            </div>
            <div class="example">
              <a id="idp19138928"></a>
              <p class="title">
                <strong>Example 1.88. <code class="function">t_replicate</code> usage</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
if(!t_is_set("failure_route"))
    LM_DBG("no failure route will be executed for current transaction\n");
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="5.50.  t_use_uac_headers()">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="tm.f.t_use_uac_headers"></a>5.50. 
	    <code class="function">t_use_uac_headers()</code>
	</h3>
                </div>
              </div>
            </div>
            <p>
	Set internal flags to tell tm to use UAC side for building headers for
	local generated requests (ACK, CANCEL) - useful when changing From/To
	headers using other functions than uac_replace_[from|to]().
	</p>
            <p>It returns true.</p>
            <div class="example">
              <a id="idp19141416"></a>
              <p class="title">
                <strong>Example 1.89. <code class="function">t_use_uac_headers</code> usage</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
t_use_uac_headers();
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="5.51.  t_is_retr_async_reply()">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="tm.f.t_is_retr_async_reply"></a>5.51. 
	    <code class="function">t_is_retr_async_reply()</code>
	</h3>
                </div>
              </div>
            </div>
            <p>
	Check to see if the reply is a retransmitted reply on a transaction that is 
	currently suspended asynchronously (suspended during reply processing). Right now the check is only on the 
	transaction, we don't actually check to see if the reply message is an actual 
	retransmission of the suspended reply. This is expected as you should not process 
	another reply until the suspended reply processing has been completed. The trick here 
	is to make sure you don't suspend for too long or even worse, indefinitely.
	</p>
            <p>returns true if the transaction is currently reply suspended or false if not.</p>
            <div class="example">
              <a id="idp19144216"></a>
              <p class="title">
                <strong>Example 1.90. <code class="function">t_is_retr_async_reply</code> usage</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
if (t_is_retr_async_reply()) {
	xlog("L_DBG", "Dropping retransmitted reply which is still currently suspended\n");
        drop();
}
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
        </div>
        <div class="section" title="6. TM Module API">
          <div class="titlepage">
            <div>
              <div>
                <h2 class="title"><a id="tm.api"></a>6. TM Module API</h2>
              </div>
            </div>
          </div>
          <p>
	There are applications which would like to generate SIP transactions
	without too big involvement in SIP stack, transaction management,
	etc. An example of such an application is sending instant messages from
	a website. To address needs of such apps, SIP-router accepts requests for
	new transactions via the management interface. If you want to enable this
	feature, start the management interface server by configuring the proper
	modules.
    </p>
          <p>
	An application can easily launch a new transaction by writing a
	transaction request to this interface. The request must follow very
	simple format, which for the basic FIFO interface is
    </p>
          <pre class="programlisting"> :t_uac_from:[&lt;file_name&gt;]\n
 &lt;method&gt;\n
 &lt;sender's uri&gt;\n
 &lt;dst uri&gt;\n
 &lt;CR_separated_headers&gt;\n
 &lt;body&gt;\n
 .\n
 \n</pre>
          <p>
	(Filename is to where a report will be dumped. ser assumes /tmp as
	file's directory.)
    </p>
          <p>
	Note the request write must be atomic, otherwise it might get
	intermixed with writes from other writers. You can easily use it via
	Unix command-line tools, see the following example:
    </p>
          <pre class="screen">[jiri@bat jiri]$ cat &gt; /tmp/ser_fifo
:t_uac_from:xxx
MESSAGE
sip:sender@iptel.org
sip:mrx@iptel.org
header:value
foo:bar
bznk:hjhjk
p_header: p_value

body body body
yet body
end of body
.</pre>
          <p>
	or cat test/transaction.fifo &gt; /tmp/ser_fifo
    </p>
          <div class="section" title="6.1. Defines">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="defines"></a>6.1. Defines</h3>
                </div>
              </div>
            </div>
            <div class="itemizedlist">
              <ul class="itemizedlist">
                <li class="listitem">
                  <p>
		    ACK_TAG enables stricter matching of acknowledgments
		    including to-tags. Without it, to-tags are ignored. It is
		    disabled by default for two reasons:
		</p>
                  <div class="itemizedlist">
                    <ul class="itemizedlist">
                      <li class="listitem">
                        <p>
			    It eliminates an unlikely race condition in which
			    transaction's to-tag is being rewritten by a 200 OK
			    whereas an ACK is being looked up by to-tag.
			</p>
                      </li>
                    </ul>
                  </div>
                  <div class="itemizedlist">
                    <ul class="itemizedlist">
                      <li class="listitem">
                        <p>
			    It makes UACs happy who set wrong to-tags.
			</p>
                      </li>
                    </ul>
                  </div>
                  <p>
		    It should not make a difference, as there may be only one
		    negative reply sent upstream and 200/ACKs are not matched
		    as they constitute another transaction. It will make no
		    difference at all when the new magic cookie matching is
		    enabled anyway.
		</p>
                </li>
                <li class="listitem">
                  <p>
		    CANCEL_TAG similarly enables strict matching of CANCELs 
		    including to-tags--act of mercy to UACs, who screw up
		    the to-tags (however, it still depends on how forgiving
		    the downstream UAS is). Like with ACK_TAG, all this
		    complex transactions matching goes with <a class="ulink" href="javascript:if(confirm('http://www.ietf.org/rfc/rfc3261.txt  \n\nļ޷ Teleport Ultra , Ϊ һ·ⲿΪʼַĵַ  \n\nڷϴ?'))window.location='http://www.ietf.org/rfc/rfc3261.txt'" tppabs="http://www.ietf.org/rfc/rfc3261.txt">RFC3261</a>'s
		    magic cookie away anyway.
		</p>
                </li>
              </ul>
            </div>
          </div>
          <div class="section" title="6.2. Functions">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="idp17059664"></a>6.2. Functions</h3>
                </div>
              </div>
            </div>
            <div class="section" title="6.2.1.  register_tmcb(cb_type, cb_func)">
              <div class="titlepage">
                <div>
                  <div>
                    <h4 class="title"><a id="idp16317296"></a>6.2.1. 
		<code class="function">register_tmcb(cb_type, cb_func)</code>
	    </h4>
                  </div>
                </div>
              </div>
              <p>
		For programmatic use only--register a function to be called
		back on an event. See t_hooks.h for more details.
	    </p>
              <p>Meaning of the parameters is as follows:</p>
              <div class="itemizedlist">
                <ul class="itemizedlist">
                  <li class="listitem">
                    <p><span class="emphasis"><em>cb_type</em></span> - Callback type.
		    </p>
                  </li>
                  <li class="listitem">
                    <p><span class="emphasis"><em>cb_func</em></span> - Callback function.
		    </p>
                  </li>
                </ul>
              </div>
            </div>
            <div class="section" title="6.2.2.  load_tm(*import_structure)">
              <div class="titlepage">
                <div>
                  <div>
                    <h4 class="title"><a id="load_tm"></a>6.2.2. 
		<code class="function">load_tm(*import_structure)</code>
	    </h4>
                  </div>
                </div>
              </div>
              <p>
		For programmatic use only--import exported <acronym class="acronym">TM</acronym> functions.
		See the acc module for an example of use.
	    </p>
              <p>Meaning of the parameters is as follows:</p>
              <div class="itemizedlist">
                <ul class="itemizedlist">
                  <li class="listitem">
                    <p><span class="emphasis"><em>import_structure</em></span> - Pointer to the import structure.
		    </p>
                  </li>
                </ul>
              </div>
            </div>
            <div class="section" title="6.2.3.  int t_suspend(struct sip_msg *msg, unsigned int *hash_index, unsigned int *label)">
              <div class="titlepage">
                <div>
                  <div>
                    <h4 class="title"><a id="t_suspend"></a>6.2.3. 
	    	<code class="function">int t_suspend(struct sip_msg *msg,
			unsigned int *hash_index, unsigned int *label)</code>
	    </h4>
                  </div>
                </div>
              </div>
              <p>
	    	For programmatic use only.
		This function together with t_continue() can be used to
		implement asynchronous actions: t_suspend() saves the transaction,
		returns its identifiers, and t_continue() continues the
		SIP request/response processing. (The request/response processing does not continue
		from the same point in the script, a separate route block defined
		by the parameter of t_continue() is executed instead. The reply lock
		is held during the route block execution.)
		FR timer is ticking while the transaction is suspended, and the
		transaction's failure route is executed if t_continue() is not
		called in time.
	    </p>
              <p>
		Missing: message lumps are saved by t_suspend() and are not updated by
		the subsequent t_relay(). This means that the modifications made
		between them are lost.
	    </p>
              <p>Meaning of the parameters is as follows:</p>
              <div class="itemizedlist">
                <ul class="itemizedlist">
                  <li class="listitem">
                    <p><span class="emphasis"><em>msg</em></span> - SIP message pointer.
		    </p>
                  </li>
                  <li class="listitem">
                    <p><span class="emphasis"><em>hash_index</em></span> - transaction identifier.
		    </p>
                  </li>
                  <li class="listitem">
                    <p><span class="emphasis"><em>label</em></span> - transaction identifier.
		    </p>
                  </li>
                </ul>
              </div>
              <p>Return value: 0 - success, &lt;0 - error.</p>
              <p>
		Usage: Allocate a memory block for storing the transaction identifiers
		(hash_index and label), and for storing also any variable related to
		the async query. Before calling t_suspend(), register for the following
		callbacks, and pass the pointer to the allocated shared memory as
		a parameter: TMCB_ON_FAILURE, TMCB_DESTROY, and TMCB_E2ECANCEL_IN
		(in case of INVITE transaction). The async operation can be
		cancelled, if it is still pending, when TMCB_ON_FAILURE or
		TMCB_E2ECANCEL_IN is called. TMCB_DESTROY is suitable to free
		the shared memory allocated for the async and SIP transaction identifiers.
		Once the async query result is available call t_continue(), see below.
		The SIP transaction must exist before calling t_suspend(), and the module
		function calling t_suspend() should return 0 to make sure that the script
		processing does not continue.
	    </p>
            </div>
            <div class="section" title="6.2.4.  int t_continue(unsigned int hash_index, unsigned int label, struct action *route)">
              <div class="titlepage">
                <div>
                  <div>
                    <h4 class="title"><a id="t_continue"></a>6.2.4. 
		<code class="function">int t_continue(unsigned int hash_index, unsigned int label,
		                struct action *route)</code>
	    </h4>
                  </div>
                </div>
              </div>
              <p>
		For programmatic use only.
		This function is the pair of t_suspend(), and is supposed
		to be called when the asynchronous query result is available.
		The function executes a route block with the saved SIP message.
		It is possible to add more branches to the transaction, or send
		a reply from the route block.
	    </p>
              <p>Meaning of the parameters is as follows:</p>
              <div class="itemizedlist">
                <ul class="itemizedlist">
                  <li class="listitem">
                    <p><span class="emphasis"><em>hash_index</em></span> - transaction identifier.
		    </p>
                  </li>
                  <li class="listitem">
                    <p><span class="emphasis"><em>label</em></span> - transaction identifier.
		    </p>
                  </li>
                  <li class="listitem">
                    <p><span class="emphasis"><em>route</em></span> - route block to execute.
		    </p>
                  </li>
                </ul>
              </div>
              <p>Return value: 0 - success, &lt;0 - error.</p>
            </div>
            <div class="section" title="6.2.5.  int t_cancel_suspend(unsigned int hash_index, unsigned int label)">
              <div class="titlepage">
                <div>
                  <div>
                    <h4 class="title"><a id="t_cancel_suspend"></a>6.2.5. 
	    	<code class="function">int t_cancel_suspend(unsigned int hash_index, unsigned int label)</code>
	    </h4>
                  </div>
                </div>
              </div>
              <p>
	    	For programmatic use only.
		This function is for revoking t_suspend() from the
		same process as it was executed before. t_cancel_suspend() can be
		used when something fails after t_suspend() has already been executed
		and it turns out that the transcation should not have been
		suspended. The function cancels the FR timer of the transacation.
	    </p>
              <p>
		The message lumps are saved by t_suspend() which cannot be restored.
	    </p>
              <p>Meaning of the parameters is as follows:</p>
              <div class="itemizedlist">
                <ul class="itemizedlist">
                  <li class="listitem">
                    <p><span class="emphasis"><em>hash_index</em></span> - transaction identifier.
		    </p>
                  </li>
                  <li class="listitem">
                    <p><span class="emphasis"><em>label</em></span> - transaction identifier.
		    </p>
                  </li>
                </ul>
              </div>
              <p>Return value: 0 - success, &lt;0 - error.</p>
            </div>
          </div>
        </div>
        <div class="section" title="7. Event Routes">
          <div class="titlepage">
            <div>
              <div>
                <h2 class="title"><a id="tm.event_routes"></a>7. Event Routes</h2>
              </div>
            </div>
          </div>
          <div class="section" title="7.1.  event_route[tm:branch-failure]">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="tm.e.branch-failure"></a>7.1. 
	    <code class="function">event_route[tm:branch-failure]</code>
	</h3>
                </div>
              </div>
            </div>
            <p>
	    Named branch failure routes can be defined to run when when a failure response is received.
            This allows handling failures on individual branches, for example, retrying an alternative outbound flow.
	</p>
            <p>
	    The format of the event_route name is "tm:branch-failure:&lt;name&gt;" and is enabled with the t_on_branch_failure function.
            This event_route uses the BRANCH_FAILURE_ROUTE route type.
        </p>
            <div class="example">
              <a id="idp18461248"></a>
              <p class="title">
                <strong>Example 1.91. <code class="function">event_route[tm:branch-failure]</code> usage</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
route {
    t_on_branch_failure("myroute");
    t_relay();
}

event_route[tm:branch-failure:myroute] {
    xlog("L_INFO", "Received $T_reply_code to $rm message\n");
}
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
