<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>XCAP_Client Module</title>
    <link rel="stylesheet" type="text/css" href="../../../../css/sr-doc.css" tppabs="http://kamailio.org/css/sr-doc.css" />
    <meta name="generator" content="DocBook XSL Stylesheets V1.76.1" />
    <link rel="home" href="#idp4480" title="XCAP_Client Module" />
    <link rel="next" href="#idp2997536" title="Chapter 1. Admin Guide" />
  </head>
  <body>
    <div class="book" title="XCAP_Client Module">
      <div class="titlepage">
        <div>
          <div>
            <h1 class="title"><a id="idp4480"></a>XCAP_Client Module</h1>
          </div>
          <div>
            <div class="authorgroup">
              <div class="author">
                <h3 class="author"><span class="firstname">Anca-Maria</span> <span class="surname">Vamanu</span></h3>
                <div class="affiliation">
                  <span class="orgname">Voice Sistem SRL<br /></span>
                </div>
              </div>
              <div class="editor">
                <h4 class="editedby">Edited by</h4>
                <h3 class="editor"><span class="firstname">Anca-Maria</span> <span class="surname">Vamanu</span></h3>
              </div>
            </div>
          </div>
          <div>
            <p class="copyright">Copyright © 2007 Voice Sistem SRL</p>
          </div>
        </div>
        <hr />
      </div>
      <div class="toc">
        <p>
          <strong>Table of Contents</strong>
        </p>
        <dl>
          <dt>
            <span class="chapter">
              <a href="#idp2997536">1. Admin Guide</a>
            </span>
          </dt>
          <dd>
            <dl>
              <dt>
                <span class="section">
                  <a href="#idp2199920">1. Overview</a>
                </span>
              </dt>
              <dt>
                <span class="section">
                  <a href="#idp256232">2. Dependencies</a>
                </span>
              </dt>
              <dd>
                <dl>
                  <dt>
                    <span class="section">
                      <a href="#idp256584">2.1. Kamailio Modules</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#idp257312">2.2. External Libraries or Applications</a>
                    </span>
                  </dt>
                </dl>
              </dd>
              <dt>
                <span class="section">
                  <a href="#idp259600">3. Parameters</a>
                </span>
              </dt>
              <dd>
                <dl>
                  <dt>
                    <span class="section">
                      <a href="#idp259968">3.1. <code class="varname">db_url</code>(str)</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#idp262552">3.2. <code class="varname">xcap_table</code>(str)</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#idp2908560">3.3. <code class="varname">periodical_query</code>(int)</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#idp2605840">3.4. <code class="varname">query_period</code>(int)</a>
                    </span>
                  </dt>
                </dl>
              </dd>
              <dt>
                <span class="section">
                  <a href="#idp71440">4. Functions</a>
                </span>
              </dt>
              <dt>
                <span class="section">
                  <a href="#idp72096">5. Exported Management Functions</a>
                </span>
              </dt>
              <dd>
                <dl>
                  <dt>
                    <span class="section">
                      <a href="#idp72448">5.1. 
		<code class="function">refreshXcapDoc</code>
		</a>
                    </span>
                  </dt>
                </dl>
              </dd>
            </dl>
          </dd>
          <dt>
            <span class="chapter">
              <a href="#idp1292736">2. Developer Guide</a>
            </span>
          </dt>
          <dd>
            <dl>
              <dt>
                <span class="section">
                  <a href="#idp285448">1. 
	     <code class="function">bind_xcap_api(xcap_api_t* api)</code>
     </a>
                </span>
              </dt>
              <dt>
                <span class="section">
                  <a href="#idp2245440">2. 
			<code class="function">get_elem</code>
		</a>
                </span>
              </dt>
              <dt>
                <span class="section">
                  <a href="#idp1116216">3. 
			<code class="function">register_xcb</code>
		</a>
                </span>
              </dt>
            </dl>
          </dd>
        </dl>
      </div>
      <div class="list-of-examples">
        <p>
          <strong>List of Examples</strong>
        </p>
        <dl>
          <dt>1.1. <a href="#idp261352">Set <code class="varname">db_url</code> parameter</a></dt>
          <dt>1.2. <a href="#idp1859448">Set <code class="varname">xcap_table</code> parameter</a></dt>
          <dt>1.3. <a href="#idp1949480">Set <code class="varname">periodical_query</code> parameter</a></dt>
          <dt>1.4. <a href="#idm20728">Set <code class="varname">query_period</code> parameter</a></dt>
          <dt>2.1. <a href="#idp3199608"><code class="function">xcap_api</code> structure</a></dt>
        </dl>
      </div>
      <div class="chapter" title="Chapter 1. Admin Guide">
        <div class="titlepage">
          <div>
            <div>
              <h2 class="title"><a id="idp2997536"></a>Chapter 1. Admin Guide</h2>
            </div>
          </div>
        </div>
        <div class="toc">
          <p>
            <strong>Table of Contents</strong>
          </p>
          <dl>
            <dt>
              <span class="section">
                <a href="#idp2199920">1. Overview</a>
              </span>
            </dt>
            <dt>
              <span class="section">
                <a href="#idp256232">2. Dependencies</a>
              </span>
            </dt>
            <dd>
              <dl>
                <dt>
                  <span class="section">
                    <a href="#idp256584">2.1. Kamailio Modules</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#idp257312">2.2. External Libraries or Applications</a>
                  </span>
                </dt>
              </dl>
            </dd>
            <dt>
              <span class="section">
                <a href="#idp259600">3. Parameters</a>
              </span>
            </dt>
            <dd>
              <dl>
                <dt>
                  <span class="section">
                    <a href="#idp259968">3.1. <code class="varname">db_url</code>(str)</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#idp262552">3.2. <code class="varname">xcap_table</code>(str)</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#idp2908560">3.3. <code class="varname">periodical_query</code>(int)</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#idp2605840">3.4. <code class="varname">query_period</code>(int)</a>
                  </span>
                </dt>
              </dl>
            </dd>
            <dt>
              <span class="section">
                <a href="#idp71440">4. Functions</a>
              </span>
            </dt>
            <dt>
              <span class="section">
                <a href="#idp72096">5. Exported Management Functions</a>
              </span>
            </dt>
            <dd>
              <dl>
                <dt>
                  <span class="section">
                    <a href="#idp72448">5.1. 
		<code class="function">refreshXcapDoc</code>
		</a>
                  </span>
                </dt>
              </dl>
            </dd>
          </dl>
        </div>
        <div class="section" title="1. Overview">
          <div class="titlepage">
            <div>
              <div>
                <h2 class="title"><a id="idp2199920"></a>1. Overview</h2>
              </div>
            </div>
          </div>
          <p> 
	The modules is a XCAP client for Kamailio that can be used by other modules.
	It fetches XCAP elements, either documents or part of them, by sending 
	HTTP GET requests to an XCAP server. It also offers support for 
	conditional queries.  It uses the <span class="emphasis"><em>libcurl</em></span> library as a 
	client-side HTTP transfer library.
	</p>
          <p>
	The module offers a XCAP client interface with general functions that
	allow requesting for a specific element from a XCAP server.
	In addition to that it also offers the service of storing and updating
	the documents it receives. In this case only an initial
	request to the module is required - xcapGetNewDoc - which is like a 
	request to the module to handle from that point on the referenced
	document so as to promise that the newest version will always be
	present in database.
	</p>
          <p>
	The update method is also configurable, either through periodical
	queries, applicable to any kind of XCAP server or with an management command 
	that should be sent by the server upon an update.
	</p>
          <p>
	The module is currently used by the <span class="quote">“<span class="quote">presence_xml</span>”</span> module, if the 
	'integrated_xcap_server' parameter is not set.
	</p>
        </div>
        <div class="section" title="2. Dependencies">
          <div class="titlepage">
            <div>
              <div>
                <h2 class="title"><a id="idp256232"></a>2. Dependencies</h2>
              </div>
            </div>
          </div>
          <div class="section" title="2.1. Kamailio Modules">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="idp256584"></a>2.1. Kamailio Modules</h3>
                </div>
              </div>
            </div>
            <p>
			The modules is not dependent of any Kamailio module.
		</p>
          </div>
          <div class="section" title="2.2. External Libraries or Applications">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="idp257312"></a>2.2. External Libraries or Applications</h3>
                </div>
              </div>
            </div>
            <p>
		The following libraries or applications must be installed before running
		Kamailio with this module loaded:
			</p>
            <div class="itemizedlist">
              <ul class="itemizedlist">
                <li class="listitem">
                  <p>
				<span class="emphasis"><em>libxml</em></span>.
			</p>
                </li>
                <li class="listitem">
                  <p>
				<span class="emphasis"><em>libcurl</em></span>.
			</p>
                </li>
              </ul>
            </div>
            <p>
		</p>
          </div>
        </div>
        <div class="section" title="3. Parameters">
          <div class="titlepage">
            <div>
              <div>
                <h2 class="title"><a id="idp259600"></a>3. Parameters</h2>
              </div>
            </div>
          </div>
          <div class="section" title="3.1. db_url(str)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="idp259968"></a>3.1. <code class="varname">db_url</code>(str)</h3>
                </div>
              </div>
            </div>
            <p>
		The database url.
		</p>
            <p>
		<span class="emphasis"><em>Default value is <span class="quote">“<span class="quote">mysql://kamailio:kamailiorw@localhost/kamailio</span>”</span>.	
		</em></span>
		</p>
            <div class="example">
              <a id="idp261352"></a>
              <p class="title">
                <strong>Example 1.1. Set <code class="varname">db_url</code> parameter</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
modparam("xcap_client", "db_url", "dbdriver://username:password@dbhost/dbname")
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="3.2. xcap_table(str)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="idp262552"></a>3.2. <code class="varname">xcap_table</code>(str)</h3>
                </div>
              </div>
            </div>
            <p>
		The name of the db table where XCAP documents are stored.
		</p>
            <p>
		<span class="emphasis"><em>Default value is <span class="quote">“<span class="quote">xcap</span>”</span>.
		</em></span>
		</p>
            <div class="example">
              <a id="idp1859448"></a>
              <p class="title">
                <strong>Example 1.2. Set <code class="varname">xcap_table</code> parameter</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
modparam("xcap_client", "xcap_table", "xcaps")
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="3.3. periodical_query(int)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="idp2908560"></a>3.3. <code class="varname">periodical_query</code>(int)</h3>
                </div>
              </div>
            </div>
            <p>
		A flag to disable periodical query as an update method for
		the documents the module is responsible for. It could be
		disabled when the XCAP server is capable to send the exported
		management command when a change occurs or when another module in Kamailio
		handles updates.
		</p>
            <p>
		To disable it set this parameter to 0.
		</p>
            <p>
		<span class="emphasis"><em>Default value is <span class="quote">“<span class="quote">1</span>”</span>.
		</em></span>
		</p>
            <div class="example">
              <a id="idp1949480"></a>
              <p class="title">
                <strong>Example 1.3. Set <code class="varname">periodical_query</code> parameter</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
modparam("xcap_client", "periodical_query", 0)
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="3.4. query_period(int)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="idp2605840"></a>3.4. <code class="varname">query_period</code>(int)</h3>
                </div>
              </div>
            </div>
            <p>
		Should be set if periodical query is not disabled. 
		Represents the time interval the XCAP servers should be 
		queried for an update.
		</p>
            <p>
		To disable it set this parameter to 0.
		</p>
            <p>
		<span class="emphasis"><em>Default value is <span class="quote">“<span class="quote">100</span>”</span>.
		</em></span>
		</p>
            <div class="example">
              <a id="idm20728"></a>
              <p class="title">
                <strong>Example 1.4. Set <code class="varname">query_period</code> parameter</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
modparam("xcap_client", "query_period", 50)
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
        </div>
        <div class="section" title="4. Functions">
          <div class="titlepage">
            <div>
              <div>
                <h2 class="title"><a id="idp71440"></a>4. Functions</h2>
              </div>
            </div>
          </div>
          <p>
	None to be used in configuration file.
	</p>
        </div>
        <div class="section" title="5. Exported Management Functions">
          <div class="titlepage">
            <div>
              <div>
                <h2 class="title"><a id="idp72096"></a>5. Exported Management Functions</h2>
              </div>
            </div>
          </div>
          <div class="section" title="5.1.  refreshXcapDoc">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="idp72448"></a>5.1. 
		<code class="function">refreshXcapDoc</code>
		</h3>
                </div>
              </div>
            </div>
            <p>
		Management command that should be sent by an XCAP server when a
		stored document changes.
		</p>
            <p>
		Name: <span class="emphasis"><em>refreshXcapDoc</em></span>
		</p>
            <p>Parameters:</p>
            <div class="itemizedlist">
              <ul class="itemizedlist">
                <li class="listitem">
                  <p>document uri: the uri of the document</p>
                </li>
                <li class="listitem">
                  <p>xcap server port: the port of the xcap server</p>
                </li>
              </ul>
            </div>
            <p>
		Management FIFO Command Format:
		</p>
            <pre class="programlisting">...
:refreshXcapDoc:fifo_reply
/xcap-root/resource-lists/users/eyebeam/buddies-resource-list.xml
8000
_empty_line_
...</pre>
          </div>
        </div>
      </div>
      <div class="chapter" title="Chapter 2. Developer Guide">
        <div class="titlepage">
          <div>
            <div>
              <h2 class="title"><a id="idp1292736"></a>Chapter 2. Developer Guide</h2>
            </div>
          </div>
        </div>
        <div class="toc">
          <p>
            <strong>Table of Contents</strong>
          </p>
          <dl>
            <dt>
              <span class="section">
                <a href="#idp285448">1. 
	     <code class="function">bind_xcap_api(xcap_api_t* api)</code>
     </a>
              </span>
            </dt>
            <dt>
              <span class="section">
                <a href="#idp2245440">2. 
			<code class="function">get_elem</code>
		</a>
              </span>
            </dt>
            <dt>
              <span class="section">
                <a href="#idp1116216">3. 
			<code class="function">register_xcb</code>
		</a>
              </span>
            </dt>
          </dl>
        </div>
        <p>
		The module exports a number of functions that allow selecting 
		and retrieving an element from an xcap server and also registering
		a callback to be called when the management command refreshXcapDoc is received
		and the document in question is retrieved.
   </p>
        <div class="section" title="1.  bind_xcap_api(xcap_api_t* api)">
          <div class="titlepage">
            <div>
              <div>
                <h2 class="title"><a id="idp285448"></a>1. 
	     <code class="function">bind_xcap_api(xcap_api_t* api)</code>
     </h2>
              </div>
            </div>
          </div>
          <p>
		This function allows binding the needed functions. 
		</p>
          <div class="example">
            <a id="idp3199608"></a>
            <p class="title">
              <strong>Example 2.1. <code class="function">xcap_api</code> structure</strong>
            </p>
            <div class="example-contents">
              <pre class="programlisting">...
typedef struct xcap_api {
	
	/* xcap node selection and retrieving functions*/
	xcap_get_elem_t get_elem;
	xcap_nodeSel_init_t int_node_sel;
	xcap_nodeSel_add_step_t add_step;
	xcap_nodeSel_add_terminal_t add_terminal;
	xcap_nodeSel_free_t free_node_sel;
	xcapGetNewDoc_t getNewDoc; /* an initial request for the module 
	fo fetch this document that does not exist in xcap db table
	and handle its update*/

	/* function to register a callback to document changes*/
	register_xcapcb_t register_xcb;
}xcap_api_t;
...</pre>
            </div>
          </div>
          <br class="example-break" />
        </div>
        <div class="section" title="2.  get_elem">
          <div class="titlepage">
            <div>
              <div>
                <h2 class="title"><a id="idp2245440"></a>2. 
			<code class="function">get_elem</code>
		</h2>
              </div>
            </div>
          </div>
          <p>
			Field type:
				</p>
          <pre class="programlisting">...
typedef char* (*xcap_get_elem_t)(char* xcap_root,
xcap_doc_sel_t* doc_sel, xcap_node_sel_t* node_sel);
...</pre>
          <p>
		</p>
          <p>
			This function sends a HTTP request and gets the specified information
			from the xcap server.
		</p>
          <p>
		The parameters signification:
		</p>
          <div class="itemizedlist">
            <ul class="itemizedlist">
              <li class="listitem">
                <p>
				<span class="emphasis"><em>xcap_root</em></span>-
				the XCAP server address;
			</p>
              </li>
              <li class="listitem">
                <p>
				<span class="emphasis"><em>doc_sel</em></span>-
				structure with document selection info;
			</p>
                <pre class="programlisting">Parameter type:
...
typedef struct xcap_doc_sel
{
	str auid; /* application defined Unique ID*/
	int type; /* the type of the path segment
				after the AUID  which must either
				be GLOBAL_TYPE (for "global") or
				USERS_TYPE (for "users") */ 
	str xid; /* the XCAP User Identifier 
				if type is USERS_TYPE */
	str filename; 
}xcap_doc_sel_t;
...</pre>
              </li>
              <li class="listitem">
                <p>
<span class="emphasis"><em>node_sel</em></span>-
structure with node selection info;
</p>
                <pre class="programlisting">Parameter type:
...
typedef struct xcap_node_sel
{
	step_t* steps;
	step_t* last_step;
	int size;
	ns_list_t* ns_list;
	ns_list_t* last_ns;
	int ns_no;

}xcap_node_sel_t;

typedef struct step
{
	str val;
	struct step* next;
}step_t;

typedef struct ns_list
{
	int name;
	str value;
	struct ns_list* next;
}ns_list_t;
...</pre>
                <p>
		The node selector is represented like a list of steps that will
		be represented in the path string separated by '/' signs. 
		The namespaces for the nodes are stored also in a list, as an
		association of name and value, where the value is to be included
		in the respective string val field of the step.
		</p>
                <p>
		To construct the node structure the following functions in the xcap_api
		structure should be used: 'int_node_sel', 'add_step' and if needed, 
		'add_terminal'.
		</p>
                <p>
		If the intention is to retrieve the whole document this argument must
		be NULL.
		</p>
              </li>
            </ul>
          </div>
        </div>
        <div class="section" title="3.  register_xcb">
          <div class="titlepage">
            <div>
              <div>
                <h2 class="title"><a id="idp1116216"></a>3. 
			<code class="function">register_xcb</code>
		</h2>
              </div>
            </div>
          </div>
          <p>
			Field type:
				</p>
          <pre class="programlisting">...
typedef int (*register_xcapcb_t)(int types, xcap_cb f);
...</pre>
          <p>
	</p>
          <p>
	- 'types' parameter can have a combined value of PRES_RULES, RESOURCE_LIST,
	RLS_SERVICES and PIDF_MANIPULATION.
	</p>
          <p>
	-the callback function has type :
	</p>
          <pre class="programlisting">...
typedef int (xcap_cb)(int doc_type, str xid, char* doc);
...</pre>
          <p>
	</p>
        </div>
      </div>
    </div>
  </body>
</html>
