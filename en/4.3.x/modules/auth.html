<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>The Auth Module</title>
    <link rel="stylesheet" type="text/css" href="../../../../css/sr-doc.css" tppabs="http://kamailio.org/css/sr-doc.css" />
    <meta name="generator" content="DocBook XSL Stylesheets V1.76.1" />
    <link rel="home" href="#auth" title="The Auth Module" />
    <link rel="next" href="#idp59032" title="Chapter 1. Admin Guide" />
  </head>
  <body>
    <div class="book" title="The Auth Module">
      <div class="titlepage">
        <div>
          <div>
            <h1 class="title"><a id="auth"></a>The Auth Module</h1>
          </div>
          <div>
            <div class="authorgroup">
              <div class="author">
                <h3 class="author"><span class="firstname">Jan</span> <span class="surname">Janak</span></h3>
                <div class="affiliation">
                  <span class="orgname">FhG Fokus<br /></span>
                </div>
                <code class="email">&lt;<a class="email" href="mailto:jan@iptel.org">jan@iptel.org</a>&gt;</code>
              </div>
              <div class="author">
                <h3 class="author"><span class="firstname">Juha</span> <span class="surname">Heinanen</span></h3>
                <div class="affiliation">
                  <span class="orgname">TutPro Inc<br /></span>
                </div>
                <code class="email">&lt;<a class="email" href="mailto:jh@song.fi">jh@song.fi</a>&gt;</code>
              </div>
              <div class="author">
                <h3 class="author"><span class="firstname">Daniel-Constantin</span> <span class="surname">Mierla</span></h3>
                <div class="affiliation">
                  <span class="orgname">asipto.com<br /></span>
                </div>
                <code class="email">&lt;<a class="email" href="mailto:miconda@gmail.com">miconda@gmail.com</a>&gt;</code>
              </div>
            </div>
          </div>
          <div>
            <p class="copyright">Copyright © 2002, 2003 FhG FOKUS</p>
          </div>
        </div>
        <hr />
      </div>
      <div class="toc">
        <p>
          <strong>Table of Contents</strong>
        </p>
        <dl>
          <dt>
            <span class="chapter">
              <a href="#idp59032">1. Admin Guide</a>
            </span>
          </dt>
          <dd>
            <dl>
              <dt>
                <span class="section">
                  <a href="#auth.overview">1. Overview</a>
                </span>
              </dt>
              <dt>
                <span class="section">
                  <a href="#auth.dep">2. Dependencies</a>
                </span>
              </dt>
              <dt>
                <span class="section">
                  <a href="#auth.parameters">3. Parameters</a>
                </span>
              </dt>
              <dd>
                <dl>
                  <dt>
                    <span class="section">
                      <a href="#auth.p.auth_checks_register">3.1. <code class="varname">auth_checks_register</code> (flags)</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#auth.p.auth_checks_no_dlg">3.2. <code class="varname">auth_checks_no_dlg</code> (flags)</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#auth.p.auth_checks_in_dlg">3.3. <code class="varname">auth_checks_in_dlg</code> (flags)</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#auth.p.qop">3.4. <code class="varname">qop</code> (string)</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#auth.p.nonce_count">3.5. <code class="varname">nonce_count</code> (boolean)</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#auth.p.one_time_nonce">3.6. <code class="varname">one_time_nonce</code> (boolean)</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#auth.p.nid_pool_no">3.7. <code class="varname">nid_pool_no</code> (integer)</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#auth.p.nc_array_size">3.8. <code class="varname">nc_array_size</code> (integer)</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#auth.p.nc_array_order">3.9. <code class="varname">nc_array_order</code> (integer)</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#auth.p.otn_in_flight_no">3.10. <code class="varname">otn_in_flight_no</code> (integer)</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#auth.p.otn_in_flight_order">3.11. <code class="varname">otn_in_flight_order</code> (integer)</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#auth.p.secret">3.12. <code class="varname">secret</code> (string)</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#auth.p.nonce_expire">3.13. <code class="varname">nonce_expire</code> (integer)</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#auth.p.nonce_auth_max_drift">3.14. <code class="varname">nonce_auth_max_drift</code> (integer)</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#auth.p.force_stateless_reply">3.15. <code class="varname">force_stateless_reply</code> (boolean)</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#auth.p.realm_prefix">3.16. <code class="varname">realm_prefix</code> (string)</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#auth.p.use_domain">3.17. <code class="varname">use_domain</code> (boolean)</a>
                    </span>
                  </dt>
                </dl>
              </dd>
              <dt>
                <span class="section">
                  <a href="#auth.functions">4. Functions</a>
                </span>
              </dt>
              <dd>
                <dl>
                  <dt>
                    <span class="section">
                      <a href="#auth.f.consume_credentials">4.1. <code class="function">consume_credentials()</code></a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#auth.f.has_credentials">4.2. <code class="function">has_credentials(realm)</code></a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#auth.f.www_challenge">4.3. 
			<code class="function">www_challenge(realm, flags)</code>
		</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#auth.f.proxy_challenge">4.4. 
			<code class="function">proxy_challenge(realm, flags)</code>
		</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#auth.f.auth_challenge">4.5. 
			<code class="function">auth_challenge(realm, flags)</code>
		</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#auth.f.pv_www_authenticate">4.6. 
		<code class="function">pv_www_authenticate(realm, passwd, flags [, method])</code>
		</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#auth.f.pv_proxy_authenticate">4.7. 
			<code class="function">pv_proxy_authenticate(realm, passwd, flags)</code>
		</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#auth.f.pv_auth_check">4.8. 
			<code class="function">pv_auth_check(realm, passwd, flags, checks)</code>
		</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#auth.f.auth_get_www_authenticate">4.9. 
			<code class="function">auth_get_www_authenticate(realm, flags, pvdest)</code>
		</a>
                    </span>
                  </dt>
                </dl>
              </dd>
            </dl>
          </dd>
        </dl>
      </div>
      <div class="list-of-examples">
        <p>
          <strong>List of Examples</strong>
        </p>
        <dl>
          <dt>1.1. <a href="#idm12680">Setting the <code class="varname">auth_checks_register</code> module 
				parameter</a></dt>
          <dt>1.2. <a href="#idp88872">qop example</a></dt>
          <dt>1.3. <a href="#idp70536">nonce_count example</a></dt>
          <dt>1.4. <a href="#idp82472">one_time_nonce example</a></dt>
          <dt>1.5. <a href="#idp1422528">nid_pool_no example</a></dt>
          <dt>1.6. <a href="#idp1427576">nc_array_size example</a></dt>
          <dt>1.7. <a href="#idp1432056">nc_array_order example</a></dt>
          <dt>1.8. <a href="#idp1437280">otn_in_flight_no example</a></dt>
          <dt>1.9. <a href="#idp1441784">otn_in_flight_order example</a></dt>
          <dt>1.10. <a href="#idp1444672">Setting secret module parameter</a></dt>
          <dt>1.11. <a href="#idp113488">nonce_expire example</a></dt>
          <dt>1.12. <a href="#idp117016">nonce_auth_max_drift example</a></dt>
          <dt>1.13. <a href="#idp119896">force_stateless_reply example</a></dt>
          <dt>1.14. <a href="#idp122552">realm_prefix parameter example</a></dt>
          <dt>1.15. <a href="#idp124784">force_stateless_reply example</a></dt>
          <dt>1.16. <a href="#idp2924992">consume_credentials example</a></dt>
          <dt>1.17. <a href="#idp2035864">consume_credentials example</a></dt>
          <dt>1.18. <a href="#idp2817512">www_challenge usage</a></dt>
          <dt>1.19. <a href="#idp2630640">proxy_challenge usage</a></dt>
          <dt>1.20. <a href="#idp2633432">auth_challenge usage</a></dt>
          <dt>1.21. <a href="#idp130808"><code class="function">pv_www_authenticate</code>
		usage</a></dt>
          <dt>1.22. <a href="#idp134824">pv_proxy_authenticate usage</a></dt>
          <dt>1.23. <a href="#idp139712">pv_auth_check usage</a></dt>
          <dt>1.24. <a href="#idp3119000">auth_get_www_authenticate</a></dt>
        </dl>
      </div>
      <div class="chapter" title="Chapter 1. Admin Guide">
        <div class="titlepage">
          <div>
            <div>
              <h2 class="title"><a id="idp59032"></a>Chapter 1. Admin Guide</h2>
            </div>
          </div>
        </div>
        <div class="toc">
          <p>
            <strong>Table of Contents</strong>
          </p>
          <dl>
            <dt>
              <span class="section">
                <a href="#auth.overview">1. Overview</a>
              </span>
            </dt>
            <dt>
              <span class="section">
                <a href="#auth.dep">2. Dependencies</a>
              </span>
            </dt>
            <dt>
              <span class="section">
                <a href="#auth.parameters">3. Parameters</a>
              </span>
            </dt>
            <dd>
              <dl>
                <dt>
                  <span class="section">
                    <a href="#auth.p.auth_checks_register">3.1. <code class="varname">auth_checks_register</code> (flags)</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#auth.p.auth_checks_no_dlg">3.2. <code class="varname">auth_checks_no_dlg</code> (flags)</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#auth.p.auth_checks_in_dlg">3.3. <code class="varname">auth_checks_in_dlg</code> (flags)</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#auth.p.qop">3.4. <code class="varname">qop</code> (string)</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#auth.p.nonce_count">3.5. <code class="varname">nonce_count</code> (boolean)</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#auth.p.one_time_nonce">3.6. <code class="varname">one_time_nonce</code> (boolean)</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#auth.p.nid_pool_no">3.7. <code class="varname">nid_pool_no</code> (integer)</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#auth.p.nc_array_size">3.8. <code class="varname">nc_array_size</code> (integer)</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#auth.p.nc_array_order">3.9. <code class="varname">nc_array_order</code> (integer)</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#auth.p.otn_in_flight_no">3.10. <code class="varname">otn_in_flight_no</code> (integer)</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#auth.p.otn_in_flight_order">3.11. <code class="varname">otn_in_flight_order</code> (integer)</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#auth.p.secret">3.12. <code class="varname">secret</code> (string)</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#auth.p.nonce_expire">3.13. <code class="varname">nonce_expire</code> (integer)</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#auth.p.nonce_auth_max_drift">3.14. <code class="varname">nonce_auth_max_drift</code> (integer)</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#auth.p.force_stateless_reply">3.15. <code class="varname">force_stateless_reply</code> (boolean)</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#auth.p.realm_prefix">3.16. <code class="varname">realm_prefix</code> (string)</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#auth.p.use_domain">3.17. <code class="varname">use_domain</code> (boolean)</a>
                  </span>
                </dt>
              </dl>
            </dd>
            <dt>
              <span class="section">
                <a href="#auth.functions">4. Functions</a>
              </span>
            </dt>
            <dd>
              <dl>
                <dt>
                  <span class="section">
                    <a href="#auth.f.consume_credentials">4.1. <code class="function">consume_credentials()</code></a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#auth.f.has_credentials">4.2. <code class="function">has_credentials(realm)</code></a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#auth.f.www_challenge">4.3. 
			<code class="function">www_challenge(realm, flags)</code>
		</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#auth.f.proxy_challenge">4.4. 
			<code class="function">proxy_challenge(realm, flags)</code>
		</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#auth.f.auth_challenge">4.5. 
			<code class="function">auth_challenge(realm, flags)</code>
		</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#auth.f.pv_www_authenticate">4.6. 
		<code class="function">pv_www_authenticate(realm, passwd, flags [, method])</code>
		</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#auth.f.pv_proxy_authenticate">4.7. 
			<code class="function">pv_proxy_authenticate(realm, passwd, flags)</code>
		</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#auth.f.pv_auth_check">4.8. 
			<code class="function">pv_auth_check(realm, passwd, flags, checks)</code>
		</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#auth.f.auth_get_www_authenticate">4.9. 
			<code class="function">auth_get_www_authenticate(realm, flags, pvdest)</code>
		</a>
                  </span>
                </dt>
              </dl>
            </dd>
          </dl>
        </div>
        <div class="section" title="1. Overview">
          <div class="titlepage">
            <div>
              <div>
                <h2 class="title"><a id="auth.overview"></a>1. Overview</h2>
              </div>
            </div>
          </div>
          <p>
	    This is a generic module that itself doesn't provide all functions
	    necessary for authentication but provides functions that are needed
	    by all other authentication related modules (so called
	    authentication backends).
	</p>
          <p>
	    We decided to divide the authentication code into several modules
	    because there are now more than one backends (currently database
	    authentication and radius are supported). This allows us to create
	    separate packages so users can install and load only the required
	    functionality. This also allows us to avoid unnecessary
	    dependencies in the binary packages.
	</p>
        </div>
        <div class="section" title="2. Dependencies">
          <div class="titlepage">
            <div>
              <div>
                <h2 class="title"><a id="auth.dep"></a>2. Dependencies</h2>
              </div>
            </div>
          </div>
          <p>
	    The module does not depend on any other module.
	</p>
        </div>
        <div class="section" title="3. Parameters">
          <div class="titlepage">
            <div>
              <div>
                <h2 class="title"><a id="auth.parameters"></a>3. Parameters</h2>
              </div>
            </div>
          </div>
          <div class="section" title="3.1. auth_checks_register (flags)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="auth.p.auth_checks_register"></a>3.1. <code class="varname">auth_checks_register</code> (flags)</h3>
                </div>
              </div>
            </div>
            <p>
		See description of parameter <code class="varname">auth_checks_in_dlg</code>.
	</p>
          </div>
          <div class="section" title="3.2. auth_checks_no_dlg (flags)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="auth.p.auth_checks_no_dlg"></a>3.2. <code class="varname">auth_checks_no_dlg</code> (flags)</h3>
                </div>
              </div>
            </div>
            <p>
		See description of parameter <code class="varname">auth_checks_in_dlg</code>.
	</p>
          </div>
          <div class="section" title="3.3. auth_checks_in_dlg (flags)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="auth.p.auth_checks_in_dlg"></a>3.3. <code class="varname">auth_checks_in_dlg</code> (flags)</h3>
                </div>
              </div>
            </div>
            <p>
		These three module parameters control which optional integrity
        checks will be performed on the SIP message carrying digest response
        during digest authentication. <code class="varname">auth_check_register</code>
        controls integrity checks to be performed on REGISTER messages,
        <code class="varname">auth_checks_no_dlg</code> controls which optional
        integrity checks will be performed on SIP requests that have no To
        header field or no To tag (in other words the requests either
        establishing or outside
        dialogs). <code class="varname">auth_checks_in_dlg</code> controls which
        integrity checks will be performed on SIP requests within dialogs,
        such as BYE or re-INVITE. The default value for all three parameters
        is 0 (old behaviour, no extra checks). The set of integrity checks
        that can be performed on REGISTERs is typically different from sets of
        integrity checks that can be performed for other SIP request types,
        hence we have three independent module parameters.
	</p>
            <p>
		Without the extra checks the nonce will protect only against expired
		values. Some reply attacks are still possible in the expire "window".
		A possible workaround is to always force qop 
		 authentication and always check the uri from the authorization
		 header, but this would not work if an upstream proxy rewrites the uri
		 and it will also not work with a lot of UA implementations.
	</p>
            <p>
		In this case the nonce value will be used only to hold
		the expire time (see <code class="varname">nonce_expire</code>) and an MD5
		over it and some secret (the MD5 is used to make sure that nobody
		tampers with the nonce expire time).
	</p>
            <p>
		When the extra checks are enabled, the nonce will include and extra
		MD5 over the selected part/parts of the message (see below) and some 
		other secret. This will be used to check if the selected part of 
		the message is the same when an UA tries to reuse the nonce, thus 
		protecting or severely limiting reply attacks.
	</p>
            <p>
		The possible flag values for all three parameters are:
		</p>
            <div class="itemizedlist">
              <ul class="itemizedlist">
                <li class="listitem">
                  <p>
				<span class="emphasis"><em>1</em></span> for checking if the message
				uri changed (uses the whole uri)
			</p>
                </li>
                <li class="listitem">
                  <p>
				<span class="emphasis"><em>2</em></span> for checking the callid
			</p>
                </li>
                <li class="listitem">
                  <p>
				<span class="emphasis"><em>4</em></span> for checking the from tag
			</p>
                </li>
                <li class="listitem">
                  <p>
				<span class="emphasis"><em>8</em></span> for checking the source ip
				(see nonce.h).
			</p>
                </li>
              </ul>
            </div>
            <p>
	</p>
            <p>
		For example setting
		 <code class="varname">auth_checks_register</code> to 3 would check if the
		 callid or the request uri changed from the REGISTER message for which
		 the original nonce was generated (this would allow nonce reuse only
		 within the same UA and for the expire time).  Note that enabling
		 the extra checks will limit nonce caching by UAs, requiring extra
		 challenges and roundtrips, but will provide much better protection.
	</p>
            <div class="warning" title="Warning" style="margin-left: 0.5in; margin-right: 0.5in;">
              <h3 class="title">Warning</h3>
              <p>
		Do not enable the from tag check (4) for REGISTERs
		(<code class="varname">auth_checks_register</code>) and out-of-dialog messages
		(<code class="varname">auth_checks_no_dlg</code>) unless you are sure that all
		your user agents do not change the from tag when challenged. Some
		user agents will also change the callid when the challenged request
		is not in-dialog, so avoid enabling the callid check (2) for
		messages that are not part of a dialog
		(<code class="varname">auth_checks_no_dlg</code>).
		In some rare case this will also have to be done for REGISTERs.
	</p>
            </div>
            <p>
		When the <code class="varname">secret</code> parameter is set and the extra
		checks are enabled, the first half of the <code class="varname">secret</code> 
		will be used for the expire time MD5 and the other half for the extra
		checks MD5, so make sure you have a long secret (32 chars or longer are
		recommended).
	</p>
            <div class="example">
              <a id="idm12680"></a>
              <p class="title">
                <strong>Example 1.1. Setting the <code class="varname">auth_checks_register</code> module 
				parameter</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
# For REGISTER requests we hash the Request-URI, Call-ID, and source IP of the
# request into the nonce string. This ensures that the generated credentials
# cannot be used with another registrar, user agent with another source IP
# address or Call-ID. Note that user agents that change Call-ID with every
# REGISTER message will not be able to register if you enable this.
modparam("auth", "auth_checks_register", 11)

# For dialog-establishing requests (such as the original INVITE, OPTIONS, etc)
# we hash the Request-URI and source IP. Hashing Call-ID and From tags takes
# some extra precaution, because these checks could render some UA unusable.
modparam("auth", "auth_checks_no_dlg", 9)

# For mid-dialog requests, such as re-INVITE, we can hash source IP and
# Request-URI just like in the previous case. In addition to that we can hash
# Call-ID and From tag because these are fixed within a dialog and are
# guaranteed not to change. This settings effectively restrict the usage of
# generated credentials to a single user agent within a single dialog.
modparam("auth", "auth_checks_in_dlg", 15)

...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="3.4. qop (string)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="auth.p.qop"></a>3.4. <code class="varname">qop</code> (string)</h3>
                </div>
              </div>
            </div>
            <p>
		If set, enable <span class="emphasis"><em>qop</em></span> for challenges: each challenge
		will include a <span class="emphasis"><em>qop</em></span> parameter. This is the 
		recommended way, but some older non rfc3261 compliant UAs might get
		confused and might not authenticate properly if <code class="varname">qop</code>
		is enabled.
	</p>
            <p>
		Enabling <code class="varname">qop</code> together with
		<code class="varname">nonce_count</code> will provide extra-security 
		(protection against replay attacks) while still allowing 
		credentials caching at the UA side and thus not compromising 
		performance.
	</p>
            <p>
		The possible values are: "auth", "auth-int" and "" (unset).
	</p>
            <p>
	    The default value is not-set ("").
	</p>
            <p>
		See also:
			<code class="varname">nonce_count</code>.
	</p>
            <div class="example">
              <a id="idp88872"></a>
              <p class="title">
                <strong>Example 1.2. qop example</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
modparam("auth", "qop", "auth")   # set qop=auth
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="3.5. nonce_count (boolean)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="auth.p.nonce_count"></a>3.5. <code class="varname">nonce_count</code> (boolean)</h3>
                </div>
              </div>
            </div>
            <p>
		If enabled the received <span class="emphasis"><em>nc</em></span> value is remembered 
		and checked against the older value (for a successful authentication
		the received <span class="emphasis"><em>nc</em></span> must be greater then the 
		previously received one, see rfc2617 for more details). This will 
		provide protection against replay attacks while still allowing
		credentials caching at the UA side.
	</p>
            <p>
		It depends on <code class="varname">qop</code> being enabled (if 
		<code class="varname">qop</code> is not enabled, the challenges won't include
		<span class="emphasis"><em>qop</em></span> and so the UA will probably not include the
		<span class="emphasis"><em>qop</em></span> or <span class="emphasis"><em>nc</em></span> parameters in its
		response).
	</p>
            <p>
		If a response doesn't include <span class="emphasis"><em>qop</em></span> or 
		<span class="emphasis"><em>nc</em></span> (for example obsolete UAs that don't support
		them) the response will be checked according to the other enabled
		nonce checks, in this order: one_time_nonce and auth_check_*.
		If a response includes <span class="emphasis"><em>nc</em></span> only the normal
		<code class="varname">nonce_expire</code> checks and the 
		<code class="varname">nonce_count</code> checks will be performed, all
		the other checks will be ignored.
	</p>
            <p>
		The <code class="varname">nonce_count</code> checks work by tracking a limited
		number of nonces. The maximum number of tracked nonces is set using
		the <code class="varname">nc_array_size</code> or 
		<code class="varname">nc_array_order</code> parameters. If this number is 
		exceeded, older entries will be overwritten. As long as the maximum
		rate of challengeable messages per average response time is lower then
		<code class="varname">nc_array_size</code>, the <code class="varname">nonce_count</code>
		checks should work flawlessly. For optimum performance (maximum reuse
		of cache credentials) <code class="varname">nc_array_size</code> divided by
		<code class="varname">nid_pool_no</code> should be lower then the message rate
		 multiplied by the desired <code class="varname">nonce_expire</code>.
	</p>
            <p>
		The maximum accepted <span class="emphasis"><em>nc</em></span> value is 255. If 
		<span class="emphasis"><em>nc</em></span> becomes greater then this, the nonce will be
		considered stale and the UA will be re-challenged.
	</p>
            <p>
		<span class="emphasis"><em>Note:</em></span> <code class="varname">nonce_count</code> should be 
		enabled only in stateful mode (a transaction should be created prior
		to the authentication check to absorb possible retransmissions and all
		the replies should be sent statefuly, using 
		<code class="function">t_reply()</code>).
		If <code class="varname">nonce_count</code> and the authentication checks are
		used in the stateless mode then all retransmissions will be 
		challenged.
	</p>
            <p>
		The default value is 0 (off).
	</p>
            <p>
		See also: 
					<code class="varname">qop</code>,
					<code class="varname">nc_array_size</code>,
					<code class="varname">nc_array_order</code>,
					<code class="varname">nid_pool_no</code>,
					<code class="varname">nonce_expire</code>.
					<code class="varname">one_time_nonce</code>.
	</p>
            <div class="example">
              <a id="idp70536"></a>
              <p class="title">
                <strong>Example 1.3. nonce_count example</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
modparam("auth", "nonce_count", 1) # enable nonce_count support
modparam("auth", "qop", "auth")    # enable qop=auth

....
route{
...
	# go stateful and catch retransmissions
	if (!t_newtran()) {
	    xlog("L_NOTICE", "Failed to create new transaction\n");
 	    drop;
	};
	if (method=="REGISTER"){
		if (!www_authenticate("test", "credentials")){
			# reply must be sent with t_reply because the 
			# transaction is already created at this point 
			# (we are in "stateful" mode)
			if ($? == -2){
				t_reply("500", "Internal Server Error");
			}else if ($? == -3){
				t_reply("400", "Bad Request");
			}else{
				if ($digest_challenge) 
					append_to_reply("%$digest_challenge");
				t_reply("401", "Unauthorized");
			}
			drop;
		}
		if (!save_noreply("location")) {
			t_reply("400", "Invalid REGISTER Request");
			drop;
		}
		append_to_reply("%$contact");
		t_reply("$code", "$reason"); # no %, avps are used directly 
		drop;
	}else{
		if (!proxy_authenticate("my_realm", "credentials")){
			if ($? == -2){
				t_reply("500", "Internal Server Error");
			}else if ($? == -3){
				t_reply("400", "Bad Request");
			}else{
				if ($digest_challenge) 
					append_to_reply("%$digest_challenge");
				t_reply("401", "Unauthorized");
			}
			drop;
		}
	}
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="3.6. one_time_nonce (boolean)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="auth.p.one_time_nonce"></a>3.6. <code class="varname">one_time_nonce</code> (boolean)</h3>
                </div>
              </div>
            </div>
            <p>
		If set to 1 nonce reuse is disabled: each nonce is allowed only once,
		in the first reponse to a challenge. All the messages will be 
		challenged, even retransmissions. Stateful mode should be used, to
		catch retransmissions before the authentication checks (using
		 <code class="function">t_newtran()</code> before the authentication checks
		 and sending all the replies with <code class="function">t_reply()</code>).
	</p>
            <p>
		<code class="varname">one_time_nonce</code> provides enhanced replay protections
		at the cost of invalidating UA side credentials caching, challenging
		every message (and thus generating extra messages and extra 
		round-trips) and requiring stateful mode. In general 
		<code class="varname">qop</code> and <code class="varname">nonce_count</code> should
		be prefered (if possible) with fallback to 
		<code class="varname">auth_checks_*</code>. Due to the disadvantages listed 
		above, <code class="varname">one_time_nonce</code> should be used only if the 
		extra checks provided by <code class="varname">auth_checks_register</code>,
		<code class="varname">auth_checks_no_dlg</code> and
		<code class="varname">auth_checks_in_dlg</code> are deemed insufficient for a
		specific setup.
	</p>
            <p>
		Compared to <code class="varname">nonce_count</code>, 
		<code class="varname">one_time_nonce</code> provides the same protection, but at
		a higher message cost. The only advantages are that it works with
		user agents that do not support <span class="emphasis"><em>qop</em></span> and 
		<span class="emphasis"><em>nc</em></span> and that it uses less memory for the same
		supported number of maximum in-flight nonces (by a factor of 8).
		<code class="varname">one_time_nonce</code> can be used as fallback from
		<code class="varname">nonce_count</code>, when the UA doesn't support 
		<span class="emphasis"><em>nc</em></span> (it happens automatically when both of them
		are enabled).
	</p>
            <p>
		Like <code class="varname">nonce_count</code>, <code class="varname">one_time_nonce</code>
		works by tracking a limited number of nonces. The maximum number of 
		tracked nonces is set using the <code class="varname">otn_in_flight_no</code> or
		<code class="varname">otn_in_flight_order</code> parameters. If this number is 
		exceeded, older entries will be overwritten. As long as the maximum
		rate of challengeable messages per average response time is lower then
		<code class="varname">otn_in_flight_no</code>, the 
		<code class="varname">one_time_nonce</code> checks should work flawlessly.
	</p>
            <p>
	    The default value is 0 (off).
	</p>
            <p>
		See also:
			<code class="varname">otn_in_flight_no</code>,
			<code class="varname">otn_in_flight_order</code>,
			<code class="varname">nid_pool_no</code> and
			<code class="varname">nonce_count</code>.
	</p>
            <div class="example">
              <a id="idp82472"></a>
              <p class="title">
                <strong>Example 1.4. one_time_nonce example</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
modparam("auth", "one_time_nonce", 1)
# Note: stateful mode should be used, see the nonce_count example
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="3.7. nid_pool_no (integer)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="auth.p.nid_pool_no"></a>3.7. <code class="varname">nid_pool_no</code> (integer)</h3>
                </div>
              </div>
            </div>
            <p>
		Controls the number of partitions for the 
		<code class="varname">nonce_count</code> and <code class="varname">one_time_nonce</code>
		arrays (it's common to both of them to reduce the nonce size).
	</p>
            <p>
		Instead of using single arrays for keeping nonce state, these arrays
		can be divided into more partitions. Each ser process is assigned to
		one of these partitions, allowing for higher concurrency on multi-CPU
		machines. Besides increasing performance, increasing 
		<code class="varname">nid_pool_no</code> has also a negative effect: it could
		decrease the maximum supported in-flight nonces in certain conditions.
		In the worst case, when only one ser process receives most of the 
		traffic (e.g. very busy tcp connection between two proxies), the 
		in-flight nonces could be limited to the array size 
		(<code class="varname">nc_array_size</code> for <code class="varname">nonce_count</code>
		 or <code class="varname">otn_in_flight_no</code> for 
		 <code class="varname">one_time_nonce</code>) divided by the partitions number
		 (<code class="varname">nid_pool_no</code>). However for normal traffic, when
		 the process receiving a message is either random or chosen in 
		 a round-robin fashion the maximum in-flight nonces number will be 
		 very little influenced by <code class="varname">nid_pool_no</code> (the 
		 messages will be close to equally distributed to processes using
		 different partitions).
	</p>
            <p>
		<code class="varname">nid_pool_no</code> value should be one of: 1, 2, 4, 8, 16,
		32 or 64 (the maximum value is 64 and all values should be of the 
		form 2^k or else they will be rounded down to 2^k).
	</p>
            <p>
	    The default value is 1.
	</p>
            <p>
		See also:
			<code class="varname">nonce_count</code>,
			<code class="varname">one_time_nonce</code>,
			<code class="varname">nc_array_size</code> and
			<code class="varname">otn_in_flight_no</code>.
	</p>
            <div class="example">
              <a id="idp1422528"></a>
              <p class="title">
                <strong>Example 1.5. nid_pool_no example</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
modparam("auth", "nid_pool_no", 4)
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="3.8. nc_array_size (integer)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="auth.p.nc_array_size"></a>3.8. <code class="varname">nc_array_size</code> (integer)</h3>
                </div>
              </div>
            </div>
            <p>
		Maximum number of in-flight nonces for <code class="varname">nonce_count</code>.
		It represents the maximum nonces for which state will be kept. When
		this number is exceeded, state for the older nonces will be 
		discarded to make space for new ones (see 
		<code class="varname">nonce_count</code> for more details).
	</p>
            <p>
		The value should be of the form 2^k. If it's not it will be rounded
		down to 2^k (for example a value of 1000000 will be rounded down to
		2^19=524288). <code class="varname">nc_array_order</code> can be used to 
		directly specify the power of 2 (e.g. 
		<code class="varname">nc_array_order</code> set to 20 is equivalent to
		<code class="varname">nc_array_size</code> set to 1048576).
	</p>
            <p>
		The memory used to keep the nonce state will be 
		<code class="varname">nc_array_size</code> in bytes.
	</p>
            <p>
	    The default value is 1048576 (1M in-flight nonces, using 1Mb memory).
	</p>
            <p>
		See also:
			<code class="varname">nonce_count</code> and
			<code class="varname">nid_pool_no</code>.
	</p>
            <div class="example">
              <a id="idp1427576"></a>
              <p class="title">
                <strong>Example 1.6. nc_array_size example</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
modparam("auth", "nc_array_size", 4194304)   # 4Mb
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="3.9. nc_array_order (integer)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="auth.p.nc_array_order"></a>3.9. <code class="varname">nc_array_order</code> (integer)</h3>
                </div>
              </div>
            </div>
            <p>
		Equivalent to <code class="varname">nc_array_size</code>, but instead of 
		directly specifying the size, its value is the power at which 2 should
		be raised (log2(<code class="varname">nc_array_size</code>)).
	</p>
            <p>
		<code class="varname">nc_array_size</code> = 2^<code class="varname">nc_array_order</code>.
		For more details see <code class="varname">nc_array_size</code>.
	</p>
            <p>
	    The default value is 20 (1M in-flight nonces, using 1Mb memory).
	</p>
            <p>
		See also:
			<code class="varname">nonce_count</code>,
			<code class="varname">nc_array_size</code> and
			<code class="varname">nid_pool_no</code>.
	</p>
            <div class="example">
              <a id="idp1432056"></a>
              <p class="title">
                <strong>Example 1.7. nc_array_order example</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
modparam("auth", "nc_array_order", 22)   # 4Mb
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="3.10. otn_in_flight_no (integer)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="auth.p.otn_in_flight_no"></a>3.10. <code class="varname">otn_in_flight_no</code> (integer)</h3>
                </div>
              </div>
            </div>
            <p>
		Maximum number of in-flight nonces for 
		<code class="varname">one_time_nonce</code>. It represents the maximum number
		of nonces remembered for the one-time-nonce check. When this 
		number is exceeded, information about older nonces will be discarded
		and overwritten with information about the new generated ones (see
		<code class="varname">one_time_nonce</code> for more details).
	</p>
            <p>
		The value should be of the form 2^k. If it's not it will be rounded
		down to 2^k (for example a value of 1000000 will be rounded down to
		2^19=524288). <code class="varname">otn_in_flight_no</code> can be used to 
		directly specify the power of 2 (e.g. 
		<code class="varname">otn_in_flight_order</code> set to 19 is equivalent to
		<code class="varname">otn_in_fligh_number</code> set to 524288).
	</p>
            <p>
		The memory used to keep the nonce information will be the
		<code class="varname">otn_in_flight_no</code> divided by 8 (only 1 bit of state
		is kept per nonce).
	</p>
            <p>
		The default value is 1048576 (1M in-flight nonces, using 
		128Kb memory).
	</p>
            <p>
		See also:
			<code class="varname">one_time_nonce</code> and
			<code class="varname">nid_pool_no</code>.
	</p>
            <div class="example">
              <a id="idp1437280"></a>
              <p class="title">
                <strong>Example 1.8. otn_in_flight_no example</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
modparam("auth", "otn_in_flight_no", 8388608)   # 8 Mb (1Mb memory)
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="3.11. otn_in_flight_order (integer)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="auth.p.otn_in_flight_order"></a>3.11. <code class="varname">otn_in_flight_order</code> (integer)</h3>
                </div>
              </div>
            </div>
            <p>
		Equivalent to <code class="varname">otn_in_flight_no</code>, but instead of
		directly specifying the size, its value is the power at which 2 should
		be raised (log2(<code class="varname">otn_in_flight_no</code>)).
	</p>
            <p>
		<code class="varname">otn_in_flight_no</code> = 
		2^<code class="varname">otn_in_flight_order</code>.
		For more details see <code class="varname">otn_in_flight_order</code>.
	</p>
            <p>
		The default value is 20 (1M in-flight nonces, using 128Kb memory).
	</p>
            <p>
		See also:
			<code class="varname">one_time_nonce</code>,
			<code class="varname">otn_in_flight_no</code> and
			<code class="varname">nid_pool_no</code>.
	</p>
            <div class="example">
              <a id="idp1441784"></a>
              <p class="title">
                <strong>Example 1.9. otn_in_flight_order example</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
modparam("auth", "otn_in_flight_order", 23)   # 8 Mb (1Mb memory)
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="3.12. secret (string)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="auth.p.secret"></a>3.12. <code class="varname">secret</code> (string)</h3>
                </div>
              </div>
            </div>
            <p>Secret phrase used to calculate the nonce value used to challenge
	the client for authentication.</p>
            <p>If you use multiple servers in your installation, and would like to
	authenticate on the second server against the nonce generated at the
	first one its necessary to explicitly set the secret to the same value
	on all servers. However, as the use of a shared (and fixed) secret as
	nonce is insecure, it is much better is to stay with the default. Any
	clients should send the authenticated request to the server that 
	issued the challenge.
	</p>
            <p>
	    Default value is randomly generated string.
	</p>
            <div class="example">
              <a id="idp1444672"></a>
              <p class="title">
                <strong>Example 1.10. Setting secret module parameter</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
modparam("auth", "secret", "johndoessecretphrase")
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="3.13. nonce_expire (integer)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="auth.p.nonce_expire"></a>3.13. <code class="varname">nonce_expire</code> (integer)</h3>
                </div>
              </div>
            </div>
            <p>
	    Nonces have limited lifetime. After a given period of time nonces
	    will be considered invalid. This is to protect replay
	    attacks. Credentials containing a stale nonce will be not
	    authorized, but the user agent will be challenged again. This time
	    the challenge will contain <code class="varname">stale</code> parameter which
	    will indicate to the client that it doesn't have to disturb user by
	    asking for username and password, it can recalculate credentials
	    using existing username and password.
	</p>
            <p>
	    The value is in seconds and default value is 300 seconds.
	</p>
            <div class="example">
              <a id="idp113488"></a>
              <p class="title">
                <strong>Example 1.11. nonce_expire example</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
modparam("auth", "nonce_expire", 600)   # Set nonce_expire to 600s
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="3.14. nonce_auth_max_drift (integer)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="auth.p.nonce_auth_max_drift"></a>3.14. <code class="varname">nonce_auth_max_drift</code> (integer)</h3>
                </div>
              </div>
            </div>
            <p>
		Maximum difference in seconds between a nonce creation time and the
		current time, if the nonce creation time appears to be in the future.
	</p>
            <p>
		In some cases, like shortly after a system time backward adjustment 
		or when the current proxy is part of a cluster which is not
		time-synchronized, it's possible to receive a nonce with creation time
		in the future. In this case if the difference is greater then
		<code class="varname">nonce_auth_max_drift</code> seconds, consider the nonce
		stale and re-challenge (otherwise after a dramatic time change
		backwards, it might happen that some previously generated nonces will
		be valid for too much time).
	</p>
            <p>
		The default value is 3 seconds
	</p>
            <p>
		See also: <code class="varname">nonce_expire</code>.
	</p>
            <div class="example">
              <a id="idp117016"></a>
              <p class="title">
                <strong>Example 1.12. nonce_auth_max_drift example</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
modparam("auth", "nonce_auth_max_drift", 1)   # set max drift to 1 s
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="3.15. force_stateless_reply (boolean)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="auth.p.force_stateless_reply"></a>3.15. <code class="varname">force_stateless_reply</code> (boolean)</h3>
                </div>
              </div>
            </div>
            <p>
		If set to 1, <code class="function">www_challenge()</code> and
		<code class="function">proxy_challenge()</code>
		functions send reply statelessly no matter if transaction
                exists or not.  If set to 0 (default), reply is sent statefully
		if transaction exists and stelelessly otherwise.
	</p>
            <div class="example">
              <a id="idp119896"></a>
              <p class="title">
                <strong>Example 1.13. force_stateless_reply example</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
modparam("auth", "force_stateless_reply", 1)
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="3.16. realm_prefix (string)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="auth.p.realm_prefix"></a>3.16. <code class="varname">realm_prefix</code> (string)</h3>
                </div>
              </div>
            </div>
            <p>
			Prefix to be automatically strip from realm. As an alternative to
			SRV records (not all SIP clients support SRV lookup), a subdomain
			of the master domain can be defined for SIP purposes (like 
			sip.mydomain.net pointing to same IP address as the SRV
			record for mydomain.net). By ignoring the realm_prefix 
			<span class="quote">“<span class="quote">sip.</span>”</span>, at authentication, sip.mydomain.net will be
			equivalent to mydomain.net .
		</p>
            <p>
		Default value is empty string.
		</p>
            <div class="example">
              <a id="idp122552"></a>
              <p class="title">
                <strong>Example 1.14. realm_prefix parameter example</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">modparam("auth", "realm_prefix", "sip.")</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="3.17. use_domain (boolean)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="auth.p.use_domain"></a>3.17. <code class="varname">use_domain</code> (boolean)</h3>
                </div>
              </div>
            </div>
            <p>
		If set to 1, <code class="function">pv_auth_check()</code> uses
		domain parts of the URIs to check user identity.
	</p>
            <div class="example">
              <a id="idp124784"></a>
              <p class="title">
                <strong>Example 1.15. force_stateless_reply example</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
modparam("auth", "use_domain", 1)
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
        </div>
        <div class="section" title="4. Functions">
          <div class="titlepage">
            <div>
              <div>
                <h2 class="title"><a id="auth.functions"></a>4. Functions</h2>
              </div>
            </div>
          </div>
          <div class="section" title="4.1. consume_credentials()">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="auth.f.consume_credentials"></a>4.1. <code class="function">consume_credentials()</code></h3>
                </div>
              </div>
            </div>
            <p>
	    This function removes previously authorized credential headers from the
	    message being processed by the server. That means that the
	    downstream message will not contain credentials there were used by
	    this server. This ensures that the proxy will not reveal
	    information about credentials used to downstream elements and also
	    the message will be a little bit shorter. The function must be
	    called after <code class="function">www_authorize</code>,
		<code class="function">proxy_authorize</code>,
		<code class="function">www_authenticate</code> or
	    <code class="function">proxy_authenticate</code>.
	</p>
            <div class="example">
              <a id="idp2924992"></a>
              <p class="title">
                <strong>Example 1.16. consume_credentials example</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
if (www_authenticate("realm", "subscriber")) {
    consume_credentials();
};
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="4.2. has_credentials(realm)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="auth.f.has_credentials"></a>4.2. <code class="function">has_credentials(realm)</code></h3>
                </div>
              </div>
            </div>
            <p>
		This function returns true of the request has Autorization or
		Proxy-Authorization header with provided realm. The parameter
		can be string with pseudo-variables.
	</p>
            <div class="example">
              <a id="idp2035864"></a>
              <p class="title">
                <strong>Example 1.17. consume_credentials example</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
if (has_credentials("myrealm")) {
    ...
}
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="4.3.  www_challenge(realm, flags)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="auth.f.www_challenge"></a>4.3. 
			<code class="function">www_challenge(realm, flags)</code>
		</h3>
                </div>
              </div>
            </div>
            <p>
		The function challenges a user agent. It will generate a
		WWW-Authorize header field containing a digest challenge, it will
		put the header field into a response generated from the request the
		server is processing and send the reply. Upon reception of such a
		reply the user agent should compute credentials and retry the
		request. For more information regarding digest authentication
		see RFC2617.  See module parameter force_stateless_reply
		regarding sending of the reply.
		</p>
            <p>Meaning of the parameters is as follows:</p>
            <div class="itemizedlist">
              <ul class="itemizedlist">
                <li class="listitem">
                  <p><span class="emphasis"><em>realm</em></span> - Realm is a opaque string that
			the user agent should present to the user so he can decide what
			username and password to use. Usually this is domain of the host
			the server is running on.
			</p>
                  <p>
			It must not be empty string <span class="quote">“<span class="quote"></span>”</span>. In case of REGISTER
			requests, the To header field domain (e.g., variable $td) can be used
			(because this header field represents the user being registered),
			for all other messages From header field domain can be used
			(e.g., variable $fd).
			</p>
                  <p>
			The string may contain pseudo variables.
			</p>
                </li>
                <li class="listitem">
                  <p><span class="emphasis"><em>flags</em></span> - Value of this parameter can be
			a bitmask of following:</p>
                  <div class="itemizedlist">
                    <ul class="itemizedlist">
                      <li class="listitem">
                        <p><span class="emphasis"><em>1</em></span> - build challenge header with
					qop=auth</p>
                      </li>
                      <li class="listitem">
                        <p><span class="emphasis"><em>2</em></span> - build challenge header with
					qop=auth-int</p>
                      </li>
                      <li class="listitem">
                        <p><span class="emphasis"><em>4</em></span> - do not send '500 Internal
					Server Error' reply automatically in failure cases
					(error code is returned to config)</p>
                      </li>
                      <li class="listitem">
                        <p><span class="emphasis"><em>16</em></span> - build challenge header with
					stale=true</p>
                      </li>
                    </ul>
                  </div>
                </li>
              </ul>
            </div>
            <p>
		This function can be used from REQUEST_ROUTE.
		</p>
            <div class="example">
              <a id="idp2817512"></a>
              <p class="title">
                <strong>Example 1.18. www_challenge usage</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
if (!www_authenticate("$td", "subscriber")) {
	www_challenge("$td", "1");
}
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="4.4.  proxy_challenge(realm, flags)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="auth.f.proxy_challenge"></a>4.4. 
			<code class="function">proxy_challenge(realm, flags)</code>
		</h3>
                </div>
              </div>
            </div>
            <p>
		The function challenges a user agent. It will generate a
		Proxy-Authorize header field containing a digest challenge, it will
		put the header field into a response generated from the request the
		server is processing and send the reply. Upon reception of such a
		reply the user agent should compute credentials and retry the request.
		For more information regarding digest authentication see RFC2617.
		See module parameter force_stateless_reply regarding sending of the reply.
		</p>
            <p>Meaning of the parameters is the same as for function
		www_challenge(realm, flags)</p>
            <p>
		This function can be used from REQUEST_ROUTE.
		</p>
            <div class="example">
              <a id="idp2630640"></a>
              <p class="title">
                <strong>Example 1.19. proxy_challenge usage</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
if (!proxy_authenticate("$fd", "subscriber")) {
	proxy_challenge("$fd", "1");
};
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="4.5.  auth_challenge(realm, flags)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="auth.f.auth_challenge"></a>4.5. 
			<code class="function">auth_challenge(realm, flags)</code>
		</h3>
                </div>
              </div>
            </div>
            <p>
		The function challenges a user agent for authentication. It combines
		the functions www_challenge() and proxy_challenge(), by calling
		internally the first one for REGISTER requests and the second one for
		the rest of other request types.
		</p>
            <p>Meaning of the parameters the same as for function
		www_challenge(realm, flags)</p>
            <p>
		This function can be used from REQUEST_ROUTE.
		</p>
            <div class="example">
              <a id="idp2633432"></a>
              <p class="title">
                <strong>Example 1.20. auth_challenge usage</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
if (!auth_check("$fd", "subscriber", "1")) {
	auth_challenge("$fd", "1");
};
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="4.6.  pv_www_authenticate(realm, passwd, flags [, method])">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="auth.f.pv_www_authenticate"></a>4.6. 
		<code class="function">pv_www_authenticate(realm, passwd, flags [, method])</code>
		</h3>
                </div>
              </div>
            </div>
            <p>
		The function verifies credentials according to
		<a class="ulink" href="javascript:if(confirm('http://www.ietf.org/rfc/rfc2617.txt  \n\nļ޷ Teleport Ultra , Ϊ һ·ⲿΪʼַĵַ  \n\nڷϴ?'))window.location='http://www.ietf.org/rfc/rfc2617.txt'" tppabs="http://www.ietf.org/rfc/rfc2617.txt">RFC2617</a>.
		If the credentials are verified successfully then the function
		will succeed and mark the credentials as authorized (marked
		credentials can be later used by some other functions). If the
		function was unable to verify the credentials for some reason
		then it will fail and the script should
		call <code class="function">www_challenge</code> which will
		challenge the user again.
		</p>
            <p>Negative codes may be interpreted as follows:</p>
            <div class="itemizedlist">
              <ul class="itemizedlist">
                <li class="listitem">
                  <p>
			<span class="emphasis"><em>-1 (generic error)</em></span> - some generic error
			occurred and no reply was sent out
			</p>
                </li>
                <li class="listitem">
                  <p>
			<span class="emphasis"><em>-2 (invalid password)</em></span> - wrong password
			</p>
                </li>
                <li class="listitem">
                  <p>
			<span class="emphasis"><em>-4 (nonce expired)</em></span> - the nonce has expired
			</p>
                </li>
                <li class="listitem">
                  <p>
			<span class="emphasis"><em>-5 (no credentials)</em></span> - request does not contain
			an Authorization header with the correct realm
			</p>
                </li>
                <li class="listitem">
                  <p>
			<span class="emphasis"><em>-6 (nonce reused)</em></span> - the nonce has already been
			used to authenticate a previous request
			</p>
                </li>
              </ul>
            </div>
            <p>Meaning of the parameters is as follows:</p>
            <div class="itemizedlist">
              <ul class="itemizedlist">
                <li class="listitem">
                  <p><span class="emphasis"><em>realm</em></span> - Realm is a opaque string that
			the user agent should present to the user so he can decide what
			username and password to use. Usually this is domain of the host
			the server is running on.
			</p>
                  <p>
			It must not be empty string <span class="quote">“<span class="quote"></span>”</span>. In case of REGISTER
			requests To header field domain (e.g., varibale $td) can be used
			(because this header field represents a user being registered),
			for all other messages From header field domain can be used
			(e.g., varibale $fd).
			</p>
                  <p>
			The string may contain pseudo variables.
			</p>
                </li>
                <li class="listitem">
                  <p><span class="emphasis"><em>passwd</em></span> - the password to be used
			for authentication. Can contain config variables. The Username is
			taken from Auth header.</p>
                </li>
                <li class="listitem">
                  <p><span class="emphasis"><em>flags</em></span> - the value of this parameter
				can be a bitmask of following:</p>
                  <div class="itemizedlist">
                    <ul class="itemizedlist">
                      <li class="listitem">
                        <p><span class="emphasis"><em>1</em></span> - the value of password
					parameter is HA1 format</p>
                      </li>
                      <li class="listitem">
                        <p><span class="emphasis"><em>2</em></span> - build challenge header with
					no qop and add it to avp</p>
                      </li>
                      <li class="listitem">
                        <p><span class="emphasis"><em>4</em></span> - build challenge header with
					qop=auth and add it to avp</p>
                      </li>
                      <li class="listitem">
                        <p><span class="emphasis"><em>8</em></span> - build challenge header with
					qop=auth-int and add it to avp</p>
                      </li>
                      <li class="listitem">
                        <p><span class="emphasis"><em>16</em></span> - build challenge header with
					stale=true</p>
                      </li>
                    </ul>
                  </div>
                </li>
                <li class="listitem">
                  <p><span class="emphasis"><em>method</em></span> - the method to be used for
			authentication. This parameter is optional and if not set
			is the first "word" on the request-line.</p>
                </li>
              </ul>
            </div>
            <p>
			When challenge header is built and stored in avp,
			append_to_reply() and the sl reply functions can be used to send
			appropriate SIP reply to challenge for authentication.
		</p>
            <p>
		This function can be used from REQUEST_ROUTE.
		</p>
            <div class="example">
              <a id="idp130808"></a>
              <p class="title">
                <strong>Example 1.21. <code class="function">pv_www_authenticate</code>
		usage</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
if (!pv_www_authenticate("$td", "123abc", "0")) {
	www_challenge("$td", "1");
};
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="4.7.  pv_proxy_authenticate(realm, passwd, flags)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="auth.f.pv_proxy_authenticate"></a>4.7. 
			<code class="function">pv_proxy_authenticate(realm, passwd, flags)</code>
		</h3>
                </div>
              </div>
            </div>
            <p>
		The function verifies credentials according to
		<a class="ulink" href="javascript:if(confirm('http://www.ietf.org/rfc/rfc2617.txt  \n\nļ޷ Teleport Ultra , Ϊ һ·ⲿΪʼַĵַ  \n\nڷϴ?'))window.location='http://www.ietf.org/rfc/rfc2617.txt'" tppabs="http://www.ietf.org/rfc/rfc2617.txt">RFC2617</a>. If
		the credentials are verified successfully then the function will
		succeed and mark the credentials as authorized (marked credentials can
		be later used by some other functions). If the function was unable to
		verify the credentials for some reason then it will fail and
		the script should call
		<code class="function">proxy_challenge</code> which will
		challenge the user again. For more about the negative return codes,
		see the above function.
		</p>
            <p>Meaning of the parameters is the same as for
		pv_www_authenticate(realm, passwd, flags)</p>
            <p>
		This function can be used from REQUEST_ROUTE.
		</p>
            <div class="example">
              <a id="idp134824"></a>
              <p class="title">
                <strong>Example 1.22. pv_proxy_authenticate usage</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
$avp(password)="xyz";
if (!pv_proxy_authenticate("$fd", "$avp(password)", "0")) {
	proxy_challenge("$fd", "1");
};
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="4.8.  pv_auth_check(realm, passwd, flags, checks)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="auth.f.pv_auth_check"></a>4.8. 
			<code class="function">pv_auth_check(realm, passwd, flags, checks)</code>
		</h3>
                </div>
              </div>
            </div>
            <p>
		The function combines the functionalities of
		<code class="function">pv_www_authenticate</code> and
		<code class="function">pv_proxy_authenticate</code>, first being
		exectuted if the SIP request is a REGISTER, the second for the rest.
		</p>
            <p>
		Meaning of the first three parameters is the same as for
		pv_www_authenticate(realm, passwd, flags).
		</p>
            <p>
		Parameter <span class="emphasis"><em>checks</em></span> can be used to control the
		behaviour of the function. If it is 1, then the function will
		check to see if the authentication username matches either To or
		From header username, a matter of whether it is for a REGISTER
		request or not.	The parameter may be a pseudo variable.
		</p>
            <p>
		The set of possible return codes is the same than pv_{www,proxy}_authenticate, with
		one more possible value:
		    </p>
            <p><span class="emphasis"><em>-8 (auth user mismatch)</em></span> - the auth user is different
               than the From/To user
			</p>
            <p>
		</p>
            <p>
		This function can be used from REQUEST_ROUTE.
		</p>
            <div class="example">
              <a id="idp139712"></a>
              <p class="title">
                <strong>Example 1.23. pv_auth_check usage</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
$avp(password)="xyz";
if (!pv_auth_check("$fd", "$avp(password)", "0", "1")) {
	proxy_challenge("$fd", "1");
};
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="4.9.  auth_get_www_authenticate(realm, flags, pvdest)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="auth.f.auth_get_www_authenticate"></a>4.9. 
			<code class="function">auth_get_www_authenticate(realm, flags, pvdest)</code>
		</h3>
                </div>
              </div>
            </div>
            <p>
		Build WWW-Authentication header and set the resulting value in 'pvdest' pseudo-variable parameter.
		</p>
            <p>Meaning of the realm and flags parameters is the same as for
		pv_www_authenticate(realm, passwd, flags)</p>
            <p>
		This function can be used from ANY_ROUTE.
		</p>
            <div class="example">
              <a id="idp3119000"></a>
              <p class="title">
                <strong>Example 1.24. auth_get_www_authenticate</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
if (auth_get_www_authenticate("$fd", "0", "$var(wauth)")) {
	xlog("www authenticate header is [$var(wauth)]\n");
}
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
