<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>Mediaproxy Module</title>
    <link rel="stylesheet" type="text/css" href="../../../../css/sr-doc.css" tppabs="http://kamailio.org/css/sr-doc.css" />
    <meta name="generator" content="DocBook XSL Stylesheets V1.76.1" />
    <link rel="home" href="#idm15532640" title="Mediaproxy Module" />
    <link rel="next" href="#idp4504" title="Chapter 1. Admin Guide" />
  </head>
  <body>
    <div class="book" title="Mediaproxy Module">
      <div class="titlepage">
        <div>
          <div>
            <h1 class="title"><a id="idm15532640"></a>Mediaproxy Module</h1>
          </div>
          <div>
            <div class="authorgroup">
              <div class="author">
                <h3 class="author"><span class="firstname">Dan</span> <span class="surname">Pascu</span></h3>
                <code class="email">&lt;<a class="email" href="mailto:dan@ag-projects.com">dan@ag-projects.com</a>&gt;</code>
              </div>
              <div class="editor">
                <h4 class="editedby">Edited by</h4>
                <h3 class="editor"><span class="firstname">Dan</span> <span class="surname">Pascu</span></h3>
                <code class="email">&lt;<a class="email" href="mailto:dan@ag-projects.com">dan@ag-projects.com</a>&gt;</code>
              </div>
            </div>
          </div>
          <div>
            <p class="copyright">Copyright © 2004 Dan Pascu</p>
          </div>
        </div>
        <hr />
      </div>
      <div class="toc">
        <p>
          <strong>Table of Contents</strong>
        </p>
        <dl>
          <dt>
            <span class="chapter">
              <a href="#idp4504">1. Admin Guide</a>
            </span>
          </dt>
          <dd>
            <dl>
              <dt>
                <span class="section">
                  <a href="#idp933768">1. Overview</a>
                </span>
              </dt>
              <dt>
                <span class="section">
                  <a href="#idp1761488">2. Principle of operation</a>
                </span>
              </dt>
              <dt>
                <span class="section">
                  <a href="#idp3016400">3. Features</a>
                </span>
              </dt>
              <dt>
                <span class="section">
                  <a href="#idp3018448">4. Dependencies</a>
                </span>
              </dt>
              <dd>
                <dl>
                  <dt>
                    <span class="section">
                      <a href="#idp3018800">4.1. SIP Router Modules</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#idp3020544">4.2. External Libraries or Applications</a>
                    </span>
                  </dt>
                </dl>
              </dd>
              <dt>
                <span class="section">
                  <a href="#idp3022264">5. Exported parameters</a>
                </span>
              </dt>
              <dd>
                <dl>
                  <dt>
                    <span class="section">
                      <a href="#idp2886128">5.1. <code class="varname">disable</code> (int)</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#idm15136">5.2. <code class="varname">mediaproxy_socket</code> (string)</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#idm12496">5.3. <code class="varname">mediaproxy_timeout</code> (int)</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#idm9760">5.4. <code class="varname">signaling_ip_avp</code> (string)</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#idp1989000">5.5. <code class="varname">media_relay_avp</code> (string)</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#idm5912">5.6. <code class="varname">ice_candidate</code> (string)</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#idm2904">5.7. <code class="varname">ice_candidate_avp</code> (string)</a>
                    </span>
                  </dt>
                </dl>
              </dd>
              <dt>
                <span class="section">
                  <a href="#idp63528">6. Functions</a>
                </span>
              </dt>
              <dd>
                <dl>
                  <dt>
                    <span class="section">
                      <a href="#idp63896">6.1. <code class="function">engage_media_proxy()</code></a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#idp68176">6.2. <code class="function">use_media_proxy()</code></a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#idp73224">6.3. <code class="function">end_media_session()</code></a>
                    </span>
                  </dt>
                </dl>
              </dd>
            </dl>
          </dd>
        </dl>
      </div>
      <div class="list-of-examples">
        <p>
          <strong>List of Examples</strong>
        </p>
        <dl>
          <dt>1.1. <a href="#idm16312">Setting the <code class="varname">disable</code> parameter</a></dt>
          <dt>1.2. <a href="#idm13728">Setting the <code class="varname">mediaproxy_socket</code> parameter</a></dt>
          <dt>1.3. <a href="#idm10952">Setting the <code class="varname">mediaproxy_timeout</code> parameter</a></dt>
          <dt>1.4. <a href="#idp2514768">Setting the <code class="varname">signaling_ip_avp</code> parameter</a></dt>
          <dt>1.5. <a href="#idm7064">Setting the <code class="varname">media_relay_avp</code> parameter</a></dt>
          <dt>1.6. <a href="#idm4104">Setting the <code class="varname">ice_candidate</code> parameter</a></dt>
          <dt>1.7. <a href="#idm1184">Setting the <code class="varname">ice_candidate_avp</code> parameter</a></dt>
          <dt>1.8. <a href="#idp66744">Using the <code class="function">engage_media_proxy</code> function</a></dt>
          <dt>1.9. <a href="#idp71808">Using the <code class="function">use_media_proxy</code> function</a></dt>
          <dt>1.10. <a href="#idp74976">Using the <code class="function">end_media_session</code> function</a></dt>
        </dl>
      </div>
      <div class="chapter" title="Chapter 1. Admin Guide">
        <div class="titlepage">
          <div>
            <div>
              <h2 class="title"><a id="idp4504"></a>Chapter 1. Admin Guide</h2>
            </div>
          </div>
        </div>
        <div class="toc">
          <p>
            <strong>Table of Contents</strong>
          </p>
          <dl>
            <dt>
              <span class="section">
                <a href="#idp933768">1. Overview</a>
              </span>
            </dt>
            <dt>
              <span class="section">
                <a href="#idp1761488">2. Principle of operation</a>
              </span>
            </dt>
            <dt>
              <span class="section">
                <a href="#idp3016400">3. Features</a>
              </span>
            </dt>
            <dt>
              <span class="section">
                <a href="#idp3018448">4. Dependencies</a>
              </span>
            </dt>
            <dd>
              <dl>
                <dt>
                  <span class="section">
                    <a href="#idp3018800">4.1. SIP Router Modules</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#idp3020544">4.2. External Libraries or Applications</a>
                  </span>
                </dt>
              </dl>
            </dd>
            <dt>
              <span class="section">
                <a href="#idp3022264">5. Exported parameters</a>
              </span>
            </dt>
            <dd>
              <dl>
                <dt>
                  <span class="section">
                    <a href="#idp2886128">5.1. <code class="varname">disable</code> (int)</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#idm15136">5.2. <code class="varname">mediaproxy_socket</code> (string)</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#idm12496">5.3. <code class="varname">mediaproxy_timeout</code> (int)</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#idm9760">5.4. <code class="varname">signaling_ip_avp</code> (string)</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#idp1989000">5.5. <code class="varname">media_relay_avp</code> (string)</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#idm5912">5.6. <code class="varname">ice_candidate</code> (string)</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#idm2904">5.7. <code class="varname">ice_candidate_avp</code> (string)</a>
                  </span>
                </dt>
              </dl>
            </dd>
            <dt>
              <span class="section">
                <a href="#idp63528">6. Functions</a>
              </span>
            </dt>
            <dd>
              <dl>
                <dt>
                  <span class="section">
                    <a href="#idp63896">6.1. <code class="function">engage_media_proxy()</code></a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#idp68176">6.2. <code class="function">use_media_proxy()</code></a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#idp73224">6.3. <code class="function">end_media_session()</code></a>
                  </span>
                </dt>
              </dl>
            </dd>
          </dl>
        </div>
        <div class="section" title="1. Overview">
          <div class="titlepage">
            <div>
              <div>
                <h2 class="title"><a id="idp933768"></a>1. Overview</h2>
              </div>
            </div>
          </div>
          <p>
      Mediaproxy is an SIP Router module that is designed to allow automatic 
      NAT traversal for the majority of existing SIP clients. This means 
      that there will be no need to configure anything in particular on 
      the NAT box to allow these clients to work behind NAT when using 
      the mediaproxy module.
    </p>
        </div>
        <div class="section" title="2. Principle of operation">
          <div class="titlepage">
            <div>
              <div>
                <h2 class="title"><a id="idp1761488"></a>2. Principle of operation</h2>
              </div>
            </div>
          </div>
          <p>
      This NAT traversal solution operates by placing a media relay in the
      middle between 2 SIP user-agents. It mangles the SDP messages for both
      of them in a way that will make the parties talk with the relay while
      they think they talk directly with each other.
    </p>
          <p>
      Mediaproxy consists of 2 components:
      </p>
          <div class="itemizedlist">
            <ul class="itemizedlist">
              <li class="listitem">
                <p>The SIP Router mediaproxy module</p>
              </li>
              <li class="listitem">
                <p>
            An external application called MediaProxy which employs a
            dispatcher and multiple distributed media relays. This is
            available from http://ag-projects.com/MediaProxy.html
            (version 2.0.0 or newer is required by this module).
          </p>
              </li>
            </ul>
          </div>
          <p>
    </p>
          <p>
      The mediaproxy dispatcher runs on the same machine as SIP Router
      and its purpose is to select a media relay for a call. The media
      relay may run on the same machine as the dispatcher or on multiple
      remote hosts and its purpose is to forward the streams between the
      calling parties. To find out more about the architecture of MediaProxy
      please read the documentation that comes with it.
    </p>
          <p>
      To be able to act as a relay between the 2 user agents, the machine(s)
      running the module/proxy server must have a public IP address.
    </p>
          <p>
      SIP Router will ask the media relay to allocate as many ports as there are
      media streams in the SDP offer and answer. The media relay will send back
      to SIP Router the IP address and port(s) for them. Then SIP Router will
      replace the original contact IP and RTP ports from the SDP messages with
      the ones provided by the media relay. By doing this, both user agents will
      try to contact the media relay instead of communicating directly with each
      other. Once the user agents contact the media relay, it will record the
      addresses they came from and will know where to forward packets received
      from the other endpoint. This is needed because the address/port the NAT
      box will allocate for the media streams is not known before they actually
      leave the NAT box. However the address of the media relay is always known
      (being a public IP) so the 2 endpoints know where to connect. After they
      do so, the relay learns their addresses and can forward packets between
      them.
    </p>
          <p>
      The SIP clients that will work transparently behind NAT when using
      mediaproxy, are the so-called symmetric clients. The symmetric clients
      have the particularity that use the same port to send and receive data.
      This must be true for both signaling and media for a client to work
      transparently with mediaproxy without any configuration on the NAT box.
    </p>
        </div>
        <div class="section" title="3. Features">
          <div class="titlepage">
            <div>
              <div>
                <h2 class="title"><a id="idp3016400"></a>3. Features</h2>
              </div>
            </div>
          </div>
          <p>
      </p>
          <div class="itemizedlist">
            <ul class="itemizedlist">
              <li class="listitem">
                <p>
            make symmetric clients work behind NAT transparently, with no
            configuration needed on the client's NAT box.
          </p>
              </li>
              <li class="listitem">
                <p>
            have the ability to distribute RTP traffic on multiple media relays
            running on multiple hosts.
          </p>
              </li>
            </ul>
          </div>
          <p>
    </p>
        </div>
        <div class="section" title="4. Dependencies">
          <div class="titlepage">
            <div>
              <div>
                <h2 class="title"><a id="idp3018448"></a>4. Dependencies</h2>
              </div>
            </div>
          </div>
          <div class="section" title="4.1. SIP Router Modules">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="idp3018800"></a>4.1. SIP Router Modules</h3>
                </div>
              </div>
            </div>
            <p>
        The following modules must be loaded before this module:
        </p>
            <div class="itemizedlist">
              <ul class="itemizedlist">
                <li class="listitem">
                  <p>
              <span class="emphasis"><em>dialog</em></span> module - if engage_media_proxy is used
              (see below the description of engage_media_proxy).
            </p>
                </li>
              </ul>
            </div>
            <p>
      </p>
          </div>
          <div class="section" title="4.2. External Libraries or Applications">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="idp3020544"></a>4.2. External Libraries or Applications</h3>
                </div>
              </div>
            </div>
            <p>
        The following libraries or applications must be installed before
        running SIP Router with this module loaded:
        </p>
            <div class="itemizedlist">
              <ul class="itemizedlist">
                <li class="listitem">
                  <p>
              <span class="emphasis"><em>Mediaproxy version 2.4.2 or higher (but not
    necessarily on the same host as SIP Router)</em></span>.
            </p>
                </li>
              </ul>
            </div>
            <p>
      </p>
          </div>
        </div>
        <div class="section" title="5. Exported parameters">
          <div class="titlepage">
            <div>
              <div>
                <h2 class="title"><a id="idp3022264"></a>5. Exported parameters</h2>
              </div>
            </div>
          </div>
          <div class="section" title="5.1. disable (int)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="idp2886128"></a>5.1. <code class="varname">disable</code> (int)</h3>
                </div>
              </div>
            </div>
            <p>
        Boolean flag that specifies if mediaproxy should be disabled. This
        is useful when you want to use the same openser configuration in
        two different context, one using mediaproxy, the other not. In the
        case mediaproxy is disabled, calls to its functions will have no
        effect, allowing you to use the same configuration without changes.
      </p>
            <p>
        <span class="emphasis"><em>
          Default value is <span class="quote">“<span class="quote">0</span>”</span>.
        </em></span>
      </p>
            <div class="example">
              <a id="idm16312"></a>
              <p class="title">
                <strong>Example 1.1. Setting the <code class="varname">disable</code> parameter</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
modparam("mediaproxy", "disable", 1)
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="5.2. mediaproxy_socket (string)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="idm15136"></a>5.2. <code class="varname">mediaproxy_socket</code> (string)</h3>
                </div>
              </div>
            </div>
            <p>
        It is the path to the filesystem socket where the mediaproxy dispatcher
        listens for commands from the module.
      </p>
            <p>
        <span class="emphasis"><em>
          Default value is 
            <span class="quote">“<span class="quote">/var/run/mediaproxy/dispatcher.sock</span>”</span>.
        </em></span>
      </p>
            <div class="example">
              <a id="idm13728"></a>
              <p class="title">
                <strong>Example 1.2. Setting the <code class="varname">mediaproxy_socket</code> parameter</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
modparam("mediaproxy", "mediaproxy_socket", "/var/run/mediaproxy/dispatcher.sock")
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="5.3. mediaproxy_timeout (int)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="idm12496"></a>5.3. <code class="varname">mediaproxy_timeout</code> (int)</h3>
                </div>
              </div>
            </div>
            <p>
        How much time (in milliseconds) to wait for an answer from the
        mediaproxy dispatcher.
      </p>
            <p>
        <span class="emphasis"><em>
          Default value is <span class="quote">“<span class="quote">500</span>”</span>.
        </em></span>
      </p>
            <div class="example">
              <a id="idm10952"></a>
              <p class="title">
                <strong>Example 1.3. Setting the <code class="varname">mediaproxy_timeout</code> parameter</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
modparam("mediaproxy", "mediaproxy_timeout", 500)
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="5.4. signaling_ip_avp (string)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="idm9760"></a>5.4. <code class="varname">signaling_ip_avp</code> (string)</h3>
                </div>
              </div>
            </div>
            <p>
        Specification of the AVP which holds the IP address from where
        the SIP signaling originated. If this AVP is set it will be used
        to get the signaling IP address, else the source IP address
        from where the SIP message was received will be used.
        This AVP is meant to be used in cases where there are more than
        one proxy in the call setup path and the proxy that actually
        starts mediaproxy doesn't receive the SIP messages directly
        from the UA and it cannot determine the NAT IP address from
        where the signaling originated. In such a case attaching a
        SIP header at the first proxy and then copying that header's
        value into the signaling_ip_avp on the proxy that starts
        mediaproxy will allow it to get the correct NAT IP address
        from where the SIP signaling originated.
      </p>
            <p>
        <span class="emphasis"><em>
          Default value is <span class="quote">“<span class="quote">$avp(signaling_ip)</span>”</span>.
        </em></span>
      </p>
            <div class="example">
              <a id="idp2514768"></a>
              <p class="title">
                <strong>Example 1.4. Setting the <code class="varname">signaling_ip_avp</code> parameter</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
modparam("mediaproxy", "signaling_ip_avp", "$avp(nat_ip)")
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="5.5. media_relay_avp (string)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="idp1989000"></a>5.5. <code class="varname">media_relay_avp</code> (string)</h3>
                </div>
              </div>
            </div>
            <p>
        Specification of the AVP which holds an optional application
        defined media relay IP address of a particular media relay that
        is preferred to be used for the current call. If an IP address
        is written to this AVP before calling use_media_proxy(), it
        will be preferred by the dispatcher over the normal selection
        algorithm.
      </p>
            <p>
        <span class="emphasis"><em>
          Default value is <span class="quote">“<span class="quote">$avp(media_relay)</span>”</span>.
        </em></span>
      </p>
            <div class="example">
              <a id="idm7064"></a>
              <p class="title">
                <strong>Example 1.5. Setting the <code class="varname">media_relay_avp</code> parameter</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
modparam("mediaproxy", "media_relay_avp", "$avp(media_relay)")
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="5.6. ice_candidate (string)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="idm5912"></a>5.6. <code class="varname">ice_candidate</code> (string)</h3>
                </div>
              </div>
            </div>
            <p>
        Indicates the type of ICE candidate that will be added to the SDP. 
        It can take 3 values: 'none', 'low-priority' or 'high-priority'. 
        If 'none' is selected no candidate will be adeed to the SDP. If 
        'low-priority' is selected then a low priority candidate will be 
        added and if 'high-priority' is selected a high priority one.
      </p>
            <p>
        <span class="emphasis"><em>
          Default value is <span class="quote">“<span class="quote">none</span>”</span>.
        </em></span>
      </p>
            <div class="example">
              <a id="idm4104"></a>
              <p class="title">
                <strong>Example 1.6. Setting the <code class="varname">ice_candidate</code> parameter</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
modparam("mediaproxy", "ice_candidate", "low-priority")
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="5.7. ice_candidate_avp (string)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="idm2904"></a>5.7. <code class="varname">ice_candidate_avp</code> (string)</h3>
                </div>
              </div>
            </div>
            <p>
        Specification of the AVP which holds the ICE candidate that will be 
        inserted in the SDP. The value specified in this AVP will override 
        the value in ice_candidate module parameter.  If the AVP
        is not set, the default value will be used.
      </p>
            <p>
        <span class="emphasis"><em>
          Default value is <span class="quote">“<span class="quote">$avp(ice_candidate)</span>”</span>.
        </em></span>
      </p>
            <div class="example">
              <a id="idm1184"></a>
              <p class="title">
                <strong>Example 1.7. Setting the <code class="varname">ice_candidate_avp</code> parameter</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
modparam("mediaproxy", "ice_candidate_avp", "$avp(ice_candidate)")
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
        </div>
        <div class="section" title="6. Functions">
          <div class="titlepage">
            <div>
              <div>
                <h2 class="title"><a id="idp63528"></a>6. Functions</h2>
              </div>
            </div>
          </div>
          <div class="section" title="6.1. engage_media_proxy()">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="idp63896"></a>6.1. <code class="function">engage_media_proxy()</code></h3>
                </div>
              </div>
            </div>
            <p>
        Trigger the use of MediaProxy for all the dialog requests and
        replies that have an SDP body. This needs to be called only
        once for the first INVITE in a dialog. After that it will use
        the dialog module to trace the dialog and automatically call
        use_media_proxy() on every request and reply that belongs to
        the dialog and has an SDP body. When the dialog ends it will
        also call automatically end_media_session(). All of these are
        called internally on dialog callbacks, so for this function to
        work, the dialog module must be loaded and configured.
      </p>
            <p>
        This function is an advanced mechanism to use a media relay
        without having to manually call a function on each message that
        belongs to the dialog. However this method is less flexible,
        because once things were set in motion by calling this function
        on the first INVITE, it cannot be stopped, not even by calling
        end_media_session(). It will only stop when the dialog ends.
        Until then it will modify the SDP content of every in-dialog
        message to make it use a media relay. If one needs more control
        over the process, like starting to use mediaproxy only later in
        the failure route, or stopping to use mediaproxy in the failure
        route, then the use_media_proxy and end_media_session functions
        should be used, and manually called as appropriate. Using this
        function should NOT be mixed with either of use_media_proxy()
        or end_media_session().
      </p>
            <p>
        This function can be used from REQUEST_ROUTE.
      </p>
            <div class="example">
              <a id="idp66744"></a>
              <p class="title">
                <strong>Example 1.8. Using the <code class="function">engage_media_proxy</code> function</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
if (method==INVITE &amp;&amp; !has_totag()) {
    # We can also use a specific media relay if we need to
    #$avp(media_relay) = "1.2.3.4";
    engage_media_proxy();
}
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="6.2. use_media_proxy()">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="idp68176"></a>6.2. <code class="function">use_media_proxy()</code></h3>
                </div>
              </div>
            </div>
            <p>
        Will make a call to the dispatcher and replace the IPs and ports
        in the SDP body with the ones returned by the media relay for
        each supported media stream in the SDP body. This will force the
        media streams to be routed through the media relay. If a mix of
        supported and unsupported streams are present in the SDP, only
        the supported streams will be modified, while the unsupported
        streams will be left alone.
      </p>
            <p>
        This function should NOT be mixed with engage_media_proxy().
      </p>
            <p>This function has the following return codes:</p>
            <p>
        </p>
            <div class="itemizedlist">
              <ul class="itemizedlist">
                <li class="listitem">
                  <p>
          +1 - successfully modified message (true value)
        </p>
                </li>
                <li class="listitem">
                  <p>
          -1 - error in processing message (false value)
        </p>
                </li>
                <li class="listitem">
                  <p>
          -2 - missing SDP body, nothing to process (false value)
        </p>
                </li>
              </ul>
            </div>
            <p>
      </p>
            <p>
        This function can be used from REQUEST_ROUTE, ONREPLY_ROUTE, FAILURE_ROUTE, BRANCH_ROUTE.
      </p>
            <div class="example">
              <a id="idp71808"></a>
              <p class="title">
                <strong>Example 1.9. Using the <code class="function">use_media_proxy</code> function</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
if (method==INVITE) {
    # We can also use a specific media relay if we need to
    #$avp(media_relay) = "1.2.3.4";
    use_media_proxy();
}
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="6.3. end_media_session()">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="idp73224"></a>6.3. <code class="function">end_media_session()</code></h3>
                </div>
              </div>
            </div>
            <p>
        Will call on the dispatcher to inform the media relay to end the
        media session. This is done when a call ends, to instruct the media
        relay to release the resources allocated to that call as well as
        to save logging information about the media session. Called on BYE,
        CANCEL or failures.
      </p>
            <p>
        This function should NOT be mixed with engage_media_proxy().
      </p>
            <p>
        This function can be used from REQUEST_ROUTE, ONREPLY_ROUTE, FAILURE_ROUTE, BRANCH_ROUTE.
      </p>
            <div class="example">
              <a id="idp74976"></a>
              <p class="title">
                <strong>Example 1.10. Using the <code class="function">end_media_session</code> function</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
if (method==BYE) {
    end_media_session();
}
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
