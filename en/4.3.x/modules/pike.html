<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>pike Module</title>
    <link rel="stylesheet" type="text/css" href="../../../../css/sr-doc.css" tppabs="http://kamailio.org/css/sr-doc.css" />
    <meta name="generator" content="DocBook XSL Stylesheets V1.76.1" />
    <link rel="home" href="#idm4354152" title="pike Module" />
    <link rel="next" href="#idp2884000" title="Chapter 1. Admin Guide" />
  </head>
  <body>
    <div class="book" title="pike Module">
      <div class="titlepage">
        <div>
          <div>
            <h1 class="title"><a id="idm4354152"></a>pike Module</h1>
          </div>
          <div>
            <div class="authorgroup">
              <div class="author">
                <h3 class="author"><span class="firstname">Bogdan-Andrei</span> <span class="surname">Iancu</span></h3>
                <div class="affiliation">
                  <span class="orgname">Voice Sistem SRL<br /></span>
                </div>
              </div>
              <div class="editor">
                <h4 class="editedby">Edited by</h4>
                <h3 class="editor"><span class="firstname">Bogdan-Andrei</span> <span class="surname">Iancu</span></h3>
              </div>
            </div>
          </div>
          <div>
            <p class="copyright">Copyright © 2003 FhG FOKUS</p>
          </div>
        </div>
        <hr />
      </div>
      <div class="toc">
        <p>
          <strong>Table of Contents</strong>
        </p>
        <dl>
          <dt>
            <span class="chapter">
              <a href="#idp2884000">1. Admin Guide</a>
            </span>
          </dt>
          <dd>
            <dl>
              <dt>
                <span class="section">
                  <a href="#idp2035480">1. Overview</a>
                </span>
              </dt>
              <dt>
                <span class="section">
                  <a href="#idp3254688">2. Dependencies</a>
                </span>
              </dt>
              <dd>
                <dl>
                  <dt>
                    <span class="section">
                      <a href="#idp3079560">2.1. Kamailio Modules</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#idp2055336">2.2. External Libraries or Applications</a>
                    </span>
                  </dt>
                </dl>
              </dd>
              <dt>
                <span class="section">
                  <a href="#idp2674200">3. Parameters</a>
                </span>
              </dt>
              <dd>
                <dl>
                  <dt>
                    <span class="section">
                      <a href="#pike.p.sampling_time_unit">3.1. <code class="varname">sampling_time_unit</code> (integer)</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#pike.p.reqs_density_per_unit">3.2. <code class="varname">reqs_density_per_unit</code> (integer)</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#pike.p.remove_latency">3.3. <code class="varname">remove_latency</code> (integer)</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#pike.p.pike_log_level">3.4. <code class="varname">pike_log_level</code> (integer)</a>
                    </span>
                  </dt>
                </dl>
              </dd>
              <dt>
                <span class="section">
                  <a href="#idp192016">4. Functions</a>
                </span>
              </dt>
              <dd>
                <dl>
                  <dt>
                    <span class="section">
                      <a href="#pike.f.pike_check_req">4.1. 
		<code class="function">pike_check_req()</code>
		</a>
                    </span>
                  </dt>
                </dl>
              </dd>
              <dt>
                <span class="section">
                  <a href="#idp287248">5. MI Commands</a>
                </span>
              </dt>
              <dd>
                <dl>
                  <dt>
                    <span class="section">
                      <a href="#pike.m.pike_list">5.1. 
		<code class="function">pike_list</code>
		</a>
                    </span>
                  </dt>
                </dl>
              </dd>
            </dl>
          </dd>
          <dt>
            <span class="chapter">
              <a href="#pike.rpc">2. RPC calls</a>
            </span>
          </dt>
          <dd>
            <dl>
              <dt>
                <span class="section">
                  <a href="#pike.top">1. 
			<code class="function">pike.top</code>
		</a>
                </span>
              </dt>
            </dl>
          </dd>
          <dt>
            <span class="chapter">
              <a href="#idp1537432">3. Developer Guide</a>
            </span>
          </dt>
        </dl>
      </div>
      <div class="list-of-examples">
        <p>
          <strong>List of Examples</strong>
        </p>
        <dl>
          <dt>1.1. <a href="#idp2757104">Set <code class="varname">sampling_time_unit</code> parameter</a></dt>
          <dt>1.2. <a href="#idp185312">Set <code class="varname">reqs_density_per_unit</code> parameter</a></dt>
          <dt>1.3. <a href="#idp188168">Set <code class="varname">remove_latency</code> parameter</a></dt>
          <dt>1.4. <a href="#idp190768">Set <code class="varname">pike_log_level</code> parameter</a></dt>
          <dt>1.5. <a href="#idp286000"><code class="function">pike_check_req</code> usage</a></dt>
          <dt>3.1. <a href="#idp2262360">Tree of <acronym class="acronym">IP</acronym> addresses</a></dt>
        </dl>
      </div>
      <div class="chapter" title="Chapter 1. Admin Guide">
        <div class="titlepage">
          <div>
            <div>
              <h2 class="title"><a id="idp2884000"></a>Chapter 1. Admin Guide</h2>
            </div>
          </div>
        </div>
        <div class="toc">
          <p>
            <strong>Table of Contents</strong>
          </p>
          <dl>
            <dt>
              <span class="section">
                <a href="#idp2035480">1. Overview</a>
              </span>
            </dt>
            <dt>
              <span class="section">
                <a href="#idp3254688">2. Dependencies</a>
              </span>
            </dt>
            <dd>
              <dl>
                <dt>
                  <span class="section">
                    <a href="#idp3079560">2.1. Kamailio Modules</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#idp2055336">2.2. External Libraries or Applications</a>
                  </span>
                </dt>
              </dl>
            </dd>
            <dt>
              <span class="section">
                <a href="#idp2674200">3. Parameters</a>
              </span>
            </dt>
            <dd>
              <dl>
                <dt>
                  <span class="section">
                    <a href="#pike.p.sampling_time_unit">3.1. <code class="varname">sampling_time_unit</code> (integer)</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#pike.p.reqs_density_per_unit">3.2. <code class="varname">reqs_density_per_unit</code> (integer)</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#pike.p.remove_latency">3.3. <code class="varname">remove_latency</code> (integer)</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#pike.p.pike_log_level">3.4. <code class="varname">pike_log_level</code> (integer)</a>
                  </span>
                </dt>
              </dl>
            </dd>
            <dt>
              <span class="section">
                <a href="#idp192016">4. Functions</a>
              </span>
            </dt>
            <dd>
              <dl>
                <dt>
                  <span class="section">
                    <a href="#pike.f.pike_check_req">4.1. 
		<code class="function">pike_check_req()</code>
		</a>
                  </span>
                </dt>
              </dl>
            </dd>
            <dt>
              <span class="section">
                <a href="#idp287248">5. MI Commands</a>
              </span>
            </dt>
            <dd>
              <dl>
                <dt>
                  <span class="section">
                    <a href="#pike.m.pike_list">5.1. 
		<code class="function">pike_list</code>
		</a>
                  </span>
                </dt>
              </dl>
            </dd>
          </dl>
        </div>
        <div class="section" title="1. Overview">
          <div class="titlepage">
            <div>
              <div>
                <h2 class="title"><a id="idp2035480"></a>1. Overview</h2>
              </div>
            </div>
          </div>
          <p>
		The pike module keeps trace of all (or selected ones) incoming request's IP
		source and blocks the ones that exceed the limit. 
		It works simultaneously for IPv4 and IPv6 addresses.
	</p>
          <p>
		The module does not implement any actions on blocking - it just simply
		reports that there is high traffic from an IP; what to do, is
		the administator decision (via scripting).
	</p>
        </div>
        <div class="section" title="2. Dependencies">
          <div class="titlepage">
            <div>
              <div>
                <h2 class="title"><a id="idp3254688"></a>2. Dependencies</h2>
              </div>
            </div>
          </div>
          <div class="section" title="2.1. Kamailio Modules">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="idp3079560"></a>2.1. Kamailio Modules</h3>
                </div>
              </div>
            </div>
            <p>
		The following modules must be loaded before this module:
			</p>
            <div class="itemizedlist">
              <ul class="itemizedlist">
                <li class="listitem">
                  <p>
				<span class="emphasis"><em>No dependencies on other Kamailio modules</em></span>.
			</p>
                </li>
              </ul>
            </div>
            <p>
		</p>
          </div>
          <div class="section" title="2.2. External Libraries or Applications">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="idp2055336"></a>2.2. External Libraries or Applications</h3>
                </div>
              </div>
            </div>
            <p>
		The following libraries or applications must be installed before 
		running Kamailio with this module loaded:
			</p>
            <div class="itemizedlist">
              <ul class="itemizedlist">
                <li class="listitem">
                  <p>
				<span class="emphasis"><em>None</em></span>.
			</p>
                </li>
              </ul>
            </div>
            <p>
		</p>
          </div>
        </div>
        <div class="section" title="3. Parameters">
          <div class="titlepage">
            <div>
              <div>
                <h2 class="title"><a id="idp2674200"></a>3. Parameters</h2>
              </div>
            </div>
          </div>
          <div class="section" title="3.1. sampling_time_unit (integer)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="pike.p.sampling_time_unit"></a>3.1. <code class="varname">sampling_time_unit</code> (integer)</h3>
                </div>
              </div>
            </div>
            <p>
		Time period in seconds used for sampling (or the sampling accuracy).
		The smaller the better, but slower. If you want to detect peeks, use
		a small one. To limit the access (like total number of requests on a 
		long period of time) to a proxy resource (a gateway for example), use 
		a bigger value of this parameter.
		</p>
            <p>
		IMPORTANT: a too small value may lead to performance penalties due 
		to timer process overloading.
		</p>
            <p>
		<span class="emphasis"><em>
			Default value is <span class="quote">“<span class="quote">2</span>”</span>.
		</em></span>
		</p>
            <div class="example">
              <a id="idp2757104"></a>
              <p class="title">
                <strong>Example 1.1. Set <code class="varname">sampling_time_unit</code> parameter</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
modparam("pike", "sampling_time_unit", 10)
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="3.2. reqs_density_per_unit (integer)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="pike.p.reqs_density_per_unit"></a>3.2. <code class="varname">reqs_density_per_unit</code> (integer)</h3>
                </div>
              </div>
            </div>
            <p>
		How many requests should be allowed per <code class="varname">sampling_time_unit</code>
		before blocking all the incoming request from that IP. Practically, the 
		blocking limit is between ( let's have x=reqs_density_per_unit) x 
		and 3*x for IPv4 addresses and between x and 8*x for IPv6 addresses.
		</p>
            <p>
		<span class="emphasis"><em>
			Default value is 30.
		</em></span>
		</p>
            <div class="example">
              <a id="idp185312"></a>
              <p class="title">
                <strong>Example 1.2. Set <code class="varname">reqs_density_per_unit</code> parameter</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
modparam("pike", "reqs_density_per_unit", 30)
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="3.3. remove_latency (integer)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="pike.p.remove_latency"></a>3.3. <code class="varname">remove_latency</code> (integer)</h3>
                </div>
              </div>
            </div>
            <p>
		Speciies for how long the IP address will be kept in memory after the last 
		request from that IP address. It's a sort of timeout value, in seconds.
		Note that it is not the duration to keep the IP in state 'blocked'. An
		IP is unblocked next occurence of 'sampling_time_unit' that does not
		exceed 'reqs_density_per_unit'. Keeping an IP in memory results in
		faster reaching of blocked state -- see the notes about the limits of
		getting to state 'blocked'.
		</p>
            <p>
		<span class="emphasis"><em>
			Default value is 120.
		</em></span>
		</p>
            <div class="example">
              <a id="idp188168"></a>
              <p class="title">
                <strong>Example 1.3. Set <code class="varname">remove_latency</code> parameter</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
modparam("pike", "remove_latency", 130)
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="3.4. pike_log_level (integer)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="pike.p.pike_log_level"></a>3.4. <code class="varname">pike_log_level</code> (integer)</h3>
                </div>
              </div>
            </div>
            <p>
		Syslog log level to be used by module to auto report the blocking (only first
		time) and unblocking of IPs detected as source of floods.
		</p>
            <p>
		<span class="emphasis"><em>
			Default value is 1 (L_WARN).
		</em></span>
		</p>
            <div class="example">
              <a id="idp190768"></a>
              <p class="title">
                <strong>Example 1.4. Set <code class="varname">pike_log_level</code> parameter</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
modparam("pike", "pike_log_level", -1)
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
        </div>
        <div class="section" title="4. Functions">
          <div class="titlepage">
            <div>
              <div>
                <h2 class="title"><a id="idp192016"></a>4. Functions</h2>
              </div>
            </div>
          </div>
          <div class="section" title="4.1.  pike_check_req()">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="pike.f.pike_check_req"></a>4.1. 
		<code class="function">pike_check_req()</code>
		</h3>
                </div>
              </div>
            </div>
            <p>
		Process the source IP of the current request and return false if 
		the IP was exceeding the blocking limit.
		</p>
            <p>
		Return codes:
		</p>
            <div class="itemizedlist">
              <ul class="itemizedlist">
                <li class="listitem">
                  <p>
				<span class="emphasis"><em>1 (true)</em></span> - IP is not to be blocked or 
				internal error occured.
			</p>
                  <div class="warning" title="Warning" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Warning</h3>
			IMPORTANT: in case of internal error, the function returns true to
			avoid reporting the current processed IP as blocked.
			</div>
                </li>
                <li class="listitem">
                  <p>
				<span class="emphasis"><em>-1 (false)</em></span> - IP is source of
				flooding, previously detected
			</p>
                </li>
                <li class="listitem">
                  <p>
				<span class="emphasis"><em>-2 (false)</em></span> - IP is detected as a new 
				source of flooding - first time detection
			</p>
                </li>
              </ul>
            </div>
            <p>
		</p>
            <p>
		This function can be used from REQUEST_ROUTE.
		</p>
            <div class="example">
              <a id="idp286000"></a>
              <p class="title">
                <strong>Example 1.5. <code class="function">pike_check_req</code> usage</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
if (!pike_check_req()) { exit; };
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
        </div>
        <div class="section" title="5. MI Commands">
          <div class="titlepage">
            <div>
              <div>
                <h2 class="title"><a id="idp287248"></a>5. MI Commands</h2>
              </div>
            </div>
          </div>
          <div class="section" title="5.1.  pike_list">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="pike.m.pike_list"></a>5.1. 
		<code class="function">pike_list</code>
		</h3>
                </div>
              </div>
            </div>
            <p>
		Lists the nodes in the pike tree.
		</p>
            <p>
		Name: <span class="emphasis"><em>pike_list</em></span>
		</p>
            <p>Parameters: <span class="emphasis"><em>none</em></span></p>
            <p>
		MI FIFO Command Format:
		</p>
            <pre class="programlisting">		:pike_list:_reply_fifo_file_
		_empty_line_</pre>
          </div>
        </div>
      </div>
      <div class="chapter" title="Chapter 2. RPC calls">
        <div class="titlepage">
          <div>
            <div>
              <h2 class="title"><a id="pike.rpc"></a>Chapter 2. RPC calls</h2>
            </div>
          </div>
        </div>
        <div class="toc">
          <p>
            <strong>Table of Contents</strong>
          </p>
          <dl>
            <dt>
              <span class="section">
                <a href="#pike.top">1. 
			<code class="function">pike.top</code>
		</a>
              </span>
            </dt>
          </dl>
        </div>
        <div class="section" title="1.  pike.top">
          <div class="titlepage">
            <div>
              <div>
                <h2 class="title"><a id="pike.top"></a>1. 
			<code class="function">pike.top</code>
		</h2>
              </div>
            </div>
          </div>
          <p>
			Pike.top behaves like a 'top' command and shows source IP addresses of incoming requestes to pike_check_req() function.
		</p>
          <p>
			The IP list is sorted by sum of leaf hits (prev and curr) descending and in second level by hits.
		</p>
          <p>
			Some IPs could be marked as HOT depending on theirs request rates.
		</p>
          <p>
			pike.top command takes one string parameter which specifies what kind of nodes you are interested in. Possible values
			are HOT or ALL. If no argument is given, it behaves as HOT was used.
		</p>
          <p>
			Marking nodes HOT is done on server side, client only presents given data and make some postprocessing like sorting.
		</p>
          <p>
			Output of this command is a simple dump of ip_tree nodes marked as ip-leafs.
		</p>
        </div>
      </div>
      <div class="chapter" title="Chapter 3. Developer Guide">
        <div class="titlepage">
          <div>
            <div>
              <h2 class="title"><a id="idp1537432"></a>Chapter 3. Developer Guide</h2>
            </div>
          </div>
        </div>
        <p>
	One single tree (for both IPv4 and IPv6) is used. Each node contains a byte, the <acronym class="acronym">IP</acronym>
	addresses stretching from root to the leafs.
    </p>
        <div class="example">
          <a id="idp2262360"></a>
          <p class="title">
            <strong>Example 3.1. Tree of <acronym class="acronym">IP</acronym> addresses</strong>
          </p>
          <div class="example-contents">
            <pre class="programlisting">	   / 193 - 175 - 132 - 164
tree root /                  \ 142
	  \ 195 - 37 - 78 - 163
	   \ 79 - 134</pre>
          </div>
        </div>
        <br class="example-break" />
        <p>
	To detect the whole address, step by step, from the root to the leafs, the nodes corresponding
	to each byte of the ip address are expanded. In order to be expended a node has to be hit
	for a given number of times (possible by different addresses; in the previous example, the
	node <span class="quote">“<span class="quote">37</span>”</span> was expended by the 195.37.78.163 and 195.37.79.134 hits).
    </p>
        <p>
	For 193.175.132.164 with x= reqs_density_per_unit:
    </p>
        <div class="itemizedlist">
          <ul class="itemizedlist">
            <li class="listitem">
              <p>
		After first req hits -&gt; the <span class="quote">“<span class="quote">193</span>”</span> node is built.
	    </p>
            </li>
            <li class="listitem">
              <p>
		After x more hits, the <span class="quote">“<span class="quote">175</span>”</span> node is build; the hits of
		<span class="quote">“<span class="quote">193</span>”</span> node are split between itself and its child--both of them gone
		have x/2.
	    </p>
            </li>
            <li class="listitem">
              <p>
		And so on for node <span class="quote">“<span class="quote">132</span>”</span> and <span class="quote">“<span class="quote">164</span>”</span>.
	    </p>
            </li>
            <li class="listitem">
              <p>
		Once <span class="quote">“<span class="quote">164</span>”</span> build the entire address can be found in the
		tree. <span class="quote">“<span class="quote">164</span>”</span> becomes a leaf. After it will be hit as a leaf for x
		times, it will become <span class="quote">“<span class="quote">RED</span>”</span> (further request from this address will
		be blocked).
	    </p>
            </li>
          </ul>
        </div>
        <p>
	So, to build and block this address were needed 3*x hits. Now, if reqs start coming from
	193.175.132.142, the first 3 bytes are already in the tree (they are shared with the previous
	address), so I will need only x hits (to build node <span class="quote">“<span class="quote">142</span>”</span> and to make it
	<span class="quote">“<span class="quote">RED</span>”</span>) to make this address also to be blocked.  This is the reason for the
	variable number of hits necessary to block an <acronym class="acronym">IP</acronym>.
    </p>
        <p>
	The maximum number of hits to turn an address red are (n is the address's number of bytes):
    </p>
        <p>
	1 (first byte) + x (second byte) + (x / 2) * (n - 2) (for the rest of the bytes) + (n - 1)
	(to turn the node to red).
    </p>
        <p>
	So, for IPv4 (n = 4) will be 3x and for IPv6 (n = 16) will be 9x. The minimum number of hits
	to turn an address red is x.
    </p>
      </div>
    </div>
  </body>
</html>
