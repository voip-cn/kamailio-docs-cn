<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>EVAPI Module</title>
    <link rel="stylesheet" type="text/css" href="../../../../css/sr-doc.css" tppabs="http://kamailio.org/css/sr-doc.css" />
    <meta name="generator" content="DocBook XSL Stylesheets V1.76.1" />
    <link rel="home" href="#idm15531768" title="EVAPI Module" />
    <link rel="next" href="#idp2441248" title="Chapter1.Admin Guide" />
  </head>
  <body>
    <div class="book" title="EVAPI Module">
      <div class="titlepage">
        <div>
          <div>
            <h1 class="title"><a id="idm15531768"></a>EVAPI Module</h1>
          </div>
          <div>
            <div class="authorgroup">
              <div class="author">
                <h3 class="author"><span class="firstname">Daniel-Constantin</span> <span class="surname">Mierla</span></h3>
                <code class="email">&lt;<a class="email" href="mailto:miconda@gmail.com">miconda@gmail.com</a>&gt;</code>
              </div>
              <div class="editor">
                <h4 class="editedby">Edited by</h4>
                <h3 class="editor"><span class="firstname">Daniel-Constantin</span> <span class="surname">Mierla</span></h3>
                <code class="email">&lt;<a class="email" href="mailto:miconda@gmail.com">miconda@gmail.com</a>&gt;</code>
              </div>
            </div>
          </div>
          <div>
            <p class="copyright">Copyright 漏 2014 asipto.com</p>
          </div>
        </div>
        <hr />
      </div>
      <div class="toc">
        <p>
          <strong>Table of Contents</strong>
        </p>
        <dl>
          <dt>
            <span class="chapter">
              <a href="#idp2441248">1. Admin Guide</a>
            </span>
          </dt>
          <dd>
            <dl>
              <dt>
                <span class="section">
                  <a href="#idp2337944">1. Overview</a>
                </span>
              </dt>
              <dt>
                <span class="section">
                  <a href="#idp2407264">2. Dependencies</a>
                </span>
              </dt>
              <dd>
                <dl>
                  <dt>
                    <span class="section">
                      <a href="#idp2186072">2.1. Kamailio Modules</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#idp1824792">2.2. External Libraries or Applications</a>
                    </span>
                  </dt>
                </dl>
              </dd>
              <dt>
                <span class="section">
                  <a href="#idp2574368">3. Parameters</a>
                </span>
              </dt>
              <dd>
                <dl>
                  <dt>
                    <span class="section">
                      <a href="#evapi.p.workers">3.1. <code class="varname">workers</code> (int)</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#evapi.p.bind_addr">3.2. <code class="varname">bind_addr</code> (str)</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#evapi.p.netstring_format">3.3. <code class="varname">netstring_format</code> (int)</a>
                    </span>
                  </dt>
                </dl>
              </dd>
              <dt>
                <span class="section">
                  <a href="#idp189648">4. Functions</a>
                </span>
              </dt>
              <dd>
                <dl>
                  <dt>
                    <span class="section">
                      <a href="#evapi.f.evapi_relay">4.1. 
		<code class="function">evapi_relay(evdata)</code>
	    </a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#evapi.f.evapi_async_relay">4.2. 
		<code class="function">evapi_async_relay(evdata)</code>
	    </a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#evapi.f.evapi_close">4.3. 
		<code class="function">evapi_close()</code>
	    </a>
                    </span>
                  </dt>
                </dl>
              </dd>
              <dt>
                <span class="section">
                  <a href="#idp2891136">5. Event routes</a>
                </span>
              </dt>
              <dd>
                <dl>
                  <dt>
                    <span class="section">
                      <a href="#idp2891512">5.1. 
        <code class="function">evapi:connection-new</code>
        </a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#idp2893112">5.2. 
        <code class="function">evapi:connection-closed</code>
        </a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#idp2894728">5.3. 
        <code class="function">evapi:message-received</code>
        </a>
                    </span>
                  </dt>
                </dl>
              </dd>
              <dt>
                <span class="section">
                  <a href="#idm16184">6. Exported pseudo-variables</a>
                </span>
              </dt>
            </dl>
          </dd>
        </dl>
      </div>
      <div class="list-of-examples">
        <p>
          <strong>List of Examples</strong>
        </p>
        <dl>
          <dt>1.1. <a href="#idp2685256">Set <code class="varname">workers</code> parameter</a></dt>
          <dt>1.2. <a href="#idp185208">Set <code class="varname">bind_addr</code> parameter</a></dt>
          <dt>1.3. <a href="#idp188144">Set <code class="varname">netstring_format</code> parameter</a></dt>
          <dt>1.4. <a href="#idp192328"><code class="function">evapi_relay</code> usage</a></dt>
          <dt>1.5. <a href="#idp193776">TCP message</a></dt>
          <dt>1.6. <a href="#idp2887016"><code class="function">evapi_async_relay</code> usage</a></dt>
          <dt>1.7. <a href="#idp2889768"><code class="function">evapi_evapi</code> usage</a></dt>
        </dl>
      </div>
      <div class="chapter" title="Chapter1.Admin Guide">
        <div class="titlepage">
          <div>
            <div>
              <h2 class="title"><a id="idp2441248"></a>Chapter1.Admin Guide</h2>
            </div>
          </div>
        </div>
        <div class="toc">
          <p>
            <strong>Table of Contents</strong>
          </p>
          <dl>
            <dt>
              <span class="section">
                <a href="#idp2337944">1. Overview</a>
              </span>
            </dt>
            <dt>
              <span class="section">
                <a href="#idp2407264">2. Dependencies</a>
              </span>
            </dt>
            <dd>
              <dl>
                <dt>
                  <span class="section">
                    <a href="#idp2186072">2.1. Kamailio Modules</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#idp1824792">2.2. External Libraries or Applications</a>
                  </span>
                </dt>
              </dl>
            </dd>
            <dt>
              <span class="section">
                <a href="#idp2574368">3. Parameters</a>
              </span>
            </dt>
            <dd>
              <dl>
                <dt>
                  <span class="section">
                    <a href="#evapi.p.workers">3.1. <code class="varname">workers</code> (int)</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#evapi.p.bind_addr">3.2. <code class="varname">bind_addr</code> (str)</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#evapi.p.netstring_format">3.3. <code class="varname">netstring_format</code> (int)</a>
                  </span>
                </dt>
              </dl>
            </dd>
            <dt>
              <span class="section">
                <a href="#idp189648">4. Functions</a>
              </span>
            </dt>
            <dd>
              <dl>
                <dt>
                  <span class="section">
                    <a href="#evapi.f.evapi_relay">4.1. 
		<code class="function">evapi_relay(evdata)</code>
	    </a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#evapi.f.evapi_async_relay">4.2. 
		<code class="function">evapi_async_relay(evdata)</code>
	    </a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#evapi.f.evapi_close">4.3. 
		<code class="function">evapi_close()</code>
	    </a>
                  </span>
                </dt>
              </dl>
            </dd>
            <dt>
              <span class="section">
                <a href="#idp2891136">5. Event routes</a>
              </span>
            </dt>
            <dd>
              <dl>
                <dt>
                  <span class="section">
                    <a href="#idp2891512">5.1. 
        <code class="function">evapi:connection-new</code>
        </a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#idp2893112">5.2. 
        <code class="function">evapi:connection-closed</code>
        </a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#idp2894728">5.3. 
        <code class="function">evapi:message-received</code>
        </a>
                  </span>
                </dt>
              </dl>
            </dd>
            <dt>
              <span class="section">
                <a href="#idm16184">6. Exported pseudo-variables</a>
              </span>
            </dt>
          </dl>
        </div>
        <div class="section" title="1.Overview">
          <div class="titlepage">
            <div>
              <div>
                <h2 class="title"><a id="idp2337944"></a>1.Overview</h2>
              </div>
            </div>
          </div>
          <p>
		The EVAPI module can be used to create an event message flow
		from Kamailio to any application that can connect to a TCP
		socket. The remote application can also issue messages received
		by Kamailio.
	</p>
          <p>
		There is no protocol definition, it is all up to the author of
		the routing script. Events can be generated for any event in
		Kamailio. For 3rd party transaction control, a transaction can
		be automatically suspended when sending the event, to be resumed
		at a later point, maybe triggered by an incoming message on the event socket.
	</p>
        </div>
        <div class="section" title="2.Dependencies">
          <div class="titlepage">
            <div>
              <div>
                <h2 class="title"><a id="idp2407264"></a>2.Dependencies</h2>
              </div>
            </div>
          </div>
          <div class="section" title="2.1.Kamailio Modules">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="idp2186072"></a>2.1.Kamailio Modules</h3>
                </div>
              </div>
            </div>
            <p>
		The following modules must be loaded before this module:
			</p>
            <div class="itemizedlist">
              <ul class="itemizedlist">
                <li class="listitem">
                  <p>
				<span class="emphasis"><em>tm</em></span> - (optional) needed only by
				evapi_async_relay()
			</p>
                </li>
              </ul>
            </div>
            <p>
		</p>
          </div>
          <div class="section" title="2.2.External Libraries or Applications">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="idp1824792"></a>2.2.External Libraries or Applications</h3>
                </div>
              </div>
            </div>
            <p>
		The following libraries or applications must be installed before running
		Kamailio with this module loaded:
			</p>
            <div class="itemizedlist">
              <ul class="itemizedlist">
                <li class="listitem">
                  <p>
				<span class="emphasis"><em>libev</em></span> - <a class="ulink" href="javascript:if(confirm('http://software.schmorp.de/pkg/libev  \n\n该文件无法用 Teleport Ultra 下载, 因为 它是一个域或路径外部被设置为它的启始地址的地址。  \n\n你想在服务器上打开它?'))window.location='http://software.schmorp.de/pkg/libev'" tppabs="http://software.schmorp.de/pkg/libev">http://software.schmorp.de/pkg/libev</a>
			</p>
                </li>
              </ul>
            </div>
            <p>
		</p>
          </div>
        </div>
        <div class="section" title="3.Parameters">
          <div class="titlepage">
            <div>
              <div>
                <h2 class="title"><a id="idp2574368"></a>3.Parameters</h2>
              </div>
            </div>
          </div>
          <div class="section" title="3.1.workers (int)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="evapi.p.workers"></a>3.1.<code class="varname">workers</code> (int)</h3>
                </div>
              </div>
            </div>
            <p>
			Number of worker processes to be started to handle incoming messages
			from remote applications.
		</p>
            <p>
		<span class="emphasis"><em>
			Default value is 1.
		</em></span>
		</p>
            <div class="example">
              <a id="idp2685256"></a>
              <p class="title">
                <strong>Example1.1.Set <code class="varname">workers</code> parameter</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
modparam("evapi", "workers", 2)
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="3.2.bind_addr (str)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="evapi.p.bind_addr"></a>3.2.<code class="varname">bind_addr</code> (str)</h3>
                </div>
              </div>
            </div>
            <p>
		Local IP and port to listen on for incoming TCP connections.
		</p>
            <p>
		<span class="emphasis"><em>
			Default value is "127.0.0.1:8448".
		</em></span>
		</p>
            <div class="example">
              <a id="idp185208"></a>
              <p class="title">
                <strong>Example1.2.Set <code class="varname">bind_addr</code> parameter</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
modparam("evapi", "bind_addr", "1.2.3.4:8228")
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="3.3.netstring_format (int)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="evapi.p.netstring_format"></a>3.3.<code class="varname">netstring_format</code> (int)</h3>
                </div>
              </div>
            </div>
            <p>
			Control if messages on the socket (to and from clients)
			are encapsulated in netstring format.
		</p>
            <p>
		<span class="emphasis"><em>
			Default value is 1 (netstring format).
		</em></span>
		</p>
            <div class="example">
              <a id="idp188144"></a>
              <p class="title">
                <strong>Example1.3.Set <code class="varname">netstring_format</code> parameter</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
modparam("evapi", "netstring_format", 0)
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
        </div>
        <div class="section" title="4.Functions">
          <div class="titlepage">
            <div>
              <div>
                <h2 class="title"><a id="idp189648"></a>4.Functions</h2>
              </div>
            </div>
          </div>
          <div class="section" title="4.1. evapi_relay(evdata)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="evapi.f.evapi_relay"></a>4.1.
		<code class="function">evapi_relay(evdata)</code>
	    </h3>
                </div>
              </div>
            </div>
            <p>
		Relay the event data given as parameter to connected applications.
		</p>
            <p>
		The format on the network is netstring with evdata payload if
		netstring_format parameter is set to 1 or bare evdata if
		netstring_format parameter is set to 0.
		</p>
            <p>
		The function is passing the task to evapi dispatcher process, therefore
		the SIP worker process is not blocked. Also, it doesn't wait for any
		response, therefore the processing of the configuration continues
		very fast when executing evapi_relay().
		</p>
            <p>
		This function can be used from ANY_ROUTE.
		</p>
            <div class="example">
              <a id="idp192328"></a>
              <p class="title">
                <strong>Example1.4.<code class="function">evapi_relay</code> usage</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
evapi_relay("{ \"event\": \"test\",\n \"data\": { \"fU\": \"$fU\" }\n}");
...</pre>
              </div>
            </div>
            <br class="example-break" />
            <p>
		The above exaple will send the following message over tcp:
		</p>
            <div class="example">
              <a id="idp193776"></a>
              <p class="title">
                <strong>Example1.5.TCP message</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
47:{
 "event": "test",
 "data": { "fU": "test" }
},
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="4.2. evapi_async_relay(evdata)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="evapi.f.evapi_async_relay"></a>4.2.
		<code class="function">evapi_async_relay(evdata)</code>
	    </h3>
                </div>
              </div>
            </div>
            <p>
		Relay the event data given as parameter to connected applications. Before
		evaluating the parameter, the request processing is suspended using
		tm module (using the t_suspend()/t_continue() framework). The routing
		of the SIP request can be continued once event_route[evapi:message-received]
		is triggered. After evapi_async_relay() returns true, no relaying should
		happen in request_route(), it should be followed by exit;.
		</p>
            <p>
		The format on the network is netstring with evdata payload if
		netstring_format parameter is set to 1 or bare evdata if
		netstring_format parameter is set to 0.
		</p>
            <p>
		This function can be used from REQUEST_ROUTE.
		</p>
            <div class="example">
              <a id="idp2887016"></a>
              <p class="title">
                <strong>Example1.6.<code class="function">evapi_async_relay</code> usage</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
evapi_async_relay("{ \"event\": \"suspend\",\n \"data\":"
        " { \"index\": \"$T(id_index)\", \"label\": \"$T(id_label)\" }\n}");
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="4.3. evapi_close()">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="evapi.f.evapi_close"></a>4.3.
		<code class="function">evapi_close()</code>
	    </h3>
                </div>
              </div>
            </div>
            <p>
		Close evapi current client connection.
		</p>
            <p>
		This function can be used from ANY_ROUTE.
		</p>
            <div class="example">
              <a id="idp2889768"></a>
              <p class="title">
                <strong>Example1.7.<code class="function">evapi_evapi</code> usage</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
event_route[evapi:connection-new] {
  if($evapi(srcaddr)!="127.0.0.1") {
    evapi_close();
    exit;
  }
}
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
        </div>
        <div class="section" title="5.Event routes">
          <div class="titlepage">
            <div>
              <div>
                <h2 class="title"><a id="idp2891136"></a>5.Event routes</h2>
              </div>
            </div>
          </div>
          <div class="section" title="5.1. evapi:connection-new">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="idp2891512"></a>5.1.
        <code class="function">evapi:connection-new</code>
        </h3>
                </div>
              </div>
            </div>
            <p>
			If defined, the module calls event_route[evapi:connection-new]
			when a new client is connected.
        </p>
            <pre class="programlisting">...
event_route[evapi:connection-new] {
    xlog("new connection from $evapi(srcaddr):$evapi(srcport)\n");
}
...</pre>
          </div>
          <div class="section" title="5.2. evapi:connection-closed">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="idp2893112"></a>5.2.
        <code class="function">evapi:connection-closed</code>
        </h3>
                </div>
              </div>
            </div>
            <p>
			If defined, the module calls event_route[evapi:connection-closed]
			when a client connection is closed.
        </p>
            <pre class="programlisting">...
event_route[evapi:connection-closed] {
    xlog("connection closed by $evapi(srcaddr):$evapi(srcport)\n");
}
...</pre>
          </div>
          <div class="section" title="5.3. evapi:message-received">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="idp2894728"></a>5.3.
        <code class="function">evapi:message-received</code>
        </h3>
                </div>
              </div>
            </div>
            <p>
			If defined, the module calls event_route[evapi:message-received]
			when a message is received from a client.
        </p>
            <pre class="programlisting">...
event_route[evapi:message-received] {
    xlog("received [$evapi(msg)] from $evapi(srcaddr):$evapi(srcport)\n");
}
...</pre>
          </div>
        </div>
        <div class="section" title="6.Exported pseudo-variables">
          <div class="titlepage">
            <div>
              <div>
                <h2 class="title"><a id="idm16184"></a>6.Exported pseudo-variables</h2>
              </div>
            </div>
          </div>
          <div class="itemizedlist">
            <ul class="itemizedlist">
              <li class="listitem">
                <p>
				<span class="emphasis"><em>$evapi(srcaddr)</em></span> - source ip
			</p>
              </li>
              <li class="listitem">
                <p>
				<span class="emphasis"><em>$evapi(srcport)</em></span> - source port
			</p>
              </li>
              <li class="listitem">
                <p>
				<span class="emphasis"><em>$evapi(msg)</em></span> - received event message
			</p>
              </li>
              <li class="listitem">
                <p>
				<span class="emphasis"><em>$evapi(conidx)</em></span> - internal connection index
			</p>
              </li>
            </ul>
          </div>
          <p>
		Exported pseudo-variables are documented at <a class="ulink" href="javascript:if(confirm('http://www.kamailio.org/wiki/  \n\n该文件无法用 Teleport Ultra 下载, 因为 它是一个域或路径外部被设置为它的启始地址的地址。  \n\n你想在服务器上打开它?'))window.location='http://www.kamailio.org/wiki/'" tppabs="http://www.kamailio.org/wiki/">http://www.kamailio.org/wiki/</a>.
		</p>
        </div>
      </div>
    </div>
  </body>
</html>
