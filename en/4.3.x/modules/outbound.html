<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>Outbound Module</title>
    <link rel="stylesheet" type="text/css" href="../../../../css/sr-doc.css" tppabs="http://kamailio.org/css/sr-doc.css" />
    <meta name="generator" content="DocBook XSL Stylesheets V1.76.1" />
    <link rel="home" href="#idm4346368" title="Outbound Module" />
    <link rel="next" href="#idp2980784" title="Chapter 1. Admin Guide" />
  </head>
  <body>
    <div class="book" title="Outbound Module">
      <div class="titlepage">
        <div>
          <div>
            <h1 class="title"><a id="idm4346368"></a>Outbound Module</h1>
          </div>
          <div>
            <div class="authorgroup">
              <div class="author">
                <h3 class="author"><span class="firstname">Peter</span> <span class="surname">Dunkley</span></h3>
                <div class="affiliation">
                  <span class="orgname">Crocodile RCS Ltd<br /></span>
                </div>
              </div>
            </div>
          </div>
          <div>
            <p class="copyright">Copyright © 2012-2013 Crocodile RCS Ltd</p>
          </div>
        </div>
        <hr />
      </div>
      <div class="toc">
        <p>
          <strong>Table of Contents</strong>
        </p>
        <dl>
          <dt>
            <span class="chapter">
              <a href="#idp2980784">1. Admin Guide</a>
            </span>
          </dt>
          <dd>
            <dl>
              <dt>
                <span class="section">
                  <a href="#idp3143144">1. Overview</a>
                </span>
              </dt>
              <dd>
                <dl>
                  <dt>
                    <span class="section">
                      <a href="#idp2409248">1.1. Edge Proxy Keep-Alives (STUN)</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#idp1406832">1.2. Flow Timer</a>
                    </span>
                  </dt>
                </dl>
              </dd>
              <dt>
                <span class="section">
                  <a href="#idp2558128">2. Dependencies</a>
                </span>
              </dt>
              <dd>
                <dl>
                  <dt>
                    <span class="section">
                      <a href="#idp2706112">2.1. Kamailio Modules</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#idm19696">2.2. External Libraries or Applications</a>
                    </span>
                  </dt>
                </dl>
              </dd>
              <dt>
                <span class="section">
                  <a href="#idp258568">3. Parameters</a>
                </span>
              </dt>
              <dd>
                <dl>
                  <dt>
                    <span class="section">
                      <a href="#idp258936">3.1. <code class="varname">force_outbound_flag</code> (integer)</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#idp184680">3.2. <code class="varname">force_no_outbound_flag</code> (integer)</a>
                    </span>
                  </dt>
                </dl>
              </dd>
              <dt>
                <span class="section">
                  <a href="#idp187376">4. Functions</a>
                </span>
              </dt>
              <dt>
                <span class="section">
                  <a href="#idp188112">5. MI Commands</a>
                </span>
              </dt>
            </dl>
          </dd>
        </dl>
      </div>
      <div class="list-of-examples">
        <p>
          <strong>List of Examples</strong>
        </p>
        <dl>
          <dt>1.1. <a href="#idp2778192">Edge Proxy Configuration</a></dt>
          <dt>1.2. <a href="#idp2450688">Registrar Configuration</a></dt>
          <dt>1.3. <a href="#idp183576">Set <code class="varname">force_outbound_flag</code> parameter
		</a></dt>
          <dt>1.4. <a href="#idp186192">Set <code class="varname">force_no_outbound_flag</code> parameter
		</a></dt>
        </dl>
      </div>
      <div class="chapter" title="Chapter 1. Admin Guide">
        <div class="titlepage">
          <div>
            <div>
              <h2 class="title"><a id="idp2980784"></a>Chapter 1. Admin Guide</h2>
            </div>
          </div>
        </div>
        <div class="toc">
          <p>
            <strong>Table of Contents</strong>
          </p>
          <dl>
            <dt>
              <span class="section">
                <a href="#idp3143144">1. Overview</a>
              </span>
            </dt>
            <dd>
              <dl>
                <dt>
                  <span class="section">
                    <a href="#idp2409248">1.1. Edge Proxy Keep-Alives (STUN)</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#idp1406832">1.2. Flow Timer</a>
                  </span>
                </dt>
              </dl>
            </dd>
            <dt>
              <span class="section">
                <a href="#idp2558128">2. Dependencies</a>
              </span>
            </dt>
            <dd>
              <dl>
                <dt>
                  <span class="section">
                    <a href="#idp2706112">2.1. Kamailio Modules</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#idm19696">2.2. External Libraries or Applications</a>
                  </span>
                </dt>
              </dl>
            </dd>
            <dt>
              <span class="section">
                <a href="#idp258568">3. Parameters</a>
              </span>
            </dt>
            <dd>
              <dl>
                <dt>
                  <span class="section">
                    <a href="#idp258936">3.1. <code class="varname">force_outbound_flag</code> (integer)</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#idp184680">3.2. <code class="varname">force_no_outbound_flag</code> (integer)</a>
                  </span>
                </dt>
              </dl>
            </dd>
            <dt>
              <span class="section">
                <a href="#idp187376">4. Functions</a>
              </span>
            </dt>
            <dt>
              <span class="section">
                <a href="#idp188112">5. MI Commands</a>
              </span>
            </dt>
          </dl>
        </div>
        <div class="section" title="1. Overview">
          <div class="titlepage">
            <div>
              <div>
                <h2 class="title"><a id="idp3143144"></a>1. Overview</h2>
              </div>
            </div>
          </div>
          <p>This module provides C-API functions to enable Kamailio to be
	used as an outbound Edge Proxy (see RFC 5626 section 5).</p>
          <p>The <span class="emphasis"><em>path</em></span> and <span class="emphasis"><em>rr</em></span> will
	bind to this module if it is loaded before they are.</p>
          <div class="section" title="1.1. Edge Proxy Keep-Alives (STUN)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="idp2409248"></a>1.1. Edge Proxy Keep-Alives (STUN)</h3>
                </div>
              </div>
            </div>
            <p>Outbound Edge Proxies MUST support STUN NAT keep-alives
		on their SIP UDP ports. Kamailio supports this though the
		<span class="quote">“<span class="quote">stun</span>”</span> module.</p>
          </div>
          <div class="section" title="1.2. Flow Timer">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="idp1406832"></a>1.2. Flow Timer</h3>
                </div>
              </div>
            </div>
            <p>The maximum interval at which a User Agent must send a
		keep-alive may be specified by the Registrar using the
		Flow-Timer: header in 2xx responses to REGISTERs.</p>
            <p>When using TCP or TLS as the SIP transport care should
		be taken to set the <span class="quote">“<span class="quote">tcp_connection_lifetime</span>”</span>
		on the Edge Proxy to a value slightly larger than the interval
		the Registrar is using for flow timer. Setting
		<span class="quote">“<span class="quote">tcp_connection_lifetime</span>”</span> to less than the
		interval could cause connections to be lost, and setting it
		to a value much larger than the interval will keep connections
		open far longer than is required (which is wasteful).</p>
            <p>Application-layer keep-alives are optional when the
		underlying transport already has a keep-alive mechanism. The
		WebSocket transport has a transport-layer keep-alive. When
		using the WebSocket transport the
		<span class="quote">“<span class="quote">keepalive_timeout</span>”</span> should be set to a value
		a little greater than the Registrar flow timer interval and a
		little less than the <span class="quote">“<span class="quote">tcp_connection_lifetime</span>”</span>.
		</p>
          </div>
          <div class="example">
            <a id="idp2778192"></a>
            <p class="title">
              <strong>Example 1.1. Edge Proxy Configuration</strong>
            </p>
            <div class="example-contents">
              <pre class="programlisting">#!KAMAILIO
#
# Edge proxy configuration
#

#!subst "/REGISTRAR_IP/192.168.122.3/"
#!subst "/REGISTRAR_PORT/5060/"
#!substdef "/FLOW_TIMER/20/"

####### Global Parameters #########

debug=2
log_stderror=no
log_facility=LOG_LOCAL0
fork=yes
children=4
alias="example.com"
mpath="/usr/lib64/kamailio/modules"
tcp_connection_lifetime=30 # FLOW_TIMER + 10
force_rport=yes


####### Modules Section ########

loadmodule "tm.so"
loadmodule "sl.so"
loadmodule "outbound.so"
loadmodule "rr.so"
loadmodule "path.so"
loadmodule "pv.so"
loadmodule "maxfwd.so"
loadmodule "xlog.so"
loadmodule "sanity.so"
loadmodule "ctl.so"
loadmodule "mi_rpc.so"
loadmodule "mi_fifo.so"
loadmodule "textops.so"
loadmodule "siputils.so"
loadmodule "stun.so"

# ----------------- setting module-specific parameters ---------------

# ----- mi_fifo params -----
modparam("mi_fifo", "fifo_name", "/tmp/kamailio_fifo")

# ----- tm params -----
modparam("tm", "failure_reply_mode", 3)

# ----- rr params -----
modparam("rr", "append_fromtag", 0)


####### Routing Logic ########

request_route {
	route(REQINIT);

	if (is_method("CANCEL")) {
		if (t_check_trans()) {
			route(RELAY);
		}
		exit;
	}

	route(WITHINDLG);

	t_check_trans();

	if (is_method("REGISTER")) {
		remove_hf("Route");
		add_path();
		$du = "sip:REGISTRAR_IP:REGISTRAR_PORT";
	} else {
		if (is_method("INVITE|SUBSCRIBE"))
			record_route();

		if (@via[2] == "") {
			# From client so route to registrar...

			if ($rU == $null) {
				sl_send_reply("484", "Address Incomplete");
				exit;
			}
			remove_hf("Route");
			$du = "sip:REGISTRAR_IP:REGISTRAR_PORT";
		} else {
			# From registrar so route using "Route:" headers...

			if (!loose_route()) {
				switch($rc) {
				case -2:
					sl_send_reply("403", "Forbidden");
					exit;
				default:
					xlog("L_ERR", "in request_route\n");
					sl_reply_error();
					exit;
				}
			}

			t_on_failure("FAIL_OUTBOUND");
		}
	}

	route(RELAY);
}

route[RELAY] {
	if (!t_relay()) {
		sl_reply_error();
	}
	exit;
}

route[REQINIT] {
	if (!mf_process_maxfwd_header("10")) {
		sl_send_reply("483","Too Many Hops");
		exit;
	}

	if(!sanity_check("1511", "7"))
	{
		xlog("Malformed SIP message from $si:$sp\n");
		exit;
	}
}

route[WITHINDLG] {
	if (has_totag()) {
		if (!loose_route()) {
			switch($rc) {
			case -2:
				sl_send_reply("403", "Forbidden");
				exit;
			default:
				if (is_method("ACK")) {
					if ( t_check_trans() ) {
						route(RELAY);
						exit;
					} else {
						exit;
					}
				}
				sl_send_reply("404","Not Found");
			}
		} else {
			if (is_method("NOTIFY")) {
				record_route();
			}
			route(RELAY);
		}
		exit;
	}
}

onreply_route {
	if (!t_check_trans()) {
		drop;
	}

	if ($rm == "REGISTER" &amp;&amp; $rs &gt;= 200 &amp;&amp; $rs &lt;= 299) {
		remove_hf("Flow-Timer");
		if ($(hdr(Require)[*])=~"outbound")
			insert_hf("Flow-Timer: FLOW_TIMER\r\n", "Call-ID");
	}
}

failure_route[FAIL_OUTBOUND] {
	if (t_branch_timeout() || !t_branch_replied()) {
		send_reply("430", "Flow Failed");
	}
}</pre>
            </div>
          </div>
          <br class="example-break" />
          <div class="example">
            <a id="idp2450688"></a>
            <p class="title">
              <strong>Example 1.2. Registrar Configuration</strong>
            </p>
            <div class="example-contents">
              <pre class="programlisting">MAILIO
#
# Registrar configuration
#


####### Global Parameters #########

debug=2
log_stderror=no
log_facility=LOG_LOCAL0
fork=yes
children=4
alias="example.com"
mpath="/usr/lib64/kamailio/modules"


####### Modules Section ########

loadmodule "tm.so"
loadmodule "tmx.so"
loadmodule "sl.so"
loadmodule "rr.so"
loadmodule "pv.so"
loadmodule "maxfwd.so"
loadmodule "xlog.so"
loadmodule "sanity.so"
loadmodule "ctl.so"
loadmodule "mi_rpc.so"
loadmodule "mi_fifo.so"
loadmodule "textops.so"
loadmodule "siputils.so"
loadmodule "usrloc.so"
loadmodule "registrar.so"

# ----------------- setting module-specific parameters ---------------

# ----- mi_fifo params -----
modparam("mi_fifo", "fifo_name", "/tmp/kamailio_fifo")


# ----- tm params -----
modparam("tm", "failure_reply_mode", 3)
modparam("tm", "restart_fr_on_each_reply", 0)
modparam("tm", "contact_flows_avp", "tm_contact_flows")
modparam("tm", "contacts_avp", "tm_contacts")

# ----- rr params -----
modparam("rr", "append_fromtag", 0)

# ----- registrar params -----
modparam("registrar", "use_path", 1)
modparam("registrar", "gruu_enabled", 1)
modparam("registrar", "outbound_mode", 1)


####### Routing Logic ########

request_route {
	route(REQINIT);

	if (is_method("CANCEL")) {
		if (t_check_trans()) {
			route(RELAY);
		}
		exit;
	}

	route(WITHINDLG);

	t_check_trans();

	remove_hf("Route");
	if (is_method("INVITE|SUBSCRIBE"))
		record_route();

	route(REGISTRAR);

	if ($rU==$null) {
		xlog("L_INFO", "Address Incomplete\n");
		send_reply("484","Address Incomplete");
		exit;
	}

	route(LOCATION);
}


route[RELAY] {
	if (!t_relay()) {
		xlog("L_ERR", "t_relay() failed\n");
		sl_reply_error();
	}
	exit;
}

route[REQINIT] {
	if (!mf_process_maxfwd_header("10")) {
		xlog("L_INFO", "Too Many Hops\n");
		send_reply("483","Too Many Hops");
		exit;
	}

	if(!sanity_check("1511", "7"))
	{
		xlog("Malformed SIP message from $si:$sp\n");
		exit;
	}
}

route[WITHINDLG] {
	if (has_totag()) {
		if (loose_route()) {
			if (is_method("NOTIFY")) {
				record_route();
			}
			route(RELAY);
		} else {
			if (is_method("ACK")) {
				if (t_check_trans()) {
					route(RELAY);
					exit;
				} else {
					exit;
				}
			}
			xlog("L_INFO", "Not Found");
			send_reply("404","Not Found");
		}
		exit;
	}
}

route[REGISTRAR] {
	if (is_method("REGISTER"))
	{
		if (!save("location")) {
			xlog("L_ERR", "Unable to save location\n");
			sl_reply_error();
		}
		exit;
	}
}

route[LOCATION] {
	if (!lookup("location")) {
		$var(rc) = $rc;
		t_newtran();
		switch ($var(rc)) {
			case -1:
			case -3:
				send_reply("404", "Not Found");
				exit;
			case -2:
				send_reply("405", "Method Not Allowed");
				exit;
		}
	}

	if (!t_load_contacts() || !t_next_contacts()) {
		xlog("L_ERR", "t_(load|next)_contacts() failed\n");
		sl_reply_error();
		exit;
	}

	t_on_failure("FAIL_TRANSACTION");
	t_on_branch_failure("FAIL-BRANCH");
	route(RELAY);
	exit;
}

onreply_route {
	if (!t_check_trans()) {
		drop;
	}
}

failure_route[FAIL_TRANSACTION] {
	if (!t_check_status("6[0-9][0-9]")) {
		if (t_next_contacts()) {
			t_relay();
			exit;
		}
	}

	if (t_check_status("430")) {
		t_reply("480", "Temporarily Unavailable");
		exit;
	}
}

event_route[tm:branch-failure:FAIL-BRANCH] {
	if (t_check_status("403|430")
			|| (t_branch_timeout() &amp;&amp; !t_branch_replied())) {
		unregister("location", "$tu", "$T_reply_ruid");

		if (t_next_contact_flow()) {
			t_on_branch_failure("FAIL-BRANCH");
			t_relay();
		}
	}
}</pre>
            </div>
          </div>
          <br class="example-break" />
        </div>
        <div class="section" title="2. Dependencies">
          <div class="titlepage">
            <div>
              <div>
                <h2 class="title"><a id="idp2558128"></a>2. Dependencies</h2>
              </div>
            </div>
          </div>
          <div class="section" title="2.1. Kamailio Modules">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="idp2706112"></a>2.1. Kamailio Modules</h3>
                </div>
              </div>
            </div>
            <p>
		The following modules must be loaded before this module:
		</p>
            <div class="itemizedlist">
              <ul class="itemizedlist">
                <li class="listitem">
                  <p>
                    <span class="emphasis">
                      <em>None</em>
                    </span>
                  </p>
                </li>
              </ul>
            </div>
            <p>
		</p>
            <p>
		The following modules are required to make proper use of this
		module:
		</p>
            <div class="itemizedlist">
              <ul class="itemizedlist">
                <li class="listitem">
                  <p><span class="emphasis"><em>stun</em></span>.</p>
                </li>
              </ul>
            </div>
            <p>
		</p>
          </div>
          <div class="section" title="2.2. External Libraries or Applications">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="idm19696"></a>2.2. External Libraries or Applications</h3>
                </div>
              </div>
            </div>
            <p>
		The following libraries must be installed before running
		Kamailio with this module loaded:
		</p>
            <div class="itemizedlist">
              <ul class="itemizedlist">
                <li class="listitem">
                  <p><span class="emphasis"><em>OpenSSL</em></span>.</p>
                </li>
              </ul>
            </div>
            <p>
		</p>
          </div>
        </div>
        <div class="section" title="3. Parameters">
          <div class="titlepage">
            <div>
              <div>
                <h2 class="title"><a id="idp258568"></a>3. Parameters</h2>
              </div>
            </div>
          </div>
          <div class="section" title="3.1. force_outbound_flag (integer)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="idp258936"></a>3.1. <code class="varname">force_outbound_flag</code> (integer)</h3>
                </div>
              </div>
            </div>
            <p>A flag which, if set for a request, will force
		<span class="emphasis"><em>path</em></span> and <span class="emphasis"><em>rr</em></span> to add
		flow tokens to Path: and Record-Route: headers regardless of
		the request contents.</p>
            <p>
              <span class="emphasis">
                <em>Default value is -1.</em>
              </span>
            </p>
            <div class="example">
              <a id="idp183576"></a>
              <p class="title">
                <strong>Example 1.3. Set <code class="varname">force_outbound_flag</code> parameter
		</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
modparam("outbound", "force_outbound_flag", 1)
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="3.2. force_no_outbound_flag (integer)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="idp184680"></a>3.2. <code class="varname">force_no_outbound_flag</code> (integer)</h3>
                </div>
              </div>
            </div>
            <p>A flag which, if set for a request, will force
		<span class="emphasis"><em>path</em></span> and <span class="emphasis"><em>rr</em></span> not
		to add flow tokens to Path: and Record-Route: headers
		regardless of the request contents.</p>
            <p>
              <span class="emphasis">
                <em>Default value is -1.</em>
              </span>
            </p>
            <div class="example">
              <a id="idp186192"></a>
              <p class="title">
                <strong>Example 1.4. Set <code class="varname">force_no_outbound_flag</code> parameter
		</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
modparam("outbound", "force_no_outbound_flag", 2)
...</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
        </div>
        <div class="section" title="4. Functions">
          <div class="titlepage">
            <div>
              <div>
                <h2 class="title"><a id="idp187376"></a>4. Functions</h2>
              </div>
            </div>
          </div>
          <p>
            <span class="emphasis">
              <em>None</em>
            </span>
          </p>
        </div>
        <div class="section" title="5. MI Commands">
          <div class="titlepage">
            <div>
              <div>
                <h2 class="title"><a id="idp188112"></a>5. MI Commands</h2>
              </div>
            </div>
          </div>
          <p>
            <span class="emphasis">
              <em>None</em>
            </span>
          </p>
        </div>
      </div>
    </div>
  </body>
</html>
