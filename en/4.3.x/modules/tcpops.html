<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>TCP Ops module</title>
    <link rel="stylesheet" type="text/css" href="../../../../css/sr-doc.css" tppabs="http://kamailio.org/css/sr-doc.css" />
    <meta name="generator" content="DocBook XSL Stylesheets V1.76.1" />
    <link rel="home" href="#print" title="TCP Ops module" />
    <link rel="next" href="#idm4299912" title="Chapter 1. Admin Guide" />
  </head>
  <body>
    <div class="book" title="TCP Ops module">
      <div class="titlepage">
        <div>
          <div>
            <h1 class="title"><a id="print"></a>TCP Ops module</h1>
          </div>
          <div>
            <div class="authorgroup">
              <div class="author">
                <h3 class="author"><span class="firstname">Camille</span> <span class="surname">Oudot</span></h3>
                <div class="affiliation">
                  <span class="orgname">Orange<br /></span>
                </div>
              </div>
            </div>
          </div>
          <div>
            <p class="copyright">Copyright © 2015 Orange</p>
          </div>
        </div>
        <hr />
      </div>
      <div class="toc">
        <p>
          <strong>Table of Contents</strong>
        </p>
        <dl>
          <dt>
            <span class="chapter">
              <a href="#idm4299912">1. Admin Guide</a>
            </span>
          </dt>
          <dd>
            <dl>
              <dt>
                <span class="section">
                  <a href="#tcpops.overview">1. Overview</a>
                </span>
              </dt>
              <dt>
                <span class="section">
                  <a href="#print.parameters">2. Parameters</a>
                </span>
              </dt>
              <dt>
                <span class="section">
                  <a href="#print.functions">3. Functions</a>
                </span>
              </dt>
              <dd>
                <dl>
                  <dt>
                    <span class="section">
                      <a href="#tcpops.f.tcp_keepalive_enable">3.1. 
			<code class="function">tcp_keepalive_enable([conid], idle, count, interval)</code>
		</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#tcpops.f.tcp_keepalive_disable">3.2. 
			<code class="function">tcp_keepalive_disable([conid])</code>
		</a>
                    </span>
                  </dt>
                  <dt>
                    <span class="section">
                      <a href="#tcpops.f.tcp_set_connection_lifetime">3.3. 
                        <code class="function">tcp_set_connection_lifetime([conid], lifetime)</code>
                </a>
                    </span>
                  </dt>
                </dl>
              </dd>
            </dl>
          </dd>
        </dl>
      </div>
      <div class="list-of-examples">
        <p>
          <strong>List of Examples</strong>
        </p>
        <dl>
          <dt>1.1. <a href="#idp1349808"><code class="function">tcp_keepalive_enable</code> usage</a></dt>
          <dt>1.2. <a href="#idp731160"><code class="function">tcp_keepalive_disable</code> usage</a></dt>
          <dt>1.3. <a href="#idp2338576"><code class="function">tcp_set_connection_lifetime</code> usage</a></dt>
        </dl>
      </div>
      <div class="chapter" title="Chapter 1. Admin Guide">
        <div class="titlepage">
          <div>
            <div>
              <h2 class="title"><a id="idm4299912"></a>Chapter 1. Admin Guide</h2>
            </div>
          </div>
        </div>
        <div class="toc">
          <p>
            <strong>Table of Contents</strong>
          </p>
          <dl>
            <dt>
              <span class="section">
                <a href="#tcpops.overview">1. Overview</a>
              </span>
            </dt>
            <dt>
              <span class="section">
                <a href="#print.parameters">2. Parameters</a>
              </span>
            </dt>
            <dt>
              <span class="section">
                <a href="#print.functions">3. Functions</a>
              </span>
            </dt>
            <dd>
              <dl>
                <dt>
                  <span class="section">
                    <a href="#tcpops.f.tcp_keepalive_enable">3.1. 
			<code class="function">tcp_keepalive_enable([conid], idle, count, interval)</code>
		</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#tcpops.f.tcp_keepalive_disable">3.2. 
			<code class="function">tcp_keepalive_disable([conid])</code>
		</a>
                  </span>
                </dt>
                <dt>
                  <span class="section">
                    <a href="#tcpops.f.tcp_set_connection_lifetime">3.3. 
                        <code class="function">tcp_set_connection_lifetime([conid], lifetime)</code>
                </a>
                  </span>
                </dt>
              </dl>
            </dd>
          </dl>
        </div>
        <div class="section" title="1. Overview">
          <div class="titlepage">
            <div>
              <div>
                <h2 class="title"><a id="tcpops.overview"></a>1. Overview</h2>
              </div>
            </div>
          </div>
          <p>
	    This modules allows kamailio to control the TCP options (such as the keepalive
	    mechanism), on demand, and on a per-socket basis.
	</p>
          <p>
	<span class="emphasis"><em>Note</em></span>: the keepalive functions only work on systems with the
	HAVE_TCP_KEEPIDLE, HAVE_TCP_KEEPCNT and HAVE_TCP_KEEPINTVL macros defined
	(currently only Linux).
	</p>
        </div>
        <div class="section" title="2. Parameters">
          <div class="titlepage">
            <div>
              <div>
                <h2 class="title"><a id="print.parameters"></a>2. Parameters</h2>
              </div>
            </div>
          </div>
        </div>
        <div class="section" title="3. Functions">
          <div class="titlepage">
            <div>
              <div>
                <h2 class="title"><a id="print.functions"></a>3. Functions</h2>
              </div>
            </div>
          </div>
          <div class="section" title="3.1.  tcp_keepalive_enable([conid], idle, count, interval)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="tcpops.f.tcp_keepalive_enable"></a>3.1. 
			<code class="function">tcp_keepalive_enable([conid], idle, count, interval)</code>
		</h3>
                </div>
              </div>
            </div>
            <p>
				Enables keepalive on a TCP connection.
		</p>
            <p>Meaning of the parameters is as follows:</p>
            <div class="itemizedlist">
              <ul class="itemizedlist">
                <li class="listitem">
                  <p><span class="emphasis"><em>conid</em></span> (optionnal): the kamailio internal
				connection id on which TCP keepalive will be enabled. If no parameter
				is given, the keepalive mechanism will be enabled on the current message
				source connection.
				</p>
                </li>
                <li class="listitem">
                  <p><span class="emphasis"><em>idle</em></span> (seconds): the time before the first
				keepalive packet is sent out.
				</p>
                </li>
                <li class="listitem">
                  <p><span class="emphasis"><em>count</em></span>: number of non-acked keepalive before
				reseting the connection. 
				</p>
                </li>
                <li class="listitem">
                  <p><span class="emphasis"><em>interval</em></span> (seconds): time between two keepalive
				probes. 
				</p>
                </li>
              </ul>
            </div>
            <p>Retuns 1 on success, -1 on failure.</p>
            <div class="example">
              <a id="idp1349808"></a>
              <p class="title">
                <strong>Example 1.1. <code class="function">tcp_keepalive_enable</code> usage</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">request_route {
	if (is_method("INVITE")) {
		$avp(caller_conid) = $conid;
		t_on_reply("foo");
	}
	...
}

onreply_route[foo] {
	if (is_method("INVITE") &amp;&amp; status == 200) {
		# enable on callee's connection
		tcp_keepalive_enable("60", "5", "5");
		# enable on caller's connection
		tcp_keepalive_enable("$avp(caller_conid)", "60", "5", "2");
	}
	...
}</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="3.2.  tcp_keepalive_disable([conid])">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="tcpops.f.tcp_keepalive_disable"></a>3.2. 
			<code class="function">tcp_keepalive_disable([conid])</code>
		</h3>
                </div>
              </div>
            </div>
            <p>
				Disables keepalive on a TCP connection.
		</p>
            <p>Meaning of the parameters is as follows:</p>
            <div class="itemizedlist">
              <ul class="itemizedlist">
                <li class="listitem">
                  <p><span class="emphasis"><em>conid</em></span> (optionnal): the kamailio internal
				connection id on which TCP keepalive will be disabled. If no parameter
				is given, the keepalive mechanism will be disabled on the current message
				source connection.
				</p>
                </li>
              </ul>
            </div>
            <p>Retuns 1 on success, -1 on failure.</p>
            <div class="example">
              <a id="idp731160"></a>
              <p class="title">
                <strong>Example 1.2. <code class="function">tcp_keepalive_disable</code> usage</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">request_route {
	...
	if (is_method("BYE")) {
		$avp(bye_conid) = $conid;
		t_on_reply("foo");
	}
	...
}

onreply_route[foo] {
	...
	if (is_method("BYE") &amp;&amp; status == 200) {
		tcp_keepalive_disable();
		tcp_keepalive_disable("$avp(bye_conid)");
	}
	...
}</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
          <div class="section" title="3.3.  tcp_set_connection_lifetime([conid], lifetime)">
            <div class="titlepage">
              <div>
                <div>
                  <h3 class="title"><a id="tcpops.f.tcp_set_connection_lifetime"></a>3.3. 
                        <code class="function">tcp_set_connection_lifetime([conid], lifetime)</code>
                </h3>
                </div>
              </div>
            </div>
            <p>
                                Sets the connection lifetime of a connection (TCP).
                </p>
            <p>Meaning of the parameters is as follows:</p>
            <div class="itemizedlist">
              <ul class="itemizedlist">
                <li class="listitem">
                  <p><span class="emphasis"><em>conid</em></span> (optionnal): the kamailio internal
                                connection id on which to set the new lifetime. If no parameter
                                is given, it will be set on the current message source connection.
                                </p>
                </li>
                <li class="listitem">
                  <p><span class="emphasis"><em>lifetime</em></span> (seconds): the new connection lifetime.
                                </p>
                </li>
              </ul>
            </div>
            <p>Retuns 1 on success, -1 on failure.</p>
            <div class="example">
              <a id="idp2338576"></a>
              <p class="title">
                <strong>Example 1.3. <code class="function">tcp_set_connection_lifetime</code> usage</strong>
              </p>
              <div class="example-contents">
                <pre class="programlisting">...
# use 10s as default lifetime
tcp_connection_lifetime=10 
...

request_route {
        ...
        if (is_method("REGISTER") &amp;&amp; pv_www_authenticate("$td", "xxx", "0")) {
                # raise the TCP lifetime to a bigger value
                tcp_set_connection_lifetime("3605");
        }
        ...
}</pre>
              </div>
            </div>
            <br class="example-break" />
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
